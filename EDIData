/**
 * EDI ë°ì´í„° ì²˜ë¦¬ (ë‚ ì§œ ì§€ì • ì§€ì›)
 * EDIData.gs
 */

const EDIData = {
  /**
   * EDI ë°ì´í„° ì—…ë°ì´íŠ¸ (ì˜¤ëŠ˜ ë‚ ì§œ)
   */
  updateEDIData: function() {
    try {
      const today = new Date();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const searchDate = month + day; // MMDD í˜•ì‹
      
      return this.getEDIFromEmail(searchDate);
      
    } catch (error) {
      return {
        success: false,
        error: error.toString()
      };
    }
  },

  /**
   * EDI ë°ì´í„° ì—…ë°ì´íŠ¸ (ë‚ ì§œ ì§€ì •)
   * @param {string} targetDate - MMDD í˜•ì‹ì˜ ë‚ ì§œ (ì˜ˆ: "1205", "0315")
   */
  updateEDIDataForDate: function(targetDate) {
    console.log('=== Function Start: updateEDIDataForDate ===');
    console.log('Target Date:', targetDate);
    
    try {
      // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
      if (!targetDate || targetDate.length !== 4 || !/^\d{4}$/.test(targetDate)) {
        throw new Error('ë‚ ì§œëŠ” MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 1205, 0315)');
      }
      
      const month = parseInt(targetDate.substring(0, 2));
      const day = parseInt(targetDate.substring(2, 4));
      
      if (month < 1 || month > 12 || day < 1 || day > 31) {
        throw new Error('ì˜¬ë°”ë¥¸ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì›”: 01-12, ì¼: 01-31)');
      }
      
      const result = this.getEDIFromEmail(targetDate);
      
      console.log('=== Function End: updateEDIDataForDate ===');
      return result;
      
    } catch (error) {
      console.error('ERROR in updateEDIDataForDate:', error.toString());
      console.log('=== Function End: updateEDIDataForDate FAILED ===');
      return {
        success: false,
        error: error.toString()
      };
    }
  },
  
  /**
   * Gmailì—ì„œ EDI ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
   */
  getEDIFromEmail: function(dateString) {
    try {
      // ì„¤ì • ì´ˆê¸°í™”
      if (typeof initializeConfig === 'function') {
        initializeConfig();
      }
      
      // ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
      let targetDate = dateString;
      let fullDate = '';
      
      if (dateString.length === 4) {
        // MMDD í˜•ì‹
        targetDate = dateString;
        const year = new Date().getFullYear();
        fullDate = year + dateString;
      } else if (dateString.length === 8) {
        // YYYYMMDD í˜•ì‹
        targetDate = dateString.substring(4); // MMDD ì¶”ì¶œ
        fullDate = dateString;
      } else {
        // ê¸°ë³¸ê°’: ì˜¤ëŠ˜ ë‚ ì§œ
        targetDate = getTodayShortDate();
        fullDate = getTodayDate();
      }
      
      console.log(`EDI ì´ë©”ì¼ ê²€ìƒ‰: ${targetDate} (ì „ì²´: ${fullDate})`);
      
      // EDI ì´ë©”ì¼ ê²€ìƒ‰ ë¡œì§ ê°œì„ 
      const threads = this.searchEDIEmails(targetDate);
      
      if (threads.length === 0) {
        return {
          success: false,
          error: `${targetDate} ë‚ ì§œì˜ EDI ì´ë©”ì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
        };
      }
      
      // ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬
      for (const thread of threads) {
        const messages = thread.getMessages();
        for (const message of messages) {
          const attachments = message.getAttachments();
          
          for (const attachment of attachments) {
            const fileName = attachment.getName();
            
            // í–¥ìƒëœ EDI ì²¨ë¶€íŒŒì¼ ê²€ì¦
            if (this.isEDIAttachment(fileName, fullDate)) {
              console.log(`EDI ì²¨ë¶€íŒŒì¼ ë°œê²¬: ${fileName}`);
              
              // í•œê¸€ Office íŒŒì¼ ì‚¬ì „ ê°ì§€
              const contentType = attachment.getContentType();
              if (contentType.includes('haansoft') || contentType.includes('hancom')) {
                console.log(`âš ï¸ í•œê¸€ Office íŒŒì¼ ê°ì§€: ${fileName} (${contentType})`);
                console.log('ë³€í™˜ ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              }
              
              return this.convertExcelToSheets(attachment, fullDate);
            }
          }
        }
      }
      
      return {
        success: false,
        error: 'EDI ì—‘ì…€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      };
      
    } catch (error) {
      return {
        success: false,
        error: error.toString()
      };
    }
  },
  
  /**
   * EDI ì´ë©”ì¼ ê²€ìƒ‰ (ê°œì„ ëœ ë¡œì§)
   */
  searchEDIEmails: function(targetDate) {
    let threads = [];
    
    // 1. brdmc@naver.com ë°œì‹ ì ìš°ì„  ê²€ìƒ‰
    const primarySender = 'brdmc@naver.com';
    
    // 1-1. MMDD ì œëª©ìœ¼ë¡œ ê²€ìƒ‰
    let query = `from:${primarySender} subject:"${targetDate}" has:attachment`;
    let searchResults = GmailApp.search(query, 0, 10);
    threads = threads.concat(searchResults);
    
    // 1-2. MMDD.xlsx ì œëª©ìœ¼ë¡œ ê²€ìƒ‰
    query = `from:${primarySender} subject:"${targetDate}.xlsx" has:attachment`;
    searchResults = GmailApp.search(query, 0, 10);
    threads = threads.concat(searchResults);
    
    // 1-3. MMDD.xls ì œëª©ìœ¼ë¡œ ê²€ìƒ‰
    query = `from:${primarySender} subject:"${targetDate}.xls" has:attachment`;
    searchResults = GmailApp.search(query, 0, 10);
    threads = threads.concat(searchResults);
    
    // 1-4. ìš´ì†¡ì¥ ê´€ë ¨ ì œëª©ìœ¼ë¡œ ê²€ìƒ‰ (ë‚ ì§œ í¬í•¨)
    const currentYear = new Date().getFullYear();
    const fullDate = currentYear + targetDate; // YYYYMMDD
    query = `from:${primarySender} subject:"${fullDate}_ìš´ì†¡ì¥" has:attachment`;
    searchResults = GmailApp.search(query, 0, 10);
    threads = threads.concat(searchResults);
    
    // 2. ë³´ì¡° ë°œì‹ ì ê²€ìƒ‰ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    if (threads.length === 0) {
      const secondarySender = 'suhyang@kas.co.kr';
      query = `from:${secondarySender} subject:"${targetDate}" has:attachment`;
      searchResults = GmailApp.search(query, 0, 10);
      threads = threads.concat(searchResults);
    }
    
    // 3. ì‹œê°„ ë²”ìœ„ ê²€ìƒ‰ (ì˜¤ëŠ˜ ë‚ ì§œì¸ ê²½ìš°ë§Œ)
    if (threads.length === 0 && targetDate === getTodayShortDate()) {
      const todayStart = new Date();
      todayStart.setHours(13, 0, 0, 0); // ì˜¤í›„ 1ì‹œ
      const todayEnd = new Date();
      todayEnd.setHours(15, 30, 0, 0); // ì˜¤í›„ 3ì‹œ 30ë¶„
      
      query = `(from:brdmc@naver.com OR from:suhyang@kas.co.kr) has:attachment after:${Math.floor(todayStart.getTime()/1000)} before:${Math.floor(todayEnd.getTime()/1000)}`;
      searchResults = GmailApp.search(query, 0, 10);
      threads = threads.concat(searchResults);
    }
    
    // 4. ê³¼ê±° ë‚ ì§œ ê²€ìƒ‰ (ì˜¤ëŠ˜ì´ ì•„ë‹Œ ê²½ìš° ë„“ì€ ë²”ìœ„ ê²€ìƒ‰)
    if (threads.length === 0 && targetDate !== getTodayShortDate()) {
      console.log('ê³¼ê±° ë‚ ì§œ ê²€ìƒ‰ ëª¨ë“œ í™œì„±í™”');
      
      // ë” ë„“ì€ ë²”ìœ„ì˜ ê²€ìƒ‰
      query = `(from:brdmc@naver.com OR from:suhyang@kas.co.kr) subject:${targetDate} has:attachment`;
      searchResults = GmailApp.search(query, 0, 20);
      threads = threads.concat(searchResults);
      
      // ìš´ì†¡ì¥ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰
      query = `(from:brdmc@naver.com OR from:suhyang@kas.co.kr) subject:ìš´ì†¡ì¥ subject:${targetDate} has:attachment`;
      searchResults = GmailApp.search(query, 0, 20);
      threads = threads.concat(searchResults);
      
      // ì „ì²´ ë…„ë„ í¬í•¨ ê²€ìƒ‰
      const fullDate = currentYear + targetDate;
      query = `(from:brdmc@naver.com OR from:suhyang@kas.co.kr) subject:${fullDate} has:attachment`;
      searchResults = GmailApp.search(query, 0, 20);
      threads = threads.concat(searchResults);
    }
    
    // ì¤‘ë³µ ì œê±°
    const uniqueThreads = [];
    const threadIds = new Set();
    
    for (const thread of threads) {
      const threadId = thread.getId();
      if (!threadIds.has(threadId)) {
        threadIds.add(threadId);
        uniqueThreads.push(thread);
      }
    }
    
    console.log(`EDI ì´ë©”ì¼ ê²€ìƒ‰ ê²°ê³¼: ${uniqueThreads.length}ê°œ ë°œê²¬ (ì¤‘ë³µ ì œê±° í›„)`);
    return uniqueThreads;
  },
  
  /**
   * EDI ì²¨ë¶€íŒŒì¼ ê²€ì¦ (ê°œì„ ëœ ë¡œì§)
   */
  isEDIAttachment: function(fileName, fullDate) {
    console.log(`ì²¨ë¶€íŒŒì¼ ê²€ì¦ ì¤‘: ${fileName}`);
    
    // ì—‘ì…€ íŒŒì¼ì´ ì•„ë‹ˆë©´ íŒ¨ìŠ¤
    if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
      return false;
    }
    
    // 1. ìš´ì†¡ì¥ ê´€ë ¨ í‚¤ì›Œë“œ ê²€ì¦
    if (fileName.includes('ìš´ì†¡ì¥')) {
      console.log('ìš´ì†¡ì¥ í‚¤ì›Œë“œ ë°œê²¬');
      return true;
    }
    
    // 2. YYYYMMDD_ìš´ì†¡ì¥ ì¶œë ¥ ìƒì„¸ íŒ¨í„´ ê²€ì¦
    if (fullDate && fileName.includes(fullDate) && fileName.includes('ìš´ì†¡ì¥') && fileName.includes('ì¶œë ¥')) {
      console.log('YYYYMMDD_ìš´ì†¡ì¥ ì¶œë ¥ ìƒì„¸ íŒ¨í„´ ë°œê²¬');
      return true;
    }
    
    // 3. ë¶€ë¶„ì  ë§¤ì¹­ - ìš´ì†¡ì¥ ì¶œë ¥ ìƒì„¸
    if (fileName.includes('ìš´ì†¡ì¥') && fileName.includes('ì¶œë ¥') && fileName.includes('ìƒì„¸')) {
      console.log('ìš´ì†¡ì¥ ì¶œë ¥ ìƒì„¸ ë¶€ë¶„ íŒ¨í„´ ë°œê²¬');
      return true;
    }
    
    // 4. ë‚ ì§œ íŒ¨í„´ì´ í¬í•¨ëœ ê²½ìš° (MMDD)
    const shortDate = fullDate ? fullDate.substring(4) : null;
    if (shortDate && fileName.includes(shortDate)) {
      console.log('ë‚ ì§œ íŒ¨í„´ ë°œê²¬');
      return true;
    }
    
    // 5. ê³¼ê±° ë‚ ì§œ ê²€ìƒ‰ì‹œ ë” ìœ ì—°í•œ ê²€ì¦
    if (shortDate && shortDate !== getTodayShortDate()) {
      // ê³¼ê±° ë‚ ì§œì˜ ê²½ìš° í™•ì¥ìë§Œ í™•ì¸í•˜ê³  í†µê³¼
      if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        console.log('ê³¼ê±° ë‚ ì§œ ì—‘ì…€ íŒŒì¼ - ìœ ì—°í•œ ê²€ì¦ í†µê³¼');
        return true;
      }
    }
    
    console.log('EDI ì²¨ë¶€íŒŒì¼ ì¡°ê±´ì— ë§ì§€ ì•ŠìŒ');
    return false;
  },
  
  /**
   * Excel íŒŒì¼ì„ Google Sheetsë¡œ ë³€í™˜
   */
  convertExcelToSheets: function(attachment, fullDate) {
    try {
      console.log(`ì²¨ë¶€íŒŒì¼ ë³€í™˜ ì‹œì‘: ${attachment.getName()}`);
      console.log(`ì²¨ë¶€íŒŒì¼ ContentType: ${attachment.getContentType()}`);
      
      // ë‹¤ì–‘í•œ Excel í˜•ì‹ ì§€ì›ì„ ìœ„í•œ ìœ ì—°í•œ ë³€í™˜
      let blob;
      const contentType = attachment.getContentType();
      
      // í•œê¸€ Office íŒŒì¼ í˜•ì‹ ê°ì§€
      if (contentType.includes('haansoft') || contentType.includes('hancom')) {
        console.log('í•œê¸€ Office íŒŒì¼ í˜•ì‹ ê°ì§€, íŠ¹ë³„ ì²˜ë¦¬');
        
        // í•œê¸€ Officeì˜ ê²½ìš° ì›ë³¸ blob ì‚¬ìš©
        blob = attachment.copyBlob();
        
        // MIME íƒ€ì…ì„ Excelë¡œ ê°•ì œ ë³€ê²½
        blob = blob.setContentType('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        console.log('í•œê¸€ Office íŒŒì¼ì˜ MIME íƒ€ì…ì„ Excelë¡œ ë³€ê²½');
        
      } else {
        // ì¼ë°˜ì ì¸ Excel íŒŒì¼ ì²˜ë¦¬
        try {
          // í‘œì¤€ Excel í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ì‹œë„
          blob = attachment.getAs('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
          console.log('í‘œì¤€ Excel í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ì„±ê³µ');
        } catch (conversionError) {
          console.log('í‘œì¤€ Excel ë³€í™˜ ì‹¤íŒ¨, ëŒ€ì•ˆ ë°©ë²• ì‹œë„:', conversionError.toString());
          
          try {
            // .xls í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ì‹œë„
            blob = attachment.getAs('application/vnd.ms-excel');
            console.log('MS Excel í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ì„±ê³µ');
          } catch (xlsError) {
            console.log('MS Excel ë³€í™˜ë„ ì‹¤íŒ¨, ì›ë³¸ í˜•ì‹ ê·¸ëŒ€ë¡œ ì‚¬ìš©:', xlsError.toString());
            
            // ì›ë³¸ blob ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë˜ Excel MIME íƒ€ì…ìœ¼ë¡œ ì„¤ì •
            blob = attachment.copyBlob();
            try {
              blob = blob.setContentType('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
              console.log('ì›ë³¸ blobì˜ MIME íƒ€ì…ì„ Excelë¡œ ë³€ê²½');
            } catch (mimeError) {
              console.log('MIME íƒ€ì… ë³€ê²½ ì‹¤íŒ¨, ì›ë³¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©:', mimeError.toString());
            }
          }
        }
      }
      
      // fullDateê°€ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©
      if (!fullDate) {
        fullDate = getTodayDate();
      }
      
      const fileName = fullDate + '_ê°„í¸ì‹_EDI';
      
      // ì„ì‹œë¡œ Driveì— ì €ì¥
      const tempFile = DriveApp.createFile(blob);
      tempFile.setName('temp_' + fileName);
      
      // Google Sheetsë¡œ ë³€í™˜ ì‹œë„
      let convertedFile;
      let spreadsheet;
      let sourceSheet;
      
      const fileId = tempFile.getId();
      
      try {
        // Drive APIë¥¼ í†µí•œ ë³€í™˜ ì‹œë„
        const resource = {
          title: fileName,
          mimeType: MimeType.GOOGLE_SHEETS,
          parents: [{id: CONFIG.FOLDER_ID}]
        };
        
        convertedFile = Drive.Files.copy(resource, fileId);
        console.log('Drive API ë³€í™˜ ì„±ê³µ');
        
        // ë³€í™˜ëœ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°
        spreadsheet = SpreadsheetApp.openById(convertedFile.id);
        sourceSheet = spreadsheet.getSheetByName('empty') || spreadsheet.getSheets()[0];
        
      } catch (driveConversionError) {
        console.log('Drive API ë³€í™˜ ì‹¤íŒ¨, ëŒ€ì•ˆ ë°©ë²• ì‹œë„:', driveConversionError.toString());
        
        try {
          // DriveAppì„ í†µí•œ ì§ì ‘ ë³€í™˜ ì‹œë„
          const importedFile = DriveApp.getFileById(fileId);
          
          // ìƒˆ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±
          const newSpreadsheet = SpreadsheetApp.create(fileName);
          convertedFile = { id: newSpreadsheet.getId() };
          
          console.log('ìƒˆ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„± í›„ ìˆ˜ë™ ì²˜ë¦¬ í•„ìš”');
          
          // í•œê¸€ Office íŒŒì¼ì˜ ê²½ìš° ìƒì„¸í•œ ì•ˆë‚´ ì œê³µ
          const isHancomFile = contentType.includes('haansoft') || contentType.includes('hancom');
          const fileTypeMsg = isHancomFile ? 'í•œê¸€ Office(í•œì…€)' : 'ì•Œ ìˆ˜ ì—†ëŠ” Excel';
          
          return {
            success: false,
            error: `${fileTypeMsg} íŒŒì¼ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nğŸ“„ íŒŒì¼: ${attachment.getName()}\nğŸ”§ í˜•ì‹: ${contentType}\n\nâœ… í•´ê²°ë°©ë²•:\n1. Gmailì—ì„œ ì²¨ë¶€íŒŒì¼ì„ ì§ì ‘ ë‹¤ìš´ë¡œë“œ\n2. Google Driveì— ì—…ë¡œë“œ\n3. Google Sheetsë¡œ ë³€í™˜í•´ì„œ ì—´ê¸°\n4. ë°ì´í„°ë¥¼ ë³µì‚¬í•´ì„œ '${fileName}' ì‹œíŠ¸ì— ë¶™ì—¬ë„£ê¸°\n\nğŸ’¡ íŒ: í•œì…€ íŒŒì¼ì€ Excel í˜•ì‹ìœ¼ë¡œ ë‹¤ì‹œ ì €ì¥ í›„ ì—…ë¡œë“œí•˜ì‹œë©´ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.`
          };
          
        } catch (manualError) {
          console.log('ëª¨ë“  ë³€í™˜ ë°©ë²• ì‹¤íŒ¨:', manualError.toString());
          
          return {
            success: false,
            error: `Excel íŒŒì¼ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼: ${attachment.getName()}\ní˜•ì‹: ${contentType}\nì˜¤ë¥˜: ${driveConversionError.toString()}`
          };
        }
      }
      
      // ì„ì‹œ íŒŒì¼ ì‚­ì œ
      try {
        DriveApp.getFileById(fileId).setTrashed(true);
        console.log('ì„ì‹œ íŒŒì¼ ì‚­ì œ ì™„ë£Œ');
      } catch (deleteError) {
        console.log('ì„ì‹œ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', deleteError.toString());
      }
      
      // í˜„ì¬ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ë³µì‚¬
      const currentSpreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      let targetSheet = currentSpreadsheet.getSheetByName(fileName);
      
      if (targetSheet) {
        currentSpreadsheet.deleteSheet(targetSheet);
      }
      
      targetSheet = currentSpreadsheet.insertSheet(fileName);
      const data = sourceSheet.getDataRange().getValues();
      
      if (data.length > 0) {
        targetSheet.getRange(1, 1, data.length, data[0].length).setValues(data);
      }
      
      // ë“œë¼ì´ë¸Œ í´ë” ì •ë¦¬
      this.moveToDateFolder(convertedFile.id, fullDate);
      
      return {
        success: true,
        sheetName: fileName,
        rowCount: data.length,
        date: fullDate
      };
      
    } catch (error) {
      return {
        success: false,
        error: 'Excel ë³€í™˜ ì‹¤íŒ¨: ' + error.toString()
      };
    }
  },
  
  /**
   * íŒŒì¼ì„ ë‚ ì§œ í´ë”ë¡œ ì´ë™
   */
  moveToDateFolder: function(fileId, dateString) {
    try {
      const file = DriveApp.getFileById(fileId);
      const parentFolderId = CONFIG.FOLDER_ID;
      const parentFolder = DriveApp.getFolderById(parentFolderId);
      
      // ë‚ ì§œ í´ë” ìƒì„± ë˜ëŠ” ê°€ì ¸ì˜¤ê¸°
      const folders = parentFolder.getFoldersByName(dateString);
      let dateFolder;
      
      if (folders.hasNext()) {
        dateFolder = folders.next();
      } else {
        dateFolder = parentFolder.createFolder(dateString);
      }
      
      // íŒŒì¼ ì´ë™
      dateFolder.addFile(file);
      
      // ì›ë˜ ìœ„ì¹˜ì—ì„œ ì œê±°
      const parents = file.getParents();
      while (parents.hasNext()) {
        const parent = parents.next();
        if (parent.getId() !== dateFolder.getId()) {
          parent.removeFile(file);
        }
      }
      
    } catch (error) {
      console.error('íŒŒì¼ ì´ë™ ì‹¤íŒ¨:', error);
    }
  },
  
  /**
   * Bì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë°ì´í„° ì²˜ë¦¬ìš©)
   */
  getSheetBData: function() {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // ê°€ëŠ¥í•œ ì‹œíŠ¸ ì´ë¦„ë“¤ ì°¾ê¸° (ë‚ ì§œ ì§€ì • ë˜ëŠ” ì˜¤ëŠ˜ ë‚ ì§œ)
    const sheets = spreadsheet.getSheets();
    let bSheet = null;
    
    // _ê°„í¸ì‹_EDIë¡œ ëë‚˜ëŠ” ê°€ì¥ ìµœê·¼ ì‹œíŠ¸ ì°¾ê¸°
    for (const sheet of sheets) {
      const name = sheet.getName();
      if (name.includes('_ê°„í¸ì‹_EDI') && !name.startsWith('TEST_') && !name.startsWith('ìƒ˜í”Œ_')) {
        bSheet = sheet;
        break;
      }
    }
    
    if (!bSheet) {
      // ì˜¤ëŠ˜ ë‚ ì§œ ì‹œíŠ¸ ì‹œë„
      const todayFull = getTodayDate();
      const sheetName = todayFull + '_ê°„í¸ì‹_EDI';
      bSheet = spreadsheet.getSheetByName(sheetName);
    }
    
    if (!bSheet) {
      throw new Error('Bì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € EDI ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.');
    }
    
    return bSheet.getDataRange().getValues();
  },
  
  /**
   * Bì‹œíŠ¸ ì—´ ì¸ë±ìŠ¤ ë§¤í•‘
   */
  getSheetBColumnMapping: function(headers) {
    const mapping = {};
    
    // í—¤ë”ì—ì„œ ì—´ ì°¾ê¸°
    headers.forEach((header, index) => {
      const cleanHeader = header.toString().toLowerCase().replace(/\s/g, '');
      
      if (cleanHeader.includes('ì£¼ë¬¸ë²ˆí˜¸') || cleanHeader.includes('orderno')) {
        mapping['ì£¼ë¬¸ë²ˆí˜¸'] = index;
      }
      if (cleanHeader.includes('ìƒí’ˆëª…') || cleanHeader.includes('product')) {
        mapping['ìƒí’ˆëª…'] = index;
      }
      if (cleanHeader.includes('ìˆ˜ëŸ‰') || cleanHeader.includes('qty') || cleanHeader.includes('quantity')) {
        mapping['ìˆ˜ëŸ‰'] = index;
      }
    });
    
    return mapping;
  }
};