<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <script src="https://apis.google.com/js/api.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; margin:0; padding:20px; background:#f8f9fa; }
    .container { background:#fff; border-radius:10px; padding:24px; box-shadow:0 1px 3px rgba(0,0,0,0.1); max-width:1060px; margin:0 auto; }
    h2 { margin:0 0 8px; font-size:20px; font-weight:600; color:#202124; }
    .subtitle { color:#5f6368; margin-bottom:14px; font-size:13px; }
    .selection { border:1px solid #e0e0e0; border-radius:10px; padding:16px; margin-bottom:14px; background:#fafbfc; }
    .title { font-size:14px; font-weight:600; color:#202124; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
    .current { border:1px solid #e0e0e0; border-radius:8px; background:#fff; padding:12px; min-height:18px; font-size:13px; margin-bottom:10px; color:#202124; }
    .current.empty { color:#9aa0a6; font-style:italic; }
    .btn { border:0; border-radius:8px; padding:9px 14px; font-size:13px; cursor:pointer; }
    .btn.pick { background:#1a73e8; color:#fff; } .btn.pick:hover { background:#1765d1; }
    .btn.text { background:transparent; color:#1a73e8; } .btn.text:hover { background:#f1f5ff; }
    .btn.primary { background:#1a73e8; color:#fff; padding:10px 18px; }
    .btn.primary:disabled { background:#eaecef; color:#9aa0a6; cursor:not-allowed; }
    .footer { display:flex; justify-content:flex-end; gap:8px; margin-top:18px; padding-top:12px; border-top:1px solid #eceff1; }
    .loading { display:none; color:#5f6368; text-align:center; padding:14px; }
    .loading.show { display:block; }
    .content { display:none; }
    
    /* 드라이브 탐색기 모달 */
    .explorer-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .explorer-dialog {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      height: 600px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }
    .explorer-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .explorer-title {
      font-size: 18px;
      font-weight: 600;
      color: #202124;
    }
    .explorer-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #5f6368;
      padding: 4px;
    }
    .explorer-body {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    .explorer-sidebar {
      width: 200px;
      border-right: 1px solid #e0e0e0;
      padding: 12px;
      overflow-y: auto;
      background: #f8f9fa;
    }
    .nav-section {
      margin-bottom: 16px;
    }
    .nav-item {
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #3c4043;
      margin-bottom: 4px;
    }
    .nav-item:hover {
      background: #e8eaed;
    }
    .nav-item.active {
      background: #d2e3fc;
      color: #1967d2;
    }
    .nav-icon {
      font-size: 16px;
    }
    .explorer-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .explorer-search {
      padding: 12px 16px;
      border-bottom: 1px solid #e0e0e0;
      background: #fff;
    }
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      font-size: 14px;
      background: #f8f9fa url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTExLjc0MiAxMC40MDJMOS4zNzMgOC4wMzNDOS45NDkgNy4yODEgMTAuMzEzIDYuMzE0IDEwLjMxMyA1LjI1QzEwLjMxMyAyLjkwMSA4LjQxMiAxIDYuMDYzIDFTMS44MTMgMi45MDEgMS44MTMgNS4yNVM0LjcxNCA5LjUgNi4wNjMgOS41QzUuOTk5IDkuNTAxIDUuOTM2IDkuNTAxIDUuODc0IDkuNDk5TDguMTU1IDExLjc4MUM4LjM0NCAxMS45NyA4LjY1NiAxMS45NyA4Ljg0NSAxMS43ODFDMTIuMDMxIDExLjk3IDEyLjAzMSAxMS42NTggMTEuODQyIDExLjQ2OVoiIGZpbGw9IiM1RjYzNjgiLz4KPC9zdmc+Cg==') no-repeat 12px center;
      background-size: 16px 16px;
      outline: none;
    }
    .search-input:focus {
      border-color: #1a73e8;
      background-color: #fff;
    }
    .explorer-breadcrumb {
      padding: 12px 16px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 13px;
      color: #5f6368;
      background: #fff;
    }
    .breadcrumb-item {
      color: #1a73e8;
      cursor: pointer;
      text-decoration: none;
    }
    .breadcrumb-item:hover {
      text-decoration: underline;
    }
    .explorer-content {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }
    .file-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }
    .file-item {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-item:hover {
      background: #f8f9fa;
      border-color: #dadce0;
    }
    .file-item.selectable:hover {
      background: #e8f0fe;
      border-color: #1a73e8;
    }
    .file-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    .file-icon .fa-file-excel {
      color: #107C41; /* Excel 초록색 */
    }
    .file-icon .fa-folder {
      color: #5f6368; /* 폴더 회색 */
    }
    .file-icon .fa-file {
      color: #9aa0a6; /* 일반 파일 회색 */
    }
    .file-name {
      font-size: 12px;
      color: #3c4043;
      word-break: break-word;
      line-height: 1.3;
    }
    .loading-text, .empty-text, .error-text {
      text-align: center;
      padding: 40px;
      color: #5f6368;
      font-size: 14px;
    }
    .error-text {
      color: #d93025;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>파일 및 폴더 선택</h2>
    <div class="subtitle">구글 드라이브에서 사용할 스프레드시트와 저장 폴더를 선택하세요.</div>

    <div id="loading" class="loading">설정을 불러오는 중...</div>

    <div id="content" class="content">
      <div class="selection">
        <div class="title"><i class="fa-solid fa-file-excel" style="color: #107C41;"></i> 스프레드시트</div>
        <div id="selectedSpreadsheet" class="current empty">선택된 파일이 없습니다</div>
        <button class="btn pick" onclick="openDriveExplorer('spreadsheet')">스프레드시트 선택</button>
      </div>

      <div class="selection">
        <div class="title">📁 저장 폴더</div>
        <div id="selectedFolder" class="current empty">선택된 폴더가 없습니다</div>
        <button class="btn pick" onclick="openDriveExplorer('folder')">폴더 선택</button>
      </div>

      <div class="footer">
        <button class="btn text" onclick="google.script.host.close()">취소</button>
        <button id="saveBtn" class="btn primary" onclick="saveSettings()" disabled>설정 저장</button>
      </div>
    </div>
  </div>

  <!-- 드라이브 탐색기 모달 -->
  <div id="explorerModal" class="explorer-modal">
    <div class="explorer-dialog">
      <div class="explorer-header">
        <div id="explorerTitle" class="explorer-title">파일 선택</div>
        <button class="explorer-close" onclick="closeDriveExplorer()">×</button>
      </div>
      <div class="explorer-body">
        <div id="explorerSidebar" class="explorer-sidebar">
          <div class="loading-text">로딩 중...</div>
        </div>
        <div class="explorer-main">
          <div class="explorer-search">
            <input type="text" id="searchInput" class="search-input" placeholder="파일 및 폴더 검색" onkeyup="handleSearch(event)">
          </div>
          <div id="explorerBreadcrumb" class="explorer-breadcrumb">
            내 드라이브
          </div>
          <div id="explorerContent" class="explorer-content">
            <div class="loading-text">로딩 중...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <?!= include('PickerClient'); ?>
</body>
</html>
