/**
 * Google Drive íƒìƒ‰ê¸° ê¸°ë°˜ íŒŒì¼/í´ë” ì„ íƒê¸°
 * íŒŒì¼ëª…: GooglePicker.gs
 */

function __init_setPickerConfigOnce() {
  const props = PropertiesService.getScriptProperties();
  // ì´ë¯¸ ì €ì¥í•´ë‘” ê°’ ì‚¬ìš©í•´ë„ ë©ë‹ˆë‹¤.
  props.setProperty('PICKER_API_KEY', 'AIzaSyBkzoaHZmYgrH9yOkr8dI3GXGM0RyxDABc');
  props.setProperty('GCP_PROJECT_NUMBER', '840962145115');
  SpreadsheetApp.getUi().alert('Picker ì„¤ì •ê°’ ì €ì¥ ì™„ë£Œ');
}

function openGooglePicker() {
  const html = HtmlService.createTemplateFromFile('PickerDialog').evaluate()
    .setWidth(1100)
    .setHeight(760)
    .setTitle('êµ¬ê¸€ ë“œë¼ì´ë¸Œ íŒŒì¼/í´ë” ì„ íƒ');
  SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ“ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì„¤ì •');
}

/** HTML include í—¬í¼ */
function include(name) {
  return HtmlService.createHtmlOutputFromFile(name).getContent();
}

/**
 * âœ… Drive ìŠ¤ì½”í”„ ê°•ì œ ì›Œë°ì—…
 * - getOAuthToken() í˜¸ì¶œ ì „ì— ë°˜ë“œì‹œ ì‹¤í–‰
 * - ìµœì†Œ ê¶Œí•œ ì ‘ê·¼ìœ¼ë¡œ ìŠ¤ì½”í”„ë§Œ íšë“ (ì‹¤ì œ íŒŒì¼ ì½ì§€ ì•ŠìŒ)
 */
function ensureDriveScope() {
  try {
    // root IDë§Œ í„°ì¹˜í•´ì„œ ê¶Œí•œ ìŠ¹ì¸ ìœ ë„
    DriveApp.getRootFolder().getId();
    return { ok: true };
  } catch (e) {
    return { ok: false, error: String(e) };
  }
}

function getOAuthToken() {
  try { return ScriptApp.getOAuthToken(); }
  catch (e) { console.error('OAuth í† í° ì˜¤ë¥˜:', e); return null; }
}

function getPickerApiKey() {
  return PropertiesService.getScriptProperties().getProperty('PICKER_API_KEY') || '';
}

function getPickerAppId() { // ì„ íƒ(ì—†ì–´ë„ ë™ì‘)
  return PropertiesService.getScriptProperties().getProperty('GCP_PROJECT_NUMBER') || '';
}

/** ë¹ ë¥¸ í‘œì‹œìš©(ê¶Œí•œ ë¶ˆí•„ìš”) */
function getCurrentPickerSettingsLite() {
  const p = PropertiesService.getScriptProperties();
  return {
    success: true,
    settings: {
      sourceSpreadsheetId: p.getProperty('SOURCE_SPREADSHEET_ID') || '',
      sourceSpreadsheetName: '',
      folderId: p.getProperty('FOLDER_ID') || '',
      folderName: ''
    }
  };
}

/** ë„¤íŠ¸ì›Œí¬/ì„¸ì…˜ í™•ì¸ìš© */
function pingServer() {
  return { ok: true, ts: new Date().toISOString() };
}

/** ì´ë¦„ í¬í•¨(Drive ê¶Œí•œ í•„ìš”, ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ) */
function getCurrentPickerSettings() {
  const p = PropertiesService.getScriptProperties();
  const ssId = p.getProperty('SOURCE_SPREADSHEET_ID') || '';
  const folderId = p.getProperty('FOLDER_ID') || '';
  return {
    success: true,
    settings: {
      sourceSpreadsheetId: ssId,
      sourceSpreadsheetName: getDisplayName(ssId),
      folderId: folderId,
      folderName: getDisplayName(folderId)
    }
  };
}

function getDisplayName(id) {
  if (!id) return '';
  try {
    try { return SpreadsheetApp.openById(id).getName(); }
    catch (e1) {
      try { return DriveApp.getFolderById(id).getName(); }
      catch (e2) {
        try { return DriveApp.getFileById(id).getName(); }
        catch (e3) { return '(ì ‘ê·¼ ë¶ˆê°€)'; }
      }
    }
  } catch (e) { return '(ì ‘ê·¼ ë¶ˆê°€)'; }
}

function savePickerSelection(selection) {
  try {
    const p = PropertiesService.getScriptProperties();
    if (selection?.spreadsheetId) p.setProperty('SOURCE_SPREADSHEET_ID', selection.spreadsheetId);
    if (selection?.folderId) p.setProperty('FOLDER_ID', selection.folderId);
    return { success: true, message: 'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' };
  } catch (err) {
    return { success: false, error: String(err) };
  }
}

/**
 * ë£¨íŠ¸ í´ë” ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ì¢Œì¸¡ ë‚´ë¹„ê²Œì´ì…˜ìš©)
 */
function getDriveRoots() {
  console.log('=== Function Start: getDriveRoots ===');
  
  try {
    const roots = [];
    
    // ë‚´ ë“œë¼ì´ë¸Œ
    console.log('Step 1: Adding My Drive');
    roots.push({
      id: 'root',
      name: 'ë‚´ ë“œë¼ì´ë¸Œ',
      type: 'my_drive',
      icon: 'ğŸ“'
    });
    
    // ê³µìœ  ë“œë¼ì´ë¸Œ ì¹´í…Œê³ ë¦¬ (ê°œë³„ ë“œë¼ì´ë¸Œê°€ ì•„ë‹Œ ì¹´í…Œê³ ë¦¬)
    console.log('Step 2: Adding Shared Drives category');
    roots.push({
      id: 'sharedDrives',
      name: 'ê³µìœ  ë“œë¼ì´ë¸Œ',
      type: 'shared_drives_category',
      icon: 'ğŸ“'
    });
    
    // ê³µìœ  ë¬¸ì„œí•¨
    console.log('Step 3: Adding shared with me');
    roots.push({
      id: 'sharedWithMe',
      name: 'ê³µìœ  ë¬¸ì„œí•¨',
      type: 'shared',
      icon: 'ğŸ‘¥'
    });
    
    // ìµœê·¼ í•­ëª©
    console.log('Step 4: Adding recent items');
    roots.push({
      id: 'recent',
      name: 'ìµœê·¼ í•­ëª©',
      type: 'recent',
      icon: 'ğŸ•'
    });
    
    console.log('Final roots array:', roots);
    console.log('=== Function End: getDriveRoots SUCCESS ===');
    return { success: true, roots };
    
  } catch (error) {
    console.error('ERROR in getDriveRoots:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Function End: getDriveRoots FAILED ===');
    return { success: false, error: error.toString() };
  }
}

/**
 * ê³µìœ  ë“œë¼ì´ë¸Œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ê³µìœ  ë“œë¼ì´ë¸Œ ì¹´í…Œê³ ë¦¬ í´ë¦­ ì‹œ)
 */
function getSharedDrivesList() {
  console.log('=== Function Start: getSharedDrivesList ===');
  
  try {
    const drives = [];
    
    console.log('Step 1: Fetching shared drives list');
    try {
      // Drive.Drives API ì‚¬ìš©
      const sharedDrives = Drive.Drives.list({ pageSize: 100 });
      console.log('Shared drives response:', sharedDrives);
      
      if (sharedDrives.drives && sharedDrives.drives.length > 0) {
        console.log(`Found ${sharedDrives.drives.length} shared drives`);
        sharedDrives.drives.forEach(drive => {
          drives.push({
            id: drive.id,
            name: drive.name,
            type: 'folder',  // í´ë”ì²˜ëŸ¼ ì·¨ê¸‰
            mimeType: 'application/vnd.google-apps.folder',
            icon: 'ğŸ“'
          });
        });
      } else {
        console.log('No shared drives found');
      }
    } catch (e) {
      console.error('Failed to fetch shared drives:', e);
      return { success: false, error: e.toString() };
    }
    
    console.log(`Returning ${drives.length} shared drives`);
    console.log('=== Function End: getSharedDrivesList SUCCESS ===');
    return { success: true, items: drives, folderId: 'sharedDrives' };
    
  } catch (error) {
    console.error('ERROR in getSharedDrivesList:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Function End: getSharedDrivesList FAILED ===');
    return { success: false, error: error.toString() };
  }
}

/**
 * íŒŒì¼ í™•ì¥ìì— ë”°ë¥¸ ì•„ì´ì½˜ ë°˜í™˜
 */
function getFileIcon(file) {
  const mimeType = file.mimeType;
  const fileName = file.name || '';
  const extension = fileName.split('.').pop().toLowerCase();
  
  // MIME íƒ€ì… ê¸°ë°˜ ì•„ì´ì½˜
  if (mimeType === 'application/vnd.google-apps.folder') {
    return 'ğŸ“';
  } else if (mimeType === 'application/vnd.google-apps.spreadsheet' || 
             extension === 'xls' || extension === 'xlsx' || extension === 'csv') {
    return '<i class="fa-solid fa-file-excel" style="color: #107C41;"></i>';
  } else if (mimeType === 'application/vnd.google-apps.document' || 
             extension === 'doc' || extension === 'docx') {
    return '<i class="fa-solid fa-file-word" style="color: #2B579A;"></i>';
  } else if (mimeType === 'application/vnd.google-apps.presentation' || 
             extension === 'ppt' || extension === 'pptx') {
    return '<i class="fa-solid fa-file-powerpoint" style="color: #B7472A;"></i>';
  } else if (extension === 'pdf') {
    return '<i class="fa-solid fa-file-pdf" style="color: #FF0000;"></i>';
  } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'].includes(extension)) {
    return '<i class="fa-solid fa-file-image" style="color: #4285F4;"></i>';
  } else if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'mkv'].includes(extension)) {
    return '<i class="fa-solid fa-file-video" style="color: #EA4335;"></i>';
  } else if (['mp3', 'wav', 'flac', 'aac', 'ogg'].includes(extension)) {
    return '<i class="fa-solid fa-file-audio" style="color: #FBBC04;"></i>';
  } else if (['zip', 'rar', '7z', 'tar', 'gz'].includes(extension)) {
    return '<i class="fa-solid fa-file-zipper" style="color: #34A853;"></i>';
  } else if (['txt', 'md', 'log'].includes(extension)) {
    return '<i class="fa-solid fa-file-lines" style="color: #5F6368;"></i>';
  } else if (['js', 'py', 'java', 'cpp', 'c', 'html', 'css', 'json', 'xml'].includes(extension)) {
    return '<i class="fa-solid fa-file-code" style="color: #673AB7;"></i>';
  } else {
    return '<i class="fa-solid fa-file" style="color: #9AA0A6;"></i>';
  }
}

/**
 * í´ë” ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
 */
function getDriveFolderContents(folderId, filterType = 'all', pageToken = null) {
  console.log('=== Function Start: getDriveFolderContents ===');
  console.log('Parameters:', { folderId, filterType, pageToken });
  
  try {
    const items = [];
    let query = '';
    
    console.log('Step 1: Building query for folder:', folderId);
    
    // ê¸°ë³¸ ì¿¼ë¦¬ ì„¤ì •
    if (folderId === 'root') {
      query = "'root' in parents and trashed = false";
    } else if (folderId === 'sharedWithMe') {
      query = "sharedWithMe and trashed = false";
    } else if (folderId === 'sharedDrives') {
      // ê³µìœ  ë“œë¼ì´ë¸Œ ëª©ë¡ì„ ë³„ë„ í•¨ìˆ˜ë¡œ ì²˜ë¦¬
      console.log('Special case: shared drives category');
      console.log('=== Function End: getDriveFolderContents SUCCESS (delegating to getSharedDrivesList) ===');
      return getSharedDrivesList();
    } else if (folderId === 'recent') {
      // ìµœê·¼ í•­ëª©: ìµœê·¼ 30ì¼ê°„ ìˆ˜ì •ëœ íŒŒì¼
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      const dateStr = thirtyDaysAgo.toISOString();
      query = `modifiedTime > '${dateStr}' and trashed = false`;
    } else {
      query = `'${folderId}' in parents and trashed = false`;
    }
    
    // íƒ€ì… í•„í„° ì¶”ê°€
    if (filterType === 'spreadsheet') {
      query += " and mimeType = 'application/vnd.google-apps.spreadsheet'";
    } else if (filterType === 'folder') {
      query += " and mimeType = 'application/vnd.google-apps.folder'";
    }
    
    console.log('Step 2: Executing query:', query);
    
    // íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° - Drive API v3 í˜•ì‹ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ
    const requestParams = {
      q: query,
      pageSize: 50, // í˜ì´ì§€ë‹¹ 50ê°œ
      orderBy: folderId === 'recent' ? 'modifiedTime desc' : 'folder,name',
      fields: 'nextPageToken,files(id,name,mimeType,parents,modifiedTime)', // nextPageToken ì¶”ê°€
      supportsAllDrives: true,
      includeItemsFromAllDrives: true
    };
    
    // í˜ì´ì§€ í† í°ì´ ìˆìœ¼ë©´ ì¶”ê°€
    if (pageToken) {
      requestParams.pageToken = pageToken;
    }
    
    console.log('Step 3: Making API request with params:', requestParams);
    const response = Drive.Files.list(requestParams);
    console.log('API response:', response);
    
    if (response.files && response.files.length > 0) {
      console.log(`Step 4: Processing ${response.files.length} items`);
      response.files.forEach(file => {
        const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
        const isSpreadsheet = file.mimeType === 'application/vnd.google-apps.spreadsheet';
        
        // í•„í„°ë§
        if (filterType === 'all' || 
            (filterType === 'spreadsheet' && isSpreadsheet) ||
            (filterType === 'folder' && isFolder)) {
          
          items.push({
            id: file.id,
            name: file.name,
            type: isFolder ? 'folder' : 'file',
            mimeType: file.mimeType,
            icon: getFileIcon(file), // ì•„ì´ì½˜ í•¨ìˆ˜ ì‚¬ìš©
            modifiedDate: file.modifiedTime
          });
        }
      });
    } else {
      console.log('Step 4: No items found');
    }
    
    console.log(`Step 5: Returning ${items.length} filtered items`);
    console.log('=== Function End: getDriveFolderContents SUCCESS ===');
    return { 
      success: true, 
      items, 
      folderId,
      nextPageToken: response.nextPageToken || null, // ë‹¤ìŒ í˜ì´ì§€ í† í°
      hasMore: !!response.nextPageToken // ë” ë§ì€ ê²°ê³¼ê°€ ìˆëŠ”ì§€
    };
    
  } catch (error) {
    console.error('ERROR in getDriveFolderContents:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Function End: getDriveFolderContents FAILED ===');
    return { success: false, error: error.toString() };
  }
}

/**
 * í´ë” ê²½ë¡œ ê°€ì ¸ì˜¤ê¸° (breadcrumbìš©)
 */
function getDrivePath(folderId) {
  console.log('=== Function Start: getDrivePath ===');
  console.log('Parameters:', { folderId });
  
  try {
    const path = [];
    let currentId = folderId;
    
    console.log('Step 1: Checking for special folder IDs');
    
    if (folderId === 'root') {
      console.log('Special case: root folder');
      console.log('=== Function End: getDrivePath SUCCESS ===');
      return { success: true, path: [{ id: 'root', name: 'ë‚´ ë“œë¼ì´ë¸Œ' }] };
    }
    
    if (folderId === 'sharedWithMe') {
      console.log('Special case: shared with me');
      console.log('=== Function End: getDrivePath SUCCESS ===');
      return { success: true, path: [{ id: 'sharedWithMe', name: 'ê³µìœ  ë¬¸ì„œí•¨' }] };
    }
    
    if (folderId === 'sharedDrives') {
      console.log('Special case: shared drives category');
      console.log('=== Function End: getDrivePath SUCCESS ===');
      return { success: true, path: [{ id: 'sharedDrives', name: 'ê³µìœ  ë“œë¼ì´ë¸Œ' }] };
    }
    
    if (folderId === 'recent') {
      console.log('Special case: recent items');
      console.log('=== Function End: getDrivePath SUCCESS ===');
      return { success: true, path: [{ id: 'recent', name: 'ìµœê·¼ í•­ëª©' }] };
    }
    
    console.log('Step 2: Building path for regular folder');
    
    // í´ë” ê²½ë¡œ ì¶”ì 
    while (currentId && currentId !== 'root') {
      try {
        console.log('Getting file info for ID:', currentId);
        const file = Drive.Files.get(currentId, { 
          supportsAllDrives: true, // v3ì—ì„œëŠ” supportsAllDrives ì‚¬ìš©
          fields: 'id,name,parents' // v3ì—ì„œëŠ” name ì‚¬ìš©
        });
        console.log('File info:', { id: file.id, name: file.name, parents: file.parents });
        
        path.unshift({ id: file.id, name: file.name }); // v3ì—ì„œëŠ” name ì‚¬ìš©
        
        if (file.parents && file.parents.length > 0) {
          currentId = file.parents[0].id;
          console.log('Moving to parent:', currentId);
        } else {
          console.log('No parent found, breaking');
          break;
        }
      } catch (e) {
        console.error('Error getting file info:', e);
        break;
      }
    }
    
    // ë£¨íŠ¸ ì¶”ê°€
    if (currentId === 'root') {
      console.log('Step 3: Adding root to path');
      path.unshift({ id: 'root', name: 'ë‚´ ë“œë¼ì´ë¸Œ' });
    }
    
    console.log('Final path:', path);
    console.log('=== Function End: getDrivePath SUCCESS ===');
    return { success: true, path };
    
  } catch (error) {
    console.error('ERROR in getDrivePath:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Function End: getDrivePath FAILED ===');
    return { success: false, error: error.toString() };
  }
}

/**
 * íŒŒì¼/í´ë” ê²€ìƒ‰ ê¸°ëŠ¥ (í˜„ì¬ í´ë” ì»¨í…ìŠ¤íŠ¸ ë‚´ì—ì„œ)
 */
function searchDriveFiles(query, filterType = 'all', currentFolderId = 'root', searchMode = 'recursive', pageToken = null) {
  console.log('=== Function Start: searchDriveFiles ===');
  console.log('Parameters:', { query, filterType, currentFolderId, searchMode });
  
  try {
    if (!query || query.trim() === '') {
      console.log('Empty query, returning empty results');
      console.log('=== Function End: searchDriveFiles SUCCESS (empty) ===');
      return { success: true, items: [], query: '' };
    }
    
    const items = [];
    let searchQuery = `name contains '${query.trim()}' and trashed = false`;
    
    // í˜„ì¬ í´ë” ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€
    console.log('Step 1: Adding folder context to search');
    if (currentFolderId === 'root') {
      // rootì—ì„œ ê²€ìƒ‰í•  ë•ŒëŠ” parents ì¡°ê±´ ì—†ì´ ì „ì²´ ê²€ìƒ‰ (ë‚´ ë“œë¼ì´ë¸Œ ì „ì²´)
      // searchQueryëŠ” ì´ë¯¸ name containsì™€ trashed = falseë§Œ í¬í•¨
    } else if (currentFolderId === 'sharedWithMe') {
      searchQuery += " and sharedWithMe";
    } else if (currentFolderId === 'recent') {
      // ìµœê·¼ í•­ëª©ì€ ì „ì—­ ê²€ìƒ‰ì´ì§€ë§Œ ë‚ ì§œ ì œí•œ ì¶”ê°€
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      const dateStr = thirtyDaysAgo.toISOString();
      searchQuery += ` and modifiedTime > '${dateStr}'`;
    } else if (currentFolderId !== 'sharedDrives' && currentFolderId !== 'recent') {
      // íŠ¹ì • í´ë” ë‚´ ê²€ìƒ‰ - searchModeì— ë”°ë¼ ì¬ê·€/ë¹„ì¬ê·€ ê²°ì •
      if (searchMode === 'current') {
        searchQuery += ` and '${currentFolderId}' in parents`;
      }
      // recursive ëª¨ë“œì¼ ë•ŒëŠ” parents ì¡°ê±´ ì—†ì´ ì „ì²´ ê²€ìƒ‰ (ì•„ë˜ì—ì„œ í•„í„°ë§)
    }
    // ê³µìœ  ë“œë¼ì´ë¸Œ ì¹´í…Œê³ ë¦¬ì˜ ê²½ìš° ë³„ë„ ì²˜ë¦¬
    
    // íƒ€ì… í•„í„° ì¶”ê°€
    if (filterType === 'spreadsheet') {
      searchQuery += " and mimeType = 'application/vnd.google-apps.spreadsheet'";
    } else if (filterType === 'folder') {
      searchQuery += " and mimeType = 'application/vnd.google-apps.folder'";
    }
    
    console.log('Step 2: Final search query:', searchQuery);
    
    // ê³µìœ  ë“œë¼ì´ë¸Œ ì¹´í…Œê³ ë¦¬ì˜ ê²½ìš° ë³„ë„ ì²˜ë¦¬
    if (currentFolderId === 'sharedDrives') {
      console.log('Step 3: Special handling for shared drives category search');
      // ëª¨ë“  ê³µìœ  ë“œë¼ì´ë¸Œì™€ ê·¸ í•˜ìœ„ íŒŒì¼ë“¤ì—ì„œ ê²€ìƒ‰
      try {
        const drives = Drive.Drives.list({ pageSize: 100 });
        if (drives.drives && drives.drives.length > 0) {
          // 1. ë¨¼ì € ë“œë¼ì´ë¸Œ ì´ë¦„ì´ ë§¤ì¹­ë˜ëŠ”ì§€ í™•ì¸
          for (const drive of drives.drives) {
            if (drive.name.toLowerCase().includes(query.toLowerCase())) {
              items.push({
                id: drive.id,
                name: drive.name,
                type: 'folder',
                mimeType: 'application/vnd.google-apps.folder',
                icon: 'ğŸ“',
                modifiedDate: null,
                isSharedDrive: true
              });
            }
          }
          
          // 2. ê° ê³µìœ  ë“œë¼ì´ë¸Œ ë‚´ë¶€ì˜ ëª¨ë“  íŒŒì¼/í´ë”ì—ì„œ ê²€ìƒ‰
          console.log('Searching within all shared drives...');
          for (const drive of drives.drives) {
            try {
              const driveSearchQuery = `name contains '${query.trim()}' and trashed = false`;
              const driveSearchParams = {
                q: driveSearchQuery,
                pageSize: 20, // ê° ë“œë¼ì´ë¸Œë‹¹ ìµœëŒ€ 20ê°œ
                orderBy: 'name',
                fields: 'files(id,name,mimeType,parents,modifiedTime)',
                supportsAllDrives: true,
                includeItemsFromAllDrives: true,
                driveId: drive.id,
                corpora: 'drive'
              };
              
              // íƒ€ì… í•„í„° ì ìš©
              if (filterType === 'spreadsheet') {
                driveSearchParams.q += " and mimeType = 'application/vnd.google-apps.spreadsheet'";
              } else if (filterType === 'folder') {
                driveSearchParams.q += " and mimeType = 'application/vnd.google-apps.folder'";
              }
              
              const driveFiles = Drive.Files.list(driveSearchParams);
              if (driveFiles.files && driveFiles.files.length > 0) {
                driveFiles.files.forEach(file => {
                  const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
                  const isSpreadsheet = file.mimeType === 'application/vnd.google-apps.spreadsheet';
                  
                  items.push({
                    id: file.id,
                    name: `${file.name} (${drive.name})`, // ë“œë¼ì´ë¸Œ ì´ë¦„ í‘œì‹œ
                    type: isFolder ? 'folder' : 'file',
                    mimeType: file.mimeType,
                    icon: getFileIcon(file), // ì•„ì´ì½˜ í•¨ìˆ˜ ì‚¬ìš©
                    modifiedDate: file.modifiedTime,
                    parentDrive: drive.name
                  });
                });
              }
            } catch (e) {
              console.log(`Failed to search in drive ${drive.name}:`, e);
            }
          }
        }
      } catch (e) {
        console.error('Failed to search shared drives:', e);
      }
      
      console.log(`Step 4: Found ${items.length} total results across all shared drives`);
      console.log('=== Function End: searchDriveFiles SUCCESS (shared drives) ===');
      return { success: true, items, query: query.trim(), searchContext: 'sharedDrives' };
    }
    
    // ê°œë³„ ê³µìœ  ë“œë¼ì´ë¸Œ ë‚´ë¶€ ê²€ìƒ‰ ì²˜ë¦¬
    console.log('Step 3: Checking if current folder is in a shared drive');
    let sharedDriveId = null;
    try {
      if (currentFolderId !== 'root' && currentFolderId !== 'sharedWithMe' && currentFolderId !== 'recent') {
        // ë¨¼ì € í˜„ì¬ í´ë”ê°€ ì§ì ‘ ê³µìœ  ë“œë¼ì´ë¸Œì¸ì§€ í™•ì¸
        const drives = Drive.Drives.list({ pageSize: 100 });
        if (drives.drives) {
          const directDrive = drives.drives.find(drive => drive.id === currentFolderId);
          if (directDrive) {
            sharedDriveId = currentFolderId;
          } else {
            // í˜„ì¬ í´ë”ê°€ ê³µìœ  ë“œë¼ì´ë¸Œì˜ í•˜ìœ„ í´ë”ì¸ì§€ í™•ì¸
            const fileInfo = Drive.Files.get(currentFolderId, { 
              supportsAllDrives: true,
              fields: 'driveId'
            });
            if (fileInfo.driveId) {
              sharedDriveId = fileInfo.driveId;
            }
          }
        }
      }
    } catch (e) {
      console.log('Could not check shared drives:', e);
    }
    
    if (sharedDriveId) {
      console.log('Step 4: Searching within entire shared drive:', sharedDriveId);
      // ê³µìœ  ë“œë¼ì´ë¸Œ ì „ì²´ì—ì„œ ê²€ìƒ‰ (parents ì¡°ê±´ ì œê±°)
      searchQuery = `name contains '${query.trim()}' and trashed = false`;
    }
    
    // ì¼ë°˜ ê²€ìƒ‰ ì‹¤í–‰
    const requestParams = {
      q: searchQuery,
      pageSize: 50, // ê²€ìƒ‰ ê²°ê³¼ëŠ” 50ê°œë¡œ ì œí•œ
      orderBy: 'name', // ì´ë¦„ìˆœ ì •ë ¬
      fields: 'files(id,name,mimeType,parents,modifiedTime)',
      supportsAllDrives: true,
      includeItemsFromAllDrives: true
    };
    
    // ê³µìœ  ë“œë¼ì´ë¸Œ ë‚´ë¶€ ê²€ìƒ‰ì˜ ê²½ìš° driveId ì§€ì •
    if (sharedDriveId) {
      requestParams.driveId = sharedDriveId;
      requestParams.corpora = 'drive';
    }
    
    const files = Drive.Files.list(requestParams);
    console.log('Search API response:', files);
    
    if (files.files && files.files.length > 0) {
      console.log(`Step 2: Processing ${files.files.length} search results`);
      files.files.forEach(file => {
        const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
        const isSpreadsheet = file.mimeType === 'application/vnd.google-apps.spreadsheet';
        
        // í•„í„°ë§
        if (filterType === 'all' || 
            (filterType === 'spreadsheet' && isSpreadsheet) ||
            (filterType === 'folder' && isFolder)) {
          
          items.push({
            id: file.id,
            name: file.name,
            type: isFolder ? 'folder' : 'file',
            mimeType: file.mimeType,
            icon: isFolder ? 'ğŸ“' : (isSpreadsheet ? '<i class="fa-solid fa-file-excel"></i>' : 'ğŸ“„'),
            modifiedDate: file.modifiedTime
          });
        }
      });
    } else {
      console.log('Step 2: No search results found');
    }
    
    console.log(`Step 5: Returning ${items.length} filtered search results`);
    console.log('=== Function End: searchDriveFiles SUCCESS ===');
    return { success: true, items, query: query.trim(), searchContext: currentFolderId };
    
  } catch (error) {
    console.error('ERROR in searchDriveFiles:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Function End: searchDriveFiles FAILED ===');
    return { success: false, error: error.toString() };
  }
}

/**
 * ìƒˆ í´ë” ë§Œë“¤ê¸° - Drive API v3 ì‚¬ìš©
 */
function createNewFolder(parentFolderId, folderName) {
  console.log('=== Function Start: createNewFolder ===');
  console.log('Parameters:', { parentFolderId, folderName });
  
  try {
    if (!folderName || folderName.trim() === '') {
      console.log('Empty folder name');
      console.log('=== Function End: createNewFolder FAILED ===');
      return { success: false, error: 'í´ë” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' };
    }
    
    // íŠ¹ìˆ˜ ìœ„ì¹˜ ì²´í¬
    if (parentFolderId === 'sharedWithMe' || parentFolderId === 'recent') {
      console.log('Cannot create folder in special location');
      console.log('=== Function End: createNewFolder FAILED ===');
      return { success: false, error: 'ì´ ìœ„ì¹˜ì—ëŠ” í´ë”ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' };
    }
    
    if (parentFolderId === 'sharedDrives') {
      console.log('Cannot create folder at shared drives root');
      console.log('=== Function End: createNewFolder FAILED ===');
      return { success: false, error: 'ê³µìœ  ë“œë¼ì´ë¸Œ ë£¨íŠ¸ì—ëŠ” í´ë”ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŠ¹ì • ê³µìœ  ë“œë¼ì´ë¸Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.' };
    }
    
    console.log('Step 1: Preparing folder metadata for Drive API v3');
    
    // Drive API v3 ë©”íƒ€ë°ì´í„°
    const folderMetadata = {
      name: folderName.trim(),  // v3ì—ì„œëŠ” 'name' ì‚¬ìš© (v2ì˜ 'title' ëŒ€ì‹ )
      mimeType: 'application/vnd.google-apps.folder',
      parents: [parentFolderId === 'root' ? 'root' : parentFolderId]
    };
    
    console.log('Step 2: Folder metadata:', folderMetadata);
    
    // ê³µìœ  ë“œë¼ì´ë¸Œ ì²´í¬
    let supportsAllDrives = false;
    if (parentFolderId !== 'root') {
      try {
        console.log('Step 3: Checking if parent is in shared drive');
        
        // ë¶€ëª¨ê°€ ê³µìœ  ë“œë¼ì´ë¸Œì¸ì§€ í™•ì¸
        try {
          const drives = Drive.Drives.list({ pageSize: 100 });
          if (drives.drives && drives.drives.some(drive => drive.id === parentFolderId)) {
            console.log('Parent is a shared drive');
            supportsAllDrives = true;
          } else {
            // ë¶€ëª¨ í´ë”ê°€ ê³µìœ  ë“œë¼ì´ë¸Œ ë‚´ë¶€ì¸ì§€ í™•ì¸
            try {
              const parentInfo = Drive.Files.get(parentFolderId, {
                supportsAllDrives: true,
                fields: 'driveId'
              });
              if (parentInfo.driveId) {
                console.log('Parent is in shared drive:', parentInfo.driveId);
                supportsAllDrives = true;
              }
            } catch (e) {
              console.log('Parent is not in shared drive');
            }
          }
        } catch (e) {
          console.log('Could not check shared drive status:', e);
        }
      } catch (e) {
        console.log('Shared drive check skipped:', e);
      }
    }
    
    console.log('Step 4: Creating folder with Drive API v3');
    console.log('SupportsAllDrives:', supportsAllDrives);
    
    // Drive API v3ë¡œ í´ë” ìƒì„±
    const createdFolder = Drive.Files.create(
      folderMetadata,
      null,  // media (í´ë”ì´ë¯€ë¡œ null)
      {
        supportsAllDrives: supportsAllDrives,
        fields: 'id,name,mimeType,parents'  // v3ì—ì„œëŠ” 'name' ì‚¬ìš©
      }
    );
    
    console.log('Step 5: Folder created successfully:', createdFolder);
    
    const result = {
      success: true,
      folder: {
        id: createdFolder.id,
        name: createdFolder.name,  // v3ì—ì„œëŠ” 'name' ì‚¬ìš©
        type: 'folder',
        mimeType: createdFolder.mimeType,
        icon: 'ğŸ“',
        isNew: true
      }
    };
    
    console.log('=== Function End: createNewFolder SUCCESS ===');
    return result;
    
  } catch (error) {
    console.error('ERROR in createNewFolder:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Function End: createNewFolder FAILED ===');
    
    // ë” ì¹œìˆ™í•œ ì—ëŸ¬ ë©”ì‹œì§€
    let errorMessage = error.toString();
    if (errorMessage.includes('Insufficient permissions')) {
      errorMessage = 'ì´ ìœ„ì¹˜ì— í´ë”ë¥¼ ë§Œë“¤ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
    } else if (errorMessage.includes('File not found')) {
      errorMessage = 'ì„ íƒí•œ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    }
    
    return { success: false, error: errorMessage };
  }
}

/**
 * í…ŒìŠ¤íŠ¸ìš© - í´ë” ìƒì„± í…ŒìŠ¤íŠ¸
 */
function testCreateFolder() {
  try {
    console.log('=== í´ë” ìƒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
    
    // 1. ë‚´ ë“œë¼ì´ë¸Œ ë£¨íŠ¸ì— í…ŒìŠ¤íŠ¸ í´ë” ìƒì„±
    const testResult = createNewFolder('root', 'TEST_FOLDER_' + new Date().getTime());
    console.log('í…ŒìŠ¤íŠ¸ ê²°ê³¼:', testResult);
    
    if (testResult.success) {
      console.log('âœ… í´ë” ìƒì„± ì„±ê³µ:', testResult.folder);
      
      // ìƒì„±ëœ í´ë” ì‚­ì œ
      try {
        Drive.Files.remove(testResult.folder.id);
        console.log('âœ… í…ŒìŠ¤íŠ¸ í´ë” ì‚­ì œ ì™„ë£Œ');
      } catch (e) {
        console.log('í´ë” ì‚­ì œ ì‹¤íŒ¨:', e);
      }
    } else {
      console.log('âŒ í´ë” ìƒì„± ì‹¤íŒ¨:', testResult.error);
    }
    
    console.log('=== í´ë” ìƒì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
    return testResult;
    
  } catch (error) {
    console.error('í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
    return { success: false, error: error.toString() };
  }
}

/**
 * ë””ë²„ê·¸ìš© - ê³µìœ  ë“œë¼ì´ë¸Œ ëª©ë¡ í™•ì¸
 */
function testSharedDrives() {
  try {
    console.log('=== ê³µìœ  ë“œë¼ì´ë¸Œ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
    
    // ë°©ë²• 1: Drive.Drives.list (v3)
    try {
      const drives = Drive.Drives.list({ pageSize: 100 });
      console.log('Drive.Drives.list ê²°ê³¼:', drives);
    } catch (e) {
      console.log('Drive.Drives.list ì‹¤íŒ¨:', e);
    }
    
    // ë°©ë²• 2: Drive.Teamdrives.list (v2)
    try {
      const teamDrives = Drive.Teamdrives.list({ pageSize: 100 });
      console.log('Drive.Teamdrives.list ê²°ê³¼:', teamDrives);
    } catch (e) {
      console.log('Drive.Teamdrives.list ì‹¤íŒ¨:', e);
    }
    
    // ë°©ë²• 3: UrlFetch ì§ì ‘ í˜¸ì¶œ
    try {
      const url = 'https://www.googleapis.com/drive/v2/teamdrives';
      const response = UrlFetchApp.fetch(url, {
        headers: {
          'Authorization': 'Bearer ' + ScriptApp.getOAuthToken()
        }
      });
      console.log('UrlFetch ê²°ê³¼:', response.getContentText());
    } catch (e) {
      console.log('UrlFetch ì‹¤íŒ¨:', e);
    }
    
    console.log('=== ê³µìœ  ë“œë¼ì´ë¸Œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
  } catch (error) {
    console.log('ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
  }
}
