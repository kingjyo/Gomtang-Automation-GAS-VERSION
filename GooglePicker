/**
 * Google Picker ê¸°ë°˜ íŒŒì¼/í´ë” ì„ íƒê¸° (ì¢Œì¸¡ ë‚´ë¹„ê²Œì´ì…˜ ì§€ì›)
 * íŒŒì¼ëª…: GooglePicker.gs
 */

function __init_setPickerConfigOnce() {
  const props = PropertiesService.getScriptProperties();
  // ì´ë¯¸ ì €ì¥í•´ë‘” ê°’ ì‚¬ìš©í•´ë„ ë©ë‹ˆë‹¤.
  props.setProperty('PICKER_API_KEY', 'YOUR_PICKER_API_KEY');
  props.setProperty('GCP_PROJECT_NUMBER', 'YOUR_GCP_PROJECT_NUMBER');
  SpreadsheetApp.getUi().alert('Picker ì„¤ì •ê°’ ì €ì¥ ì™„ë£Œ');
}

function openGooglePicker() {
  const html = HtmlService.createTemplateFromFile('PickerDialog').evaluate()
    .setWidth(1100)
    .setHeight(760)
    .setTitle('êµ¬ê¸€ ë“œë¼ì´ë¸Œ íŒŒì¼/í´ë” ì„ íƒ');
  SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ“ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì„¤ì •');
}

/** HTML include í—¬í¼ */
function include(name) {
  return HtmlService.createHtmlOutputFromFile(name).getContent();
}

/**
 * âœ… Drive ìŠ¤ì½”í”„ ê°•ì œ ì›Œë°ì—…
 * - getOAuthToken() í˜¸ì¶œ ì „ì— ë°˜ë“œì‹œ ì‹¤í–‰
 * - ìµœì†Œ ê¶Œí•œ ì ‘ê·¼ìœ¼ë¡œ ìŠ¤ì½”í”„ë§Œ íšë“ (ì‹¤ì œ íŒŒì¼ ì½ì§€ ì•ŠìŒ)
 */
function ensureDriveScope() {
  try {
    // root IDë§Œ í„°ì¹˜í•´ì„œ ê¶Œí•œ ìŠ¹ì¸ ìœ ë„
    DriveApp.getRootFolder().getId();
    return { ok: true };
  } catch (e) {
    return { ok: false, error: String(e) };
  }
}

function getOAuthToken() {
  try { return ScriptApp.getOAuthToken(); }
  catch (e) { console.error('OAuth í† í° ì˜¤ë¥˜:', e); return null; }
}

function getPickerApiKey() {
  return PropertiesService.getScriptProperties().getProperty('PICKER_API_KEY') || '';
}

function getPickerAppId() { // ì„ íƒ(ì—†ì–´ë„ ë™ì‘)
  return PropertiesService.getScriptProperties().getProperty('GCP_PROJECT_NUMBER') || '';
}

/** ë¹ ë¥¸ í‘œì‹œìš©(ê¶Œí•œ ë¶ˆí•„ìš”) */
function getCurrentPickerSettingsLite() {
  const p = PropertiesService.getScriptProperties();
  return {
    success: true,
    settings: {
      sourceSpreadsheetId: p.getProperty('SOURCE_SPREADSHEET_ID') || '',
      sourceSpreadsheetName: '',
      folderId: p.getProperty('FOLDER_ID') || '',
      folderName: ''
    }
  };
}

/** ë„¤íŠ¸ì›Œí¬/ì„¸ì…˜ í™•ì¸ìš© */
function pingServer() {
  return { ok: true, ts: new Date().toISOString() };
}

/** ì´ë¦„ í¬í•¨(Drive ê¶Œí•œ í•„ìš”, ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ) */
function getCurrentPickerSettings() {
  const p = PropertiesService.getScriptProperties();
  const ssId = p.getProperty('SOURCE_SPREADSHEET_ID') || '';
  const folderId = p.getProperty('FOLDER_ID') || '';
  return {
    success: true,
    settings: {
      sourceSpreadsheetId: ssId,
      sourceSpreadsheetName: getDisplayName(ssId),
      folderId: folderId,
      folderName: getDisplayName(folderId)
    }
  };
}

function getDisplayName(id) {
  if (!id) return '';
  try {
    try { return SpreadsheetApp.openById(id).getName(); }
    catch (e1) {
      try { return DriveApp.getFolderById(id).getName(); }
      catch (e2) {
        try { return DriveApp.getFileById(id).getName(); }
        catch (e3) { return '(ì ‘ê·¼ ë¶ˆê°€)'; }
      }
    }
  } catch (e) { return '(ì ‘ê·¼ ë¶ˆê°€)'; }
}

function savePickerSelection(selection) {
  try {
    const p = PropertiesService.getScriptProperties();
    if (selection?.spreadsheetId) p.setProperty('SOURCE_SPREADSHEET_ID', selection.spreadsheetId);
    if (selection?.folderId) p.setProperty('FOLDER_ID', selection.folderId);
    return { success: true, message: 'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' };
  } catch (err) {
    return { success: false, error: String(err) };
  }
}
