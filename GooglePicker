/**
 * Google Picker ê¸°ë°˜ íŒŒì¼/í´ë” ì„ íƒê¸° (í° ì°½/í•œê¸€/UI ì•ˆì „ë¶€íŒ…)
 * íŒŒì¼ëª…: GooglePicker.gs
 */

function __init_setPickerConfigOnce() {
  const props = PropertiesService.getScriptProperties();
  // â†“ ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ "ì „ì²´" í‚¤ ê·¸ëŒ€ë¡œ ë„£ìœ¼ì„¸ìš” (â€¦ ì“°ì§€ ë§ê¸°)
  props.setProperty('PICKER_API_KEY', 'AIzaSyBkzoaHZmYgrH9yOkr8dI3GXGM0RyxDABc');
  props.setProperty('GCP_PROJECT_NUMBER', '840962145115');
  SpreadsheetApp.getUi().alert('Picker ì„¤ì •ê°’ ì €ì¥ ì™„ë£Œ');
}

function openGooglePicker() {
  const html = HtmlService.createTemplateFromFile('PickerDialog').evaluate()
    .setWidth(1100)   // ëª¨ë‹¬ ìì²´ë¥¼ í¬ê²Œ
    .setHeight(760)
    .setTitle('êµ¬ê¸€ ë“œë¼ì´ë¸Œ íŒŒì¼/í´ë” ì„ íƒ');
  SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ“ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì„¤ì •');
}

/** HTML include í—¬í¼ (í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©) */
function include(name) {
  return HtmlService.createHtmlOutputFromFile(name).getContent();
}

/** ì¼ë¶€ ë„ë©”ì¸ì—ì„œ Drive root ì ‘ê·¼ 500 íšŒí”¼ â†’ no-op */
function ensureDriveScope() { return true; }

function getOAuthToken() {
  try { return ScriptApp.getOAuthToken(); }
  catch (e) { console.error('OAuth í† í° ì˜¤ë¥˜:', e); return null; }
}

function getPickerApiKey() {
  return PropertiesService.getScriptProperties().getProperty('PICKER_API_KEY') || '';
}

function getPickerAppId() { // ì„ íƒ
  return PropertiesService.getScriptProperties().getProperty('GCP_PROJECT_NUMBER') || '';
}

/** ë¹ ë¥¸ í‘œì‹œìš©(ê¶Œí•œ ë¶ˆí•„ìš”) */
function getCurrentPickerSettingsLite() {
  const p = PropertiesService.getScriptProperties();
  return {
    success: true,
    settings: {
      sourceSpreadsheetId: p.getProperty('SOURCE_SPREADSHEET_ID') || '',
      sourceSpreadsheetName: '',
      folderId: p.getProperty('FOLDER_ID') || '',
      folderName: ''
    }
  };
}

/** ë„¤íŠ¸ì›Œí¬/ì„¸ì…˜ í™•ì¸ìš© */
function pingServer() {
  return { ok: true, ts: new Date().toISOString() };
}

/** ì´ë¦„ í¬í•¨(ê¶Œí•œ í•„ìš”) */
function getCurrentPickerSettings() {
  const p = PropertiesService.getScriptProperties();
  const ssId = p.getProperty('SOURCE_SPREADSHEET_ID') || '';
  const folderId = p.getProperty('FOLDER_ID') || '';
  return {
    success: true,
    settings: {
      sourceSpreadsheetId: ssId,
      sourceSpreadsheetName: getDisplayName(ssId),
      folderId: folderId,
      folderName: getDisplayName(folderId)
    }
  };
}

function getDisplayName(id) {
  if (!id) return '';
  try {
    try { return SpreadsheetApp.openById(id).getName(); }
    catch (e1) {
      try { return DriveApp.getFolderById(id).getName(); }
      catch (e2) {
        try { return DriveApp.getFileById(id).getName(); }
        catch (e3) { return '(ì ‘ê·¼ ë¶ˆê°€)'; }
      }
    }
  } catch (e) { return '(ì ‘ê·¼ ë¶ˆê°€)'; }
}

function savePickerSelection(selection) {
  try {
    const p = PropertiesService.getScriptProperties();
    if (selection?.spreadsheetId) p.setProperty('SOURCE_SPREADSHEET_ID', selection.spreadsheetId);
    if (selection?.folderId) p.setProperty('FOLDER_ID', selection.folderId);
    return { success: true, message: 'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' };
  } catch (err) {
    return { success: false, error: String(err) };
  }
}
