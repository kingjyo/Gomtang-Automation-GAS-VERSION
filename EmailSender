/**
 * ì´ë©”ì¼ ì „ìš© ì „ì†¡ê¸°
 * EmailSender.gs
 */

const EmailSender = {
  /**
   * ì—‘ì…€ íŒŒì¼ì—ì„œ ì¶œê³  ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ê³  ì´ë©”ì¼ ì „ì†¡
   */
  processExcelAndSendEmail: function(fileData, fileName, targetDate) {
    console.log('=== ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ì¶œê³  ë°ì´í„° ì²˜ë¦¬ ë° ì´ë©”ì¼ ì „ì†¡ ì‹œì‘ ===');
    console.log('Parameters:', { fileName, targetDate });
    
    try {
      // ì„¤ì • ì´ˆê¸°í™”
      initializeConfig();
      
      // ë‚ ì§œ ì²˜ë¦¬
      let dateString;
      if (targetDate) {
        if (targetDate.length === 4) {
          // MMDD í˜•ì‹ì„ YYYYMMDDë¡œ ë³€í™˜
          const currentYear = new Date().getFullYear();
          const month = targetDate.substring(0, 2);
          const day = targetDate.substring(2, 4);
          dateString = currentYear + month + day;
        } else {
          // YYYYMMDD í˜•ì‹
          dateString = targetDate.replace(/\//g, '').replace(/-/g, '');
        }
      } else {
        dateString = getTodayDate();
      }
      
      console.log('Target date:', dateString);
      
      // í˜„ì¬ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ì§ì ‘ ë°ì´í„° ì½ê¸°
      const currentSpreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      console.log('Current spreadsheet sheets:', currentSpreadsheet.getSheets().map(s => s.getName()));
      
      // ì¶œê³  ë°ì´í„° ìˆ˜ì§‘ (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë‚´ë¶€ ì‹œíŠ¸ë“¤ì—ì„œ)
      const shipmentData = this.extractShipmentDataFromSpreadsheet(currentSpreadsheet, dateString);
      
      if (!shipmentData.success) {
        return shipmentData;
      }
      
      // ì´ë©”ì¼ ìˆ˜ì‹ ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      const recipientsResult = ProductDownloader.getEmailRecipients();
      if (!recipientsResult.success) {
        return recipientsResult;
      }
      
      if (recipientsResult.recipients.length === 0) {
        return {
          success: false,
          error: 'ì „ì†¡ ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë©”ì¼_ì„¤ì • ì‹œíŠ¸ì—ì„œ ì „ì†¡ì—¬ë¶€ë¥¼ ì²´í¬í•´ì£¼ì„¸ìš”.'
        };
      }
      
      // ì´ë©”ì¼ ë‚´ìš© ìƒì„± (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë°ì´í„° ê¸°ë°˜)
      const emailContent = ProductDownloader.generateEmailContent(shipmentData.data, dateString);
      
      // ì²¨ë¶€í•  ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬
      let attachmentBlob;
      if (fileData && fileName) {
        // ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ì—‘ì…€ íŒŒì¼ ì‚¬ìš©
        attachmentBlob = Utilities.newBlob(
          Utilities.base64Decode(fileData), 
          'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
          fileName
        );
        console.log(`âœ… ì²¨ë¶€íŒŒì¼ë¡œ ì‚¬ìš©ì ì—…ë¡œë“œ íŒŒì¼ ì‚¬ìš©: ${fileName}`);
      } else {
        // íŒŒì¼ì´ ì—†ìœ¼ë©´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥ íŒŒì¼ ì°¾ê¸°
        const downloadResult = ProductDownloader.downloadProductSheets(targetDate);
        if (downloadResult.success && downloadResult.downloadInfo) {
          const fileId = downloadResult.downloadInfo.fileId;
          const file = DriveApp.getFileById(fileId);
          attachmentBlob = file.getBlob();
          console.log(`âœ… ì²¨ë¶€íŒŒì¼ë¡œ ìƒì„±ëœ ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥ ì‚¬ìš©: ${downloadResult.downloadInfo.fileName}`);
        } else {
          console.log('âŒ ì²¨ë¶€í•  ì—‘ì…€ íŒŒì¼ì´ ì—†ê³  ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥ë„ ìƒì„±í•  ìˆ˜ ì—†ìŒ');
          return {
            success: false,
            error: 'ì²¨ë¶€í•  ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ í’ˆëª©ë³„ ì‹œíŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.'
          };
        }
      }
      
      // ì´ë©”ì¼ ì „ì†¡
      const subject = `${dateString.substring(4,6)}.${dateString.substring(6,8)} ê°„í¸ì‹ ì¶œê³ ìš”ì²­`;
      const recipients = recipientsResult.recipients.map(r => r.email).join(',');
      
      GmailApp.sendEmail(
        recipients,
        subject,
        emailContent,
        {
          attachments: [attachmentBlob],
          name: 'í•œêµ­ê³µí•­ ê¹€ì˜ì¤€'
        }
      );
      
      console.log('=== ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ ===');
      
      // ì²¨ë¶€íŒŒì¼ëª… ê²°ì •
      const attachmentFileName = (fileData && fileName) ? fileName : this.generateEmailFileName(dateString);
      
      return {
        success: true,
        message: `ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\në°›ëŠ” ì‚¬ëŒ: ${recipientsResult.recipients.length}ëª…\níŒŒì¼ëª…: ${attachmentFileName}`,
        recipientCount: recipientsResult.recipients.length,
        recipients: recipientsResult.recipients,
        shipmentSummary: shipmentData.data,
        fileName: attachmentFileName
      };
      
    } catch (error) {
      console.error('ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ë° ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: 'ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.toString()
      };
    }
  },

  /**
   * ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ì¶œê³  ë°ì´í„° ì¶”ì¶œ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ + ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸)
   */
  extractShipmentDataFromSpreadsheet: function(spreadsheet, dateString) {
    console.log(`=== ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ì¶œê³  ë°ì´í„° ì¶”ì¶œ: ${dateString} ===`);
    
    // ë¡œê·¸ ì‹œíŠ¸ì— ê¸°ë¡í•  ìƒì„¸ ë¡œê·¸
    const logEntries = [];
    logEntries.push(`[${new Date().toLocaleString()}] ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë°ì´í„° ì¶”ì¶œ ì‹œì‘ - ëŒ€ìƒ ë‚ ì§œ: ${dateString}`);
    
    try {
      const shipmentData = {
        'ì‚¬ê³¨ê³ ê¸°ê³°íƒ•5ê°œì…': { cybersky: 0, coupang: 0, total: 0 },
        'ì‚¬ê³¨ê³°íƒ•5ê°œì…': { cybersky: 0, coupang: 0, total: 0 },
        'ì‚¬ê³¨ê³°íƒ•20ê°œì…': { cybersky: 0, coupang: 0, total: 0 },
        'ì‚¬ê³¨ê³°íƒ•10ê°œì…': { cybersky: 0, coupang: 0, total: 0 },
        'ìœ¡í¬5ê°œì…': { cybersky: 0, coupang: 0, total: 0 }
      };
      
      // 1. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì½ê¸°
      const cyberskySheetName = `${dateString}_ê°„í¸ì‹_ì‹¸ì´ë²„ìŠ¤ì¹´ì´`;
      const cyberskySheet = spreadsheet.getSheetByName(cyberskySheetName);
      
      console.log(`ğŸ” ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ ì°¾ê¸°: ${cyberskySheetName}`);
      logEntries.push(`ğŸ” ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ ì°¾ê¸°: ${cyberskySheetName}`);
      
      if (!cyberskySheet) {
        const errorMsg = `âŒ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${cyberskySheetName}`;
        console.log(errorMsg);
        logEntries.push(errorMsg);
        
        this.saveEmailProcessLog(logEntries, 'Spreadsheet Data Extraction - ERROR');
        return {
          success: false,
          error: `ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${cyberskySheetName}`
        };
      }
      
      console.log(`âœ… ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ ë°œê²¬: ${cyberskySheet.getName()}`);
      logEntries.push(`âœ… ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ ë°œê²¬: ${cyberskySheet.getName()}`);
      
      // ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì²˜ë¦¬
      const cyberskyResult = this.processCyberskySheet(cyberskySheet, shipmentData, logEntries);
      
      // 2. EDI ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì½ê¸° (ìˆëŠ” ê²½ìš°)
      const ediSheetName = `${dateString}_ê°„í¸ì‹_EDI`;
      const ediSheet = spreadsheet.getSheetByName(ediSheetName);
      
      console.log(`ğŸ” EDI ì‹œíŠ¸ ì°¾ê¸°: ${ediSheetName}`);
      logEntries.push(`ğŸ” EDI ì‹œíŠ¸ ì°¾ê¸°: ${ediSheetName}`);
      
      if (ediSheet) {
        console.log(`âœ… EDI ì‹œíŠ¸ ë°œê²¬: ${ediSheet.getName()}`);
        logEntries.push(`âœ… EDI ì‹œíŠ¸ ë°œê²¬: ${ediSheet.getName()}`);
        
        // EDI ì‹œíŠ¸ ì²˜ë¦¬
        const ediResult = this.processEDISheet(ediSheet, shipmentData, logEntries);
      } else {
        console.log(`âš ï¸ EDI ì‹œíŠ¸ ì—†ìŒ - EDI ë°ì´í„° ê±´ë„ˆë›°ê¸°`);
        logEntries.push(`âš ï¸ EDI ì‹œíŠ¸ ì—†ìŒ - EDI ë°ì´í„° ê±´ë„ˆë›°ê¸°`);
      }

      // 3. ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì½ê¸° (ìˆëŠ” ê²½ìš°)
      const manualSheetName = `${dateString}_ê°„í¸ì‹_ìˆ˜ê¸°ì†¡ì¥`;
      const manualSheet = spreadsheet.getSheetByName(manualSheetName);
      
      console.log(`ğŸ” ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ ì°¾ê¸°: ${manualSheetName}`);
      logEntries.push(`ğŸ” ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ ì°¾ê¸°: ${manualSheetName}`);
      
      if (manualSheet) {
        console.log(`âœ… ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ ë°œê²¬: ${manualSheet.getName()}`);
        logEntries.push(`âœ… ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ ë°œê²¬: ${manualSheet.getName()}`);
        
        // ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ ì²˜ë¦¬
        const manualResult = this.processManualSheet(manualSheet, shipmentData, logEntries);
      } else {
        console.log(`âš ï¸ ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ ì—†ìŒ - ìˆ˜ê¸°ì†¡ì¥ ë°ì´í„° ê±´ë„ˆë›°ê¸°`);
        logEntries.push(`âš ï¸ ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ ì—†ìŒ - ìˆ˜ê¸°ì†¡ì¥ ë°ì´í„° ê±´ë„ˆë›°ê¸°`);
      }

      // 4. ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì—ì„œ ì¿ íŒ¡ ë°ì´í„° ì½ê¸° (ìˆëŠ” ê²½ìš°)
      const verificationSheetName = `${dateString}_ê²€ì‚°ê²°ê³¼`;
      const verificationSheet = spreadsheet.getSheetByName(verificationSheetName);
      
      console.log(`ğŸ” ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì°¾ê¸°: ${verificationSheetName}`);
      logEntries.push(`ğŸ” ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì°¾ê¸°: ${verificationSheetName}`);
      
      if (verificationSheet) {
        console.log(`âœ… ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ë°œê²¬: ${verificationSheet.getName()}`);
        logEntries.push(`âœ… ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ë°œê²¬: ${verificationSheet.getName()}`);
        
        // ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì—ì„œ ì¿ íŒ¡ ë°ì´í„° ì½ê¸°
        const coupangResult = this.processCoupangDataFromVerification(verificationSheet, shipmentData, logEntries);
      } else {
        console.log(`âš ï¸ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì—†ìŒ - ì¿ íŒ¡ ë°ì´í„° ê±´ë„ˆë›°ê¸°`);
        logEntries.push(`âš ï¸ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì—†ìŒ - ì¿ íŒ¡ ë°ì´í„° ê±´ë„ˆë›°ê¸°`);
      }
      
      // ìµœì¢… ê²°ê³¼ ë¡œê¹…
      console.log('ğŸ“Š ìµœì¢… ì¶œê³  ë°ì´í„°:');
      logEntries.push('ğŸ“Š ìµœì¢… ì¶œê³  ë°ì´í„°:');
      
      let totalQuantity = 0;
      for (const [product, data] of Object.entries(shipmentData)) {
        if (data.total > 0) {
          const summary = `  ${product}: ì´ ${data.total}ê°œ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´: ${data.cybersky}, ì¿ íŒ¡: ${data.coupang})`;
          console.log(summary);
          logEntries.push(summary);
          totalQuantity += data.total;
        }
      }
      
      if (totalQuantity === 0) {
        console.log('  âŒ ì¶œê³ í•  ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤!');
        logEntries.push('  âŒ ì¶œê³ í•  ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤!');
      } else {
        console.log(`âœ… ì´ ì¶œê³ ëŸ‰: ${totalQuantity}ê°œ`);
        logEntries.push(`âœ… ì´ ì¶œê³ ëŸ‰: ${totalQuantity}ê°œ`);
      }
      
      // ë¡œê·¸ ì‹œíŠ¸ì— ì €ì¥
      try {
        this.saveEmailProcessLog(logEntries, 'Spreadsheet Data Extraction');
        console.log('ğŸ“ ìƒì„¸ ë¡œê·¸ê°€ ì´ë©”ì¼_ë¡œê·¸ ì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (logError) {
        console.error('ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', logError);
      }
      
      return {
        success: true,
        data: shipmentData,
        totalQuantity: totalQuantity,
        logs: logEntries
      };
      
    } catch (error) {
      console.error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì¶œê³  ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨:', error);
      logEntries.push(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.toString()}`);
      
      // ì˜¤ë¥˜ ë¡œê·¸ë„ ì €ì¥
      try {
        this.saveEmailProcessLog(logEntries, 'Spreadsheet Data Extraction - ERROR');
      } catch (logError) {
        console.error('ì˜¤ë¥˜ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', logError);
      }
      
      return {
        success: false,
        error: error.toString(),
        logs: logEntries
      };
    }
  },

  /**
   * ì—‘ì…€ íŒŒì¼ì—ì„œ ì¶œê³  ë°ì´í„° ì¶”ì¶œ (ê¸°ì¡´ í•¨ìˆ˜ - ì°¸ê³ ìš© ìœ ì§€)
   */
  extractShipmentDataFromExcel: function(sourceSpreadsheet, dateString) {
    console.log(`=== ì—‘ì…€ íŒŒì¼ì—ì„œ ì¶œê³  ë°ì´í„° ì¶”ì¶œ: ${dateString} ===`);
    
    // ë¡œê·¸ ì‹œíŠ¸ì— ê¸°ë¡í•  ìƒì„¸ ë¡œê·¸
    const logEntries = [];
    logEntries.push(`[${new Date().toLocaleString()}] ì—‘ì…€ ë°ì´í„° ì¶”ì¶œ ì‹œì‘ - ëŒ€ìƒ ë‚ ì§œ: ${dateString}`);
    
    try {
      const shipmentData = {
        'ì‚¬ê³¨ê³ ê¸°ê³°íƒ•5ê°œì…': { cybersky: 0, coupang: 0, total: 0 },
        'ì‚¬ê³¨ê³°íƒ•5ê°œì…': { cybersky: 0, coupang: 0, total: 0 },
        'ì‚¬ê³¨ê³°íƒ•20ê°œì…': { cybersky: 0, coupang: 0, total: 0 },
        'ì‚¬ê³¨ê³°íƒ•10ê°œì…': { cybersky: 0, coupang: 0, total: 0 },
        'ìœ¡í¬5ê°œì…': { cybersky: 0, coupang: 0, total: 0 }
      };
      
      const sheets = sourceSpreadsheet.getSheets();
      let processedRows = 0;
      
      console.log(`ğŸ“Š ì´ ${sheets.length}ê°œ ì‹œíŠ¸ ë°œê²¬`);
      logEntries.push(`ğŸ“Š ì´ ${sheets.length}ê°œ ì‹œíŠ¸ ë°œê²¬: ${sheets.map(s => s.getName()).join(', ')}`);
      
      // ëª¨ë“  ì‹œíŠ¸ë¥¼ ê²€ì‚¬í•´ì„œ ë°ì´í„° ì¶”ì¶œ
      for (const sheet of sheets) {
        const sheetName = sheet.getName();
        console.log(`ğŸ“‹ Processing sheet: ${sheetName}`);
        logEntries.push(`ğŸ“‹ ì‹œíŠ¸ ì²˜ë¦¬ ì¤‘: ${sheetName}`);
        
        const data = sheet.getDataRange().getValues();
        console.log(`  â””â”€ ì‹œíŠ¸ í¬ê¸°: ${data.length} í–‰ x ${data[0] ? data[0].length : 0} ì—´`);
        logEntries.push(`  â””â”€ ì‹œíŠ¸ í¬ê¸°: ${data.length} í–‰ x ${data[0] ? data[0].length : 0} ì—´`);
        
        if (data.length <= 1) {
          console.log(`  â””â”€ âš ï¸ ë°ì´í„° ì—†ìŒ (í—¤ë”ë§Œ ìˆê±°ë‚˜ ë¹ˆ ì‹œíŠ¸)`);
          logEntries.push(`  â””â”€ âš ï¸ ë°ì´í„° ì—†ìŒ (í—¤ë”ë§Œ ìˆê±°ë‚˜ ë¹ˆ ì‹œíŠ¸)`);
          continue;
        }
        
        // í—¤ë” í–‰ì—ì„œ í•„ìš”í•œ ì—´ ì¸ë±ìŠ¤ ì°¾ê¸°
        const headers = data[0];
        let productColIndex = -1;
        let quantityColIndex = -1;
        let memoColIndex = -1;
        
        console.log(`  â””â”€ í—¤ë” ë¶„ì„: ${headers.slice(0, 10).map((h, i) => `${i}:${h}`).join(', ')}...`);
        logEntries.push(`  â””â”€ í—¤ë” ë¶„ì„: ${headers.slice(0, 20).map((h, i) => `${i}:${h}`).join(', ')}`);
        
        // í—¤ë”ì—ì„œ ì—´ ì°¾ê¸°
        for (let i = 0; i < headers.length; i++) {
          const header = String(headers[i]).toUpperCase();
          if (header.includes('PROD_NAME') || header.includes('ìƒí’ˆëª…') || header.includes('ì œí’ˆëª…')) {
            productColIndex = i;
            console.log(`  â””â”€ âœ… ìƒí’ˆëª… ì—´ ë°œê²¬: ${i}ì—´ (${headers[i]})`);
            logEntries.push(`  â””â”€ âœ… ìƒí’ˆëª… ì—´ ë°œê²¬: ${i}ì—´ (${headers[i]})`);
          }
          if (header.includes('ORDERCNT') || header.includes('ìˆ˜ëŸ‰') || header.includes('ê°œìˆ˜')) {
            quantityColIndex = i;
            console.log(`  â””â”€ âœ… ìˆ˜ëŸ‰ ì—´ ë°œê²¬: ${i}ì—´ (${headers[i]})`);
            logEntries.push(`  â””â”€ âœ… ìˆ˜ëŸ‰ ì—´ ë°œê²¬: ${i}ì—´ (${headers[i]})`);
          }
          if (header.includes('ë©”ëª¨') || header.includes('MEMO')) {
            memoColIndex = i;
            console.log(`  â””â”€ âœ… ë©”ëª¨ ì—´ ë°œê²¬: ${i}ì—´ (${headers[i]})`);
            logEntries.push(`  â””â”€ âœ… ë©”ëª¨ ì—´ ë°œê²¬: ${i}ì—´ (${headers[i]})`);
          }
        }
        
        // ê¸°ë³¸ê°’ ì„¤ì • (í—¤ë”ë¥¼ ëª» ì°¾ì€ ê²½ìš°)
        if (productColIndex === -1) {
          productColIndex = 15; // Pì—´ (0-based index)
          console.log(`  â””â”€ âš ï¸ ìƒí’ˆëª… ì—´ì„ ì°¾ì§€ ëª»í•´ ê¸°ë³¸ê°’ ì‚¬ìš©: Pì—´(${productColIndex})`);
          logEntries.push(`  â””â”€ âš ï¸ ìƒí’ˆëª… ì—´ì„ ì°¾ì§€ ëª»í•´ ê¸°ë³¸ê°’ ì‚¬ìš©: Pì—´(${productColIndex})`);
        }
        if (quantityColIndex === -1) {
          quantityColIndex = 2; // Cì—´
          console.log(`  â””â”€ âš ï¸ ìˆ˜ëŸ‰ ì—´ì„ ì°¾ì§€ ëª»í•´ ê¸°ë³¸ê°’ ì‚¬ìš©: Cì—´(${quantityColIndex})`);
          logEntries.push(`  â””â”€ âš ï¸ ìˆ˜ëŸ‰ ì—´ì„ ì°¾ì§€ ëª»í•´ ê¸°ë³¸ê°’ ì‚¬ìš©: Cì—´(${quantityColIndex})`);
        }
        if (memoColIndex === -1) {
          memoColIndex = 18; // Sì—´
          console.log(`  â””â”€ âš ï¸ ë©”ëª¨ ì—´ì„ ì°¾ì§€ ëª»í•´ ê¸°ë³¸ê°’ ì‚¬ìš©: Sì—´(${memoColIndex})`);
          logEntries.push(`  â””â”€ âš ï¸ ë©”ëª¨ ì—´ì„ ì°¾ì§€ ëª»í•´ ê¸°ë³¸ê°’ ì‚¬ìš©: Sì—´(${memoColIndex})`);
        }
        
        console.log(`  â””â”€ ğŸ“ ìµœì¢… ì—´ ì¸ë±ìŠ¤ - ìƒí’ˆëª…: ${productColIndex}, ìˆ˜ëŸ‰: ${quantityColIndex}, ë©”ëª¨: ${memoColIndex}`);
        logEntries.push(`  â””â”€ ğŸ“ ìµœì¢… ì—´ ì¸ë±ìŠ¤ - ìƒí’ˆëª…: ${productColIndex}, ìˆ˜ëŸ‰: ${quantityColIndex}, ë©”ëª¨: ${memoColIndex}`);
        
        // í—¤ë” í–‰ ì œì™¸í•˜ê³  ì²˜ë¦¬
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          
          // ë°ì´í„°ê°€ ìˆëŠ” í–‰ì¸ì§€ í™•ì¸
          if (!row || row.length <= Math.max(productColIndex, quantityColIndex)) continue;
          
          const productName = String(row[productColIndex] || '');
          const quantity = parseInt(row[quantityColIndex] || 0);
          const memo = memoColIndex >= 0 ? String(row[memoColIndex] || '') : '';
          
          if (quantity > 0 && productName) {
            // console.log(`    ğŸ” í–‰ ${i}: "${productName}" / ìˆ˜ëŸ‰=${quantity} / ë©”ëª¨="${memo}"`);
            // logEntries.push(`    ğŸ” í–‰ ${i}: "${productName}" / ìˆ˜ëŸ‰=${quantity} / ë©”ëª¨="${memo}"`);
            
            // ì œí’ˆëª… ì •ê·œí™” - ë” ìœ ì—°í•œ ë§¤ì¹­
            let normalizedProduct = '';
            
            // ì‚¬ê³¨ê³ ê¸°ê³°íƒ• ì²´í¬ (5íŒ© ë˜ëŠ” 5ê°œì…) - ë°˜ë“œì‹œ "ê³ ê¸°"ê°€ í¬í•¨ë˜ì–´ì•¼ í•¨
            if (productName.includes('ì‚¬ê³¨ê³ ê¸°ê³°íƒ•')) {
              normalizedProduct = 'ì‚¬ê³¨ê³ ê¸°ê³°íƒ•5ê°œì…';
              console.log(`    âœ… ë§¤ì¹­: ${productName} â†’ ${normalizedProduct}`);
              logEntries.push(`    âœ… ë§¤ì¹­: ${productName} â†’ ${normalizedProduct}`);
            }
            // ì‚¬ê³¨ê³°íƒ• 20ê°œì… ì²´í¬
            else if (productName.includes('ì‚¬ê³¨ê³°íƒ•') && (productName.includes('20íŒ©') || productName.includes('20ê°œì…'))) {
              normalizedProduct = 'ì‚¬ê³¨ê³°íƒ•20ê°œì…';
              console.log(`    âœ… ë§¤ì¹­: ${productName} â†’ ${normalizedProduct}`);
              logEntries.push(`    âœ… ë§¤ì¹­: ${productName} â†’ ${normalizedProduct}`);
            }
            // ì‚¬ê³¨ê³°íƒ• 10ê°œì… ì²´í¬
            else if (productName.includes('ì‚¬ê³¨ê³°íƒ•') && (productName.includes('10íŒ©') || productName.includes('10ê°œì…'))) {
              normalizedProduct = 'ì‚¬ê³¨ê³°íƒ•10ê°œì…';
              console.log(`    âœ… ë§¤ì¹­: ${productName} â†’ ${normalizedProduct}`);
              logEntries.push(`    âœ… ë§¤ì¹­: ${productName} â†’ ${normalizedProduct}`);
            }
            // ì‚¬ê³¨ê³°íƒ• 5ê°œì… ì²´í¬ (ì‚¬ê³¨ê³ ê¸°ê³°íƒ•ì´ ì•„ë‹Œ ê²½ìš°)
            else if (productName.includes('ì‚¬ê³¨ê³°íƒ•') && !productName.includes('ì‚¬ê³¨ê³ ê¸°ê³°íƒ•') && 
                    (productName.includes('5íŒ©') || productName.includes('5ê°œì…') || productName.includes('1ë°•ìŠ¤'))) {
              normalizedProduct = 'ì‚¬ê³¨ê³°íƒ•5ê°œì…';
              console.log(`    âœ… ë§¤ì¹­: ${productName} â†’ ${normalizedProduct}`);
              logEntries.push(`    âœ… ë§¤ì¹­: ${productName} â†’ ${normalizedProduct}`);
            }
            // ìœ¡í¬ ì²´í¬
            else if (productName.includes('ìœ¡í¬')) {
              normalizedProduct = 'ìœ¡í¬5ê°œì…';
              console.log(`    âœ… ë§¤ì¹­: ${productName} â†’ ${normalizedProduct}`);
              logEntries.push(`    âœ… ë§¤ì¹­: ${productName} â†’ ${normalizedProduct}`);
            }
            
            if (normalizedProduct && shipmentData[normalizedProduct]) {
              const category = memo.trim() === 'ì¿ íŒ¡' ? 'coupang' : 'cybersky';
              shipmentData[normalizedProduct][category] += quantity;
              shipmentData[normalizedProduct].total += quantity;
              processedRows++;
              // console.log(`    â• ì¶”ê°€: ${normalizedProduct} +${quantity} (${category}) â†’ ì´ê³„: ${shipmentData[normalizedProduct].total}`);
              // logEntries.push(`    â• ì¶”ê°€: ${normalizedProduct} +${quantity} (${category}) â†’ ì´ê³„: ${shipmentData[normalizedProduct].total}`);
            } else {
              console.log(`    âŒ ë§¤ì¹­ ì‹¤íŒ¨: "${productName}"`);
              logEntries.push(`    âŒ ë§¤ì¹­ ì‹¤íŒ¨: "${productName}"`);
            }
          } else if (productName) {
            // console.log(`    âš ï¸ ê±´ë„ˆëœ€ í–‰ ${i}: "${productName}" (ìˆ˜ëŸ‰=${quantity})"`);
            // logEntries.push(`    âš ï¸ ê±´ë„ˆëœ€ í–‰ ${i}: "${productName}" (ìˆ˜ëŸ‰=${quantity})"`);
          }
        }
      }
      
      // ìµœì¢… ê²°ê³¼ ë¡œê¹…
      console.log('ğŸ“Š ìµœì¢… ì¶œê³  ë°ì´í„°:');
      logEntries.push('ğŸ“Š ìµœì¢… ì¶œê³  ë°ì´í„°:');
      
      let totalQuantity = 0;
      for (const [product, data] of Object.entries(shipmentData)) {
        if (data.total > 0) {
          const summary = `  ${product}: ì´ ${data.total}ê°œ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´: ${data.cybersky}, ì¿ íŒ¡: ${data.coupang})`;
          console.log(summary);
          logEntries.push(summary);
          totalQuantity += data.total;
        }
      }
      
      if (totalQuantity === 0) {
        console.log('  âŒ ì¶œê³ í•  ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤!');
        logEntries.push('  âŒ ì¶œê³ í•  ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤!');
      } else {
        console.log(`âœ… ì´ ì¶œê³ ëŸ‰: ${totalQuantity}ê°œ, ì²˜ë¦¬ëœ í–‰ ìˆ˜: ${processedRows}`);
        logEntries.push(`âœ… ì´ ì¶œê³ ëŸ‰: ${totalQuantity}ê°œ, ì²˜ë¦¬ëœ í–‰ ìˆ˜: ${processedRows}`);
      }
      
      // ë¡œê·¸ ì‹œíŠ¸ì— ì €ì¥
      try {
        this.saveEmailProcessLog(logEntries, 'Excel Data Extraction');
        console.log('ğŸ“ ìƒì„¸ ë¡œê·¸ê°€ ì´ë©”ì¼_ë¡œê·¸ ì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (logError) {
        console.error('ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', logError);
      }
      
      return {
        success: true,
        data: shipmentData,
        processedRows: processedRows,
        totalQuantity: totalQuantity,
        logs: logEntries
      };
      
    } catch (error) {
      console.error('ì—‘ì…€ ì¶œê³  ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨:', error);
      logEntries.push(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.toString()}`);
      
      // ì˜¤ë¥˜ ë¡œê·¸ë„ ì €ì¥
      try {
        this.saveEmailProcessLog(logEntries, 'Excel Data Extraction - ERROR');
      } catch (logError) {
        console.error('ì˜¤ë¥˜ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', logError);
      }
      
      return {
        success: false,
        error: error.toString(),
        logs: logEntries
      };
    }
  },

  /**
   * ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ ì²˜ë¦¬
   */
  processCyberskySheet: function(cyberskySheet, shipmentData, logEntries) {
    console.log('ğŸ“‹ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
    logEntries.push('ğŸ“‹ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
    
    const data = cyberskySheet.getDataRange().getValues();
    console.log(`  â””â”€ ì‹œíŠ¸ í¬ê¸°: ${data.length} í–‰ x ${data[0] ? data[0].length : 0} ì—´`);
    logEntries.push(`  â””â”€ ì‹œíŠ¸ í¬ê¸°: ${data.length} í–‰ x ${data[0] ? data[0].length : 0} ì—´`);
    
    if (data.length <= 1) {
      console.log(`  â””â”€ âš ï¸ ë°ì´í„° ì—†ìŒ`);
      logEntries.push(`  â””â”€ âš ï¸ ë°ì´í„° ì—†ìŒ`);
      return;
    }
    
    // ê³ ì • ì—´ ì¸ë±ìŠ¤ ì‚¬ìš© (ì‚¬ìš©ì ëª…ì„¸ì— ë”°ë¼)
    const productColIndex = 15; // Pì—´: PROD_NAME (0-based index)
    const quantityColIndex = 19; // Tì—´: ORDERCNT (0-based index)
    
    const headers = data[0];
    console.log(`  â””â”€ ğŸ“ ê³ ì • ì—´ ì‚¬ìš© - Pì—´(${productColIndex}): ${headers[productColIndex]}, Tì—´(${quantityColIndex}): ${headers[quantityColIndex]}`);
    logEntries.push(`  â””â”€ ğŸ“ ê³ ì • ì—´ ì‚¬ìš© - Pì—´(${productColIndex}): ${headers[productColIndex]}, Tì—´(${quantityColIndex}): ${headers[quantityColIndex]}`);
    
    let processedRows = 0;
    
    // ë°ì´í„° í–‰ ì²˜ë¦¬
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const productName = String(row[productColIndex] || '');
      const quantity = parseInt(row[quantityColIndex] || 0);
      
      if (quantity > 0 && productName) {
        // console.log(`    ğŸ” í–‰ ${i}: "${productName}" / ìˆ˜ëŸ‰=${quantity}`);
        // logEntries.push(`    ğŸ” í–‰ ${i}: "${productName}" / ìˆ˜ëŸ‰=${quantity}`);
        
        const normalizedProduct = this.normalizeProductName(productName);
        
        if (normalizedProduct && shipmentData[normalizedProduct]) {
          shipmentData[normalizedProduct].cybersky += quantity;
          shipmentData[normalizedProduct].total += quantity;
          processedRows++;
          // console.log(`    â• ì¶”ê°€: ${normalizedProduct} +${quantity} (ì‹¸ì´ë²„ìŠ¤ì¹´ì´) â†’ ì´ê³„: ${shipmentData[normalizedProduct].total}`);
          // logEntries.push(`    â• ì¶”ê°€: ${normalizedProduct} +${quantity} (ì‹¸ì´ë²„ìŠ¤ì¹´ì´) â†’ ì´ê³„: ${shipmentData[normalizedProduct].total}`);
        } else {
          console.log(`    âŒ ë§¤ì¹­ ì‹¤íŒ¨: "${productName}"`);
          logEntries.push(`    âŒ ë§¤ì¹­ ì‹¤íŒ¨: "${productName}"`);
        }
      }
    }
    
    const productSummary = Object.keys(shipmentData).map(key => 
      `${key}: ${shipmentData[key].cybersky}ê°œ`
    ).join(', ');
    console.log(`âœ… ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì²˜ë¦¬ ì™„ë£Œ: ${processedRows}ê°œ í–‰ ì²˜ë¦¬ (${productSummary})`);
    logEntries.push(`âœ… ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì²˜ë¦¬ ì™„ë£Œ: ${processedRows}ê°œ í–‰ ì²˜ë¦¬ (${productSummary})`);
    
    return processedRows;
  },

  /**
   * EDI ì‹œíŠ¸ ì²˜ë¦¬
   */
  processEDISheet: function(ediSheet, shipmentData, logEntries) {
    console.log('ğŸ“‹ EDI ì‹œíŠ¸ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
    logEntries.push('ğŸ“‹ EDI ì‹œíŠ¸ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
    
    const data = ediSheet.getDataRange().getValues();
    console.log(`  â””â”€ ì‹œíŠ¸ í¬ê¸°: ${data.length} í–‰ x ${data[0] ? data[0].length : 0} ì—´`);
    logEntries.push(`  â””â”€ ì‹œíŠ¸ í¬ê¸°: ${data.length} í–‰ x ${data[0] ? data[0].length : 0} ì—´`);
    
    if (data.length <= 1) {
      console.log(`  â””â”€ âš ï¸ ë°ì´í„° ì—†ìŒ`);
      logEntries.push(`  â””â”€ âš ï¸ ë°ì´í„° ì—†ìŒ`);
      return;
    }
    
    // ê³ ì • ì—´ ì¸ë±ìŠ¤ ì‚¬ìš© (ì‚¬ìš©ì ëª…ì„¸ì— ë”°ë¼)
    const productColIndex = 15; // Pì—´: ìƒí’ˆëª… (|ë¡œ ë¶„ë¦¬ëœ ê²½ìš° ì²« ë¶€ë¶„) (0-based index)
    const quantityColIndex = 16; // Qì—´: ìˆ˜ëŸ‰ (0-based index)
    
    const headers = data[0];
    console.log(`  â””â”€ ğŸ“ ê³ ì • ì—´ ì‚¬ìš© - Pì—´(${productColIndex}): ${headers[productColIndex]}, Qì—´(${quantityColIndex}): ${headers[quantityColIndex]}`);
    logEntries.push(`  â””â”€ ğŸ“ ê³ ì • ì—´ ì‚¬ìš© - Pì—´(${productColIndex}): ${headers[productColIndex]}, Qì—´(${quantityColIndex}): ${headers[quantityColIndex]}`);
    
    let processedRows = 0;
    
    // ë°ì´í„° í–‰ ì²˜ë¦¬
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const productNameRaw = String(row[productColIndex] || '');
      const quantity = parseInt(row[quantityColIndex] || 0);
      
      // ìƒí’ˆëª…ì—ì„œ | ì• ë¶€ë¶„ë§Œ ì¶”ì¶œ
      const productName = productNameRaw.includes('|') ? productNameRaw.split('|')[0].trim() : productNameRaw.trim();
      
      if (quantity > 0 && productName) {
        // console.log(`    ğŸ” í–‰ ${i}: "${productName}" (ì›ë³¸: "${productNameRaw}") / ìˆ˜ëŸ‰=${quantity}`);
        // logEntries.push(`    ğŸ” í–‰ ${i}: "${productName}" (ì›ë³¸: "${productNameRaw}") / ìˆ˜ëŸ‰=${quantity}`);
        
        const normalizedProduct = this.normalizeProductName(productName);
        
        if (normalizedProduct && shipmentData[normalizedProduct]) {
          shipmentData[normalizedProduct].cybersky += quantity; // EDIë„ ì¼ë°˜ì ìœ¼ë¡œ cyberskyë¡œ ë¶„ë¥˜
          shipmentData[normalizedProduct].total += quantity;
          processedRows++;
          // console.log(`    â• ì¶”ê°€: ${normalizedProduct} +${quantity} (EDI) â†’ ì´ê³„: ${shipmentData[normalizedProduct].total}`);
          // logEntries.push(`    â• ì¶”ê°€: ${normalizedProduct} +${quantity} (EDI) â†’ ì´ê³„: ${shipmentData[normalizedProduct].total}`);
        } else {
          console.log(`    âŒ ë§¤ì¹­ ì‹¤íŒ¨: "${productName}"`);
          logEntries.push(`    âŒ ë§¤ì¹­ ì‹¤íŒ¨: "${productName}"`);
        }
      }
    }
    
    const ediSummary = Object.keys(shipmentData).map(key => 
      `${key}: +${shipmentData[key].edi}ê°œ`
    ).join(', ');
    console.log(`âœ… EDI ì²˜ë¦¬ ì™„ë£Œ: ${processedRows}ê°œ í–‰ ì²˜ë¦¬ (${ediSummary})`);
    logEntries.push(`âœ… EDI ì²˜ë¦¬ ì™„ë£Œ: ${processedRows}ê°œ í–‰ ì²˜ë¦¬ (${ediSummary})`);
    
    return processedRows;
  },

  /**
   * ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ ì²˜ë¦¬
   */
  processManualSheet: function(manualSheet, shipmentData, logEntries) {
    console.log('ğŸ“‹ ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
    logEntries.push('ğŸ“‹ ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
    
    // ì²˜ë¦¬ ì „ í˜„ì¬ ì¹´ìš´íŠ¸ ì €ì¥
    const originalCounts = {};
    Object.keys(shipmentData).forEach(key => {
      originalCounts[key] = shipmentData[key].cybersky;
    });
    
    const data = manualSheet.getDataRange().getValues();
    console.log(`  â””â”€ ì‹œíŠ¸ í¬ê¸°: ${data.length} í–‰ x ${data[0] ? data[0].length : 0} ì—´`);
    logEntries.push(`  â””â”€ ì‹œíŠ¸ í¬ê¸°: ${data.length} í–‰ x ${data[0] ? data[0].length : 0} ì—´`);
    
    if (data.length <= 1) {
      console.log(`  â””â”€ âš ï¸ ë°ì´í„° ì—†ìŒ`);
      logEntries.push(`  â””â”€ âš ï¸ ë°ì´í„° ì—†ìŒ`);
      return;
    }
    
    // ê³ ì • ì—´ ì¸ë±ìŠ¤ ì‚¬ìš© (ì‚¬ìš©ì ëª…ì„¸ì— ë”°ë¼)
    const productColIndex = 13; // Nì—´: í’ˆëª©ëª… (0-based index)
    const quantityColIndex = 12; // Mì—´: ìˆ˜ëŸ‰ (0-based index)
    const memoColIndex = 18; // Sì—´: ë©”ëª¨1 (ì¿ íŒ¡ ë§ˆí‚¹) (0-based index)
    
    const headers = data[0];
    console.log(`  â””â”€ ğŸ“ ê³ ì • ì—´ ì‚¬ìš© - Nì—´(${productColIndex}): ${headers[productColIndex]}, Mì—´(${quantityColIndex}): ${headers[quantityColIndex]}, Sì—´(${memoColIndex}): ${headers[memoColIndex]}`);
    logEntries.push(`  â””â”€ ğŸ“ ê³ ì • ì—´ ì‚¬ìš© - Nì—´(${productColIndex}): ${headers[productColIndex]}, Mì—´(${quantityColIndex}): ${headers[quantityColIndex]}, Sì—´(${memoColIndex}): ${headers[memoColIndex]}`);
    
    let processedRows = 0;
    
    // ë°ì´í„° í–‰ ì²˜ë¦¬
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const productName = String(row[productColIndex] || '');
      const quantity = parseInt(row[quantityColIndex] || 0);
      const memo = String(row[memoColIndex] || '').trim();
      
      if (quantity > 0 && productName) {
        // console.log(`    ğŸ” í–‰ ${i}: "${productName}" / ìˆ˜ëŸ‰=${quantity} / ë©”ëª¨="${memo}"`);
        // logEntries.push(`    ğŸ” í–‰ ${i}: "${productName}" / ìˆ˜ëŸ‰=${quantity} / ë©”ëª¨="${memo}"`);
        
        const normalizedProduct = this.normalizeProductName(productName);
        
        if (normalizedProduct && shipmentData[normalizedProduct]) {
          const category = memo === 'ì¿ íŒ¡' ? 'coupang' : 'cybersky';
          shipmentData[normalizedProduct][category] += quantity;
          shipmentData[normalizedProduct].total += quantity;
          processedRows++;
          // console.log(`    â• ì¶”ê°€: ${normalizedProduct} +${quantity} (${category}) â†’ ì´ê³„: ${shipmentData[normalizedProduct].total}`);
          // logEntries.push(`    â• ì¶”ê°€: ${normalizedProduct} +${quantity} (${category}) â†’ ì´ê³„: ${shipmentData[normalizedProduct].total}`);
        } else {
          console.log(`    âŒ ë§¤ì¹­ ì‹¤íŒ¨: "${productName}"`);
          logEntries.push(`    âŒ ë§¤ì¹­ ì‹¤íŒ¨: "${productName}"`);
        }
      }
    }
    
    const manualSummary = Object.keys(shipmentData).map(key => {
      const cyberskyCount = shipmentData[key].cybersky - (originalCounts[key] || 0);
      const coupangCount = shipmentData[key].coupang;
      if (cyberskyCount > 0 && coupangCount > 0) {
        return `${key}: +${cyberskyCount}ê°œ(ì¼ë°˜) +${coupangCount}ê°œ(ì¿ íŒ¡)`;
      } else if (cyberskyCount > 0) {
        return `${key}: +${cyberskyCount}ê°œ`;
      } else if (coupangCount > 0) {
        return `${key}: +${coupangCount}ê°œ(ì¿ íŒ¡)`;
      }
      return null;
    }).filter(Boolean).join(', ');
    console.log(`âœ… ìˆ˜ê¸°ì†¡ì¥ ì²˜ë¦¬ ì™„ë£Œ: ${processedRows}ê°œ í–‰ ì²˜ë¦¬ (${manualSummary})`);
    logEntries.push(`âœ… ìˆ˜ê¸°ì†¡ì¥ ì²˜ë¦¬ ì™„ë£Œ: ${processedRows}ê°œ í–‰ ì²˜ë¦¬ (${manualSummary})`);
    
    return processedRows;
  },

  /**
   * ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì—ì„œ ì¿ íŒ¡ ë°ì´í„° ì²˜ë¦¬
   */
  processCoupangDataFromVerification: function(verificationSheet, shipmentData, logEntries) {
    console.log('ğŸ“‹ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì—ì„œ ì¿ íŒ¡ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
    logEntries.push('ğŸ“‹ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì—ì„œ ì¿ íŒ¡ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
    
    const data = verificationSheet.getDataRange().getValues();
    console.log(`  â””â”€ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ í¬ê¸°: ${data.length} í–‰ x ${data[0] ? data[0].length : 0} ì—´`);
    logEntries.push(`  â””â”€ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ í¬ê¸°: ${data.length} í–‰ x ${data[0] ? data[0].length : 0} ì—´`);
    
    if (data.length <= 1) {
      console.log(`  â””â”€ âš ï¸ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì— ë°ì´í„° ì—†ìŒ`);
      logEntries.push(`  â””â”€ âš ï¸ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì— ë°ì´í„° ì—†ìŒ`);
      return 0;
    }
    
    // Hì—´(7)ì— ì¿ íŒ¡ ìˆ˜ëŸ‰ì´ ìˆëŠ” í–‰ë“¤ì—ì„œ ì¿ íŒ¡ ë°ì´í„° ì½ê¸°
    let coupangCount = 0;
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const productName = String(row[1] || ''); // Bì—´: í’ˆëª©ëª…
      const coupangQuantity = parseInt(row[7] || 0); // Hì—´: ì¿ íŒ¡ ìˆ˜ëŸ‰
      
      if (coupangQuantity > 0 && productName) {
        // Iì—´(8)ì—ì„œ ì´ ì¶œê³ ìˆ˜ëŸ‰ ì½ê¸° (ìˆëŠ” ê²½ìš°)
        const totalQuantity = parseInt(row[8] || 0);
        
        console.log(`    ğŸ›’ ì¿ íŒ¡ ë°ì´í„° ë°œê²¬: "${productName}" / ì¿ íŒ¡ìˆ˜ëŸ‰=${coupangQuantity}, ì´ìˆ˜ëŸ‰=${totalQuantity}`);
        logEntries.push(`    ğŸ›’ ì¿ íŒ¡ ë°ì´í„° ë°œê²¬: "${productName}" / ì¿ íŒ¡ìˆ˜ëŸ‰=${coupangQuantity}, ì´ìˆ˜ëŸ‰=${totalQuantity}`);
        
        if (totalQuantity > 0) {
          const normalizedProduct = this.normalizeProductName(productName);
          
          if (normalizedProduct && shipmentData[normalizedProduct]) {
            // Hì—´ì—ì„œ ì§ì ‘ ì¿ íŒ¡ ìˆ˜ëŸ‰ì„ ê°€ì ¸ì˜´
            if (coupangQuantity > 0) {
              shipmentData[normalizedProduct].coupang += coupangQuantity;
              shipmentData[normalizedProduct].total += coupangQuantity; // ê¸°ì¡´ ì´í•©ì— ì¿ íŒ¡ ìˆ˜ëŸ‰ ì¶”ê°€
              coupangCount++;
              
              console.log(`    â• ì¿ íŒ¡ ì¶”ê°€: ${normalizedProduct} +${coupangQuantity} (ìƒˆ ì´ê³„: ${shipmentData[normalizedProduct].total})`);
              logEntries.push(`    â• ì¿ íŒ¡ ì¶”ê°€: ${normalizedProduct} +${coupangQuantity} (ìƒˆ ì´ê³„: ${shipmentData[normalizedProduct].total})`);
            }
          } else {
            console.log(`    âŒ ì¿ íŒ¡ ì œí’ˆ ë§¤ì¹­ ì‹¤íŒ¨: "${productName}"`);
            logEntries.push(`    âŒ ì¿ íŒ¡ ì œí’ˆ ë§¤ì¹­ ì‹¤íŒ¨: "${productName}"`);
          }
        }
      }
    }
    
    console.log(`âœ… ì¿ íŒ¡ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${coupangCount}ê°œ í•­ëª© ì²˜ë¦¬`);
    logEntries.push(`âœ… ì¿ íŒ¡ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${coupangCount}ê°œ í•­ëª© ì²˜ë¦¬`);
    
    return coupangCount;
  },

  /**
   * ì œí’ˆëª… ì •ê·œí™”
   */
  normalizeProductName: function(productName) {
    if (productName.includes('ì‚¬ê³¨ê³ ê¸°ê³°íƒ•')) {
      return 'ì‚¬ê³¨ê³ ê¸°ê³°íƒ•5ê°œì…';
    }
    else if (productName.includes('ì‚¬ê³¨ê³°íƒ•') && (productName.includes('20íŒ©') || productName.includes('20ê°œì…'))) {
      return 'ì‚¬ê³¨ê³°íƒ•20ê°œì…';
    }
    else if (productName.includes('ì‚¬ê³¨ê³°íƒ•') && (productName.includes('10íŒ©') || productName.includes('10ê°œì…'))) {
      return 'ì‚¬ê³¨ê³°íƒ•10ê°œì…';
    }
    else if (productName.includes('ì‚¬ê³¨ê³°íƒ•') && !productName.includes('ì‚¬ê³¨ê³ ê¸°ê³°íƒ•') && 
            (productName.includes('5íŒ©') || productName.includes('5ê°œì…') || productName.includes('1ë°•ìŠ¤'))) {
      return 'ì‚¬ê³¨ê³°íƒ•5ê°œì…';
    }
    else if (productName.includes('ìœ¡í¬')) {
      return 'ìœ¡í¬5ê°œì…';
    }
    
    return null;
  },

  /**
   * ì´ë©”ì¼ìš© íŒŒì¼ëª… ìƒì„±
   */
  generateEmailFileName: function(dateString) {
    const month = dateString.substring(4, 6);
    const day = dateString.substring(6, 8);
    return `ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥ (${month}.${day}).xlsx`;
  },

  /**
   * ì´ë©”ì¼ ì²˜ë¦¬ ë¡œê·¸ë¥¼ ì‹œíŠ¸ì— ì €ì¥
   */
  saveEmailProcessLog: function(logEntries, processName) {
    console.log('=== ì´ë©”ì¼ ë¡œê·¸ ì‹œíŠ¸ ì €ì¥ ì‹œì‘ ===');
    
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      let logSheet = spreadsheet.getSheetByName('ì´ë©”ì¼_ë¡œê·¸');
      
      // ë¡œê·¸ ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±
      if (!logSheet) {
        console.log('ì´ë©”ì¼_ë¡œê·¸ ì‹œíŠ¸ ìƒì„±');
        logSheet = spreadsheet.insertSheet('ì´ë©”ì¼_ë¡œê·¸');
        
        // í—¤ë” ì„¤ì •
        const headers = ['íƒ€ì„ìŠ¤íƒ¬í”„', 'í”„ë¡œì„¸ìŠ¤', 'ìƒì„¸ë¡œê·¸'];
        logSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
        
        // í—¤ë” ìŠ¤íƒ€ì¼ë§
        const headerRange = logSheet.getRange(1, 1, 1, headers.length);
        headerRange.setBackground('#34a853');
        headerRange.setFontColor('white');
        headerRange.setFontWeight('bold');
        headerRange.setHorizontalAlignment('center');
        
        // ì—´ ë„ˆë¹„ ì¡°ì •
        logSheet.setColumnWidth(1, 150); // íƒ€ì„ìŠ¤íƒ¬í”„
        logSheet.setColumnWidth(2, 200); // í”„ë¡œì„¸ìŠ¤
        logSheet.setColumnWidth(3, 800); // ìƒì„¸ë¡œê·¸
        
        console.log('ì´ë©”ì¼_ë¡œê·¸ ì‹œíŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
      }
      
      // í˜„ì¬ ì‹œê°„
      const timestamp = new Date().toLocaleString('ko-KR');
      
      // ë¡œê·¸ ì—”íŠ¸ë¦¬ë“¤ì„ í•˜ë‚˜ì˜ ê¸´ ë¬¸ìì—´ë¡œ ê²°í•©
      const combinedLog = logEntries.join('\n');
      
      // ìƒˆ í–‰ ì¶”ê°€
      const newRow = [timestamp, processName, combinedLog];
      logSheet.appendRow(newRow);
      
      // ìµœê·¼ 100ê°œ í•­ëª©ë§Œ ìœ ì§€ (ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ)
      const lastRow = logSheet.getLastRow();
      if (lastRow > 101) { // í—¤ë” + 100ê°œ
        const deleteCount = lastRow - 101;
        logSheet.deleteRows(2, deleteCount);
        console.log(`ì˜¤ë˜ëœ ë¡œê·¸ ${deleteCount}ê°œ ì‚­ì œ`);
      }
      
      // ìµœì‹  ë¡œê·¸ê°€ ìœ„ë¡œ ì˜¤ë„ë¡ ì •ë ¬ (íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ)
      if (logSheet.getLastRow() > 1) {
        const range = logSheet.getRange(2, 1, logSheet.getLastRow() - 1, 3);
        range.sort({column: 1, ascending: false});
      }
      
      console.log(`ì´ë©”ì¼ ë¡œê·¸ ì €ì¥ ì™„ë£Œ: ${processName} (${logEntries.length}ê°œ í•­ëª©)`);
      return { success: true };
      
    } catch (error) {
      console.error('ì´ë©”ì¼ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', error);
      return { success: false, error: error.toString() };
    }
  }
};

/**
 * HTMLì—ì„œ í˜¸ì¶œí•  ì „ì—­ í•¨ìˆ˜ë“¤ (EmailSenderDialogìš©)
 */

// ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ë° ì´ë©”ì¼ ì „ì†¡
function processExcelAndSendEmail(fileData, fileName, targetDate) {
  console.log('=== Global Function Start: processExcelAndSendEmail ===');
  console.log('Parameters:', { fileName, targetDate });
  
  try {
    const result = EmailSender.processExcelAndSendEmail(fileData, fileName, targetDate);
    console.log('Process and send result:', result);
    console.log('=== Global Function End: processExcelAndSendEmail SUCCESS ===');
    return result;
    
  } catch (error) {
    console.error('ERROR in global processExcelAndSendEmail:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Global Function End: processExcelAndSendEmail FAILED ===');
    return { success: false, error: error.toString() };
  }
}