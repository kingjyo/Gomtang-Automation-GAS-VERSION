<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    
    .content {
      padding: 30px;
    }
    
    /* ë‚ ì§œ ì„ íƒ ì„¹ì…˜ */
    .date-section {
      margin-bottom: 25px;
      padding: 20px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      background: #f8f9fa;
    }
    
    .date-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .date-input-group {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .date-input {
      padding: 10px 15px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 14px;
      width: 120px;
      text-align: center;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .date-input:focus {
      outline: none;
      border-color: #28a745;
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
    }
    
    .date-input::placeholder {
      color: #999;
      font-weight: 400;
    }
    
    .date-today-btn {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: #28a745;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .date-today-btn:hover {
      background: #218838;
      transform: translateY(-1px);
    }
    
    .date-help {
      font-size: 12px;
      color: #666;
      margin-left: 10px;
      line-height: 1.4;
    }
    
    /* ì œí’ˆ ëª©ë¡ ì„¹ì…˜ */
    .products-section {
      margin-bottom: 25px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .product-card {
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 20px;
      background: #fafbfc;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .product-card.available {
      border-color: #28a745;
      background: #d4edda;
    }
    
    .product-card.unavailable {
      border-color: #dc3545;
      background: #f8d7da;
      opacity: 0.7;
    }
    
    .product-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    .product-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .product-info {
      font-size: 12px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .product-status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      display: inline-block;
    }
    
    .status-available {
      background: #28a745;
      color: white;
    }
    
    .status-unavailable {
      background: #dc3545;
      color: white;
    }
    
    /* ë²„íŠ¼ ê·¸ë£¹ */
    .button-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    
    .button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .button.primary {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }
    
    .button.primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
    }
    
    .button.secondary {
      background: #e9ecef;
      color: #495057;
    }
    
    .button.secondary:hover:not(:disabled) {
      background: #dee2e6;
    }
    
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ë¡œë”© ë° ë©”ì‹œì§€ */
    .loading {
      display: none;
      text-align: center;
      padding: 30px;
    }
    
    .loading.show {
      display: block;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #28a745;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .message {
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      display: none;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    
    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }
    
    /* ë‹¤ìš´ë¡œë“œ ê²°ê³¼ */
    .download-results {
      margin-top: 20px;
      display: none;
    }
    
    .download-results.show {
      display: block;
    }
    
    .download-item {
      padding: 15px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .download-item.success {
      background: #d4edda;
      border-color: #c3e6cb;
    }
    
    .download-item.error {
      background: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .download-info {
      flex: 1;
    }
    
    .download-name {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .download-detail {
      font-size: 12px;
      color: #666;
    }
    
    .download-link {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .download-link:hover {
      background: #0056b3;
    }
    
    /* ë‹¤ìš´ë¡œë“œ ë§í¬ í‘œì‹œ ìŠ¤íƒ€ì¼ */
    .download-link-container {
      background: #f8f9fa;
      border: 2px solid #28a745;
      border-radius: 10px;
      padding: 25px;
      margin-top: 20px;
    }
    
    .download-ready {
      text-align: center;
    }
    
    .download-actions {
      margin-top: 20px;
    }
    
    .download-url-section {
      margin-bottom: 20px;
    }
    
    .email-section {
      margin-bottom: 20px;
      padding-top: 15px;
      border-top: 1px solid #dee2e6;
    }
    
    .download-url-section label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    
    .url-input-group,
    .email-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
    }
    
    .url-input,
    .email-input {
      flex: 1;
      padding: 10px;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      font-size: 12px;
      background: white;
    }
    
    .url-input {
      font-family: 'Courier New', monospace;
    }
    
    .email-input {
      font-family: inherit;
    }
    
    .url-input:focus,
    .email-input:focus {
      outline: none;
      border-color: #28a745;
    }
    
    .copy-btn,
    .email-btn,
    .email-load-btn {
      padding: 10px 15px;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      transition: background 0.3s ease;
    }
    
    .copy-btn {
      background: #007bff;
    }
    
    .copy-btn:hover {
      background: #0056b3;
    }
    
    .email-btn {
      background: #28a745;
    }
    
    .email-btn:hover {
      background: #218838;
    }
    
    .email-load-btn {
      background: #6c757d;
    }
    
    .email-load-btn:hover {
      background: #5a6268;
    }
    
    .email-recipients-display {
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      font-size: 12px;
      display: none;
    }
    
    .email-recipients-display.show {
      display: block;
    }
    
    .recipient-item {
      padding: 10px 0;
      border-bottom: 1px solid #e9ecef;
      position: relative;
    }
    
    .recipient-item:last-child {
      border-bottom: none;
    }
    
    .recipient-order {
      display: inline-block;
      background: #007bff;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .recipient-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
    }
    
    .recipient-email {
      color: #666;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      margin-bottom: 3px;
    }
    
    .recipient-memo {
      color: #999;
      font-size: 10px;
      font-style: italic;
    }
    
    .download-hint {
      font-size: 11px;
      color: #666;
      font-style: italic;
      text-align: left;
    }
    
    .quick-actions {
      text-align: center;
      padding-top: 15px;
      border-top: 1px solid #dee2e6;
    }
    
    @media (max-width: 768px) {
      .products-grid {
        grid-template-columns: 1fr;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .url-input-group,
      .email-input-group {
        flex-direction: column;
      }
      
      .url-input {
        font-size: 11px;
        word-break: break-all;
      }
      
      .copy-btn,
      .email-btn,
      .email-load-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“¦ í’ˆëª©ë³„ ë‹¤ìš´ë¡œë”</h1>
      <p>ì‚¬ê³¨ê³ ê¸°ê³°íƒ•, ì‚¬ê³¨ê³°íƒ•, ìœ¡í¬ ì‹œíŠ¸ë¥¼ ì—‘ì…€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ</p>
    </div>
    
    <div class="content">
      <!-- ë‚ ì§œ ì„ íƒ ì„¹ì…˜ -->
      <div class="date-section">
        <div class="date-title">
          ğŸ“… ë‹¤ìš´ë¡œë“œí•  ë‚ ì§œ ì§€ì •
        </div>
        <div class="date-input-group">
          <input type="text" id="dateInput" class="date-input" placeholder="0809" maxlength="4" pattern="[0-9]{4}">
          <button class="date-today-btn" onclick="setTodayDate()">ğŸ“… ì˜¤ëŠ˜</button>
          <div class="date-help">
            MMDD í˜•ì‹ (ì˜ˆ: 0809)<br>
            í•´ë‹¹ ë‚ ì§œì˜ í’ˆëª©ë³„ ì‹œíŠ¸ê°€ ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤
          </div>
        </div>
      </div>
      
      <!-- ì œí’ˆ ëª©ë¡ ì„¹ì…˜ -->
      <div class="products-section">
        <div class="section-title">
          ğŸ² ì‚¬ìš© ê°€ëŠ¥í•œ ì œí’ˆ ì‹œíŠ¸
        </div>
        <div class="products-grid" id="productsGrid">
          <!-- ì œí’ˆ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
      </div>
      
      <div class="button-group">
        <button class="button secondary" onclick="checkAvailableSheets()" id="checkButton">
          <span>ğŸ”</span> ì‹œíŠ¸ í™•ì¸
        </button>
        <button class="button primary" onclick="downloadAllSheets()" id="downloadButton" disabled>
          <span>ğŸ“¥</span> í’ˆëª©ë³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        </button>
      </div>
      
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div id="loadingText">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
      </div>
      
      <div class="download-results" id="downloadResults">
        <!-- ë‹¤ìš´ë¡œë“œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
      
      <div class="message" id="message"></div>
    </div>
  </div>
  
  <script>
    let availableSheets = [];
    let currentDate = '';
    let currentDownloadInfo = null;
    let emailRecipients = [];
    
    // ë‚ ì§œ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function setTodayDate() {
      const today = new Date();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const mmdd = month + day;
      
      document.getElementById('dateInput').value = mmdd;
      
      // ë‚ ì§œê°€ ì„¤ì •ë˜ë©´ ìë™ìœ¼ë¡œ ì‹œíŠ¸ í™•ì¸
      setTimeout(checkAvailableSheets, 100);
    }
    
    function getSelectedDate() {
      const dateInput = document.getElementById('dateInput').value.trim();
      
      // ì…ë ¥ê°’ ê²€ì¦
      if (dateInput && dateInput.length === 4 && /^\d{4}$/.test(dateInput)) {
        return dateInput;
      } else if (dateInput && dateInput.length > 0) {
        showMessage('ë‚ ì§œëŠ” MMDD í˜•ì‹ 4ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 0809)', 'error');
        return null;
      }
      
      // ì…ë ¥ê°’ì´ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©
      const today = new Date();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      return month + day;
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì • ë° ì‹œíŠ¸ í™•ì¸
    window.onload = function() {
      setTodayDate();
    };
    
    // ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸ í™•ì¸
    function checkAvailableSheets() {
      const targetDate = getSelectedDate();
      if (targetDate === null) {
        return;
      }
      
      showLoading('ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
      clearMessage();
      
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          
          if (result.success) {
            availableSheets = result.availableSheets;
            currentDate = result.dateString;
            
            updateProductsGrid(result.availableSheets);
            
            if (result.availableSheets.length > 0) {
              document.getElementById('downloadButton').disabled = false;
              showMessage(`${result.availableSheets.length}ê°œì˜ í’ˆëª© ì‹œíŠ¸ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`, 'success');
            } else {
              document.getElementById('downloadButton').disabled = true;
              showMessage(`${result.dateString} ë‚ ì§œì˜ í’ˆëª©ë³„ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'info');
            }
          } else {
            showMessage(result.error, 'error');
            updateProductsGrid([]);
            document.getElementById('downloadButton').disabled = true;
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage(`ì‹œíŠ¸ í™•ì¸ ì‹¤íŒ¨: ${error}`, 'error');
          updateProductsGrid([]);
          document.getElementById('downloadButton').disabled = true;
        })
        .getAvailableProductSheets(targetDate);
    }
    
    // ì œí’ˆ ì¹´ë“œ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
    function updateProductsGrid(availableSheets) {
      const grid = document.getElementById('productsGrid');
      const products = ['ì‚¬ê³¨ê³ ê¸°ê³°íƒ•', 'ì‚¬ê³¨ê³°íƒ•', 'ìœ¡í¬'];
      const productIcons = {
        'ì‚¬ê³¨ê³ ê¸°ê³°íƒ•': 'ğŸ¥©',
        'ì‚¬ê³¨ê³°íƒ•': 'ğŸ²', 
        'ìœ¡í¬': 'ğŸ¥“'
      };
      
      grid.innerHTML = '';
      
      products.forEach(product => {
        const available = availableSheets.find(sheet => sheet.product === product);
        
        const card = document.createElement('div');
        card.className = `product-card ${available ? 'available' : 'unavailable'}`;
        
        card.innerHTML = `
          <div class="product-icon">${productIcons[product] || 'ğŸ“¦'}</div>
          <div class="product-name">${product}</div>
          <div class="product-info">
            ${available ? `${available.rowCount}í–‰ì˜ ë°ì´í„°` : 'ë°ì´í„° ì—†ìŒ'}
          </div>
          <div class="product-status ${available ? 'status-available' : 'status-unavailable'}">
            ${available ? 'ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥' : 'ì‹œíŠ¸ ì—†ìŒ'}
          </div>
        `;
        
        grid.appendChild(card);
      });
    }
    
    // ëª¨ë“  ì‹œíŠ¸ ë‹¤ìš´ë¡œë“œ
    function downloadAllSheets() {
      const targetDate = getSelectedDate();
      if (targetDate === null) {
        return;
      }
      
      if (availableSheets.length === 0) {
        showMessage('ë‹¤ìš´ë¡œë“œí•  ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì‹œíŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      showLoading('ì—‘ì…€ íŒŒì¼ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
      clearMessage();
      hideDownloadResults();
      
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          
          if (result.success) {
            showMessage(`âœ… ì—‘ì…€ íŒŒì¼ ìƒì„± ì™„ë£Œ!\n${result.downloadInfo.sheetsIncluded.length}ê°œ í’ˆëª©ì´ í¬í•¨ëœ íŒŒì¼ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.`, 'success');
            showDownloadResults([result.downloadInfo]);
          } else {
            showMessage(result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage(`ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${error}`, 'error');
        })
        .downloadProductSheets(targetDate);
    }
    
    // ë‹¤ìš´ë¡œë“œ ê²°ê³¼ í‘œì‹œ
    function showDownloadResults(downloadResults) {
      const container = document.getElementById('downloadResults');
      container.innerHTML = '';
      
      downloadResults.forEach(result => {
        const item = document.createElement('div');
        item.className = 'download-item success';
        
        item.innerHTML = `
          <div class="download-info">
            <div class="download-name">ğŸ“¦ ${result.fileName}</div>
            <div class="download-detail">í¬í•¨ ì‹œíŠ¸: ${result.sheetsIncluded.join(', ')}</div>
          </div>
          <button class="download-link" onclick="downloadFile('${result.fileId}', '${result.fileName}')">
            ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
          </button>
        `;
        
        container.appendChild(item);
      });
      
      container.classList.add('show');
    }
    
    function hideDownloadResults() {
      document.getElementById('downloadResults').classList.remove('show');
    }
    
    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function downloadFile(fileId, fileName) {
      try {
        showMessage('ë‹¤ìš´ë¡œë“œë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ ì‹œì‘
              startAutomaticDownload(result.downloadUrl, result.fileName);
            } else {
              showMessage(result.error, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage(`ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${error}`, 'error');
          })
          .triggerDownload(fileId, fileName);
        
      } catch (error) {
        console.error('Download failed:', error);
        showMessage(`ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${error}`, 'error');
      }
    }
    
    // ë‹¤ìš´ë¡œë“œ ë§í¬ í‘œì‹œ
    function startAutomaticDownload(downloadUrl, fileName) {
      showDownloadLink(downloadUrl, fileName);
    }
    
    // ì‚¬ìš©ì ì¹œí™”ì ì¸ ë‹¤ìš´ë¡œë“œ ë§í¬ í‘œì‹œ
    function showDownloadLink(downloadUrl, fileName) {
      // í˜„ì¬ ë‹¤ìš´ë¡œë“œ ì •ë³´ ì €ì¥
      currentDownloadInfo = {
        downloadUrl: downloadUrl,
        fileName: fileName
      };
      
      const container = document.getElementById('downloadResults');
      container.innerHTML = '';
      
      const linkContainer = document.createElement('div');
      linkContainer.className = 'download-link-container';
      linkContainer.innerHTML = `
        <div class="download-ready">
          <h3 style="color: #28a745; margin-bottom: 15px;">ğŸ“¥ ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ì™„ë£Œ!</h3>
          <div class="file-info">
            <div class="file-name">ğŸ“„ ${fileName}</div>
          </div>
          
          <div class="download-actions">
            <div class="download-url-section">
              <label>ë‹¤ìš´ë¡œë“œ ë§í¬:</label>
              <div class="url-input-group">
                <input type="text" id="downloadUrlInput" value="${downloadUrl}" readonly class="url-input">
                <button onclick="copyDownloadUrl()" class="copy-btn">ğŸ“‹ ë³µì‚¬</button>
              </div>
              <div class="download-hint">
                ìœ„ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ìƒˆ íƒ­ì˜ ì£¼ì†Œì°½ì— ë¶™ì—¬ë„£ìœ¼ë©´ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤
              </div>
            </div>
            
            <div class="email-section">
              <label>ì´ë©”ì¼ ì „ì†¡:</label>
              <div class="email-input-group">
                <button onclick="loadEmailRecipients()" class="email-load-btn">ğŸ‘¥ ì£¼ì†Œë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="sendEmailWithAttachment()" class="email-btn">ğŸ“§ ì „ì†¡</button>
              </div>
              <div class="email-recipients-display" id="emailRecipientsDisplay">
                <!-- ì´ë©”ì¼ ìˆ˜ì‹ ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
              </div>
              <div class="download-hint">
                'ì´ë©”ì¼_ì„¤ì •' ì‹œíŠ¸ì˜ ì£¼ì†Œë¡ìœ¼ë¡œ ê°„í¸ì‹ ì¶œê³ ìš”ì²­ì„ ì „ì†¡í•©ë‹ˆë‹¤
              </div>
            </div>
            
            <div class="quick-actions">
              <button onclick="openInNewTab('${downloadUrl}')" class="button primary">
                ğŸ”— ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
              </button>
            </div>
          </div>
        </div>
      `;
      
      container.appendChild(linkContainer);
      container.classList.add('show');
      
      showMessage('âœ… ì—‘ì…€ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    }
    
    // URL ë³µì‚¬ ê¸°ëŠ¥
    function copyDownloadUrl() {
      const urlInput = document.getElementById('downloadUrlInput');
      urlInput.select();
      urlInput.setSelectionRange(0, 99999); // ëª¨ë°”ì¼ ì§€ì›
      
      try {
        document.execCommand('copy');
        showMessage('ğŸ“‹ ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nìƒˆ íƒ­ì˜ ì£¼ì†Œì°½ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)í•˜ì„¸ìš”.', 'success');
      } catch (error) {
        showMessage('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë§í¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•˜ì—¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.', 'error');
      }
    }
    
    // ìƒˆ íƒ­ì—ì„œ ì—´ê¸° (ê°€ëŠ¥í•œ ê²½ìš°)
    function openInNewTab(url) {
      try {
        // ìƒˆ ì°½ ì—´ê¸° ì‹œë„
        const newWindow = window.open(url, '_blank');
        if (newWindow) {
          showMessage('ìƒˆ íƒ­ì—ì„œ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.', 'success');
        } else {
          showMessage('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ìœ„ì˜ ë§í¬ë¥¼ ë³µì‚¬í•´ì„œ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'info');
        }
      } catch (error) {
        showMessage('ìƒˆ íƒ­ ì—´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë§í¬ë¥¼ ë³µì‚¬í•´ì„œ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'error');
      }
    }
    
    // ì´ë©”ì¼ ì£¼ì†Œë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadEmailRecipients() {
      showMessage('ì´ë©”ì¼ ì£¼ì†Œë¡ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            emailRecipients = result.recipients;
            displayEmailRecipients(result.recipients);
            showMessage(`ğŸ“§ ${result.recipients.length}ëª…ì˜ ìˆ˜ì‹ ìë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
          } else {
            showMessage(`ì£¼ì†Œë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${result.error}`, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage(`ì£¼ì†Œë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error}`, 'error');
        })
        .getEmailRecipients();
    }
    
    // ì´ë©”ì¼ ìˆ˜ì‹ ì ëª©ë¡ í‘œì‹œ
    function displayEmailRecipients(recipients) {
      const display = document.getElementById('emailRecipientsDisplay');
      display.innerHTML = '';
      
      if (recipients.length === 0) {
        display.innerHTML = '<div style="text-align: center; color: #666;">ë“±ë¡ëœ ìˆ˜ì‹ ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        recipients.forEach(recipient => {
          const item = document.createElement('div');
          item.className = 'recipient-item';
          item.innerHTML = `
            <div class="recipient-order">${recipient.order}ìˆœìœ„</div>
            <div class="recipient-name">${recipient.name}</div>
            <div class="recipient-email">${recipient.email}</div>
            <div class="recipient-memo">${recipient.memo}</div>
          `;
          display.appendChild(item);
        });
      }
      
      display.classList.add('show');
    }
    
    // ì´ë©”ì¼ ì „ì†¡ í•¨ìˆ˜
    function sendEmailWithAttachment() {
      if (!currentDownloadInfo) {
        showMessage('ë‹¤ìš´ë¡œë“œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŒŒì¼ì„ ìƒì„±í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      if (emailRecipients.length === 0) {
        showMessage('ìˆ˜ì‹ ìê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì£¼ì†Œë¡ì„ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      const targetDate = getSelectedDate();
      if (targetDate === null) {
        return;
      }
      
      // íŒŒì¼ ID ì¶”ì¶œ (downloadUrlì—ì„œ)
      const fileIdMatch = currentDownloadInfo.downloadUrl.match(/id=([^&]+)/);
      if (!fileIdMatch) {
        showMessage('íŒŒì¼ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      
      const fileId = fileIdMatch[1];
      
      // ì´ë©”ì¼ ì£¼ì†Œ ëª©ë¡ ìƒì„±
      const recipients = emailRecipients.map(r => r.email).join(',');
      
      showMessage('ì´ë©”ì¼ì„ ì „ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage(`âœ… ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ!\në°›ëŠ” ì‚¬ëŒ: ${result.recipientCount}ëª…\n\nì¶œê³  ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
          } else {
            showMessage(`ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: ${result.error}`, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage(`ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: ${error}`, 'error');
        })
        .sendShipmentEmail(targetDate, recipients, fileId, currentDownloadInfo.fileName);
    }
    
    // UI í—¬í¼ í•¨ìˆ˜ë“¤
    function showLoading(text) {
      document.getElementById('loading').classList.add('show');
      document.getElementById('loadingText').textContent = text || 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...';
      document.querySelectorAll('.button').forEach(button => {
        button.disabled = true;
      });
    }
    
    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
      document.querySelectorAll('.button').forEach(button => {
        button.disabled = false;
      });
      
      // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìƒíƒœëŠ” ë³„ë„ë¡œ ê´€ë¦¬
      if (availableSheets.length === 0) {
        document.getElementById('downloadButton').disabled = true;
      }
    }
    
    function showMessage(text, type) {
      const message = document.getElementById('message');
      message.textContent = text;
      message.className = 'message ' + type;
      
      if (type === 'success') {
        setTimeout(clearMessage, 5000);
      }
    }
    
    function clearMessage() {
      const message = document.getElementById('message');
      message.classList.remove('success', 'error', 'info');
    }
    
    // ë‚ ì§œ ì…ë ¥ í•„ë“œì—ì„œ ì—”í„°í‚¤ ì²˜ë¦¬
    document.getElementById('dateInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        checkAvailableSheets();
      }
    });
    
    // ë‚ ì§œ ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ì‹œíŠ¸ í™•ì¸ ë²„íŠ¼ í™œì„±í™”
    document.getElementById('dateInput').addEventListener('input', function() {
      document.getElementById('downloadButton').disabled = true;
      availableSheets = [];
      updateProductsGrid([]);
      clearMessage();
    });
  </script>
</body>
</html>