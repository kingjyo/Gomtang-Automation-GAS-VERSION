/**
 * í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ ëª¨ìŒ
 * TestFunctions.gs
 */

const TestFunctions = {
  /**
   * íŠ¹ì • ë‚ ì§œì˜ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° í…ŒìŠ¤íŠ¸
   */
  testCyberskyByDate: function() {
    const ui = SpreadsheetApp.getUi();
    
    // ë‚ ì§œ ì…ë ¥ ë°›ê¸°
    const response = ui.prompt(
      'ğŸ“… í…ŒìŠ¤íŠ¸ ë‚ ì§œ ì…ë ¥',
      'ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n' +
      'í˜•ì‹: MMDD (ì˜ˆ: 0807, 0808)\n' +
      'í•´ë‹¹ ë‚ ì§œì˜ ì‹œíŠ¸ê°€ ì†ŒìŠ¤ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (response.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    const testDate = response.getResponseText().trim();
    
    // ë‚ ì§œ í˜•ì‹ ê²€ì¦
    if (!/^\d{4}$/.test(testDate)) {
      ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    try {
      // ì„¤ì • ì´ˆê¸°í™”
      initializeConfig();
      
      // CyberskyDataì˜ í•¨ìˆ˜ë¥¼ ì§ì ‘ í˜¸ì¶œ
      const result = CyberskyData.updateCyberskyDataForDate(testDate);
      
      if (result.success) {
        // í…ŒìŠ¤íŠ¸ìš© ì‹œíŠ¸ë¡œ ì´ë¦„ ë³€ê²½
        const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
        const originalSheet = spreadsheet.getSheetByName(result.sheetName);
        if (originalSheet) {
          const newName = `TEST_${testDate}_ì‹¸ì´ë²„ìŠ¤ì¹´ì´`;
          originalSheet.setName(newName);
          ui.alert(`âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ!\n\n${testDate} ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.\nì‹œíŠ¸ëª…: ${newName}\në°ì´í„°: ${result.rowCount}í–‰`);
        }
      } else {
        ui.alert('âŒ ' + result.error);
      }
      
    } catch (error) {
      ui.alert('âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.toString());
    }
  },
  
  /**
   * íŠ¹ì • ë‚ ì§œì˜ EDI ë°ì´í„° í…ŒìŠ¤íŠ¸
   */
  testEDIByDate: function() {
    const ui = SpreadsheetApp.getUi();
    
    // ë‚ ì§œ ì…ë ¥ ë°›ê¸°
    const response = ui.prompt(
      'ğŸ“… í…ŒìŠ¤íŠ¸ ë‚ ì§œ ì…ë ¥',
      'EDI ë©”ì¼ì„ ê²€ìƒ‰í•  ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n' +
      'í˜•ì‹: MMDD (ì˜ˆ: 0728, 0807)\n' +
      'í•´ë‹¹ ë‚ ì§œì˜ ë©”ì¼ì´ Gmailì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (response.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    const testDate = response.getResponseText().trim();
    
    // ë‚ ì§œ í˜•ì‹ ê²€ì¦
    if (!/^\d{4}$/.test(testDate)) {
      ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    try {
      // ì„¤ì • ì´ˆê¸°í™”
      initializeConfig();
      
      // EDIDataì˜ í•¨ìˆ˜ë¥¼ ì§ì ‘ í˜¸ì¶œ
      const result = EDIData.getEDIFromEmail(testDate);
      
      if (result.success) {
        // í…ŒìŠ¤íŠ¸ìš© ì‹œíŠ¸ë¡œ ì´ë¦„ ë³€ê²½
        const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
        const originalSheet = spreadsheet.getSheetByName(result.sheetName);
        if (originalSheet) {
          const newName = `TEST_${testDate}_EDI`;
          originalSheet.setName(newName);
          ui.alert(`âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ!\n\n${testDate} EDI ë°ì´í„°ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.\nì‹œíŠ¸ëª…: ${newName}\në°ì´í„°: ${result.rowCount}í–‰`);
        }
      } else {
        ui.alert('âŒ ' + result.error);
      }
      
    } catch (error) {
      ui.alert('âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.toString());
    }
  },
  
  /**
   * íŠ¹ì • ë‚ ì§œì˜ ì „ì²´ í”„ë¡œì„¸ìŠ¤ í…ŒìŠ¤íŠ¸
   */
  testFullProcessByDate: function() {
    const ui = SpreadsheetApp.getUi();
    
    // ë‚ ì§œ ì…ë ¥ ë°›ê¸°
    const response = ui.prompt(
      'ğŸ“… ì „ì²´ í”„ë¡œì„¸ìŠ¤ í…ŒìŠ¤íŠ¸',
      'í…ŒìŠ¤íŠ¸í•  ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n' +
      'í˜•ì‹: MMDD (ì˜ˆ: 0807, 0808)\n\n' +
      'âš ï¸ ì£¼ì˜:\n' +
      '- ì‹¸ì´ë²„ìŠ¤ì¹´ì´: MMDD ì‹œíŠ¸ê°€ ìˆì–´ì•¼ í•¨\n' +
      '- EDI: MMDD ì œëª©ì˜ ë©”ì¼ì´ ìˆì–´ì•¼ í•¨',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (response.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    const shortDate = response.getResponseText().trim();
    
    // ë‚ ì§œ í˜•ì‹ ê²€ì¦
    if (!/^\d{4}$/.test(shortDate)) {
      ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const year = new Date().getFullYear();
    const fullDate = year + shortDate;
    
    try {
      ui.alert('ğŸ”„ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...\n\n1. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°\n2. EDI ë°ì´í„° ê°€ì ¸ì˜¤ê¸°\n3. ë°ì´í„° ì²˜ë¦¬\n4. ê²€ì‚°');
      
      // ì„¤ì • ì´ˆê¸°í™”
      initializeConfig();
      
      // 1. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° í…ŒìŠ¤íŠ¸
      const cyberskyResult = CyberskyData.updateCyberskyDataForDate(shortDate);
      if (!cyberskyResult.success) {
        throw new Error('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì‹¤íŒ¨: ' + cyberskyResult.error);
      }
      
      // TEST_ ì ‘ë‘ì‚¬ ì¶”ê°€
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      let aSheet = spreadsheet.getSheetByName(cyberskyResult.sheetName);
      if (aSheet) {
        aSheet.setName(`TEST_${fullDate}_ì‹¸ì´ë²„ìŠ¤ì¹´ì´`);
      }
      
      // 2. EDI ë°ì´í„° í…ŒìŠ¤íŠ¸
      const ediResult = EDIData.getEDIFromEmail(shortDate);
      if (!ediResult.success) {
        throw new Error('EDI ë°ì´í„° ì‹¤íŒ¨: ' + ediResult.error);
      }
      
      // TEST_ ì ‘ë‘ì‚¬ ì¶”ê°€
      let bSheet = spreadsheet.getSheetByName(ediResult.sheetName);
      if (bSheet) {
        bSheet.setName(`TEST_${shortDate}_EDI`);
      }
      
      // 3. ë°ì´í„° ì²˜ë¦¬ (TEST ì‹œíŠ¸ë“¤ì„ ì‚¬ìš©í•˜ë„ë¡ ì„ì‹œ ìˆ˜ì •)
      const processResult = this.processTestData(fullDate, shortDate);
      
      // 4. ê²€ì‚°
      const verifyResult = this.verifyTestData(fullDate);
      
      // ê²°ê³¼ ë©”ì‹œì§€
      const resultMessage = `âœ… ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!\n\n` +
        `ë‚ ì§œ: ${shortDate}\n` +
        `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
        `1. ì‹¸ì´ë²„ìŠ¤ì¹´ì´: ${cyberskyResult.rowCount}í–‰\n` +
        `2. EDI: ${ediResult.rowCount}í–‰\n` +
        `3. ì²˜ë¦¬ëœ ë°ì´í„°: ${processResult.processedRows}í–‰\n` +
        `4. ê²€ì‚°: ${verifyResult.success ? 'ì„±ê³µ âœ…' : 'ì‹¤íŒ¨ âŒ'}\n` +
        `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
        `ìƒì„±ëœ ì‹œíŠ¸:\n` +
        `- TEST_${fullDate}_ì‹¸ì´ë²„ìŠ¤ì¹´ì´\n` +
        `- TEST_${shortDate}_EDI\n` +
        `- TEST_${fullDate}_ìˆ˜ê¸°ì†¡ì¥`;
      
      ui.alert(resultMessage);
      
    } catch (error) {
      ui.alert('âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.toString());
    }
  },
  
  /**
   * í…ŒìŠ¤íŠ¸ ë°ì´í„° ì²˜ë¦¬
   */
  processTestData: function(fullDate, shortDate) {
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      
      // í…ŒìŠ¤íŠ¸ ì‹œíŠ¸ ì´ë¦„
      const aSheetName = `TEST_${fullDate}_ì‹¸ì´ë²„ìŠ¤ì¹´ì´`;
      const bSheetName = `TEST_${shortDate}_EDI`;
      const cSheetName = `TEST_${fullDate}_ìˆ˜ê¸°ì†¡ì¥`;
      
      const aSheet = spreadsheet.getSheetByName(aSheetName);
      const bSheet = spreadsheet.getSheetByName(bSheetName);
      
      if (!aSheet || !bSheet) {
        return {
          success: false,
          error: 'Aì‹œíŠ¸ ë˜ëŠ” Bì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
        };
      }
      
      // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const sheetAData = aSheet.getDataRange().getValues();
      const sheetBData = bSheet.getDataRange().getValues();
      
      if (!sheetAData || sheetAData.length < 2) {
        throw new Error('Aì‹œíŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
      
      if (!sheetBData || sheetBData.length < 2) {
        throw new Error('Bì‹œíŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
      
      // í—¤ë”ì™€ ë°ì´í„° ë¶„ë¦¬
      const sheetAHeaders = sheetAData[0];
      let sheetARows = sheetAData.slice(1);
      
      const sheetBHeaders = sheetBData[0];
      const sheetBRows = sheetBData.slice(1);
      
      // ì—´ ë§¤í•‘
      const colA = CyberskyData.getSheetAColumnMapping(sheetAHeaders);
      const colB = EDIData.getSheetBColumnMapping(sheetBHeaders);
      
      // DataProcessorì˜ ì²˜ë¦¬ ë¡œì§ ì¬ì‚¬ìš©
      const processedBRows = DataProcessor.processBSheetData(sheetBRows, colB);
      sheetARows = DataProcessor.processASheetData(sheetARows, colA);
      sheetARows = DataProcessor.adjustQuantities(sheetARows, processedBRows, colA, colB);
      sheetARows = sheetARows.filter(row => row[colA['ORDERCNT']] > 0);
      
      // Cì‹œíŠ¸ ìƒì„±
      let cSheet = spreadsheet.getSheetByName(cSheetName);
      if (cSheet) {
        spreadsheet.deleteSheet(cSheet);
      }
      
      cSheet = spreadsheet.insertSheet(cSheetName);
      
      // Cì‹œíŠ¸ í—¤ë” ì„¤ì •
      const headers = [
        'ë³´ë‚´ì‹œëŠ” ë¶„', 'ë³´ë‚´ì‹œëŠ” ë¶„ ì „í™”', 'ë³´ë‚´ì‹œëŠ” ë¶„ í•¸ë“œí°', 'íœ´ëŒ€í°ë²ˆí˜¸',
        'ë³´ë‚´ëŠ”ë¶„ìš°í¸ë²ˆí˜¸', 'ë³´ë‚´ëŠ”ë¶„ì´ì£¼ì†Œ', 'ë°›ìœ¼ì‹œëŠ” ë¶„', 'ë°›ìœ¼ì‹œëŠ” ë¶„ ì „í™”',
        'ë°›ìœ¼ì‹œëŠ” ë¶„ ìš°í¸', 'ë°›ëŠ”ë¶„í•¸ë“œí°', 'ë°›ëŠ”ë¶„ìš°í¸ë²ˆí˜¸', 'ë°›ëŠ”ë¶„ì´ì£¼ì†Œ',
        'ìˆ˜ëŸ‰', 'í’ˆëª©ëª…', 'ë©”ëª¨', 'ìš´ì„ì¢…ë¥˜', 'íƒë°°ì‚¬'
      ];
      
      cSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      
      // ë°ì´í„° ë³€í™˜ ë° ì…ë ¥
      const newRows = [];
      for (const row of sheetARows) {
        const newRow = [
          row[colA['ORDERER']] || '',
          row[colA['PHONE']] || '',
          '',
          '',
          CONFIG.SENDER_POSTAL_CODE,
          CONFIG.SENDER_ADDRESS,
          row[colA['RECEIVER']] || '',
          '',
          '',
          row[colA['CELL']] || '',
          row[colA['POST_NO']] || '',
          row[colA['ì£¼ì†Œ']] || '',
          row[colA['ORDERCNT']] || 0,
          row[colA['PROD_NAME']] || '',
          '',
          '',
          ''
        ];
        newRows.push(newRow);
      }
      
      if (newRows.length > 0) {
        cSheet.getRange(2, 1, newRows.length, newRows[0].length).setValues(newRows);
      }
      
      return {
        success: true,
        processedRows: sheetARows.length
      };
      
    } catch (error) {
      return {
        success: false,
        error: error.toString()
      };
    }
  },
  
  /**
   * í…ŒìŠ¤íŠ¸ ë°ì´í„° ê²€ì‚°
   */
  verifyTestData: function(fullDate) {
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      
      // TEST ì‹œíŠ¸ë“¤ ì°¾ê¸°
      const aSheet = spreadsheet.getSheetByName(`TEST_${fullDate}_ì‹¸ì´ë²„ìŠ¤ì¹´ì´`);
      const cSheet = spreadsheet.getSheetByName(`TEST_${fullDate}_ìˆ˜ê¸°ì†¡ì¥`);
      
      if (!aSheet || !cSheet) {
        return {
          success: false,
          message: 'ê²€ì‚°í•  ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
        };
      }
      
      // ê°„ë‹¨í•œ ê²€ì‚° (í–‰ ìˆ˜ ë¹„êµ)
      const aRows = aSheet.getLastRow() - 1; // í—¤ë” ì œì™¸
      const cRows = cSheet.getLastRow() - 1; // í—¤ë” ì œì™¸
      
      return {
        success: cRows > 0,
        message: `Aì‹œíŠ¸: ${aRows}í–‰, Cì‹œíŠ¸: ${cRows}í–‰`
      };
      
    } catch (error) {
      return {
        success: false,
        message: error.toString()
      };
    }
  },
  
  /**
   * ìµœê·¼ EDI í…ŒìŠ¤íŠ¸ (ê¸°ì¡´ í•¨ìˆ˜)
   */
  testGetRecentEDI: function() {
    try {
      initializeConfig();
      const testDate = '0728';
      const result = EDIData.getEDIFromEmail(testDate);
      
      if (result.success) {
        SpreadsheetApp.getUi().alert('âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ!\n' + testDate + ' EDI ë°ì´í„°ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.');
      } else {
        SpreadsheetApp.getUi().alert('âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + result.error);
      }
    } catch (error) {
      SpreadsheetApp.getUi().alert('âŒ ì˜¤ë¥˜: ' + error.toString());
    }
  },
  
  /**
   * í…ŒìŠ¤íŠ¸ ì‹œíŠ¸ ì •ë¦¬
   */
  cleanTestSheets: function() {
    const ui = SpreadsheetApp.getUi();
    const response = ui.alert(
      'ğŸ§¹ í…ŒìŠ¤íŠ¸ ì‹œíŠ¸ ì •ë¦¬',
      'TEST_ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ì‹œíŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) {
      return;
    }
    
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const sheets = spreadsheet.getSheets();
      let deletedCount = 0;
      
      for (const sheet of sheets) {
        if (sheet.getName().startsWith('TEST_')) {
          spreadsheet.deleteSheet(sheet);
          deletedCount++;
        }
      }
      
      ui.alert(`âœ… ${deletedCount}ê°œì˜ í…ŒìŠ¤íŠ¸ ì‹œíŠ¸ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`);
      
    } catch (error) {
      ui.alert('âŒ ì •ë¦¬ ì‹¤íŒ¨: ' + error.toString());
    }
  }
};
