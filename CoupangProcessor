/**
 * ì¿ íŒ¡ ë°ì´í„° ì²˜ë¦¬
 * CoupangProcessor.gs
 */

const CoupangProcessor = {
  /**
   * ì¿ íŒ¡ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ (HTMLì—ì„œ í˜¸ì¶œ)
   */
  processCoupangFile: function(fileData, fileName) {
    try {
      // Base64 ë””ì½”ë”©
      const blob = Utilities.newBlob(Utilities.base64Decode(fileData), 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', fileName);
      
      // ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥
      const tempFile = DriveApp.createFile(blob);
      tempFile.setName('temp_coupang_' + fileName);
      
      // Google Sheetsë¡œ ë³€í™˜
      const todayFull = getTodayDate();
      const resource = {
        title: todayFull + '_ê°„í¸ì‹_ì¿ íŒ¡',
        mimeType: MimeType.GOOGLE_SHEETS
      };
      
      const fileId = tempFile.getId();
      const convertedFile = Drive.Files.copy(resource, fileId);
      
      // ì„ì‹œ íŒŒì¼ ì‚­ì œ
      DriveApp.getFileById(fileId).setTrashed(true);
      
      // ë³€í™˜ëœ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°
      const coupangSpreadsheet = SpreadsheetApp.openById(convertedFile.id);
      const deliverySheet = coupangSpreadsheet.getSheetByName('Delivery') || coupangSpreadsheet.getSheets()[0];
      
      // ë°ì´í„° ì½ê¸°
      const coupangData = deliverySheet.getDataRange().getValues();
      
      // ì¿ íŒ¡ ë°ì´í„°ë¥¼ ìˆ˜ê¸°ì†¡ì¥ì— ì¶”ê°€
      const result = this.addCoupangDataToManualInvoice(coupangData);
      
      // ë“œë¼ì´ë¸Œ í´ë”ë¡œ ì´ë™
      this.moveCoupangFileToFolder(convertedFile.id, todayFull);
      
      return result;
      
    } catch (error) {
      return {
        success: false,
        error: error.toString()
      };
    }
  },
  
  /**
   * ì¿ íŒ¡ ë°ì´í„°ë¥¼ ìˆ˜ê¸°ì†¡ì¥ì— ì¶”ê°€
   */
  addCoupangDataToManualInvoice: function(coupangData) {
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      
      // ë‚ ì§œ ì¶”ì¶œ
      let datePrefix = getTodayDate();
      const sheets = spreadsheet.getSheets();
      
      for (const sheet of sheets) {
        const name = sheet.getName();
        if ((name.includes('_ê°„í¸ì‹_ìˆ˜ê¸°ì†¡ì¥') || name.includes(' ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥')) && !name.startsWith('TEST_')) {
          datePrefix = name.split(/[ _]/)[0];
          break;
        }
      }
      
      const manualSheetName = datePrefix + '_ê°„í¸ì‹_ìˆ˜ê¸°ì†¡ì¥';
      const manualSheetNameOld = datePrefix + ' ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥'; // ê¸°ì¡´ í˜•ì‹ í˜¸í™˜
      
      let manualSheet = spreadsheet.getSheetByName(manualSheetName);
      
      // ìƒˆ í˜•ì‹ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ í˜•ì‹ ì‹œë„
      if (!manualSheet) {
        manualSheet = spreadsheet.getSheetByName(manualSheetNameOld);
      }
      
      if (!manualSheet) {
        throw new Error('ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + manualSheetName + ' ë˜ëŠ” ' + manualSheetNameOld);
      }
      
      // ì¿ íŒ¡ ë°ì´í„° í—¤ë”ì™€ ì—´ ë§¤í•‘
      const coupangHeaders = coupangData[0];
      const coupangRows = coupangData.slice(1);
      const coupangMapping = this.getCoupangColumnMapping(coupangHeaders);
      
      // ìˆ˜ê¸°ì†¡ì¥ í—¤ë” ë§¤í•‘
      const manualHeaders = manualSheet.getRange(1, 1, 1, manualSheet.getLastColumn()).getValues()[0];
      const manualMapping = this.getManualColumnMapping(manualHeaders);
      
      // ë³€í™˜ëœ ë°ì´í„° ìƒì„±
      const newRows = [];
      for (const row of coupangRows) {
        if (!row[coupangMapping.productName]) continue;
        
        const convertedRow = this.convertCoupangRow(row, coupangMapping, manualHeaders.length);
        if (convertedRow) {
          newRows.push(convertedRow);
        }
      }
      
      // ìˆ˜ê¸°ì†¡ì¥ì— ë°ì´í„° ì¶”ê°€
      if (newRows.length > 0) {
        const lastRow = manualSheet.getLastRow();
        manualSheet.getRange(lastRow + 1, 1, newRows.length, newRows[0].length).setValues(newRows);
        
        // ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì—…ë°ì´íŠ¸
        const verificationUpdate = this.updateVerificationSheetWithCoupang(datePrefix, coupangRows, coupangMapping);
        console.log('ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ê²°ê³¼:', verificationUpdate);
      }
      
      return {
        success: true,
        rowsAdded: newRows.length,
        message: `ì¿ íŒ¡ ë°ì´í„° ${newRows.length}í–‰ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`
      };
      
    } catch (error) {
      return {
        success: false,
        error: error.toString()
      };
    }
  },
  
  /**
   * ì¿ íŒ¡ ì—´ ë§¤í•‘
   */
  getCoupangColumnMapping: function(headers) {
    const mapping = {};
    
    // í—¤ë”ë¡œ ì°¾ê¸°
    headers.forEach((header, index) => {
      const cleanHeader = String(header).trim();
      
      // Pì—´: ìƒí’ˆëª…
      if (index === 15 || cleanHeader.includes('ì œë™í•œìš°') || cleanHeader.includes('ìƒí’ˆëª…')) {
        mapping.productName = index;
      }
      // Wì—´: êµ¬ë§¤ìˆ˜(ìˆ˜ëŸ‰)
      if (index === 22 || cleanHeader === 'êµ¬ë§¤ìˆ˜' || cleanHeader === 'ìˆ˜ëŸ‰') {
        mapping.quantity = index;
      }
      // Yì—´: êµ¬ë§¤ì
      if (index === 24 || cleanHeader === 'êµ¬ë§¤ì') {
        mapping.buyer = index;
      }
      // Zì—´: êµ¬ë§¤ìì „í™”ë²ˆí˜¸
      if (index === 25 || cleanHeader === 'êµ¬ë§¤ìì „í™”ë²ˆí˜¸') {
        mapping.buyerPhone = index;
      }
      // AAì—´: ìˆ˜ì·¨ì¸ì´ë¦„
      if (index === 26 || cleanHeader === 'ìˆ˜ì·¨ì¸ì´ë¦„' || cleanHeader === 'ìˆ˜ì·¨ì¸') {
        mapping.receiverName = index;
      }
      // ABì—´: ìˆ˜ì·¨ì¸ì „í™”ë²ˆí˜¸
      if (index === 27 || cleanHeader === 'ìˆ˜ì·¨ì¸ì „í™”ë²ˆí˜¸') {
        mapping.receiverPhone = index;
      }
      // ACì—´: ìš°í¸ë²ˆí˜¸
      if (index === 28 || cleanHeader === 'ìš°í¸ë²ˆí˜¸') {
        mapping.postalCode = index;
      }
      // ADì—´: ìˆ˜ì·¨ì¸ ì£¼ì†Œ
      if (index === 29 || cleanHeader.includes('ìˆ˜ì·¨ì¸') && cleanHeader.includes('ì£¼ì†Œ')) {
        mapping.address = index;
      }
    });
    
    // ì¸ë±ìŠ¤ë¡œ ë³´ì • (í—¤ë”ë¥¼ ëª» ì°¾ì•˜ì„ ê²½ìš°)
    if (!mapping.productName) mapping.productName = 15; // Pì—´
    if (!mapping.quantity) mapping.quantity = 22; // Wì—´
    if (!mapping.buyer) mapping.buyer = 24; // Yì—´
    if (!mapping.buyerPhone) mapping.buyerPhone = 25; // Zì—´
    if (!mapping.receiverName) mapping.receiverName = 26; // AAì—´
    if (!mapping.receiverPhone) mapping.receiverPhone = 27; // ABì—´
    if (!mapping.postalCode) mapping.postalCode = 28; // ACì—´
    if (!mapping.address) mapping.address = 29; // ADì—´
    
    return mapping;
  },
  
  /**
   * ìˆ˜ê¸°ì†¡ì¥ ì—´ ë§¤í•‘
   */
  getManualColumnMapping: function(headers) {
    const mapping = {};
    
    headers.forEach((header, index) => {
      if (header === 'ë³´ë‚´ì‹œëŠ” ë¶„') mapping.senderName = index;
      if (header === 'ë³´ë‚´ì‹œëŠ” ë¶„ ì „í™”') mapping.senderPhone = index;
      if (header === 'ë°›ìœ¼ì‹œëŠ” ë¶„') mapping.receiverName = index;
      if (header === 'ë°›ìœ¼ì‹œëŠ” ë¶„ ì „í™”') mapping.receiverPhone1 = index;
      if (header === 'ë°›ëŠ”ë¶„í•¸ë“œí°') mapping.receiverPhone2 = index;
      if (header === 'ë°›ëŠ”ë¶„ìš°í¸ë²ˆí˜¸') mapping.postalCode = index;
      if (header === 'ë°›ëŠ”ë¶„ì´ì£¼ì†Œ') mapping.address = index;
      if (header === 'ìˆ˜ëŸ‰') mapping.quantity = index;
      if (header === 'í’ˆëª©ëª…') mapping.productName = index;
    });
    
    // ê¸°ë³¸ê°’ ì„¤ì • (ì°¾ì§€ ëª»í•œ ê²½ìš°)
    if (mapping.senderName === undefined) mapping.senderName = 0; // Aì—´
    if (mapping.senderPhone === undefined) mapping.senderPhone = 1; // Bì—´
    if (mapping.receiverName === undefined) mapping.receiverName = 6; // Gì—´
    if (mapping.receiverPhone1 === undefined) mapping.receiverPhone1 = 7; // Hì—´
    if (mapping.receiverPhone2 === undefined) mapping.receiverPhone2 = 9; // Jì—´
    if (mapping.postalCode === undefined) mapping.postalCode = 10; // Kì—´
    if (mapping.address === undefined) mapping.address = 11; // Lì—´
    if (mapping.quantity === undefined) mapping.quantity = 12; // Mì—´
    if (mapping.productName === undefined) mapping.productName = 13; // Nì—´
    
    return mapping;
  },
  
  /**
   * ì¿ íŒ¡ í–‰ ë³€í™˜
   */
  convertCoupangRow: function(coupangRow, coupangMapping, numColumns) {
    const productNameRaw = String(coupangRow[coupangMapping.productName] || '');
    
    // ìƒí’ˆëª… ë³€í™˜
    let convertedProductName = '';
    if (productNameRaw.includes('ì‚¬ê³¨ê³ ê¸°ê³°íƒ•') && productNameRaw.includes('5ê°œ')) {
      convertedProductName = 'ì œë™ ì‚¬ê³¨ê³ ê¸°ê³°íƒ•(5íŒ© 1ì„¸íŠ¸)';
    } else if (productNameRaw.includes('ì‚¬ê³¨ê³°íƒ•') && productNameRaw.includes('5ê°œ')) {
      convertedProductName = 'ì œë™ ì‚¬ê³¨ê³°íƒ•(5íŒ© 1ì„¸íŠ¸)';
    } else if (productNameRaw.includes('ì‚¬ê³¨ê³°íƒ•') && productNameRaw.includes('10ê°œ')) {
      convertedProductName = 'ì œë™ ì‚¬ê³¨ê³°íƒ•(10íŒ© 1ì„¸íŠ¸)';
    } else if (productNameRaw.includes('ì‚¬ê³¨ê³°íƒ•') && productNameRaw.includes('20ê°œ')) {
      convertedProductName = 'ì œë™ ì‚¬ê³¨ê³°íƒ•(20íŒ© 1ì„¸íŠ¸)';
    } else if (productNameRaw.includes('ìœ¡í¬') && productNameRaw.includes('5ê°œ')) {
      convertedProductName = 'ì œë™í•œìš° ìœ¡í¬(5íŒ© 1ì„¸íŠ¸)';
    } else {
      // ë³€í™˜í•  ìˆ˜ ì—†ëŠ” ìƒí’ˆì€ ê±´ë„ˆë›°ê¸°
      return null;
    }
    
    // ìƒˆ í–‰ ìƒì„±
    const newRow = new Array(numColumns).fill('');
    
    newRow[0] = coupangRow[coupangMapping.buyer] || ''; // A: ë³´ë‚´ì‹œëŠ” ë¶„
    newRow[1] = coupangRow[coupangMapping.buyerPhone] || ''; // B: ë³´ë‚´ì‹œëŠ” ë¶„ ì „í™”
    newRow[4] = CONFIG.SENDER_POSTAL_CODE; // E: ë³´ë‚´ëŠ”ë¶„ìš°í¸ë²ˆí˜¸
    newRow[5] = CONFIG.SENDER_ADDRESS; // F: ë³´ë‚´ëŠ”ë¶„ì´ì£¼ì†Œ
    newRow[6] = coupangRow[coupangMapping.receiverName] || ''; // G: ë°›ìœ¼ì‹œëŠ” ë¶„
    newRow[7] = coupangRow[coupangMapping.receiverPhone] || ''; // H: ë°›ìœ¼ì‹œëŠ” ë¶„ ì „í™”
    newRow[9] = coupangRow[coupangMapping.receiverPhone] || ''; // J: ë°›ëŠ”ë¶„í•¸ë“œí°
    newRow[10] = coupangRow[coupangMapping.postalCode] || ''; // K: ë°›ëŠ”ë¶„ìš°í¸ë²ˆí˜¸
    newRow[11] = coupangRow[coupangMapping.address] || ''; // L: ë°›ëŠ”ë¶„ì´ì£¼ì†Œ
    newRow[12] = coupangRow[coupangMapping.quantity] || 0; // M: ìˆ˜ëŸ‰
    newRow[13] = convertedProductName; // N: í’ˆëª©ëª…
    newRow[18] = 'ì¿ íŒ¡'; // S: ë©”ëª¨1 (ì¿ íŒ¡ ë§ˆí‚¹)
    
    console.log('Coupang row converted with ì¿ íŒ¡ marker:', { productName: convertedProductName, quantity: newRow[12] });
    
    return newRow;
  },
  
  /**
   * ì¿ íŒ¡ íŒŒì¼ì„ ë‚ ì§œ í´ë”ë¡œ ì´ë™
   */
  moveCoupangFileToFolder: function(fileId, dateString) {
    try {
      const file = DriveApp.getFileById(fileId);
      const parentFolderId = CONFIG.FOLDER_ID;
      const parentFolder = DriveApp.getFolderById(parentFolderId);
      
      // ë‚ ì§œ í´ë” ì°¾ê¸° ë˜ëŠ” ìƒì„±
      const folders = parentFolder.getFoldersByName(dateString);
      let dateFolder;
      
      if (folders.hasNext()) {
        dateFolder = folders.next();
      } else {
        dateFolder = parentFolder.createFolder(dateString);
      }
      
      // íŒŒì¼ ì´ë™
      dateFolder.addFile(file);
      DriveApp.getRootFolder().removeFile(file);
      
    } catch (error) {
      console.error('ì¿ íŒ¡ íŒŒì¼ ì´ë™ ì‹¤íŒ¨:', error);
    }
  },

  /**
   * ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì— ì¿ íŒ¡ ë°ì´í„° ì—…ë°ì´íŠ¸
   */
  updateVerificationSheetWithCoupang: function(datePrefix, coupangRows, coupangMapping) {
    console.log('=== ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì¿ íŒ¡ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œì‘ ===');
    
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const verificationSheetName = `${datePrefix}_ê²€ì‚°ê²°ê³¼`;
      let verificationSheet = spreadsheet.getSheetByName(verificationSheetName);
      
      if (!verificationSheet) {
        console.log(`âš ï¸ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì—†ìŒ: ${verificationSheetName}`);
        return { success: false, error: `ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${verificationSheetName}` };
      }
      
      console.log(`âœ… ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ë°œê²¬: ${verificationSheetName}`);
      
      // Hì—´ê³¼ Iì—´ í—¤ë” ì¶”ê°€/í™•ì¸ ë° ìŠ¤íƒ€ì¼ë§
      const headerRow = verificationSheet.getRange(1, 1, 1, Math.max(verificationSheet.getLastColumn(), 9)).getValues()[0];
      
      // Hì—´(7)ì— "ì¿ íŒ¡" í—¤ë”ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
      if (!headerRow[7] || String(headerRow[7]).trim() !== 'ì¿ íŒ¡') {
        const headerCell = verificationSheet.getRange(1, 8);
        headerCell.setValue('ì¿ íŒ¡');
        
        // ê¸°ì¡´ í—¤ë” ìŠ¤íƒ€ì¼ê³¼ ì¼ì¹˜ì‹œí‚¤ê¸°
        const existingHeaderStyle = verificationSheet.getRange(1, 1);
        headerCell.setBackground(existingHeaderStyle.getBackground());
        headerCell.setFontColor(existingHeaderStyle.getFontColor());
        headerCell.setFontWeight(existingHeaderStyle.getFontWeight());
        headerCell.setHorizontalAlignment('center');
        headerCell.setBorder(true, true, true, true, false, false);
        
        console.log('Hì—´ì— "ì¿ íŒ¡" í—¤ë” ì¶”ê°€ (ìŠ¤íƒ€ì¼ ì ìš©)');
      }
      
      // Iì—´(8)ì— "MMDD ì¶œê³ ìˆ˜ëŸ‰" í—¤ë”ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
      const mmdd = datePrefix.substring(4); // YYYYMMDDì—ì„œ MMDD ì¶”ì¶œ
      const expectedHeader = `${mmdd} ì¶œê³ ìˆ˜ëŸ‰`;
      if (!headerRow[8] || String(headerRow[8]).trim() !== expectedHeader) {
        const headerCell = verificationSheet.getRange(1, 9);
        headerCell.setValue(expectedHeader);
        
        // ê¸°ì¡´ í—¤ë” ìŠ¤íƒ€ì¼ê³¼ ì¼ì¹˜ì‹œí‚¤ê¸°
        const existingHeaderStyle = verificationSheet.getRange(1, 1);
        headerCell.setBackground(existingHeaderStyle.getBackground());
        headerCell.setFontColor(existingHeaderStyle.getFontColor());
        headerCell.setFontWeight(existingHeaderStyle.getFontWeight());
        headerCell.setHorizontalAlignment('center');
        headerCell.setBorder(true, true, true, true, false, false);
        
        console.log(`Iì—´ì— "${expectedHeader}" í—¤ë” ì¶”ê°€ (ìŠ¤íƒ€ì¼ ì ìš©)`);
      }
      
      // ì¿ íŒ¡ ì œí’ˆë³„ ìˆ˜ëŸ‰ ê³„ì‚°
      const coupangProductQuantities = {};
      
      for (const row of coupangRows) {
        const productName = String(row[coupangMapping.productName] || '').trim();
        const quantity = parseInt(row[coupangMapping.quantity] || 0);
        
        if (productName && quantity > 0) {
          console.log(`ì¿ íŒ¡ ì œí’ˆ ë°œê²¬: "${productName}" / ìˆ˜ëŸ‰=${quantity}`);
          
          // ì œí’ˆëª… ì •ê·œí™”
          const normalizedProduct = this.normalizeCoupangProductName(productName);
          if (normalizedProduct) {
            if (!coupangProductQuantities[normalizedProduct]) {
              coupangProductQuantities[normalizedProduct] = 0;
            }
            coupangProductQuantities[normalizedProduct] += quantity;
            console.log(`ì •ê·œí™”: "${productName}" â†’ "${normalizedProduct}" (+${quantity})`);
          } else {
            console.log(`âš ï¸ ì œí’ˆëª… ì •ê·œí™” ì‹¤íŒ¨: "${productName}"`);
          }
        }
      }
      
      console.log('ì¿ íŒ¡ ì œí’ˆë³„ ìˆ˜ëŸ‰:', JSON.stringify(coupangProductQuantities, null, 2));
      
      // ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì—ì„œ ëª¨ë“  ì œí’ˆì— ëŒ€í•´ ì´ ì¶œê³ ìˆ˜ëŸ‰ ê³„ì‚°
      const data = verificationSheet.getDataRange().getValues();
      let updatedCount = 0;
      
      for (let i = 1; i < data.length; i++) { // í—¤ë” ì œì™¸
        const row = data[i];
        const verificationProductName = String(row[1] || '').trim(); // Bì—´: í’ˆëª©ëª…
        
        if (verificationProductName) {
          // Fì—´(5): ì‹¸ì´ë²„ìŠ¤ì¹´ì´ í•©ê³„ ìˆ˜ëŸ‰ ì½ê¸°
          const cyberskyQuantity = parseInt(row[5] || 0);
          
          // ì¿ íŒ¡ ìˆ˜ëŸ‰ í™•ì¸
          const normalizedVerificationProduct = this.normalizeCoupangProductName(verificationProductName);
          const coupangQuantity = (normalizedVerificationProduct && coupangProductQuantities[normalizedVerificationProduct]) 
            ? coupangProductQuantities[normalizedVerificationProduct] : 0;
          
          // ì´ ì¶œê³ ìˆ˜ëŸ‰ ê³„ì‚°
          const totalQuantity = cyberskyQuantity + coupangQuantity;
          
          // Hì—´(7)ì— ì¿ íŒ¡ ìˆ˜ëŸ‰ ì„¤ì • (0ì´ì–´ë„ ì„¤ì •)
          verificationSheet.getRange(i + 1, 8).setValue(coupangQuantity);
          
          // Iì—´(8)ì— ì´ ì¶œê³ ìˆ˜ëŸ‰ ì„¤ì • (ëª¨ë“  í–‰ì— ì„¤ì •)
          verificationSheet.getRange(i + 1, 9).setValue(totalQuantity);
          
          console.log(`ì—…ë°ì´íŠ¸: "${verificationProductName}" | ì‹¸ì´ë²„ìŠ¤ì¹´ì´: ${cyberskyQuantity} + ì¿ íŒ¡: ${coupangQuantity} = ì´: ${totalQuantity}`);
          updatedCount++;
        }
      }
      
      // ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì— ì—†ëŠ” ì¿ íŒ¡ ì œí’ˆë“¤ ìƒˆë¡œ ì¶”ê°€
      const newProductsToAdd = [];
      for (const [productName, quantity] of Object.entries(coupangProductQuantities)) {
        let found = false;
        
        // ê¸°ì¡´ í–‰ì—ì„œ ì°¾ê¸°
        for (let i = 1; i < data.length; i++) {
          const verificationProductName = String(data[i][1] || '').trim();
          const normalizedVerificationProduct = this.normalizeCoupangProductName(verificationProductName);
          
          if (normalizedVerificationProduct === productName) {
            found = true;
            break;
          }
        }
        
        // ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€í•  ëª©ë¡ì— í¬í•¨
        if (!found) {
          const displayName = this.getDisplayNameFromNormalized(productName);
          newProductsToAdd.push([
            '', // Aì—´: ë¹ˆê°’
            displayName, // Bì—´: í’ˆëª©ëª…
            '', '', '', '', '', // C~Gì—´: ë¹ˆê°’ë“¤
            quantity, // Hì—´: ì¿ íŒ¡ ìˆ˜ëŸ‰
            quantity // Iì—´: ì´ ì¶œê³ ìˆ˜ëŸ‰ (ì¿ íŒ¡ë§Œ)
          ]);
          console.log(`ìƒˆ ì œí’ˆ ì¶”ê°€: "${displayName}" | ì¿ íŒ¡: ${quantity}`);
        }
      }
      
      // ìƒˆ ì œí’ˆë“¤ì„ ì •ë ¬ëœ ìœ„ì¹˜ì— ì‚½ì…
      if (newProductsToAdd.length > 0) {
        this.insertNewProductsInSortedOrder(verificationSheet, newProductsToAdd);
        console.log(`${newProductsToAdd.length}ê°œ ì‹ ê·œ ì¿ íŒ¡ ì œí’ˆì„ ì •ë ¬ëœ ìœ„ì¹˜ì— ì¶”ê°€`);
      }
      
      const totalProcessed = updatedCount + newProductsToAdd.length;
      console.log(`âœ… ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ê¸°ì¡´ ${updatedCount}ê°œ ì—…ë°ì´íŠ¸, ì‹ ê·œ ${newProductsToAdd.length}ê°œ ì¶”ê°€`);
      
      return {
        success: true,
        updatedCount: updatedCount,
        newProductsAdded: newProductsToAdd.length,
        totalProcessed: totalProcessed,
        message: `ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ (ì—…ë°ì´íŠ¸: ${updatedCount}, ì‹ ê·œ: ${newProductsToAdd.length})`
      };
      
    } catch (error) {
      console.error('ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: error.toString()
      };
    }
  },

  /**
   * ì¿ íŒ¡ ì œí’ˆëª… ì •ê·œí™”
   */
  normalizeCoupangProductName: function(productName) {
    if (productName.includes('ì‚¬ê³¨ê³ ê¸°ê³°íƒ•')) {
      return 'ì‚¬ê³¨ê³ ê¸°ê³°íƒ•5ê°œì…';
    }
    else if (productName.includes('ì‚¬ê³¨ê³°íƒ•') && (productName.includes('20íŒ©') || productName.includes('20ê°œì…'))) {
      return 'ì‚¬ê³¨ê³°íƒ•20ê°œì…';
    }
    else if (productName.includes('ì‚¬ê³¨ê³°íƒ•') && (productName.includes('10íŒ©') || productName.includes('10ê°œì…'))) {
      return 'ì‚¬ê³¨ê³°íƒ•10ê°œì…';
    }
    else if (productName.includes('ì‚¬ê³¨ê³°íƒ•') && !productName.includes('ì‚¬ê³¨ê³ ê¸°ê³°íƒ•') && 
            (productName.includes('5íŒ©') || productName.includes('5ê°œì…') || productName.includes('1ë°•ìŠ¤'))) {
      return 'ì‚¬ê³¨ê³°íƒ•5ê°œì…';
    }
    else if (productName.includes('ìœ¡í¬')) {
      return 'ìœ¡í¬5ê°œì…';
    }
    
    return null;
  },

  /**
   * ì •ê·œí™”ëœ ì œí’ˆëª…ì„ í‘œì‹œìš© ì´ë¦„ìœ¼ë¡œ ë³€í™˜ (ê´„í˜¸ ì• ê³µë°± í¬í•¨)
   */
  getDisplayNameFromNormalized: function(normalizedName) {
    const displayMap = {
      'ì‚¬ê³¨ê³ ê¸°ê³°íƒ•5ê°œì…': 'ì œë™ ì‚¬ê³¨ê³ ê¸°ê³°íƒ• (5íŒ© 1ì„¸íŠ¸)',
      'ì‚¬ê³¨ê³°íƒ•5ê°œì…': 'ì œë™ ì‚¬ê³¨ê³°íƒ• (5íŒ© 1ì„¸íŠ¸)',
      'ì‚¬ê³¨ê³°íƒ•10ê°œì…': 'ì œë™ ì‚¬ê³¨ê³°íƒ• (10íŒ© 1ì„¸íŠ¸)',
      'ì‚¬ê³¨ê³°íƒ•20ê°œì…': 'ì œë™ ì‚¬ê³¨ê³°íƒ• (20íŒ© 1ì„¸íŠ¸)',
      'ìœ¡í¬5ê°œì…': 'ì œë™í•œìš° ìœ¡í¬ (5íŒ© 1ì„¸íŠ¸)'
    };
    
    return displayMap[normalizedName] || normalizedName;
  },

  /**
   * ì œí’ˆ íƒ€ì…ì— ë”°ë¥¸ ì •ë ¬ ìš°ì„ ìˆœìœ„ ë°˜í™˜
   */
  getProductSortPriority: function(normalizedName) {
    const priorities = {
      'ì‚¬ê³¨ê³ ê¸°ê³°íƒ•5ê°œì…': 1,
      'ì‚¬ê³¨ê³°íƒ•5ê°œì…': 2,
      'ì‚¬ê³¨ê³°íƒ•10ê°œì…': 3,
      'ì‚¬ê³¨ê³°íƒ•20ê°œì…': 4,
      'ìœ¡í¬5ê°œì…': 5
    };
    
    return priorities[normalizedName] || 999;
  },

  /**
   * ìƒˆ ì¿ íŒ¡ ì œí’ˆì„ ì •ë ¬ëœ ìœ„ì¹˜ì— ì‚½ì…
   */
  insertNewProductsInSortedOrder: function(verificationSheet, newProductsToAdd) {
    console.log('=== ì •ë ¬ëœ ìœ„ì¹˜ì— ìƒˆ ì œí’ˆ ì‚½ì… ì‹œì‘ ===');
    
    if (newProductsToAdd.length === 0) {
      console.log('ì¶”ê°€í•  ì œí’ˆ ì—†ìŒ');
      return;
    }
    
    // ìƒˆ ì œí’ˆë“¤ì„ ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì •ë ¬
    newProductsToAdd.sort((a, b) => {
      const normalizedA = this.normalizeCoupangProductName(a[1]);
      const normalizedB = this.normalizeCoupangProductName(b[1]);
      const priorityA = this.getProductSortPriority(normalizedA);
      const priorityB = this.getProductSortPriority(normalizedB);
      return priorityA - priorityB;
    });
    
    const data = verificationSheet.getDataRange().getValues();
    let insertedCount = 0;
    
    for (const newProduct of newProductsToAdd) {
      const newProductNormalized = this.normalizeCoupangProductName(newProduct[1]);
      const newProductPriority = this.getProductSortPriority(newProductNormalized);
      
      // ì‚½ì…í•  ìœ„ì¹˜ ì°¾ê¸°
      let insertRowIndex = data.length; // ê¸°ë³¸ê°’: ë§¨ ì•„ë˜
      
      for (let i = 1; i < data.length; i++) { // í—¤ë” ì œì™¸
        const existingProductName = String(data[i][1] || '').trim();
        if (!existingProductName) continue;
        
        const existingNormalized = this.normalizeCoupangProductName(existingProductName);
        const existingPriority = this.getProductSortPriority(existingNormalized);
        
        if (newProductPriority < existingPriority) {
          insertRowIndex = i;
          break;
        } else if (newProductPriority === existingPriority) {
          // ê°™ì€ íƒ€ì…ì´ë©´ ê·¸ ê·¸ë£¹ì˜ ë§ˆì§€ë§‰ ìœ„ì¹˜ì— ì‚½ì…
          let j = i;
          while (j < data.length && 
                 this.getProductSortPriority(this.normalizeCoupangProductName(String(data[j][1] || '').trim())) === existingPriority) {
            j++;
          }
          insertRowIndex = j;
          break;
        }
      }
      
      console.log(`"${newProduct[1]}" ì œí’ˆì„ ${insertRowIndex + 1}ë²ˆì§¸ í–‰ì— ì‚½ì…`);
      
      // í–‰ ì‚½ì…
      verificationSheet.insertRowAfter(insertRowIndex);
      
      // ë°ì´í„° ì…ë ¥
      verificationSheet.getRange(insertRowIndex + 1, 1, 1, newProduct.length).setValues([newProduct]);
      
      // data ë°°ì—´ë„ ì—…ë°ì´íŠ¸ (ë‹¤ìŒ ì‚½ì…ì„ ìœ„í•´)
      data.splice(insertRowIndex, 0, newProduct);
      insertedCount++;
    }
    
    console.log(`âœ… ${insertedCount}ê°œ ì œí’ˆì„ ì •ë ¬ëœ ìœ„ì¹˜ì— ì‚½ì… ì™„ë£Œ`);
  }
};

/**
 * í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ ì‹œíŠ¸ëª…ì—ì„œ ì¶”ì¶œ)
 */
function getCurrentWorkingDate() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = spreadsheet.getSheets();
    
    // ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ì—ì„œ ë‚ ì§œ ì¶”ì¶œ
    for (const sheet of sheets) {
      const name = sheet.getName();
      if (name.includes('_ê°„í¸ì‹_ìˆ˜ê¸°ì†¡ì¥') && !name.startsWith('TEST_')) {
        const datePart = name.split('_')[0];
        if (datePart.length === 8 && /^\d{8}$/.test(datePart)) {
          return datePart.substring(4); // YYYYMMDDì—ì„œ MMDD ì¶”ì¶œ
        }
      }
    }
    
    // ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì—ì„œ ë‚ ì§œ ì¶”ì¶œ
    for (const sheet of sheets) {
      const name = sheet.getName();
      if (name.includes('_ê²€ì‚°ê²°ê³¼') && !name.startsWith('TEST_')) {
        const datePart = name.split('_')[0];
        if (datePart.length === 8 && /^\d{8}$/.test(datePart)) {
          return datePart.substring(4); // YYYYMMDDì—ì„œ MMDD ì¶”ì¶œ
        }
      }
    }
    
    // ê¸°ë³¸ê°’: ì˜¤ëŠ˜ ë‚ ì§œ
    return getTodayShortDate();
    
  } catch (error) {
    console.error('getCurrentWorkingDate ì˜¤ë¥˜:', error);
    return getTodayShortDate();
  }
}

/**
 * HTMLì—ì„œ í˜¸ì¶œí•  ì „ì—­ í•¨ìˆ˜ (CoupangUploaderìš©)
 */
function processCoupangFile(fileData, fileName) {
  console.log('=== Function Start: processCoupangFile ===');
  console.log('Parameters:', { fileName });
  
  try {
    const result = CoupangProcessor.processCoupangFile(fileData, fileName);
    console.log('Processing result:', result);
    console.log('=== Function End: processCoupangFile SUCCESS ===');
    return result;
    
  } catch (error) {
    console.error('ERROR in processCoupangFile:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Function End: processCoupangFile FAILED ===');
    return { success: false, error: error.toString() };
  }
}

/**
 * ì¿ íŒ¡ íŒŒì¼ ì²˜ë¦¬ í›„ ìë™ìœ¼ë¡œ ë‚˜ë¨¸ì§€ ê³¼ì • ì‹¤í–‰ (í†µí•© ì›Œí¬í”Œë¡œìš°ìš©)
 */
function processCoupangFileAndExecuteRemaining(fileData, fileName) {
  console.log('=== Function Start: processCoupangFileAndExecuteRemaining ===');
  console.log('Parameters:', { fileName });
  
  try {
    // 1. ì¿ íŒ¡ íŒŒì¼ ì²˜ë¦¬
    const coupangResult = CoupangProcessor.processCoupangFile(fileData, fileName);
    logUpdate('ğŸ›ï¸ ì¿ íŒ¡ ë°ì´í„° ì²˜ë¦¬', coupangResult);
    
    if (!coupangResult.success) {
      console.error('ì¿ íŒ¡ íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨:', coupangResult.error);
      return { success: false, error: 'ì¿ íŒ¡ íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨: ' + coupangResult.error };
    }
    
    // 2. í’ˆëª©ë³„ ë¶„í•  (í•„ìˆ˜) - í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚ ì§œ ì‚¬ìš©
    const currentDate = getCurrentWorkingDate();
    const splitResult = ProductSplitter.splitByProduct(currentDate);
    logUpdate('ğŸ“Š í’ˆëª©ë³„ ë¶„í• ', splitResult);
    
    if (!splitResult.success) {
      logUpdate('âŒ í’ˆëª©ë³„ ë¶„í•  ì‹¤íŒ¨ - ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨', splitResult);
      return { success: false, error: 'í’ˆëª©ë³„ ë¶„í•  ì‹¤íŒ¨: ' + splitResult.error };
    }
    
    // 3. í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ë° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ë™ì¼í•œ ë‚ ì§œ ì‚¬ìš©)
    const downloadResult = ProductDownloader.downloadProductSheets(currentDate);
    logUpdate('ğŸ“¥ í’ˆëª©ë³„ ì—‘ì…€ ìƒì„±', downloadResult);
    
    if (!downloadResult.success) {
      logUpdate('âš ï¸ í†µí•© ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨: ì—‘ì…€ ìƒì„± ì‹¤íŒ¨', downloadResult);
      return { success: false, error: 'ì—‘ì…€ ìƒì„± ì‹¤íŒ¨: ' + downloadResult.error };
    }
    
    // 4. ìë™ ì´ë©”ì¼ ì „ì†¡
    const emailResult = sendEmailWithProductSheets();
    logUpdate('ğŸ“§ ìë™ ì´ë©”ì¼ ì „ì†¡', emailResult);
    
    if (emailResult.success) {
      logUpdate('ğŸ‰ í†µí•© ì›Œí¬í”Œë¡œìš° ì „ì²´ ì™„ë£Œ!', {
        success: true,
        completedSteps: [
          'ê²€ì‚°ì™„ë£Œ',
          'ì¿ íŒ¡ì²˜ë¦¬',
          'í’ˆëª©ë³„ìƒì„±',
          'ì—‘ì…€ìƒì„±',
          'ì´ë©”ì¼ì „ì†¡'
        ],
        time: new Date().toLocaleString('ko-KR')
      });
      
      console.log('=== Function End: processCoupangFileAndExecuteRemaining SUCCESS ===');
      return { 
        success: true, 
        message: 'ëª¨ë“  ê³¼ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¶œê³  ìš”ì²­ ì´ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.' 
      };
    } else {
      logUpdate('âš ï¸ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨í•˜ì§€ë§Œ ë°ì´í„° ì²˜ë¦¬ëŠ” ì™„ë£Œ', emailResult);
      return { 
        success: false, 
        error: 'ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: ' + emailResult.error 
      };
    }
    
  } catch (error) {
    console.error('ERROR in processCoupangFileAndExecuteRemaining:', error.toString());
    console.error('Error stack:', error.stack);
    logUpdate('âŒ í†µí•© ì›Œí¬í”Œë¡œìš° ì˜¤ë¥˜', { success: false, error: error.toString() });
    console.log('=== Function End: processCoupangFileAndExecuteRemaining FAILED ===');
    return { success: false, error: error.toString() };
  }
}
