/**
 * ìë™ ì‹¤í–‰ íŠ¸ë¦¬ê±° ì„¤ì •
 * Triggers.gs
 */

/**
 * íŠ¸ë¦¬ê±° ì„¤ì • (ë©”ë‰´ì—ì„œ ì‹¤í–‰)
 */
function setupTriggers() {
  try {
    // ê¸°ì¡´ íŠ¸ë¦¬ê±° ì œê±° (ê¶Œí•œ ë¬¸ì œë¡œ ì¸í•´ try-catch ì²˜ë¦¬)
    try {
      removeTriggers();
    } catch (permissionError) {
      console.log('ê¸°ì¡´ íŠ¸ë¦¬ê±° í™•ì¸ ê¶Œí•œ ì—†ìŒ, ìƒˆ íŠ¸ë¦¬ê±°ë§Œ ìƒì„±:', permissionError.toString());
    }
    
    // ë§¤ì¼ ì˜¤í›„ 2ì‹œ ì‹¤í–‰ íŠ¸ë¦¬ê±° ìƒì„±
    const trigger = ScriptApp.newTrigger('dailyUpdate')
      .timeBased()
      .everyDays(1)
      .atHour(14) // ì˜¤í›„ 2ì‹œ
      .create();
    
    console.log('ìƒˆ íŠ¸ë¦¬ê±° ìƒì„±ë¨:', trigger.getUniqueId());
    
    SpreadsheetApp.getUi().alert('âœ… ìë™ ì‹¤í–‰ ì„¤ì • ì™„ë£Œ!\në§¤ì¼ ì˜¤í›„ 2ì‹œì— ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.\n\nì°¸ê³ : ê¸°ì¡´ íŠ¸ë¦¬ê±°ê°€ ìˆë‹¤ë©´ Google Apps Script í¸ì§‘ê¸°ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì£¼ì„¸ìš”.');
    
  } catch (error) {
    console.error('íŠ¸ë¦¬ê±° ì„¤ì • ì‹¤íŒ¨:', error);
    SpreadsheetApp.getUi().alert('âŒ íŠ¸ë¦¬ê±° ì„¤ì • ì‹¤íŒ¨: ' + error.toString() + '\n\nGoogle Apps Script í¸ì§‘ê¸°ì—ì„œ ì§ì ‘ íŠ¸ë¦¬ê±°ë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”.');
  }
}

/**
 * íŠ¸ë¦¬ê±° ì œê±° (ê¶Œí•œì´ ìˆëŠ” ê²½ìš°ì—ë§Œ)
 */
function removeTriggers() {
  try {
    const triggers = ScriptApp.getProjectTriggers();
    let removedCount = 0;
    
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'dailyUpdate') {
        ScriptApp.deleteTrigger(trigger);
        removedCount++;
        console.log('íŠ¸ë¦¬ê±° ì‚­ì œë¨:', trigger.getUniqueId());
      }
    });
    
    console.log(`ì´ ${removedCount}ê°œì˜ ê¸°ì¡´ íŠ¸ë¦¬ê±° ì‚­ì œ ì™„ë£Œ`);
    return { success: true, removedCount };
    
  } catch (error) {
    console.error('íŠ¸ë¦¬ê±° ì œê±° ì‹¤íŒ¨ (ê¶Œí•œ ë¶€ì¡± ê°€ëŠ¥ì„±):', error.toString());
    throw error; // ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡
  }
}

/**
 * ìˆ˜ë™ìœ¼ë¡œ íŠ¸ë¦¬ê±° ì œê±° (ë©”ë‰´ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥)
 */
function manualRemoveTriggers() {
  try {
    const result = removeTriggers();
    SpreadsheetApp.getUi().alert(`âœ… íŠ¸ë¦¬ê±° ì œê±° ì™„ë£Œ!\nì‚­ì œëœ íŠ¸ë¦¬ê±°: ${result.removedCount}ê°œ`);
  } catch (error) {
    SpreadsheetApp.getUi().alert(`âŒ íŠ¸ë¦¬ê±° ì œê±° ì‹¤íŒ¨: ${error.toString()}\n\nGoogle Apps Script í¸ì§‘ê¸° â†’ ì™¼ìª½ ì‚¬ì´ë“œë°” â†’ íŠ¸ë¦¬ê±°(â°) ë©”ë‰´ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì£¼ì„¸ìš”.`);
  }
}

/**
 * ë§¤ì¼ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
 */
function dailyUpdate() {
  try {
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸
    const result = CyberskyData.updateCyberskyData();
    
    if (result.success) {
      // ë¡œê·¸ ê¸°ë¡
      logUpdate('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ìë™ ì—…ë°ì´íŠ¸ ì„±ê³µ', result);
      
      // EDI ë°ì´í„°ë„ í™•ì¸
      checkAndUpdateEDI();
    } else {
      logUpdate('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ìë™ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨', result);
    }
    
  } catch (error) {
    logUpdate('ìë™ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜', { error: error.toString() });
  }
}

/**
 * EDI ë°ì´í„° í™•ì¸ ë° ì—…ë°ì´íŠ¸
 */
function checkAndUpdateEDI() {
  try {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // ì˜¤í›„ 1ì‹œ ~ 3ì‹œ 30ë¶„ ì‚¬ì´ë©´ EDI í™•ì¸
    if ((hours === 13) || (hours === 14) || (hours === 15 && minutes <= 30)) {
      const ediResult = EDIData.updateEDIData();
      
      if (ediResult.success) {
        // EDI ë°ì´í„°ë„ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìœ¼ë©´ ë°ì´í„° ì²˜ë¦¬
        const processResult = DataProcessor.processData();
        
        if (processResult.success) {
          logUpdate('EDI ì—…ë°ì´íŠ¸ ë° ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ', processResult);
          
          // ê²€ì‚° ì‹¤í–‰
          const verifyResult = Verification.runVerification();
          logUpdate('ê²€ì‚° ê²°ê³¼', verifyResult);
        }
      }
    }
  } catch (error) {
    logUpdate('EDI í™•ì¸ ì˜¤ë¥˜', { error: error.toString() });
  }
}

/**
 * ì—…ë°ì´íŠ¸ ë¡œê·¸ ê¸°ë¡
 */
function logUpdate(message, details) {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  let logSheet = spreadsheet.getSheetByName('ì—…ë°ì´íŠ¸_ë¡œê·¸');
  
  // ë¡œê·¸ ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±
  if (!logSheet) {
    logSheet = spreadsheet.insertSheet('ì—…ë°ì´íŠ¸_ë¡œê·¸');
    const headers = ['ì¼ì‹œ', 'ì‘ì—…', 'ìƒíƒœ', 'ìƒì„¸ë‚´ìš©'];
    logSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    logSheet.getRange(1, 1, 1, headers.length)
      .setBackground('#f0f0f0')
      .setFontWeight('bold');
  }
  
  // ë¡œê·¸ ì¶”ê°€
  const timestamp = new Date();
  const status = details.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨';
  const detailsJson = JSON.stringify(details);
  
  const newRow = [timestamp, message, status, detailsJson];
  logSheet.appendRow(newRow);
  
  // ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬ (ìµœê·¼ 100ê°œë§Œ ìœ ì§€)
  const lastRow = logSheet.getLastRow();
  if (lastRow > 101) {
    logSheet.deleteRows(2, lastRow - 101);
  }
}

/**
 * ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
 */
function testDailyUpdate() {
  try {
    console.log('=== ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œì‘ ===');
    dailyUpdate();
    
    // ì‹¤í–‰ ê²°ê³¼ í™•ì¸
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const logSheet = spreadsheet.getSheetByName('ì—…ë°ì´íŠ¸_ë¡œê·¸');
    
    let resultMessage = 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì™„ë£Œ!\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
    
    if (logSheet) {
      const lastRow = logSheet.getLastRow();
      if (lastRow > 1) {
        const lastEntry = logSheet.getRange(lastRow, 1, 1, 4).getValues()[0];
        const [timestamp, action, status, details] = lastEntry;
        resultMessage += `\n\nìµœê·¼ ë¡œê·¸:\nì‹œê°„: ${timestamp}\nì‘ì—…: ${action}\nìƒíƒœ: ${status}`;
      }
    }
    
    SpreadsheetApp.getUi().alert(resultMessage);
    console.log('=== ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
    
  } catch (error) {
    console.error('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜:', error);
    SpreadsheetApp.getUi().alert('âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨: ' + error.toString());
  }
}

/**
 * ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ (ì‹œê°„ ë¬´ê´€)
 */
function immediateTest() {
  try {
    console.log('=== ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // í˜„ì¬ ì‹œê°„ í‘œì‹œ
    const now = new Date();
    console.log('í˜„ì¬ ì‹œê°„:', now.toLocaleString('ko-KR'));
    
    // ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œë„
    const cyberskyResult = CyberskyData.updateCyberskyData();
    console.log('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ê²°ê³¼:', cyberskyResult);
    
    // ê²°ê³¼ ë¡œê¹…
    logUpdate('ìˆ˜ë™ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸', cyberskyResult);
    
    // UI ì•Œë¦¼
    const message = cyberskyResult.success 
      ? `âœ… ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì„±ê³µ!\nì‹œíŠ¸: ${cyberskyResult.sheetName}\ní–‰ ìˆ˜: ${cyberskyResult.rowCount}` 
      : `âŒ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:\n${cyberskyResult.error}`;
      
    SpreadsheetApp.getUi().alert(message);
    
  } catch (error) {
    console.error('ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
    logUpdate('ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
    SpreadsheetApp.getUi().alert('âŒ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ (ê³¼ê±° ë°ì´í„° í…ŒìŠ¤íŠ¸ìš©)
 */
function testWithDate() {
  try {
    const ui = SpreadsheetApp.getUi();
    
    // ì‚¬ìš©ìì—ê²Œ ë‚ ì§œ ì…ë ¥ ìš”ì²­
    const response = ui.prompt(
      'ğŸ“… ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸',
      'í…ŒìŠ¤íŠ¸í•  ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n\ní˜•ì‹: MMDD (ì˜ˆ: 0728, 0810)\në˜ëŠ” YYYYMMDD (ì˜ˆ: 20240728)',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (response.getSelectedButton() === ui.Button.CANCEL) {
      return;
    }
    
    const inputDate = response.getResponseText().trim();
    if (!inputDate) {
      ui.alert('âŒ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    console.log('=== ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
    console.log('ì…ë ¥ ë‚ ì§œ:', inputDate);
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // í˜„ì¬ ì‹œê°„ í‘œì‹œ
    const now = new Date();
    console.log('í˜„ì¬ ì‹œê°„:', now.toLocaleString('ko-KR'));
    
    // ì§€ì • ë‚ ì§œë¡œ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œë„
    const cyberskyResult = CyberskyData.updateCyberskyDataForDate(inputDate);
    console.log('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ê²°ê³¼:', cyberskyResult);
    
    // ê²°ê³¼ ë¡œê¹…
    logUpdate(`ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ (${inputDate})`, cyberskyResult);
    
    // UI ì•Œë¦¼
    const message = cyberskyResult.success 
      ? `âœ… ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì„±ê³µ!\në‚ ì§œ: ${inputDate}\nì‹œíŠ¸: ${cyberskyResult.sheetName}\ní–‰ ìˆ˜: ${cyberskyResult.rowCount}` 
      : `âŒ ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:\në‚ ì§œ: ${inputDate}\nì˜¤ë¥˜: ${cyberskyResult.error}`;
      
    ui.alert(message);
    
  } catch (error) {
    console.error('ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
    logUpdate('ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
    SpreadsheetApp.getUi().alert('âŒ ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + error.toString());
  }
}
