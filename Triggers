/**
 * ìë™ ì‹¤í–‰ íŠ¸ë¦¬ê±° ì„¤ì •
 * Triggers.gs
 */

/**
 * íŠ¸ë¦¬ê±° ì„¤ì • (ë©”ë‰´ì—ì„œ ì‹¤í–‰)
 */
function setupTriggers() {
  try {
    // ê¸°ì¡´ íŠ¸ë¦¬ê±° ì œê±° (ê¶Œí•œ ë¬¸ì œë¡œ ì¸í•´ try-catch ì²˜ë¦¬)
    try {
      removeTriggers();
    } catch (permissionError) {
      console.log('ê¸°ì¡´ íŠ¸ë¦¬ê±° í™•ì¸ ê¶Œí•œ ì—†ìŒ, ìƒˆ íŠ¸ë¦¬ê±°ë§Œ ìƒì„±:', permissionError.toString());
    }
    
    // ë§¤ì¼ ì˜¤í›„ 2ì‹œ ì‹¤í–‰ íŠ¸ë¦¬ê±° ìƒì„±
    const trigger = ScriptApp.newTrigger('dailyUpdate')
      .timeBased()
      .everyDays(1)
      .atHour(14) // ì˜¤í›„ 2ì‹œ
      .create();
    
    console.log('ìƒˆ íŠ¸ë¦¬ê±° ìƒì„±ë¨:', trigger.getUniqueId());
    
    SpreadsheetApp.getUi().alert('âœ… ì™„ì „í•œ ìë™í™” ì„¤ì • ì™„ë£Œ!\n\nğŸ”„ ë§¤ì¼ ì˜¤í›„ 2ì‹œ ì‹¤í–‰ ê³¼ì •:\n1ï¸âƒ£ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ìˆ˜ì§‘\n2ï¸âƒ£ EDI ë°ì´í„° ì²˜ë¦¬ (1~3:30ì‹œ ì‚¬ì´)\n3ï¸âƒ£ ë°ì´í„° ê°€ê³µ ë° ê²€ì‚°\n4ï¸âƒ£ í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„±\n5ï¸âƒ£ ìë™ ì´ë©”ì¼ ì „ì†¡\n\nğŸ“§ ì´ë©”ì¼ì´ ìë™ìœ¼ë¡œ ë°œì†¡ë©ë‹ˆë‹¤!\n\nì°¸ê³ : ê¸°ì¡´ íŠ¸ë¦¬ê±°ê°€ ìˆë‹¤ë©´ Google Apps Script í¸ì§‘ê¸°ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì£¼ì„¸ìš”.');
    
  } catch (error) {
    console.error('íŠ¸ë¦¬ê±° ì„¤ì • ì‹¤íŒ¨:', error);
    SpreadsheetApp.getUi().alert('âŒ íŠ¸ë¦¬ê±° ì„¤ì • ì‹¤íŒ¨: ' + error.toString() + '\n\nGoogle Apps Script í¸ì§‘ê¸°ì—ì„œ ì§ì ‘ íŠ¸ë¦¬ê±°ë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”.');
  }
}

/**
 * íŠ¸ë¦¬ê±° ì œê±° (ê¶Œí•œì´ ìˆëŠ” ê²½ìš°ì—ë§Œ)
 */
function removeTriggers() {
  try {
    const triggers = ScriptApp.getProjectTriggers();
    let removedCount = 0;
    
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'dailyUpdate') {
        ScriptApp.deleteTrigger(trigger);
        removedCount++;
        console.log('íŠ¸ë¦¬ê±° ì‚­ì œë¨:', trigger.getUniqueId());
      }
    });
    
    console.log(`ì´ ${removedCount}ê°œì˜ ê¸°ì¡´ íŠ¸ë¦¬ê±° ì‚­ì œ ì™„ë£Œ`);
    return { success: true, removedCount };
    
  } catch (error) {
    console.error('íŠ¸ë¦¬ê±° ì œê±° ì‹¤íŒ¨ (ê¶Œí•œ ë¶€ì¡± ê°€ëŠ¥ì„±):', error.toString());
    throw error; // ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡
  }
}

/**
 * ìˆ˜ë™ìœ¼ë¡œ íŠ¸ë¦¬ê±° ì œê±° (ë©”ë‰´ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥)
 */
function manualRemoveTriggers() {
  try {
    const result = removeTriggers();
    SpreadsheetApp.getUi().alert(`âœ… íŠ¸ë¦¬ê±° ì œê±° ì™„ë£Œ!\nì‚­ì œëœ íŠ¸ë¦¬ê±°: ${result.removedCount}ê°œ`);
  } catch (error) {
    SpreadsheetApp.getUi().alert(`âŒ íŠ¸ë¦¬ê±° ì œê±° ì‹¤íŒ¨: ${error.toString()}\n\nGoogle Apps Script í¸ì§‘ê¸° â†’ ì™¼ìª½ ì‚¬ì´ë“œë°” â†’ íŠ¸ë¦¬ê±°(â°) ë©”ë‰´ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì£¼ì„¸ìš”.`);
  }
}

/**
 * ë§¤ì¼ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
 */
function dailyUpdate() {
  try {
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸
    const result = CyberskyData.updateCyberskyData();
    
    if (result.success) {
      // ë¡œê·¸ ê¸°ë¡
      logUpdate('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ìë™ ì—…ë°ì´íŠ¸ ì„±ê³µ', result);
      
      // EDI ë°ì´í„°ë„ í™•ì¸
      checkAndUpdateEDI();
    } else {
      logUpdate('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ìë™ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨', result);
    }
    
  } catch (error) {
    logUpdate('ìë™ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜', { error: error.toString() });
  }
}

/**
 * EDI ë°ì´í„° í™•ì¸ ë° ì „ì²´ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
 */
function checkAndUpdateEDI() {
  try {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // ì˜¤í›„ 1ì‹œ ~ 3ì‹œ 30ë¶„ ì‚¬ì´ë©´ EDI í™•ì¸ ë° ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
    if ((hours === 13) || (hours === 14) || (hours === 15 && minutes <= 30)) {
      logUpdate('ì „ì²´ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹œì‘', { success: true, time: now.toLocaleString('ko-KR') });
      
      // 1. EDI ë°ì´í„° ì—…ë°ì´íŠ¸
      const ediResult = EDIData.updateEDIData();
      logUpdate('EDI ë°ì´í„° ì—…ë°ì´íŠ¸', ediResult);
      
      if (ediResult.success) {
        // 2. ë°ì´í„° ì²˜ë¦¬ (A+B â†’ C ì‹œíŠ¸)
        const processResult = DataProcessor.processData();
        logUpdate('ë°ì´í„° ì²˜ë¦¬ (A+Bâ†’C)', processResult);
        
        if (processResult.success) {
          // 3. ê²€ì‚° ì‹¤í–‰
          const verifyResult = Verification.runVerification();
          logUpdate('ê²€ì‚° ì‹¤í–‰', verifyResult);
          
          // 4. í’ˆëª©ë³„ ë¶„í•  (ì„ íƒì )
          try {
            const splitResult = ProductSpliter.splitByProduct();
            logUpdate('í’ˆëª©ë³„ ë¶„í• ', splitResult);
          } catch (splitError) {
            logUpdate('í’ˆëª©ë³„ ë¶„í•  (ì„ íƒì )', { success: false, error: splitError.toString() });
          }
          
          // 5. ì™„ì „í•œ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (ë°ì´í„° ê°€ê³µ â†’ ì´ë©”ì¼ ì „ì†¡)
          executeFullAutomationPipeline();
        }
      } else {
        // EDI ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ ë°ì´í„° ì²˜ë¦¬ ì‹œë„
        logUpdate('EDI ì—†ì´ ê¸°ë³¸ ë°ì´í„° ì²˜ë¦¬ ì‹œë„', { success: true });
        executeBasicAutomationPipeline();
      }
    } else {
      // ì‹œê°„ëŒ€ê°€ ì•„ë‹ˆë©´ ê¸°ë³¸ ë°ì´í„° ì²˜ë¦¬ë§Œ
      logUpdate('EDI ì‹œê°„ëŒ€ ì•„ë‹˜ - ê¸°ë³¸ ì²˜ë¦¬ë§Œ ì‹¤í–‰', { success: true, time: now.toLocaleString('ko-KR') });
      executeBasicAutomationPipeline();
    }
    
  } catch (error) {
    logUpdate('ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
  }
}

/**
 * ì™„ì „í•œ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (EDI í¬í•¨)
 */
function executeFullAutomationPipeline() {
  try {
    logUpdate('ì™„ì „í•œ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œì‘', { success: true });
    
    // 1. í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ë° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    const downloadResult = ProductDownloader.downloadProductSheets();
    logUpdate('í’ˆëª©ë³„ ì‹œíŠ¸ ë‹¤ìš´ë¡œë“œ', downloadResult);
    
    if (downloadResult.success) {
      // 2. ìë™ ì´ë©”ì¼ ì „ì†¡
      const emailResult = sendEmailWithProductSheets();
      logUpdate('ìë™ ì´ë©”ì¼ ì „ì†¡', emailResult);
      
      if (emailResult.success) {
        logUpdate('ğŸ‰ ì™„ì „í•œ ìë™í™” íŒŒì´í”„ë¼ì¸ ì„±ê³µ!', { 
          success: true, 
          completedSteps: ['ë°ì´í„°ìˆ˜ì§‘', 'EDIì²˜ë¦¬', 'ë°ì´í„°ê°€ê³µ', 'ê²€ì‚°', 'í’ˆëª©ë³„ìƒì„±', 'ì´ë©”ì¼ì „ì†¡'] 
        });
      } else {
        logUpdate('ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨í•˜ì§€ë§Œ ë°ì´í„° ì²˜ë¦¬ëŠ” ì™„ë£Œ', emailResult);
      }
    } else {
      logUpdate('í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ì‹¤íŒ¨', downloadResult);
    }
    
  } catch (error) {
    logUpdate('ì™„ì „í•œ ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
  }
}

/**
 * ê¸°ë³¸ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (EDI ì—†ì´)
 */
function executeBasicAutomationPipeline() {
  try {
    logUpdate('ê¸°ë³¸ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œì‘', { success: true });
    
    // 1. ê¸°ë³¸ ë°ì´í„° ì²˜ë¦¬ ì‹œë„
    const processResult = DataProcessor.processData();
    logUpdate('ê¸°ë³¸ ë°ì´í„° ì²˜ë¦¬', processResult);
    
    // 2. ê²€ì‚° (ì„ íƒì )
    try {
      const verifyResult = Verification.runVerification();
      logUpdate('ê¸°ë³¸ ê²€ì‚°', verifyResult);
    } catch (verifyError) {
      logUpdate('ê¸°ë³¸ ê²€ì‚° (ì„ íƒì )', { success: false, error: verifyError.toString() });
    }
    
    // 3. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„°ë§Œìœ¼ë¡œ ì´ë©”ì¼ ì „ì†¡ ì‹œë„
    try {
      const emailResult = sendEmailWithProductSheets();
      logUpdate('ê¸°ë³¸ ì´ë©”ì¼ ì „ì†¡ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´ë§Œ)', emailResult);
      
      if (emailResult.success) {
        logUpdate('âœ… ê¸°ë³¸ ìë™í™” íŒŒì´í”„ë¼ì¸ ì„±ê³µ!', { 
          success: true, 
          completedSteps: ['ë°ì´í„°ìˆ˜ì§‘', 'ê¸°ë³¸ê°€ê³µ', 'ì´ë©”ì¼ì „ì†¡'] 
        });
      }
    } catch (emailError) {
      logUpdate('ê¸°ë³¸ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨', { success: false, error: emailError.toString() });
    }
    
  } catch (error) {
    logUpdate('ê¸°ë³¸ ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
  }
}

/**
 * ì—…ë°ì´íŠ¸ ë¡œê·¸ ê¸°ë¡
 */
function logUpdate(message, details) {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  let logSheet = spreadsheet.getSheetByName('ì—…ë°ì´íŠ¸_ë¡œê·¸');
  
  // ë¡œê·¸ ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±
  if (!logSheet) {
    logSheet = spreadsheet.insertSheet('ì—…ë°ì´íŠ¸_ë¡œê·¸');
    const headers = ['ì¼ì‹œ', 'ì‘ì—…', 'ìƒíƒœ', 'ìƒì„¸ë‚´ìš©'];
    logSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    logSheet.getRange(1, 1, 1, headers.length)
      .setBackground('#f0f0f0')
      .setFontWeight('bold');
  }
  
  // ë¡œê·¸ ì¶”ê°€
  const timestamp = new Date();
  const status = details.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨';
  const detailsJson = JSON.stringify(details);
  
  const newRow = [timestamp, message, status, detailsJson];
  logSheet.appendRow(newRow);
  
  // ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬ (ìµœê·¼ 100ê°œë§Œ ìœ ì§€)
  const lastRow = logSheet.getLastRow();
  if (lastRow > 101) {
    logSheet.deleteRows(2, lastRow - 101);
  }
}

/**
 * ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
 */
function testDailyUpdate() {
  try {
    console.log('=== ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œì‘ ===');
    dailyUpdate();
    
    // ì‹¤í–‰ ê²°ê³¼ í™•ì¸
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const logSheet = spreadsheet.getSheetByName('ì—…ë°ì´íŠ¸_ë¡œê·¸');
    
    let resultMessage = 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì™„ë£Œ!\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
    
    if (logSheet) {
      const lastRow = logSheet.getLastRow();
      if (lastRow > 1) {
        const lastEntry = logSheet.getRange(lastRow, 1, 1, 4).getValues()[0];
        const [timestamp, action, status, details] = lastEntry;
        resultMessage += `\n\nìµœê·¼ ë¡œê·¸:\nì‹œê°„: ${timestamp}\nì‘ì—…: ${action}\nìƒíƒœ: ${status}`;
      }
    }
    
    SpreadsheetApp.getUi().alert(resultMessage);
    console.log('=== ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
    
  } catch (error) {
    console.error('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜:', error);
    SpreadsheetApp.getUi().alert('âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨: ' + error.toString());
  }
}

/**
 * ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ (ì‹œê°„ ë¬´ê´€)
 */
function immediateTest() {
  try {
    console.log('=== ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // í˜„ì¬ ì‹œê°„ í‘œì‹œ
    const now = new Date();
    console.log('í˜„ì¬ ì‹œê°„:', now.toLocaleString('ko-KR'));
    
    // ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œë„
    const cyberskyResult = CyberskyData.updateCyberskyData();
    console.log('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ê²°ê³¼:', cyberskyResult);
    
    // ê²°ê³¼ ë¡œê¹…
    logUpdate('ìˆ˜ë™ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸', cyberskyResult);
    
    // UI ì•Œë¦¼
    const message = cyberskyResult.success 
      ? `âœ… ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì„±ê³µ!\nì‹œíŠ¸: ${cyberskyResult.sheetName}\ní–‰ ìˆ˜: ${cyberskyResult.rowCount}` 
      : `âŒ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:\n${cyberskyResult.error}`;
      
    SpreadsheetApp.getUi().alert(message);
    
  } catch (error) {
    console.error('ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
    logUpdate('ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
    SpreadsheetApp.getUi().alert('âŒ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ (ê³¼ê±° ë°ì´í„° í…ŒìŠ¤íŠ¸ìš©)
 */
function testWithDate() {
  try {
    const ui = SpreadsheetApp.getUi();
    
    // ì‚¬ìš©ìì—ê²Œ ë‚ ì§œ ì…ë ¥ ìš”ì²­
    const response = ui.prompt(
      'ğŸ“… ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸',
      'í…ŒìŠ¤íŠ¸í•  ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n\ní˜•ì‹: MMDD (ì˜ˆ: 0728, 0810)\në˜ëŠ” YYYYMMDD (ì˜ˆ: 20240728)',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (response.getSelectedButton() === ui.Button.CANCEL) {
      return;
    }
    
    const inputDate = response.getResponseText().trim();
    if (!inputDate) {
      ui.alert('âŒ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    console.log('=== ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
    console.log('ì…ë ¥ ë‚ ì§œ:', inputDate);
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // í˜„ì¬ ì‹œê°„ í‘œì‹œ
    const now = new Date();
    console.log('í˜„ì¬ ì‹œê°„:', now.toLocaleString('ko-KR'));
    
    // ì§€ì • ë‚ ì§œë¡œ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œë„
    const cyberskyResult = CyberskyData.updateCyberskyDataForDate(inputDate);
    console.log('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ê²°ê³¼:', cyberskyResult);
    
    // ê²°ê³¼ ë¡œê¹…
    logUpdate(`ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ (${inputDate})`, cyberskyResult);
    
    // UI ì•Œë¦¼
    const message = cyberskyResult.success 
      ? `âœ… ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì„±ê³µ!\në‚ ì§œ: ${inputDate}\nì‹œíŠ¸: ${cyberskyResult.sheetName}\ní–‰ ìˆ˜: ${cyberskyResult.rowCount}` 
      : `âŒ ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:\në‚ ì§œ: ${inputDate}\nì˜¤ë¥˜: ${cyberskyResult.error}`;
      
    ui.alert(message);
    
  } catch (error) {
    console.error('ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
    logUpdate('ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
    SpreadsheetApp.getUi().alert('âŒ ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ë°˜ìë™í™” íŠ¸ë¦¬ê±° ì„¤ì • (ê²€ì‚°ê¹Œì§€ë§Œ ìë™, ì¿ íŒ¡ì€ ìˆ˜ë™)
 */
function setupSemiAutomationTrigger() {
  try {
    // ê¸°ì¡´ ë°˜ìë™í™” íŠ¸ë¦¬ê±° ì œê±° (ê¶Œí•œ ë¬¸ì œë¡œ ì¸í•´ try-catch ì²˜ë¦¬)
    try {
      removeSemiAutomationTriggers();
    } catch (permissionError) {
      console.log('ê¸°ì¡´ ë°˜ìë™í™” íŠ¸ë¦¬ê±° í™•ì¸ ê¶Œí•œ ì—†ìŒ, ìƒˆ íŠ¸ë¦¬ê±°ë§Œ ìƒì„±:', permissionError.toString());
    }
    
    // ë§¤ì¼ ì˜¤í›„ 1ì‹œ 30ë¶„ ì‹¤í–‰ íŠ¸ë¦¬ê±° ìƒì„±
    const trigger = ScriptApp.newTrigger('semiAutomationPipeline')
      .timeBased()
      .everyDays(1)
      .atHour(13)
      .nearMinute(30) // 1ì‹œ 30ë¶„
      .create();
    
    console.log('ìƒˆ ë°˜ìë™í™” íŠ¸ë¦¬ê±° ìƒì„±ë¨:', trigger.getUniqueId());
    
    SpreadsheetApp.getUi().alert(
      'âœ… ë°˜ìë™í™” íŠ¸ë¦¬ê±° ì„¤ì • ì™„ë£Œ!\n\n' +
      'ğŸ”„ ë§¤ì¼ ì˜¤í›„ 1ì‹œ 30ë¶„ ì‹¤í–‰ ê³¼ì •:\n' +
      '1ï¸âƒ£ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ìˆ˜ì§‘\n' +
      '2ï¸âƒ£ EDI ë°ì´í„° ì²˜ë¦¬\n' +
      '3ï¸âƒ£ ë°ì´í„° ê°€ê³µ ë° ê²€ì‚°\n' +
      'â¸ï¸ ê²€ì‚° ì™„ë£Œ ì•Œë¦¼ ì´ë©”ì¼ ë°œì†¡\n\n' +
      'ğŸ“Œ ì´í›„ ìˆ˜ë™ ì‘ì—…:\n' +
      '4ï¸âƒ£ ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë“œ (CoupangUploader)\n' +
      '5ï¸âƒ£ í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ë° ì´ë©”ì¼ ì „ì†¡\n\n' +
      'âš ï¸ ì°¸ê³ : ê²€ì‚° ì™„ë£Œ í›„ ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ì´ ë°œì†¡ë©ë‹ˆë‹¤.'
    );
    
  } catch (error) {
    console.error('ë°˜ìë™í™” íŠ¸ë¦¬ê±° ì„¤ì • ì‹¤íŒ¨:', error);
    SpreadsheetApp.getUi().alert('âŒ ë°˜ìë™í™” íŠ¸ë¦¬ê±° ì„¤ì • ì‹¤íŒ¨: ' + error.toString() + '\n\nGoogle Apps Script í¸ì§‘ê¸°ì—ì„œ ì§ì ‘ íŠ¸ë¦¬ê±°ë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”.');
  }
}

/**
 * ë°˜ìë™í™” íŠ¸ë¦¬ê±° ì œê±° (ê¶Œí•œì´ ìˆëŠ” ê²½ìš°ì—ë§Œ)
 */
function removeSemiAutomationTriggers() {
  try {
    const triggers = ScriptApp.getProjectTriggers();
    let removedCount = 0;
    
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'semiAutomationPipeline') {
        ScriptApp.deleteTrigger(trigger);
        removedCount++;
        console.log('ë°˜ìë™í™” íŠ¸ë¦¬ê±° ì‚­ì œë¨:', trigger.getUniqueId());
      }
    });
    
    console.log(`ì´ ${removedCount}ê°œì˜ ê¸°ì¡´ ë°˜ìë™í™” íŠ¸ë¦¬ê±° ì‚­ì œ ì™„ë£Œ`);
    return { success: true, removedCount };
    
  } catch (error) {
    console.error('ë°˜ìë™í™” íŠ¸ë¦¬ê±° ì œê±° ì‹¤íŒ¨ (ê¶Œí•œ ë¶€ì¡± ê°€ëŠ¥ì„±):', error.toString());
    throw error; // ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡
  }
}

/**
 * ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (ê²€ì‚°ê¹Œì§€ë§Œ ìë™)
 */
function semiAutomationPipeline() {
  try {
    console.log('=== ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹œì‘ (Part 1: ê²€ì‚°ê¹Œì§€) ===');
    logUpdate('ğŸš€ ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ Part 1 ì‹œì‘', { success: true, time: new Date().toLocaleString('ko-KR') });
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // 1. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸
    const cyberskyResult = CyberskyData.updateCyberskyData();
    logUpdate('1ï¸âƒ£ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸', cyberskyResult);
    
    if (!cyberskyResult.success) {
      logUpdate('âš ï¸ ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì‹¤íŒ¨', cyberskyResult);
      return;
    }
    
    // 2. EDI ë°ì´í„° ì—…ë°ì´íŠ¸
    const ediResult = EDIData.updateEDIData();
    logUpdate('2ï¸âƒ£ EDI ë°ì´í„° ì—…ë°ì´íŠ¸', ediResult);
    
    // EDI ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„°ë§Œìœ¼ë¡œë„ ì²˜ë¦¬ ê°€ëŠ¥)
    
    // 3. ë°ì´í„° ì²˜ë¦¬ (A+B â†’ C ì‹œíŠ¸)
    const processResult = DataProcessor.processData();
    logUpdate('3ï¸âƒ£ ë°ì´í„° ì²˜ë¦¬ (A+Bâ†’C)', processResult);
    
    if (!processResult.success) {
      logUpdate('âš ï¸ ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨', processResult);
      return;
    }
    
    // 4. ê²€ì‚° ì‹¤í–‰ (ì‹¤íŒ¨ ì‹œ ê²½ê³  ì´ë©”ì¼)
    const verifyResult = Verification.runVerification();
    logUpdate('4ï¸âƒ£ ê²€ì‚° ì‹¤í–‰', verifyResult);
    
    if (!verifyResult.success) {
      // ê²€ì‚° ì‹¤íŒ¨ ì‹œ ê²½ê³  ì´ë©”ì¼ ì „ì†¡
      sendVerificationFailureAlert(null, verifyResult.error || 'ê²€ì‚° ì‹¤íŒ¨');
      logUpdate('âŒ ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ê²€ì‚° ì‹¤íŒ¨', verifyResult);
      return;
    }
    
    // ê²€ì‚° ì„±ê³µ - ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡
    sendCoupangUploadReminder();
    
    logUpdate('âœ… ë°˜ìë™í™” Part 1 ì™„ë£Œ - ì¿ íŒ¡ ì—…ë¡œë“œ ëŒ€ê¸°', {
      success: true,
      message: 'ê²€ì‚°ê¹Œì§€ ì™„ë£Œ. ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ë°œì†¡ë¨.',
      time: new Date().toLocaleString('ko-KR')
    });
    
  } catch (error) {
    console.error('ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜:', error);
    logUpdate('âŒ ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
  }
}

/**
 * ë‚ ì§œ ì§€ì • ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (Part 1)
 */
function semiAutomationPipelineWithDate(targetDate) {
  try {
    console.log(`=== ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ Part 1 ì‹œì‘ (ë‚ ì§œ: ${targetDate}) ===`);
    logUpdate(`ğŸš€ ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ Part 1 ì‹œì‘ (${targetDate})`, { success: true, time: new Date().toLocaleString('ko-KR') });
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // 1. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸ (ë‚ ì§œ ì§€ì •)
    const cyberskyResult = CyberskyData.updateCyberskyDataForDate(targetDate);
    logUpdate(`1ï¸âƒ£ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸ (${targetDate})`, cyberskyResult);
    
    if (!cyberskyResult.success) {
      logUpdate(`âš ï¸ ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì‹¤íŒ¨ (${targetDate})`, cyberskyResult);
      return;
    }
    
    // 2. EDI ë°ì´í„° ì—…ë°ì´íŠ¸ (ë‚ ì§œ ì§€ì •)
    const ediResult = EDIData.getEDIFromEmail(targetDate);
    logUpdate(`2ï¸âƒ£ EDI ë°ì´í„° ì—…ë°ì´íŠ¸ (${targetDate})`, ediResult);
    
    // EDI ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„°ë§Œìœ¼ë¡œë„ ì²˜ë¦¬ ê°€ëŠ¥)
    
    // 3. ë°ì´í„° ì²˜ë¦¬ (A+B â†’ C ì‹œíŠ¸)
    const processResult = DataProcessor.processData();
    logUpdate('3ï¸âƒ£ ë°ì´í„° ì²˜ë¦¬ (A+Bâ†’C)', processResult);
    
    if (!processResult.success) {
      logUpdate('âš ï¸ ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨', processResult);
      return;
    }
    
    // 4. ê²€ì‚° ì‹¤í–‰ (ì‹¤íŒ¨ ì‹œ ê²½ê³  ì´ë©”ì¼)
    const verifyResult = Verification.runVerification();
    logUpdate('4ï¸âƒ£ ê²€ì‚° ì‹¤í–‰', verifyResult);
    
    if (!verifyResult.success) {
      // ê²€ì‚° ì‹¤íŒ¨ ì‹œ ê²½ê³  ì´ë©”ì¼ ì „ì†¡
      sendVerificationFailureAlert(targetDate, verifyResult.error || 'ê²€ì‚° ì‹¤íŒ¨');
      logUpdate('âŒ ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ê²€ì‚° ì‹¤íŒ¨', verifyResult);
      return;
    }
    
    // ê²€ì‚° ì„±ê³µ - ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡ (ë‚ ì§œ ì§€ì •)
    sendCoupangUploadReminderWithDate(targetDate);
    
    logUpdate(`âœ… ë°˜ìë™í™” Part 1 ì™„ë£Œ - ì¿ íŒ¡ ì—…ë¡œë“œ ëŒ€ê¸° (${targetDate})`, {
      success: true,
      message: `ê²€ì‚°ê¹Œì§€ ì™„ë£Œ (${targetDate}). ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ë°œì†¡ë¨.`,
      time: new Date().toLocaleString('ko-KR')
    });
    
  } catch (error) {
    console.error('ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜:', error);
    logUpdate('âŒ ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
  }
}

/**
 * ë‚ ì§œ ì§€ì • ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡
 */
function sendCoupangUploadReminderWithDate(targetDate) {
  try {
    console.log('=== ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡ ì‹œì‘ (ë‚ ì§œ ì§€ì •) ===');
    
    const fullDateStr = targetDate ? convertToFullDate(targetDate) : getTodayDate();
    const subject = `ğŸ“‹ ê³°íƒ• ìë™í™”: ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë“œ í•„ìš” (${fullDateStr})`;
    
    const body = `
âœ… ê²€ì‚°ê¹Œì§€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!

ğŸ“… ì²˜ë¦¬ ë‚ ì§œ: ${fullDateStr}
â° ì™„ë£Œ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}

ğŸ“Œ ë‹¤ìŒ ë‹¨ê³„:
1. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°
2. ë©”ë‰´ â†’ "ğŸ›ï¸ ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë” ì—´ê¸°" í´ë¦­
3. ì¿ íŒ¡ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ
4. ì—…ë¡œë“œ ì™„ë£Œ í›„ "â–¶ï¸ Part 2 ì‹¤í–‰" í´ë¦­

ğŸ”— ìŠ¤í”„ë ˆë“œì‹œíŠ¸: https://docs.google.com/spreadsheets/d/${SpreadsheetApp.getActiveSpreadsheet().getId()}

âš ï¸ ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë“œ í›„ Part 2ë¥¼ ì‹¤í–‰í•˜ë©´:
â€¢ í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„±
â€¢ ì—‘ì…€ íŒŒì¼ ìƒì„±
â€¢ ìë™ ì´ë©”ì¼ ì „ì†¡

ì´ ì™„ë£Œë©ë‹ˆë‹¤.

---
ê³°íƒ• ì¶œê³  ìë™í™” ì‹œìŠ¤í…œ
    `;
    
    // ì´ë©”ì¼ ì „ì†¡
    GmailApp.sendEmail(
      'youngjoonkim@kas.co.kr',
      subject,
      body
    );
    
    console.log('ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ: youngjoonkim@kas.co.kr');
    logUpdate('ğŸ“§ ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡', { 
      success: true, 
      recipient: 'youngjoonkim@kas.co.kr',
      subject: subject 
    });
    
  } catch (emailError) {
    console.error('ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨:', emailError);
    logUpdate('âŒ ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨', { 
      success: false, 
      error: emailError.toString() 
    });
  }
}

/**
 * ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡
 */
function sendCoupangUploadReminder() {
  try {
    console.log('=== ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡ ì‹œì‘ ===');
    
    const fullDateStr = getTodayDate();
    const subject = `ğŸ“‹ ê³°íƒ• ìë™í™”: ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë“œ í•„ìš” (${fullDateStr})`;
    
    const body = `
âœ… ê²€ì‚°ê¹Œì§€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!

ğŸ“… ì²˜ë¦¬ ë‚ ì§œ: ${fullDateStr}
â° ì™„ë£Œ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}

ğŸ“Œ ë‹¤ìŒ ë‹¨ê³„:
1. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°
2. ë©”ë‰´ â†’ "ğŸ›ï¸ ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë” ì—´ê¸°" í´ë¦­
3. ì¿ íŒ¡ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ
4. ì—…ë¡œë“œ ì™„ë£Œ í›„ "â–¶ï¸ Part 2 ì‹¤í–‰" í´ë¦­

ğŸ”— ìŠ¤í”„ë ˆë“œì‹œíŠ¸: https://docs.google.com/spreadsheets/d/${SpreadsheetApp.getActiveSpreadsheet().getId()}

âš ï¸ ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë“œ í›„ Part 2ë¥¼ ì‹¤í–‰í•˜ë©´:
â€¢ í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„±
â€¢ ì—‘ì…€ íŒŒì¼ ìƒì„±
â€¢ ìë™ ì´ë©”ì¼ ì „ì†¡

ì´ ì™„ë£Œë©ë‹ˆë‹¤.

---
ê³°íƒ• ì¶œê³  ìë™í™” ì‹œìŠ¤í…œ
    `;
    
    // ì´ë©”ì¼ ì „ì†¡
    GmailApp.sendEmail(
      'youngjoonkim@kas.co.kr',
      subject,
      body
    );
    
    console.log('ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ: youngjoonkim@kas.co.kr');
    logUpdate('ğŸ“§ ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡', { 
      success: true, 
      recipient: 'youngjoonkim@kas.co.kr',
      subject: subject 
    });
    
  } catch (emailError) {
    console.error('ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨:', emailError);
    logUpdate('âŒ ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨', { 
      success: false, 
      error: emailError.toString() 
    });
  }
}

/**
 * ì™„ì „ í†µí•© íŒŒì´í”„ë¼ì¸ (Part 1 â†’ ìë™ CoupangUploader ì—´ê¸°)
 */
function executeSeamlessWorkflow() {
  try {
    const ui = SpreadsheetApp.getUi();
    
    // ë‚ ì§œ ì„ íƒ ì˜µì…˜
    const dateResponse = ui.alert(
      'ğŸ“… í†µí•© ì›Œí¬í”Œë¡œìš° - ë‚ ì§œ ì„ íƒ',
      'ì–´ë–¤ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
      'ì˜ˆ: ì˜¤ëŠ˜ ë‚ ì§œ (ìë™)\n' +
      'ì•„ë‹ˆì˜¤: ë‚ ì§œ ì§ì ‘ ì§€ì •',
      ui.ButtonSet.YES_NO_CANCEL
    );
    
    if (dateResponse === ui.Button.CANCEL) {
      return;
    }
    
    let targetDate = null;
    if (dateResponse === ui.Button.NO) {
      // ë‚ ì§œ ì§ì ‘ ì…ë ¥
      const inputResponse = ui.prompt(
        'ë‚ ì§œ ì…ë ¥',
        'MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 0807, 0810)\n\nê²€ì‚° ì™„ë£Œ í›„ ì¿ íŒ¡ ì—…ë¡œë”ê°€ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.',
        ui.ButtonSet.OK_CANCEL
      );
      
      if (inputResponse.getSelectedButton() !== ui.Button.OK) {
        return;
      }
      
      targetDate = inputResponse.getResponseText().trim();
      if (!/^\d{4}$/.test(targetDate)) {
        ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
    }
    
    // ì‹¤í–‰ í™•ì¸
    const confirmResponse = ui.alert(
      'ğŸš€ í†µí•© ì›Œí¬í”Œë¡œìš° ì‹¤í–‰',
      `ì „ì²´ í†µí•© ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
      `ë‚ ì§œ: ${targetDate || 'ì˜¤ëŠ˜'}\n\n` +
      'ì‹¤í–‰ ê³¼ì •:\n' +
      '1ï¸âƒ£ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ â†’ EDI â†’ ê²€ì‚°\n' +
      '2ï¸âƒ£ ì¿ íŒ¡ ì—…ë¡œë” ìë™ ì—´ê¸°\n' +
      '3ï¸âƒ£ ì—…ë¡œë“œ í›„ ìë™ìœ¼ë¡œ ë‚˜ë¨¸ì§€ ê³¼ì • ì‹¤í–‰\n\n' +
      'âš ï¸ ê²€ì‚° ì™„ë£Œ í›„ ì¿ íŒ¡ ì—…ë¡œë”ê°€ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.',
      ui.ButtonSet.YES_NO
    );
    
    if (confirmResponse === ui.Button.YES) {
      ui.alert(`ğŸš€ í†µí•© ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\në‚ ì§œ: ${targetDate || 'ì˜¤ëŠ˜'}\n\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ì§„í–‰ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.`);
      
      // Part 1 ì‹¤í–‰ (ê²€ì‚°ê¹Œì§€)
      if (targetDate) {
        executeSeamlessPart1WithDate(targetDate);
      } else {
        executeSeamlessPart1();
      }
    }
    
  } catch (error) {
    console.error('í†µí•© ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì˜¤ë¥˜:', error);
    SpreadsheetApp.getUi().alert('âŒ í†µí•© ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * í†µí•© ì›Œí¬í”Œë¡œìš° Part 1 (ê²€ì‚° ì™„ë£Œ í›„ CoupangUploader ìë™ ì—´ê¸°)
 */
function executeSeamlessPart1() {
  try {
    console.log('=== í†µí•© ì›Œí¬í”Œë¡œìš° Part 1 ì‹œì‘ ===');
    logUpdate('ğŸš€ í†µí•© ì›Œí¬í”Œë¡œìš° Part 1 ì‹œì‘', { success: true, time: new Date().toLocaleString('ko-KR') });
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // 1. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸
    const cyberskyResult = CyberskyData.updateCyberskyData();
    logUpdate('1ï¸âƒ£ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸', cyberskyResult);
    
    if (!cyberskyResult.success) {
      logUpdate('âš ï¸ í†µí•© ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨: ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì‹¤íŒ¨', cyberskyResult);
      SpreadsheetApp.getUi().alert('âŒ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì‹¤íŒ¨: ' + cyberskyResult.error);
      return;
    }
    
    // 2. EDI ë°ì´í„° ì—…ë°ì´íŠ¸
    const ediResult = EDIData.updateEDIData();
    logUpdate('2ï¸âƒ£ EDI ë°ì´í„° ì—…ë°ì´íŠ¸', ediResult);
    
    // EDI ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
    
    // 3. ë°ì´í„° ì²˜ë¦¬ (A+B â†’ C ì‹œíŠ¸)
    const processResult = DataProcessor.processData();
    logUpdate('3ï¸âƒ£ ë°ì´í„° ì²˜ë¦¬ (A+Bâ†’C)', processResult);
    
    if (!processResult.success) {
      logUpdate('âš ï¸ í†µí•© ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨: ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨', processResult);
      SpreadsheetApp.getUi().alert('âŒ ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨: ' + processResult.error);
      return;
    }
    
    // 4. ê²€ì‚° ì‹¤í–‰ (ì‹¤íŒ¨ ì‹œ ê²½ê³  ì´ë©”ì¼)
    const verifyResult = Verification.runVerification();
    logUpdate('4ï¸âƒ£ ê²€ì‚° ì‹¤í–‰', verifyResult);
    
    if (!verifyResult.success) {
      // ê²€ì‚° ì‹¤íŒ¨ ì‹œ ê²½ê³  ì´ë©”ì¼ ì „ì†¡
      sendVerificationFailureAlert(null, verifyResult.error || 'ê²€ì‚° ì‹¤íŒ¨');
      logUpdate('âŒ í†µí•© ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨: ê²€ì‚° ì‹¤íŒ¨', verifyResult);
      SpreadsheetApp.getUi().alert('âŒ ê²€ì‚° ì‹¤íŒ¨: ' + verifyResult.error);
      return;
    }
    
    // ê²€ì‚° ì„±ê³µ - ì¿ íŒ¡ ì—…ë¡œë” ìë™ ì—´ê¸°
    logUpdate('âœ… Part 1 ì™„ë£Œ - ì¿ íŒ¡ ì—…ë¡œë” ìë™ ì—´ê¸°', {
      success: true,
      message: 'ê²€ì‚°ê¹Œì§€ ì™„ë£Œ. ì¿ íŒ¡ ì—…ë¡œë”ê°€ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.',
      time: new Date().toLocaleString('ko-KR')
    });
    
    SpreadsheetApp.getUi().alert('âœ… ê²€ì‚°ê¹Œì§€ ì™„ë£Œ!\n\nì¿ íŒ¡ ì—…ë¡œë”ê°€ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.\nì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ë‚˜ë¨¸ì§€ ê³¼ì •ì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.');
    
    // ì¿ íŒ¡ ì—…ë¡œë” ìë™ ì—´ê¸°
    openCoupangUploaderSeamless();
    
  } catch (error) {
    console.error('í†µí•© ì›Œí¬í”Œë¡œìš° Part 1 ì˜¤ë¥˜:', error);
    logUpdate('âŒ í†µí•© ì›Œí¬í”Œë¡œìš° Part 1 ì˜¤ë¥˜', { success: false, error: error.toString() });
    SpreadsheetApp.getUi().alert('âŒ í†µí•© ì›Œí¬í”Œë¡œìš° Part 1 ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * í†µí•© ì›Œí¬í”Œë¡œìš° Part 1 (ë‚ ì§œ ì§€ì •)
 */
function executeSeamlessPart1WithDate(targetDate) {
  try {
    console.log(`=== í†µí•© ì›Œí¬í”Œë¡œìš° Part 1 ì‹œì‘ (ë‚ ì§œ: ${targetDate}) ===`);
    logUpdate(`ğŸš€ í†µí•© ì›Œí¬í”Œë¡œìš° Part 1 ì‹œì‘ (${targetDate})`, { success: true, time: new Date().toLocaleString('ko-KR') });
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚ ì§œë¥¼ ì„ì‹œ ì €ì¥ (CoupangProcessorì—ì„œ ì‚¬ìš©)
    PropertiesService.getScriptProperties().setProperty('CURRENT_WORKING_DATE', targetDate);
    console.log(`í˜„ì¬ ì‘ì—… ë‚ ì§œ ì €ì¥: ${targetDate}`);
    
    // 1. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸ (ë‚ ì§œ ì§€ì •)
    const cyberskyResult = CyberskyData.updateCyberskyDataForDate(targetDate);
    logUpdate(`1ï¸âƒ£ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸ (${targetDate})`, cyberskyResult);
    
    if (!cyberskyResult.success) {
      logUpdate(`âš ï¸ í†µí•© ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨: ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì‹¤íŒ¨ (${targetDate})`, cyberskyResult);
      SpreadsheetApp.getUi().alert('âŒ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì‹¤íŒ¨: ' + cyberskyResult.error);
      return;
    }
    
    // 2. EDI ë°ì´í„° ì—…ë°ì´íŠ¸ (ë‚ ì§œ ì§€ì •)
    const ediResult = EDIData.getEDIFromEmail(targetDate);
    logUpdate(`2ï¸âƒ£ EDI ë°ì´í„° ì—…ë°ì´íŠ¸ (${targetDate})`, ediResult);
    
    // EDI ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
    
    // 3. ë°ì´í„° ì²˜ë¦¬ (A+B â†’ C ì‹œíŠ¸)
    const processResult = DataProcessor.processData();
    logUpdate('3ï¸âƒ£ ë°ì´í„° ì²˜ë¦¬ (A+Bâ†’C)', processResult);
    
    if (!processResult.success) {
      logUpdate('âš ï¸ í†µí•© ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨: ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨', processResult);
      SpreadsheetApp.getUi().alert('âŒ ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨: ' + processResult.error);
      return;
    }
    
    // 4. ê²€ì‚° ì‹¤í–‰ (ì‹¤íŒ¨ ì‹œ ê²½ê³  ì´ë©”ì¼)
    const verifyResult = Verification.runVerification();
    logUpdate('4ï¸âƒ£ ê²€ì‚° ì‹¤í–‰', verifyResult);
    
    if (!verifyResult.success) {
      // ê²€ì‚° ì‹¤íŒ¨ ì‹œ ê²½ê³  ì´ë©”ì¼ ì „ì†¡
      sendVerificationFailureAlert(targetDate, verifyResult.error || 'ê²€ì‚° ì‹¤íŒ¨');
      logUpdate('âŒ í†µí•© ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨: ê²€ì‚° ì‹¤íŒ¨', verifyResult);
      SpreadsheetApp.getUi().alert('âŒ ê²€ì‚° ì‹¤íŒ¨: ' + verifyResult.error);
      return;
    }
    
    // ê²€ì‚° ì„±ê³µ - ì¿ íŒ¡ ì—…ë¡œë” ìë™ ì—´ê¸°
    logUpdate(`âœ… Part 1 ì™„ë£Œ - ì¿ íŒ¡ ì—…ë¡œë” ìë™ ì—´ê¸° (${targetDate})`, {
      success: true,
      message: `ê²€ì‚°ê¹Œì§€ ì™„ë£Œ (${targetDate}). ì¿ íŒ¡ ì—…ë¡œë”ê°€ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.`,
      time: new Date().toLocaleString('ko-KR')
    });
    
    SpreadsheetApp.getUi().alert(`âœ… ê²€ì‚°ê¹Œì§€ ì™„ë£Œ! (${targetDate})\n\nì¿ íŒ¡ ì—…ë¡œë”ê°€ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.\nì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ë‚˜ë¨¸ì§€ ê³¼ì •ì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.`);
    
    // ì¿ íŒ¡ ì—…ë¡œë” ìë™ ì—´ê¸°
    openCoupangUploaderSeamless();
    
  } catch (error) {
    console.error('í†µí•© ì›Œí¬í”Œë¡œìš° Part 1 ì˜¤ë¥˜:', error);
    logUpdate('âŒ í†µí•© ì›Œí¬í”Œë¡œìš° Part 1 ì˜¤ë¥˜', { success: false, error: error.toString() });
    SpreadsheetApp.getUi().alert('âŒ í†µí•© ì›Œí¬í”Œë¡œìš° Part 1 ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ì¿ íŒ¡ ì—…ë¡œë” ì—´ê¸° (í†µí•© ì›Œí¬í”Œë¡œìš°ìš©)
 */
function openCoupangUploaderSeamless() {
  const html = HtmlService.createHtmlOutputFromFile('CoupangUploaderSeamless')
    .setWidth(600)
    .setHeight(450)
    .setTitle('ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë” (í†µí•© ì›Œí¬í”Œë¡œìš°)');
  SpreadsheetApp.getUi().showModalDialog(html, 'ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë” - ì—…ë¡œë“œ í›„ ìë™ ì§„í–‰');
}

/**
 * Part 2: ì¿ íŒ¡ ì—…ë¡œë“œ í›„ ë‚˜ë¨¸ì§€ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
 */
function executePart2Pipeline() {
  try {
    console.log('=== ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ Part 2 ì‹œì‘ (ì¿ íŒ¡ í›„ ì²˜ë¦¬) ===');
    logUpdate('ğŸš€ ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ Part 2 ì‹œì‘', { success: true, time: new Date().toLocaleString('ko-KR') });
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // 1. í’ˆëª©ë³„ ë¶„í• 
    try {
      const splitResult = ProductSpliter.splitByProduct();
      logUpdate('5ï¸âƒ£ í’ˆëª©ë³„ ë¶„í• ', splitResult);
    } catch (splitError) {
      logUpdate('5ï¸âƒ£ í’ˆëª©ë³„ ë¶„í•  (ì„ íƒì )', { success: false, error: splitError.toString() });
    }
    
    // 2. í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ë° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚ ì§œ ì‚¬ìš©)
    const currentDate = getCurrentWorkingDate();
    const downloadResult = ProductDownloader.downloadProductSheets(currentDate);
    logUpdate('6ï¸âƒ£ í’ˆëª©ë³„ ì—‘ì…€ ìƒì„±', downloadResult);
    
    if (!downloadResult.success) {
      logUpdate('âš ï¸ Part 2 ì¤‘ë‹¨: ì—‘ì…€ ìƒì„± ì‹¤íŒ¨', downloadResult);
      SpreadsheetApp.getUi().alert('âŒ ì—‘ì…€ ìƒì„± ì‹¤íŒ¨: ' + downloadResult.error);
      return;
    }
    
    // 3. ìë™ ì´ë©”ì¼ ì „ì†¡
    const emailResult = sendEmailWithProductSheets();
    logUpdate('7ï¸âƒ£ ìë™ ì´ë©”ì¼ ì „ì†¡', emailResult);
    
    if (emailResult.success) {
      logUpdate('ğŸ‰ ë°˜ìë™í™” íŒŒì´í”„ë¼ì¸ ì „ì²´ ì™„ë£Œ!', {
        success: true,
        completedSteps: [
          'Part1: ì‹¸ì´ë²„ìŠ¤ì¹´ì´/EDI/ê²€ì‚°',
          'ì¿ íŒ¡ì—…ë¡œë“œ(ìˆ˜ë™)',
          'Part2: í’ˆëª©ë³„/ì—‘ì…€/ì´ë©”ì¼'
        ],
        time: new Date().toLocaleString('ko-KR')
      });
      
      SpreadsheetApp.getUi().alert(
        'âœ… Part 2 ì™„ë£Œ!\n\n' +
        'í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ë° ì´ë©”ì¼ ì „ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n' +
        'ì¶œê³  ìš”ì²­ ì´ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.'
      );
    } else {
      logUpdate('âš ï¸ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨í•˜ì§€ë§Œ ë°ì´í„° ì²˜ë¦¬ëŠ” ì™„ë£Œ', emailResult);
      SpreadsheetApp.getUi().alert('âš ï¸ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: ' + emailResult.error);
    }
    
  } catch (error) {
    console.error('Part 2 íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜:', error);
    logUpdate('âŒ Part 2 íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
    SpreadsheetApp.getUi().alert('âŒ Part 2 ì‹¤í–‰ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ í•¨ìˆ˜ (íŠ¸ë¦¬ê±°ìš©) - ë”ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
 */
function completeAutomationPipeline() {
  try {
    console.log('=== ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹œì‘ ===');
    logUpdate('ğŸš€ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹œì‘', { success: true, time: new Date().toLocaleString('ko-KR') });
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // 1. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸
    const cyberskyResult = CyberskyData.updateCyberskyData();
    logUpdate('1ï¸âƒ£ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸', cyberskyResult);
    
    if (!cyberskyResult.success) {
      logUpdate('âš ï¸ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì‹¤íŒ¨', cyberskyResult);
      return;
    }
    
    // 2. EDI ë°ì´í„° ì—…ë°ì´íŠ¸
    const ediResult = EDIData.updateEDIData();
    logUpdate('2ï¸âƒ£ EDI ë°ì´í„° ì—…ë°ì´íŠ¸', ediResult);
    
    // EDI ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„°ë§Œìœ¼ë¡œë„ ì²˜ë¦¬ ê°€ëŠ¥)
    
    // 3. ë°ì´í„° ì²˜ë¦¬ (A+B â†’ C ì‹œíŠ¸)
    const processResult = DataProcessor.processData();
    logUpdate('3ï¸âƒ£ ë°ì´í„° ì²˜ë¦¬ (A+Bâ†’C)', processResult);
    
    if (!processResult.success) {
      logUpdate('âš ï¸ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨', processResult);
      return;
    }
    
    // 4. ê²€ì‚° ì‹¤í–‰ (ì‹¤íŒ¨ ì‹œ ê²½ê³  ì´ë©”ì¼)
    const verifyResult = Verification.runVerification();
    logUpdate('4ï¸âƒ£ ê²€ì‚° ì‹¤í–‰', verifyResult);
    
    if (!verifyResult.success) {
      // ê²€ì‚° ì‹¤íŒ¨ ì‹œ ê²½ê³  ì´ë©”ì¼ ì „ì†¡
      sendVerificationFailureAlert(null, verifyResult.error || 'ê²€ì‚° ì‹¤íŒ¨');
      logUpdate('âŒ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ê²€ì‚° ì‹¤íŒ¨', verifyResult);
      return;
    }
    
    // 5. í’ˆëª©ë³„ ë¶„í• 
    try {
      const splitResult = ProductSpliter.splitByProduct();
      logUpdate('5ï¸âƒ£ í’ˆëª©ë³„ ë¶„í• ', splitResult);
    } catch (splitError) {
      logUpdate('5ï¸âƒ£ í’ˆëª©ë³„ ë¶„í•  (ì„ íƒì )', { success: false, error: splitError.toString() });
    }
    
    // 6. í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ë° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚ ì§œ ì‚¬ìš©)
    const currentDate = getCurrentWorkingDate();
    const downloadResult = ProductDownloader.downloadProductSheets(currentDate);
    logUpdate('6ï¸âƒ£ í’ˆëª©ë³„ ì—‘ì…€ ìƒì„±', downloadResult);
    
    if (!downloadResult.success) {
      logUpdate('âš ï¸ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ì—‘ì…€ ìƒì„± ì‹¤íŒ¨', downloadResult);
      return;
    }
    
    // 7. ìë™ ì´ë©”ì¼ ì „ì†¡
    const emailResult = sendEmailWithProductSheets();
    logUpdate('7ï¸âƒ£ ìë™ ì´ë©”ì¼ ì „ì†¡', emailResult);
    
    if (emailResult.success) {
      logUpdate('ğŸ‰ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì„±ê³µ!', {
        success: true,
        completedSteps: [
          'ì‹¸ì´ë²„ìŠ¤ì¹´ì´ìˆ˜ì§‘',
          'EDIì²˜ë¦¬',
          'ë°ì´í„°ê°€ê³µ',
          'ê²€ì‚°',
          'í’ˆëª©ë³„ìƒì„±',
          'ì—‘ì…€ìƒì„±',
          'ì´ë©”ì¼ì „ì†¡'
        ],
        time: new Date().toLocaleString('ko-KR')
      });
    } else {
      logUpdate('âš ï¸ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨í•˜ì§€ë§Œ ë°ì´í„° ì²˜ë¦¬ëŠ” ì™„ë£Œ', emailResult);
    }
    
  } catch (error) {
    console.error('ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜:', error);
    logUpdate('âŒ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
  }
}

/**
 * ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡
 */
function sendVerificationFailureAlert(targetDate, errorMessage) {
  try {
    console.log('=== ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡ ì‹œì‘ ===');
    
    const subject = `âš ï¸ ê³°íƒ• ìë™í™” ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ${targetDate ? `(${targetDate})` : ''}`;
    const dateStr = targetDate || getTodayShortDate();
    const fullDateStr = targetDate ? convertToFullDate(targetDate) : getTodayDate();
    
    const body = `
ğŸš¨ ê³°íƒ• ì¶œê³  ìë™í™” ì‹œìŠ¤í…œì—ì„œ ê²€ì‚° ì‹¤íŒ¨ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

ğŸ“… ì²˜ë¦¬ ë‚ ì§œ: ${fullDateStr}
âŒ ì˜¤ë¥˜ ë‚´ìš©: ${errorMessage}

â° ì‹¤íŒ¨ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}

ğŸ“‹ í™•ì¸ ì‚¬í•­:
1. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ "${fullDateStr}_ê²€ì‚°ê²°ê³¼" ì‹œíŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”
2. Aì‹œíŠ¸ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´)ì™€ Bì‹œíŠ¸ (EDI) ë°ì´í„° ìƒíƒœë¥¼ ì ê²€í•´ì£¼ì„¸ìš”
3. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ê²€ì‚°ì„ ì¬ì‹¤í–‰í•´ì£¼ì„¸ìš”

ğŸ”— ìŠ¤í”„ë ˆë“œì‹œíŠ¸: https://docs.google.com/spreadsheets/d/${SpreadsheetApp.getActiveSpreadsheet().getId()}

ìë™í™” íŒŒì´í”„ë¼ì¸ì´ ì¤‘ë‹¨ë˜ì—ˆìœ¼ë¯€ë¡œ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ì„¸ìš”.

---
ê³°íƒ• ì¶œê³  ìë™í™” ì‹œìŠ¤í…œ
    `;
    
    // ì´ë©”ì¼ ì „ì†¡
    GmailApp.sendEmail(
      'youngjoonkim@kas.co.kr',
      subject,
      body
    );
    
    console.log('ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ: youngjoonkim@kas.co.kr');
    logUpdate('ğŸ“§ ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡', { 
      success: true, 
      recipient: 'youngjoonkim@kas.co.kr',
      subject: subject 
    });
    
  } catch (emailError) {
    console.error('ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨:', emailError);
    logUpdate('âŒ ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨', { 
      success: false, 
      error: emailError.toString() 
    });
  }
}

/**
 * ìˆ˜ë™ìœ¼ë¡œ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (ë©”ë‰´ìš©) - ë‚ ì§œ ì„ íƒ í¬í•¨
 */
function manualCompleteAutomation() {
  try {
    const ui = SpreadsheetApp.getUi();
    
    // ë‚ ì§œ ì„ íƒ ì˜µì…˜
    const dateResponse = ui.alert(
      'ğŸ“… ë‚ ì§œ ì„ íƒ',
      'ì–´ë–¤ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
      'ì˜ˆ: ì˜¤ëŠ˜ ë‚ ì§œ (ìë™)\n' +
      'ì•„ë‹ˆì˜¤: ë‚ ì§œ ì§ì ‘ ì§€ì •',
      ui.ButtonSet.YES_NO_CANCEL
    );
    
    if (dateResponse === ui.Button.CANCEL) {
      return;
    }
    
    let targetDate = null;
    if (dateResponse === ui.Button.NO) {
      // ë‚ ì§œ ì§ì ‘ ì…ë ¥
      const inputResponse = ui.prompt(
        'ë‚ ì§œ ì…ë ¥',
        'MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 0807, 0810)\n\nì „ì²´ íŒŒì´í”„ë¼ì¸ì´ í•´ë‹¹ ë‚ ì§œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.',
        ui.ButtonSet.OK_CANCEL
      );
      
      if (inputResponse.getSelectedButton() !== ui.Button.OK) {
        return;
      }
      
      targetDate = inputResponse.getResponseText().trim();
      if (!/^\d{4}$/.test(targetDate)) {
        ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
    }
    
    // ì‹¤í–‰ í™•ì¸
    const confirmResponse = ui.alert(
      'ğŸš€ ì™„ì „ ìë™í™” ì‹¤í–‰',
      `ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
      `ë‚ ì§œ: ${targetDate || 'ì˜¤ëŠ˜'}\n\n` +
      'ì‹¤í–‰ ê³¼ì •:\n' +
      'â€¢ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ìˆ˜ì§‘\n' +
      'â€¢ EDI ë°ì´í„° ì²˜ë¦¬\n' +
      'â€¢ ë°ì´í„° ê°€ê³µ ë° ê²€ì‚°\n' +
      'â€¢ í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„±\n' +
      'â€¢ ì—‘ì…€ íŒŒì¼ ìƒì„±\n' +
      'â€¢ ìë™ ì´ë©”ì¼ ì „ì†¡\n\n' +
      'âš ï¸ ì´ ì‘ì—…ì€ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
      ui.ButtonSet.YES_NO
    );
    
    if (confirmResponse === ui.Button.YES) {
      ui.alert(`ğŸ”„ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤.\në‚ ì§œ: ${targetDate || 'ì˜¤ëŠ˜'}\n\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ì§„í–‰ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.`);
      
      // ë‚ ì§œ ì§€ì • ì™„ì „ ìë™í™” ì‹¤í–‰
      if (targetDate) {
        completeAutomationPipelineWithDate(targetDate);
      } else {
        completeAutomationPipeline();
      }
    }
    
  } catch (error) {
    console.error('ìˆ˜ë™ ì™„ì „ ìë™í™” ì‹¤í–‰ ì˜¤ë¥˜:', error);
    SpreadsheetApp.getUi().alert('âŒ ì‹¤í–‰ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ë‚ ì§œ ì§€ì • ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
 */
function completeAutomationPipelineWithDate(targetDate) {
  try {
    console.log(`=== ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹œì‘ (ë‚ ì§œ: ${targetDate}) ===`);
    logUpdate(`ğŸš€ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹œì‘ (${targetDate})`, { success: true, time: new Date().toLocaleString('ko-KR') });
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // 1. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸ (ë‚ ì§œ ì§€ì •)
    const cyberskyResult = CyberskyData.updateCyberskyDataForDate(targetDate);
    logUpdate(`1ï¸âƒ£ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸ (${targetDate})`, cyberskyResult);
    
    if (!cyberskyResult.success) {
      logUpdate(`âš ï¸ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì‹¤íŒ¨ (${targetDate})`, cyberskyResult);
      return;
    }
    
    // 2. EDI ë°ì´í„° ì—…ë°ì´íŠ¸ (ë‚ ì§œ ì§€ì •)
    const ediResult = EDIData.getEDIFromEmail(targetDate);
    logUpdate(`2ï¸âƒ£ EDI ë°ì´í„° ì—…ë°ì´íŠ¸ (${targetDate})`, ediResult);
    
    // EDI ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„°ë§Œìœ¼ë¡œë„ ì²˜ë¦¬ ê°€ëŠ¥)
    
    // 3. ë°ì´í„° ì²˜ë¦¬ (A+B â†’ C ì‹œíŠ¸)
    const processResult = DataProcessor.processData();
    logUpdate('3ï¸âƒ£ ë°ì´í„° ì²˜ë¦¬ (A+Bâ†’C)', processResult);
    
    if (!processResult.success) {
      logUpdate('âš ï¸ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨', processResult);
      return;
    }
    
    // 4. ê²€ì‚° ì‹¤í–‰ (ì‹¤íŒ¨ ì‹œ ê²½ê³  ì´ë©”ì¼)
    const verifyResult = Verification.runVerification();
    logUpdate('4ï¸âƒ£ ê²€ì‚° ì‹¤í–‰', verifyResult);
    
    if (!verifyResult.success) {
      // ê²€ì‚° ì‹¤íŒ¨ ì‹œ ê²½ê³  ì´ë©”ì¼ ì „ì†¡
      sendVerificationFailureAlert(targetDate, verifyResult.error || 'ê²€ì‚° ì‹¤íŒ¨');
      logUpdate('âŒ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ê²€ì‚° ì‹¤íŒ¨', verifyResult);
      return;
    }
    
    // 5. í’ˆëª©ë³„ ë¶„í• 
    try {
      const splitResult = ProductSpliter.splitByProduct();
      logUpdate('5ï¸âƒ£ í’ˆëª©ë³„ ë¶„í• ', splitResult);
    } catch (splitError) {
      logUpdate('5ï¸âƒ£ í’ˆëª©ë³„ ë¶„í•  (ì„ íƒì )', { success: false, error: splitError.toString() });
    }
    
    // 6. í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ë° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚ ì§œ ì‚¬ìš©)
    const currentDate = getCurrentWorkingDate();
    const downloadResult = ProductDownloader.downloadProductSheets(currentDate);
    logUpdate('6ï¸âƒ£ í’ˆëª©ë³„ ì—‘ì…€ ìƒì„±', downloadResult);
    
    if (!downloadResult.success) {
      logUpdate('âš ï¸ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ì—‘ì…€ ìƒì„± ì‹¤íŒ¨', downloadResult);
      return;
    }
    
    // 7. ìë™ ì´ë©”ì¼ ì „ì†¡ (ë‚ ì§œ ì§€ì •)
    const emailResult = sendEmailWithProductSheets(targetDate);
    logUpdate('7ï¸âƒ£ ìë™ ì´ë©”ì¼ ì „ì†¡', emailResult);
    
    if (emailResult.success) {
      logUpdate(`ğŸ‰ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì„±ê³µ! (${targetDate})`, {
        success: true,
        completedSteps: [
          'ì‹¸ì´ë²„ìŠ¤ì¹´ì´ìˆ˜ì§‘',
          'EDIì²˜ë¦¬',
          'ë°ì´í„°ê°€ê³µ',
          'ê²€ì‚°',
          'í’ˆëª©ë³„ìƒì„±',
          'ì—‘ì…€ìƒì„±',
          'ì´ë©”ì¼ì „ì†¡'
        ],
        time: new Date().toLocaleString('ko-KR')
      });
    } else {
      logUpdate('âš ï¸ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨í•˜ì§€ë§Œ ë°ì´í„° ì²˜ë¦¬ëŠ” ì™„ë£Œ', emailResult);
    }
    
  } catch (error) {
    console.error('ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜:', error);
    logUpdate('âŒ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
  }
}

/**
 * ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡
 */
function sendVerificationFailureAlert(targetDate, errorMessage) {
  try {
    console.log('=== ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡ ì‹œì‘ ===');
    
    const subject = `âš ï¸ ê³°íƒ• ìë™í™” ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ${targetDate ? `(${targetDate})` : ''}`;
    const dateStr = targetDate || getTodayShortDate();
    const fullDateStr = targetDate ? convertToFullDate(targetDate) : getTodayDate();
    
    const body = `
ğŸš¨ ê³°íƒ• ì¶œê³  ìë™í™” ì‹œìŠ¤í…œì—ì„œ ê²€ì‚° ì‹¤íŒ¨ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

ğŸ“… ì²˜ë¦¬ ë‚ ì§œ: ${fullDateStr}
âŒ ì˜¤ë¥˜ ë‚´ìš©: ${errorMessage}

â° ì‹¤íŒ¨ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}

ğŸ“‹ í™•ì¸ ì‚¬í•­:
1. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ "${fullDateStr}_ê²€ì‚°ê²°ê³¼" ì‹œíŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”
2. Aì‹œíŠ¸ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´)ì™€ Bì‹œíŠ¸ (EDI) ë°ì´í„° ìƒíƒœë¥¼ ì ê²€í•´ì£¼ì„¸ìš”
3. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ê²€ì‚°ì„ ì¬ì‹¤í–‰í•´ì£¼ì„¸ìš”

ğŸ”— ìŠ¤í”„ë ˆë“œì‹œíŠ¸: https://docs.google.com/spreadsheets/d/${SpreadsheetApp.getActiveSpreadsheet().getId()}

ìë™í™” íŒŒì´í”„ë¼ì¸ì´ ì¤‘ë‹¨ë˜ì—ˆìœ¼ë¯€ë¡œ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ì„¸ìš”.

---
ê³°íƒ• ì¶œê³  ìë™í™” ì‹œìŠ¤í…œ
    `;
    
    // ì´ë©”ì¼ ì „ì†¡
    GmailApp.sendEmail(
      'youngjoonkim@kas.co.kr',
      subject,
      body
    );
    
    console.log('ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ: youngjoonkim@kas.co.kr');
    logUpdate('ğŸ“§ ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡', { 
      success: true, 
      recipient: 'youngjoonkim@kas.co.kr',
      subject: subject 
    });
    
  } catch (emailError) {
    console.error('ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨:', emailError);
    logUpdate('âŒ ê²€ì‚° ì‹¤íŒ¨ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨', { 
      success: false, 
      error: emailError.toString() 
    });
  }
}


/**
 * í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ ì‹œíŠ¸ëª…ì—ì„œ ì¶”ì¶œ)
 */
function getCurrentWorkingDate() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = spreadsheet.getSheets();
    
    // ìˆ˜ê¸°ì†¡ì¥ ì‹œíŠ¸ì—ì„œ ë‚ ì§œ ì¶”ì¶œ
    for (const sheet of sheets) {
      const name = sheet.getName();
      if (name.includes("_ê°„í¸ì‹_ìˆ˜ê¸°ì†¡ì¥") && !name.startsWith("TEST_")) {
        const datePart = name.split("_")[0];
        if (datePart.length === 8 && /^\d{8}$/.test(datePart)) {
          return datePart.substring(4); // YYYYMMDDì—ì„œ MMDD ì¶”ì¶œ
        }
      }
    }
    
    // ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì—ì„œ ë‚ ì§œ ì¶”ì¶œ
    for (const sheet of sheets) {
      const name = sheet.getName();
      if (name.includes("_ê²€ì‚°ê²°ê³¼") && !name.startsWith("TEST_")) {
        const datePart = name.split("_")[0];
        if (datePart.length === 8 && /^\d{8}$/.test(datePart)) {
          return datePart.substring(4); // YYYYMMDDì—ì„œ MMDD ì¶”ì¶œ
        }
      }
    }
    
    // ê¸°ë³¸ê°’: ì˜¤ëŠ˜ ë‚ ì§œ
    return getTodayShortDate();
    
  } catch (error) {
    console.error("getCurrentWorkingDate ì˜¤ë¥˜:", error);
    return getTodayShortDate();
  }
}
