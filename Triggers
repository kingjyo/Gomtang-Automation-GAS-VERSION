/**
 * ìë™ ì‹¤í–‰ íŠ¸ë¦¬ê±° ì„¤ì •
 * Triggers.gs
 */

/**
 * íŠ¸ë¦¬ê±° ì„¤ì • (ë©”ë‰´ì—ì„œ ì‹¤í–‰)
 */
function setupTriggers() {
  try {
    // ê¸°ì¡´ íŠ¸ë¦¬ê±° ì œê±° (ê¶Œí•œ ë¬¸ì œë¡œ ì¸í•´ try-catch ì²˜ë¦¬)
    try {
      removeTriggers();
    } catch (permissionError) {
      console.log('ê¸°ì¡´ íŠ¸ë¦¬ê±° í™•ì¸ ê¶Œí•œ ì—†ìŒ, ìƒˆ íŠ¸ë¦¬ê±°ë§Œ ìƒì„±:', permissionError.toString());
    }
    
    // ë§¤ì¼ ì˜¤í›„ 2ì‹œ ì‹¤í–‰ íŠ¸ë¦¬ê±° ìƒì„±
    const trigger = ScriptApp.newTrigger('dailyUpdate')
      .timeBased()
      .everyDays(1)
      .atHour(14) // ì˜¤í›„ 2ì‹œ
      .create();
    
    console.log('ìƒˆ íŠ¸ë¦¬ê±° ìƒì„±ë¨:', trigger.getUniqueId());
    
    SpreadsheetApp.getUi().alert('âœ… ì™„ì „í•œ ìë™í™” ì„¤ì • ì™„ë£Œ!\n\nğŸ”„ ë§¤ì¼ ì˜¤í›„ 2ì‹œ ì‹¤í–‰ ê³¼ì •:\n1ï¸âƒ£ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ìˆ˜ì§‘\n2ï¸âƒ£ EDI ë°ì´í„° ì²˜ë¦¬ (1~3:30ì‹œ ì‚¬ì´)\n3ï¸âƒ£ ë°ì´í„° ê°€ê³µ ë° ê²€ì‚°\n4ï¸âƒ£ í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„±\n5ï¸âƒ£ ìë™ ì´ë©”ì¼ ì „ì†¡\n\nğŸ“§ ì´ë©”ì¼ì´ ìë™ìœ¼ë¡œ ë°œì†¡ë©ë‹ˆë‹¤!\n\nì°¸ê³ : ê¸°ì¡´ íŠ¸ë¦¬ê±°ê°€ ìˆë‹¤ë©´ Google Apps Script í¸ì§‘ê¸°ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì£¼ì„¸ìš”.');
    
  } catch (error) {
    console.error('íŠ¸ë¦¬ê±° ì„¤ì • ì‹¤íŒ¨:', error);
    SpreadsheetApp.getUi().alert('âŒ íŠ¸ë¦¬ê±° ì„¤ì • ì‹¤íŒ¨: ' + error.toString() + '\n\nGoogle Apps Script í¸ì§‘ê¸°ì—ì„œ ì§ì ‘ íŠ¸ë¦¬ê±°ë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”.');
  }
}

/**
 * íŠ¸ë¦¬ê±° ì œê±° (ê¶Œí•œì´ ìˆëŠ” ê²½ìš°ì—ë§Œ)
 */
function removeTriggers() {
  try {
    const triggers = ScriptApp.getProjectTriggers();
    let removedCount = 0;
    
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'dailyUpdate') {
        ScriptApp.deleteTrigger(trigger);
        removedCount++;
        console.log('íŠ¸ë¦¬ê±° ì‚­ì œë¨:', trigger.getUniqueId());
      }
    });
    
    console.log(`ì´ ${removedCount}ê°œì˜ ê¸°ì¡´ íŠ¸ë¦¬ê±° ì‚­ì œ ì™„ë£Œ`);
    return { success: true, removedCount };
    
  } catch (error) {
    console.error('íŠ¸ë¦¬ê±° ì œê±° ì‹¤íŒ¨ (ê¶Œí•œ ë¶€ì¡± ê°€ëŠ¥ì„±):', error.toString());
    throw error; // ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡
  }
}

/**
 * ìˆ˜ë™ìœ¼ë¡œ íŠ¸ë¦¬ê±° ì œê±° (ë©”ë‰´ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥)
 */
function manualRemoveTriggers() {
  try {
    const result = removeTriggers();
    SpreadsheetApp.getUi().alert(`âœ… íŠ¸ë¦¬ê±° ì œê±° ì™„ë£Œ!\nì‚­ì œëœ íŠ¸ë¦¬ê±°: ${result.removedCount}ê°œ`);
  } catch (error) {
    SpreadsheetApp.getUi().alert(`âŒ íŠ¸ë¦¬ê±° ì œê±° ì‹¤íŒ¨: ${error.toString()}\n\nGoogle Apps Script í¸ì§‘ê¸° â†’ ì™¼ìª½ ì‚¬ì´ë“œë°” â†’ íŠ¸ë¦¬ê±°(â°) ë©”ë‰´ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì£¼ì„¸ìš”.`);
  }
}

/**
 * ë§¤ì¼ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
 */
function dailyUpdate() {
  try {
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸
    const result = CyberskyData.updateCyberskyData();
    
    if (result.success) {
      // ë¡œê·¸ ê¸°ë¡
      logUpdate('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ìë™ ì—…ë°ì´íŠ¸ ì„±ê³µ', result);
      
      // EDI ë°ì´í„°ë„ í™•ì¸
      checkAndUpdateEDI();
    } else {
      logUpdate('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ìë™ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨', result);
    }
    
  } catch (error) {
    logUpdate('ìë™ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜', { error: error.toString() });
  }
}

/**
 * EDI ë°ì´í„° í™•ì¸ ë° ì „ì²´ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
 */
function checkAndUpdateEDI() {
  try {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // ì˜¤í›„ 1ì‹œ ~ 3ì‹œ 30ë¶„ ì‚¬ì´ë©´ EDI í™•ì¸ ë° ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
    if ((hours === 13) || (hours === 14) || (hours === 15 && minutes <= 30)) {
      logUpdate('ì „ì²´ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹œì‘', { success: true, time: now.toLocaleString('ko-KR') });
      
      // 1. EDI ë°ì´í„° ì—…ë°ì´íŠ¸
      const ediResult = EDIData.updateEDIData();
      logUpdate('EDI ë°ì´í„° ì—…ë°ì´íŠ¸', ediResult);
      
      if (ediResult.success) {
        // 2. ë°ì´í„° ì²˜ë¦¬ (A+B â†’ C ì‹œíŠ¸)
        const processResult = DataProcessor.processData();
        logUpdate('ë°ì´í„° ì²˜ë¦¬ (A+Bâ†’C)', processResult);
        
        if (processResult.success) {
          // 3. ê²€ì‚° ì‹¤í–‰
          const verifyResult = Verification.runVerification();
          logUpdate('ê²€ì‚° ì‹¤í–‰', verifyResult);
          
          // 4. í’ˆëª©ë³„ ë¶„í•  (ì„ íƒì )
          try {
            const splitResult = ProductSpliter.splitByProduct();
            logUpdate('í’ˆëª©ë³„ ë¶„í• ', splitResult);
          } catch (splitError) {
            logUpdate('í’ˆëª©ë³„ ë¶„í•  (ì„ íƒì )', { success: false, error: splitError.toString() });
          }
          
          // 5. ì™„ì „í•œ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (ë°ì´í„° ê°€ê³µ â†’ ì´ë©”ì¼ ì „ì†¡)
          executeFullAutomationPipeline();
        }
      } else {
        // EDI ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ ë°ì´í„° ì²˜ë¦¬ ì‹œë„
        logUpdate('EDI ì—†ì´ ê¸°ë³¸ ë°ì´í„° ì²˜ë¦¬ ì‹œë„', { success: true });
        executeBasicAutomationPipeline();
      }
    } else {
      // ì‹œê°„ëŒ€ê°€ ì•„ë‹ˆë©´ ê¸°ë³¸ ë°ì´í„° ì²˜ë¦¬ë§Œ
      logUpdate('EDI ì‹œê°„ëŒ€ ì•„ë‹˜ - ê¸°ë³¸ ì²˜ë¦¬ë§Œ ì‹¤í–‰', { success: true, time: now.toLocaleString('ko-KR') });
      executeBasicAutomationPipeline();
    }
    
  } catch (error) {
    logUpdate('ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
  }
}

/**
 * ì™„ì „í•œ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (EDI í¬í•¨)
 */
function executeFullAutomationPipeline() {
  try {
    logUpdate('ì™„ì „í•œ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œì‘', { success: true });
    
    // 1. í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ë° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    const downloadResult = ProductDownloader.downloadProductSheets();
    logUpdate('í’ˆëª©ë³„ ì‹œíŠ¸ ë‹¤ìš´ë¡œë“œ', downloadResult);
    
    if (downloadResult.success) {
      // 2. ìë™ ì´ë©”ì¼ ì „ì†¡
      const emailResult = sendEmailWithProductSheets();
      logUpdate('ìë™ ì´ë©”ì¼ ì „ì†¡', emailResult);
      
      if (emailResult.success) {
        logUpdate('ğŸ‰ ì™„ì „í•œ ìë™í™” íŒŒì´í”„ë¼ì¸ ì„±ê³µ!', { 
          success: true, 
          completedSteps: ['ë°ì´í„°ìˆ˜ì§‘', 'EDIì²˜ë¦¬', 'ë°ì´í„°ê°€ê³µ', 'ê²€ì‚°', 'í’ˆëª©ë³„ìƒì„±', 'ì´ë©”ì¼ì „ì†¡'] 
        });
      } else {
        logUpdate('ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨í•˜ì§€ë§Œ ë°ì´í„° ì²˜ë¦¬ëŠ” ì™„ë£Œ', emailResult);
      }
    } else {
      logUpdate('í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ì‹¤íŒ¨', downloadResult);
    }
    
  } catch (error) {
    logUpdate('ì™„ì „í•œ ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
  }
}

/**
 * ê¸°ë³¸ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (EDI ì—†ì´)
 */
function executeBasicAutomationPipeline() {
  try {
    logUpdate('ê¸°ë³¸ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œì‘', { success: true });
    
    // 1. ê¸°ë³¸ ë°ì´í„° ì²˜ë¦¬ ì‹œë„
    const processResult = DataProcessor.processData();
    logUpdate('ê¸°ë³¸ ë°ì´í„° ì²˜ë¦¬', processResult);
    
    // 2. ê²€ì‚° (ì„ íƒì )
    try {
      const verifyResult = Verification.runVerification();
      logUpdate('ê¸°ë³¸ ê²€ì‚°', verifyResult);
    } catch (verifyError) {
      logUpdate('ê¸°ë³¸ ê²€ì‚° (ì„ íƒì )', { success: false, error: verifyError.toString() });
    }
    
    // 3. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„°ë§Œìœ¼ë¡œ ì´ë©”ì¼ ì „ì†¡ ì‹œë„
    try {
      const emailResult = sendEmailWithProductSheets();
      logUpdate('ê¸°ë³¸ ì´ë©”ì¼ ì „ì†¡ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´ë§Œ)', emailResult);
      
      if (emailResult.success) {
        logUpdate('âœ… ê¸°ë³¸ ìë™í™” íŒŒì´í”„ë¼ì¸ ì„±ê³µ!', { 
          success: true, 
          completedSteps: ['ë°ì´í„°ìˆ˜ì§‘', 'ê¸°ë³¸ê°€ê³µ', 'ì´ë©”ì¼ì „ì†¡'] 
        });
      }
    } catch (emailError) {
      logUpdate('ê¸°ë³¸ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨', { success: false, error: emailError.toString() });
    }
    
  } catch (error) {
    logUpdate('ê¸°ë³¸ ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
  }
}

/**
 * ì—…ë°ì´íŠ¸ ë¡œê·¸ ê¸°ë¡
 */
function logUpdate(message, details) {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  let logSheet = spreadsheet.getSheetByName('ì—…ë°ì´íŠ¸_ë¡œê·¸');
  
  // ë¡œê·¸ ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±
  if (!logSheet) {
    logSheet = spreadsheet.insertSheet('ì—…ë°ì´íŠ¸_ë¡œê·¸');
    const headers = ['ì¼ì‹œ', 'ì‘ì—…', 'ìƒíƒœ', 'ìƒì„¸ë‚´ìš©'];
    logSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    logSheet.getRange(1, 1, 1, headers.length)
      .setBackground('#f0f0f0')
      .setFontWeight('bold');
  }
  
  // ë¡œê·¸ ì¶”ê°€
  const timestamp = new Date();
  const status = details.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨';
  const detailsJson = JSON.stringify(details);
  
  const newRow = [timestamp, message, status, detailsJson];
  logSheet.appendRow(newRow);
  
  // ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬ (ìµœê·¼ 100ê°œë§Œ ìœ ì§€)
  const lastRow = logSheet.getLastRow();
  if (lastRow > 101) {
    logSheet.deleteRows(2, lastRow - 101);
  }
}

/**
 * ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
 */
function testDailyUpdate() {
  try {
    console.log('=== ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œì‘ ===');
    dailyUpdate();
    
    // ì‹¤í–‰ ê²°ê³¼ í™•ì¸
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const logSheet = spreadsheet.getSheetByName('ì—…ë°ì´íŠ¸_ë¡œê·¸');
    
    let resultMessage = 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì™„ë£Œ!\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
    
    if (logSheet) {
      const lastRow = logSheet.getLastRow();
      if (lastRow > 1) {
        const lastEntry = logSheet.getRange(lastRow, 1, 1, 4).getValues()[0];
        const [timestamp, action, status, details] = lastEntry;
        resultMessage += `\n\nìµœê·¼ ë¡œê·¸:\nì‹œê°„: ${timestamp}\nì‘ì—…: ${action}\nìƒíƒœ: ${status}`;
      }
    }
    
    SpreadsheetApp.getUi().alert(resultMessage);
    console.log('=== ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
    
  } catch (error) {
    console.error('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜:', error);
    SpreadsheetApp.getUi().alert('âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨: ' + error.toString());
  }
}

/**
 * ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ (ì‹œê°„ ë¬´ê´€)
 */
function immediateTest() {
  try {
    console.log('=== ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // í˜„ì¬ ì‹œê°„ í‘œì‹œ
    const now = new Date();
    console.log('í˜„ì¬ ì‹œê°„:', now.toLocaleString('ko-KR'));
    
    // ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œë„
    const cyberskyResult = CyberskyData.updateCyberskyData();
    console.log('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ê²°ê³¼:', cyberskyResult);
    
    // ê²°ê³¼ ë¡œê¹…
    logUpdate('ìˆ˜ë™ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸', cyberskyResult);
    
    // UI ì•Œë¦¼
    const message = cyberskyResult.success 
      ? `âœ… ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì„±ê³µ!\nì‹œíŠ¸: ${cyberskyResult.sheetName}\ní–‰ ìˆ˜: ${cyberskyResult.rowCount}` 
      : `âŒ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:\n${cyberskyResult.error}`;
      
    SpreadsheetApp.getUi().alert(message);
    
  } catch (error) {
    console.error('ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
    logUpdate('ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
    SpreadsheetApp.getUi().alert('âŒ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ (ê³¼ê±° ë°ì´í„° í…ŒìŠ¤íŠ¸ìš©)
 */
function testWithDate() {
  try {
    const ui = SpreadsheetApp.getUi();
    
    // ì‚¬ìš©ìì—ê²Œ ë‚ ì§œ ì…ë ¥ ìš”ì²­
    const response = ui.prompt(
      'ğŸ“… ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸',
      'í…ŒìŠ¤íŠ¸í•  ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n\ní˜•ì‹: MMDD (ì˜ˆ: 0728, 0810)\në˜ëŠ” YYYYMMDD (ì˜ˆ: 20240728)',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (response.getSelectedButton() === ui.Button.CANCEL) {
      return;
    }
    
    const inputDate = response.getResponseText().trim();
    if (!inputDate) {
      ui.alert('âŒ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    console.log('=== ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
    console.log('ì…ë ¥ ë‚ ì§œ:', inputDate);
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // í˜„ì¬ ì‹œê°„ í‘œì‹œ
    const now = new Date();
    console.log('í˜„ì¬ ì‹œê°„:', now.toLocaleString('ko-KR'));
    
    // ì§€ì • ë‚ ì§œë¡œ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œë„
    const cyberskyResult = CyberskyData.updateCyberskyDataForDate(inputDate);
    console.log('ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ê²°ê³¼:', cyberskyResult);
    
    // ê²°ê³¼ ë¡œê¹…
    logUpdate(`ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ (${inputDate})`, cyberskyResult);
    
    // UI ì•Œë¦¼
    const message = cyberskyResult.success 
      ? `âœ… ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì„±ê³µ!\në‚ ì§œ: ${inputDate}\nì‹œíŠ¸: ${cyberskyResult.sheetName}\ní–‰ ìˆ˜: ${cyberskyResult.rowCount}` 
      : `âŒ ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:\në‚ ì§œ: ${inputDate}\nì˜¤ë¥˜: ${cyberskyResult.error}`;
      
    ui.alert(message);
    
  } catch (error) {
    console.error('ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
    logUpdate('ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
    SpreadsheetApp.getUi().alert('âŒ ë‚ ì§œ ì§€ì • í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ íŠ¸ë¦¬ê±° ì„¤ì • (ì´ë©”ì¼ê¹Œì§€ í¬í•¨)
 */
function setupCompleteAutomationTrigger() {
  try {
    // ê¸°ì¡´ ì™„ì „ ìë™í™” íŠ¸ë¦¬ê±° ì œê±° (ê¶Œí•œ ë¬¸ì œë¡œ ì¸í•´ try-catch ì²˜ë¦¬)
    try {
      removeCompleteAutomationTriggers();
    } catch (permissionError) {
      console.log('ê¸°ì¡´ ì™„ì „ ìë™í™” íŠ¸ë¦¬ê±° í™•ì¸ ê¶Œí•œ ì—†ìŒ, ìƒˆ íŠ¸ë¦¬ê±°ë§Œ ìƒì„±:', permissionError.toString());
    }
    
    // ë§¤ì¼ ì˜¤í›„ 2ì‹œ 30ë¶„ ì‹¤í–‰ íŠ¸ë¦¬ê±° ìƒì„± (ê¸°ë³¸ íŠ¸ë¦¬ê±°ë³´ë‹¤ 30ë¶„ ëŠ¦ê²Œ)
    const trigger = ScriptApp.newTrigger('completeAutomationPipeline')
      .timeBased()
      .everyDays(1)
      .atHour(14)
      .nearMinute(30) // 2ì‹œ 30ë¶„
      .create();
    
    console.log('ìƒˆ ì™„ì „ ìë™í™” íŠ¸ë¦¬ê±° ìƒì„±ë¨:', trigger.getUniqueId());
    
    SpreadsheetApp.getUi().alert(
      'âœ… ì™„ì „ ìë™í™” íŠ¸ë¦¬ê±° ì„¤ì • ì™„ë£Œ!\n\n' +
      'ğŸ”„ ë§¤ì¼ ì˜¤í›„ 2ì‹œ 30ë¶„ ì‹¤í–‰ ê³¼ì •:\n' +
      '1ï¸âƒ£ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ìˆ˜ì§‘\n' +
      '2ï¸âƒ£ EDI ë°ì´í„° ì²˜ë¦¬\n' +
      '3ï¸âƒ£ ë°ì´í„° ê°€ê³µ ë° ê²€ì‚°\n' +
      '4ï¸âƒ£ í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„±\n' +
      '5ï¸âƒ£ ì—‘ì…€ íŒŒì¼ ìƒì„±\n' +
      '6ï¸âƒ£ ìë™ ì´ë©”ì¼ ì „ì†¡\n\n' +
      'ğŸ“§ ëª¨ë“  ê³¼ì •ì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ ì´ë©”ì¼ì´ ë°œì†¡ë©ë‹ˆë‹¤!\n\n' +
      'âš ï¸ ì°¸ê³ : ê¸°ì¡´ íŠ¸ë¦¬ê±°ê°€ ìˆë‹¤ë©´ Google Apps Script í¸ì§‘ê¸°ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì£¼ì„¸ìš”.'
    );
    
  } catch (error) {
    console.error('ì™„ì „ ìë™í™” íŠ¸ë¦¬ê±° ì„¤ì • ì‹¤íŒ¨:', error);
    SpreadsheetApp.getUi().alert('âŒ ì™„ì „ ìë™í™” íŠ¸ë¦¬ê±° ì„¤ì • ì‹¤íŒ¨: ' + error.toString() + '\n\nGoogle Apps Script í¸ì§‘ê¸°ì—ì„œ ì§ì ‘ íŠ¸ë¦¬ê±°ë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”.');
  }
}

/**
 * ì™„ì „ ìë™í™” íŠ¸ë¦¬ê±° ì œê±° (ê¶Œí•œì´ ìˆëŠ” ê²½ìš°ì—ë§Œ)
 */
function removeCompleteAutomationTriggers() {
  try {
    const triggers = ScriptApp.getProjectTriggers();
    let removedCount = 0;
    
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'completeAutomationPipeline') {
        ScriptApp.deleteTrigger(trigger);
        removedCount++;
        console.log('ì™„ì „ ìë™í™” íŠ¸ë¦¬ê±° ì‚­ì œë¨:', trigger.getUniqueId());
      }
    });
    
    console.log(`ì´ ${removedCount}ê°œì˜ ê¸°ì¡´ ì™„ì „ ìë™í™” íŠ¸ë¦¬ê±° ì‚­ì œ ì™„ë£Œ`);
    return { success: true, removedCount };
    
  } catch (error) {
    console.error('ì™„ì „ ìë™í™” íŠ¸ë¦¬ê±° ì œê±° ì‹¤íŒ¨ (ê¶Œí•œ ë¶€ì¡± ê°€ëŠ¥ì„±):', error.toString());
    throw error; // ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡
  }
}

/**
 * ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ í•¨ìˆ˜ (íŠ¸ë¦¬ê±°ìš©)
 */
function completeAutomationPipeline() {
  try {
    console.log('=== ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹œì‘ ===');
    logUpdate('ğŸš€ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹œì‘', { success: true, time: new Date().toLocaleString('ko-KR') });
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // 1. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸
    const cyberskyResult = CyberskyData.updateCyberskyData();
    logUpdate('1ï¸âƒ£ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì—…ë°ì´íŠ¸', cyberskyResult);
    
    if (!cyberskyResult.success) {
      logUpdate('âš ï¸ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì‹¤íŒ¨', cyberskyResult);
      return;
    }
    
    // 2. EDI ë°ì´í„° ì—…ë°ì´íŠ¸
    const ediResult = EDIData.updateEDIData();
    logUpdate('2ï¸âƒ£ EDI ë°ì´í„° ì—…ë°ì´íŠ¸', ediResult);
    
    // EDI ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„°ë§Œìœ¼ë¡œë„ ì²˜ë¦¬ ê°€ëŠ¥)
    
    // 3. ë°ì´í„° ì²˜ë¦¬ (A+B â†’ C ì‹œíŠ¸)
    const processResult = DataProcessor.processData();
    logUpdate('3ï¸âƒ£ ë°ì´í„° ì²˜ë¦¬ (A+Bâ†’C)', processResult);
    
    if (!processResult.success) {
      logUpdate('âš ï¸ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨', processResult);
      return;
    }
    
    // 4. ê²€ì‚° ì‹¤í–‰
    const verifyResult = Verification.runVerification();
    logUpdate('4ï¸âƒ£ ê²€ì‚° ì‹¤í–‰', verifyResult);
    
    // 5. í’ˆëª©ë³„ ë¶„í• 
    try {
      const splitResult = ProductSpliter.splitByProduct();
      logUpdate('5ï¸âƒ£ í’ˆëª©ë³„ ë¶„í• ', splitResult);
    } catch (splitError) {
      logUpdate('5ï¸âƒ£ í’ˆëª©ë³„ ë¶„í•  (ì„ íƒì )', { success: false, error: splitError.toString() });
    }
    
    // 6. í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ë° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    const downloadResult = ProductDownloader.downloadProductSheets();
    logUpdate('6ï¸âƒ£ í’ˆëª©ë³„ ì—‘ì…€ ìƒì„±', downloadResult);
    
    if (!downloadResult.success) {
      logUpdate('âš ï¸ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨: ì—‘ì…€ ìƒì„± ì‹¤íŒ¨', downloadResult);
      return;
    }
    
    // 7. ìë™ ì´ë©”ì¼ ì „ì†¡
    const emailResult = sendEmailWithProductSheets();
    logUpdate('7ï¸âƒ£ ìë™ ì´ë©”ì¼ ì „ì†¡', emailResult);
    
    if (emailResult.success) {
      logUpdate('ğŸ‰ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì„±ê³µ!', {
        success: true,
        completedSteps: [
          'ì‹¸ì´ë²„ìŠ¤ì¹´ì´ìˆ˜ì§‘',
          'EDIì²˜ë¦¬',
          'ë°ì´í„°ê°€ê³µ',
          'ê²€ì‚°',
          'í’ˆëª©ë³„ìƒì„±',
          'ì—‘ì…€ìƒì„±',
          'ì´ë©”ì¼ì „ì†¡'
        ],
        time: new Date().toLocaleString('ko-KR')
      });
    } else {
      logUpdate('âš ï¸ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨í•˜ì§€ë§Œ ë°ì´í„° ì²˜ë¦¬ëŠ” ì™„ë£Œ', emailResult);
    }
    
  } catch (error) {
    console.error('ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜:', error);
    logUpdate('âŒ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
  }
}

/**
 * ìˆ˜ë™ìœ¼ë¡œ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (ë©”ë‰´ìš©)
 */
function manualCompleteAutomation() {
  try {
    const ui = SpreadsheetApp.getUi();
    const response = ui.alert(
      'ğŸš€ ì™„ì „ ìë™í™” ì‹¤í–‰',
      'ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
      'ì‹¤í–‰ ê³¼ì •:\n' +
      'â€¢ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ìˆ˜ì§‘\n' +
      'â€¢ EDI ë°ì´í„° ì²˜ë¦¬\n' +
      'â€¢ ë°ì´í„° ê°€ê³µ ë° ê²€ì‚°\n' +
      'â€¢ í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„±\n' +
      'â€¢ ì—‘ì…€ íŒŒì¼ ìƒì„±\n' +
      'â€¢ ìë™ ì´ë©”ì¼ ì „ì†¡\n\n' +
      'âš ï¸ ì´ ì‘ì—…ì€ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
      ui.ButtonSet.YES_NO
    );
    
    if (response === ui.Button.YES) {
      ui.alert('ğŸ”„ ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤.\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ì§„í–‰ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.');
      completeAutomationPipeline();
    }
    
  } catch (error) {
    console.error('ìˆ˜ë™ ì™„ì „ ìë™í™” ì‹¤í–‰ ì˜¤ë¥˜:', error);
    SpreadsheetApp.getUi().alert('âŒ ì‹¤í–‰ ì˜¤ë¥˜: ' + error.toString());
  }
}
