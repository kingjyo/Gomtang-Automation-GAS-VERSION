/**
 * ì¦‰ì‹œ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (íŠ¸ë¦¬ê±° ì—†ì´)
 * ImmediateFullPipeline.gs
 * 
 * íŠ¸ë¦¬ê±° ì‹œìŠ¤í…œì˜ ëª¨ë“  ê³¼ì •ì„ ì¦‰ì‹œ ì‹¤í–‰
 * ì¿ íŒ¡ íŒŒì¼ ì—…ë¡œë“œ â†’ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
 */

/**
 * ì¦‰ì‹œ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (ì¿ íŒ¡ íŒŒì¼ ì—…ë¡œë“œ í¬í•¨)
 */
function executeImmediateFullPipeline() {
  console.log('=== Function Start: executeImmediateFullPipeline ===');
  
  try {
    const ui = SpreadsheetApp.getUi();
    
    // 1. ë¨¼ì € ì¿ íŒ¡ íŒŒì¼ ì—…ë¡œë“œ ì—¬ë¶€ í™•ì¸
    const fileResponse = ui.alert(
      'ğŸ›ï¸ ì¿ íŒ¡ íŒŒì¼ ì—…ë¡œë“œ',
      'ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.\n\nì¿ íŒ¡ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì˜ˆ: ì¿ íŒ¡ íŒŒì¼ ì—…ë¡œë” ì—´ê¸°\nì•„ë‹ˆì˜¤: ì¿ íŒ¡ íŒŒì¼ ì—†ì´ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰',
      ui.ButtonSet.YES_NO_CANCEL
    );
    
    if (fileResponse === ui.Button.CANCEL) {
      return;
    }
    
    let hasCoupangFile = (fileResponse === ui.Button.YES);
    
    // 2. ë‚ ì§œ ì„ íƒ
    const dateResponse = ui.alert(
      'ğŸ“… ì²˜ë¦¬ ë‚ ì§œ ì„ íƒ',
      'ì–´ë–¤ ë‚ ì§œì˜ ë°ì´í„°ë¡œ íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì˜ˆ: ì˜¤ëŠ˜ ë‚ ì§œ (ìë™)\nì•„ë‹ˆì˜¤: ë‚ ì§œ ì§ì ‘ ì§€ì •',
      ui.ButtonSet.YES_NO_CANCEL
    );
    
    if (dateResponse === ui.Button.CANCEL) {
      return;
    }
    
    let targetDate = null;
    if (dateResponse === ui.Button.NO) {
      const inputResponse = ui.prompt(
        'ë‚ ì§œ ì…ë ¥',
        'MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 0812, 1225)',
        ui.ButtonSet.OK_CANCEL
      );
      
      if (inputResponse.getSelectedButton() !== ui.Button.OK) {
        return;
      }
      
      targetDate = inputResponse.getResponseText().trim();
      if (targetDate && !/^\d{4}$/.test(targetDate)) {
        ui.alert('ì˜¤ë¥˜', 'ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', ui.ButtonSet.OK);
        return;
      }
    }
    
    const dateStr = targetDate ? `${targetDate.substring(0,2)}ì›” ${targetDate.substring(2,4)}ì¼` : 'ì˜¤ëŠ˜';
    
    // 3. ì¿ íŒ¡ íŒŒì¼ ë¨¼ì € ì—…ë¡œë“œ (ì„ íƒí•œ ê²½ìš°)
    if (hasCoupangFile) {
      // ì‹¤í–‰ ì „ ì•ˆë‚´
      ui.alert(
        'ğŸ“¤ ì¿ íŒ¡ íŒŒì¼ ì—…ë¡œë“œ',
        `ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤.\n\nì²˜ë¦¬ ë‚ ì§œ: ${dateStr}\n\në¨¼ì € ì¿ íŒ¡ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.\nì—…ë¡œë“œ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ì „ì²´ íŒŒì´í”„ë¼ì¸ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.`,
        ui.ButtonSet.OK
      );
      
      // targetDateë¥¼ ì „ì—­ ì†ì„±ì— ì €ì¥ (ì¿ íŒ¡ ì—…ë¡œë”ì—ì„œ ì‚¬ìš©)
      if (targetDate) {
        PropertiesService.getScriptProperties().setProperty('IMMEDIATE_TARGET_DATE', targetDate);
      } else {
        PropertiesService.getScriptProperties().deleteProperty('IMMEDIATE_TARGET_DATE');
      }
      
      // ì¿ íŒ¡ ì—…ë¡œë” ì—´ê¸°
      openImmediateCoupangUploader(targetDate);
      
    } else {
      // ì¿ íŒ¡ íŒŒì¼ ì—†ì´ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (ì¿ íŒ¡ ì—…ë¡œë“œë§Œ ì œì™¸)
      const confirmResponse = ui.alert(
        'ğŸ”„ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (ì¿ íŒ¡ ì œì™¸)',
        `ì¿ íŒ¡ íŒŒì¼ ì—†ì´ ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì²˜ë¦¬ ë‚ ì§œ: ${dateStr}\n\nì‹¤í–‰ ê³¼ì •:\nâ€¢ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ìˆ˜ì§‘\nâ€¢ EDI ë°ì´í„° ì²˜ë¦¬\nâ€¢ ë°ì´í„° ê°€ê³µ ë° ê²€ì‚°\nâ€¢ í’ˆëª©ë³„ ì‹œíŠ¸ ë¶„ë¦¬\nâ€¢ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ\nâ€¢ ì´ë©”ì¼ ì „ì†¡`,
        ui.ButtonSet.YES_NO
      );
      
      if (confirmResponse !== ui.Button.YES) {
        return;
      }
      
      ui.alert(
        'ğŸ”„ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹œì‘ (ì¿ íŒ¡ ì œì™¸)',
        `ì¿ íŒ¡ ë°ì´í„° ì—†ì´ ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤.\në‚ ì§œ: ${dateStr}\n\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ì§„í–‰ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.`,
        ui.ButtonSet.OK
      );
      
      // ì„¤ì • ì´ˆê¸°í™”
      initializeConfig();
      
      logUpdate('ğŸš€ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì¦‰ì‹œ ì‹¤í–‰ ì‹œì‘ (ì¿ íŒ¡ ì—†ìŒ)', {
        success: true,
        targetDate: dateStr,
        time: new Date().toLocaleString('ko-KR')
      });
      
      // Part 1 ì‹¤í–‰
      const part1Result = targetDate 
        ? executeFullPart1PipelineWithDate(targetDate)
        : executeFullPart1Pipeline();
      
      if (!part1Result.success) {
        throw new Error('Part 1 íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨: ' + part1Result.error);
      }
      
      logUpdate('âœ… Part 1 ì™„ë£Œ - ì¿ íŒ¡ ì—†ì´ Part 2 ì§„í–‰', part1Result);
      
      // Part 2 ì‹¤í–‰ (ì¿ íŒ¡ ì—†ì´)
      const part2Result = executePart2WithoutCoupang(targetDate);
      
      if (part2Result.success) {
        logUpdate('âœ… ì „ì²´ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ! (ì¿ íŒ¡ ì—†ìŒ)', part2Result);
        ui.alert(
          'ì™„ë£Œ',
          `ì „ì²´ íŒŒì´í”„ë¼ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\në‚ ì§œ: ${dateStr}\n\nâ€¢ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ + EDI ì²˜ë¦¬ âœ…\nâ€¢ ê²€ì‚° ì™„ë£Œ âœ…\nâ€¢ í’ˆëª©ë³„ ì‹œíŠ¸ ë¶„ë¦¬ âœ…\nâ€¢ ì—‘ì…€ íŒŒì¼ ìƒì„± âœ…\nâ€¢ ì´ë©”ì¼ ì „ì†¡ âœ…\n\n(ì¿ íŒ¡ ë°ì´í„°ëŠ” í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤)`,
          ui.ButtonSet.OK
        );
      } else {
        throw new Error(part2Result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      }
    }
    
    console.log('=== Function End: executeImmediateFullPipeline SUCCESS ===');
    
  } catch (error) {
    console.error('ERROR in executeImmediateFullPipeline:', error.toString());
    logUpdate('âŒ ì¦‰ì‹œ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨', { success: false, error: error.toString() });
    
    const ui = SpreadsheetApp.getUi();
    ui.alert('ì˜¤ë¥˜', 'ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨: ' + error.toString(), ui.ButtonSet.OK);
    
    console.log('=== Function End: executeImmediateFullPipeline FAILED ===');
  }
}

/**
 * ì¦‰ì‹œ ì²˜ë¦¬ìš© ì¿ íŒ¡ ì—…ë¡œë” ì—´ê¸°
 */
function openImmediateCoupangUploader(targetDate = null) {
  console.log('=== Function Start: openImmediateCoupangUploader ===');
  console.log('Target Date:', targetDate);
  
  try {
    // targetDateë¥¼ ì „ì—­ ì†ì„±ì— ì„ì‹œ ì €ì¥
    if (targetDate) {
      PropertiesService.getScriptProperties().setProperty('IMMEDIATE_TARGET_DATE', targetDate);
    } else {
      PropertiesService.getScriptProperties().deleteProperty('IMMEDIATE_TARGET_DATE');
    }
    
    const html = HtmlService.createHtmlOutputFromFile('ImmediateCoupangUploader')
      .setWidth(650)
      .setHeight(500)
      .setTitle('ğŸš€ ì¦‰ì‹œ ì²˜ë¦¬ìš© ì¿ íŒ¡ ì—…ë¡œë”');
    SpreadsheetApp.getUi().showModalDialog(html, 'ğŸš€ ì¦‰ì‹œ ì²˜ë¦¬ìš© ì¿ íŒ¡ ì—…ë¡œë”');
    
    console.log('=== Function End: openImmediateCoupangUploader SUCCESS ===');
    
  } catch (error) {
    console.error('ERROR in openImmediateCoupangUploader:', error.toString());
    console.log('=== Function End: openImmediateCoupangUploader FAILED ===');
  }
}

/**
 * ì¿ íŒ¡ íŒŒì¼ ì—…ë¡œë“œ í›„ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (Part 1 + Part 2)
 */
function processCoupangFileImmediately(fileData, fileName) {
  console.log('=== Function Start: processCoupangFileImmediately ===');
  console.log('Parameters:', { fileName });
  
  try {
    // ì„ì‹œ ì €ì¥ëœ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
    const targetDate = PropertiesService.getScriptProperties().getProperty('IMMEDIATE_TARGET_DATE');
    const dateStr = targetDate ? `${targetDate.substring(0,2)}ì›” ${targetDate.substring(2,4)}ì¼` : 'ì˜¤ëŠ˜';
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    logUpdate('ğŸš€ ì¿ íŒ¡ íŒŒì¼ ì—…ë¡œë“œ - ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹œì‘', {
      success: true,
      fileName,
      targetDate: dateStr,
      time: new Date().toLocaleString('ko-KR')
    });
    
    // 1. Part 1 ì‹¤í–‰ (ë‚ ì§œ ì§€ì • ê°€ëŠ¥)
    logUpdate('1ï¸âƒ£ Part 1 íŒŒì´í”„ë¼ì¸ ì‹œì‘', { success: true, targetDate: dateStr });
    
    const part1Result = targetDate 
      ? executeFullPart1PipelineWithDate(targetDate)
      : executeFullPart1Pipeline();
    
    if (!part1Result.success) {
      throw new Error('Part 1 íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨: ' + part1Result.error);
    }
    
    logUpdate('âœ… Part 1 íŒŒì´í”„ë¼ì¸ ì™„ë£Œ', part1Result);
    
    // 2. Part 2 ì‹¤í–‰ (ì¿ íŒ¡ ì²˜ë¦¬ë¶€í„°)
    logUpdate('2ï¸âƒ£ Part 2 íŒŒì´í”„ë¼ì¸ ì‹œì‘ (ì¿ íŒ¡ ì²˜ë¦¬)', {
      success: true,
      fileName,
      targetDate: dateStr,
      time: new Date().toLocaleString('ko-KR')
    });
    
    const part2Result = processCoupangFileAndExecuteRemaining(fileData, fileName);
    
    if (part2Result.success) {
      logUpdate('ğŸ‰ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ!', {
        ...part2Result,
        targetDate: dateStr,
        fileName
      });
      
      // ì„ì‹œ ì €ì¥ëœ ë‚ ì§œ ì •ë¦¬
      PropertiesService.getScriptProperties().deleteProperty('IMMEDIATE_TARGET_DATE');
      
      console.log('=== Function End: processCoupangFileImmediately SUCCESS ===');
      return {
        success: true,
        message: `âœ… ì „ì²´ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ!\n\në‚ ì§œ: ${dateStr}\níŒŒì¼: ${fileName}\n\nâ€¢ Part 1: ì‹¸ì´ë²„ìŠ¤ì¹´ì´ + EDI + ê²€ì‚° âœ…\nâ€¢ Part 2: ì¿ íŒ¡ ì²˜ë¦¬ + í’ˆëª©ë¶„ë¦¬ + ì´ë©”ì¼ âœ…\n\nëª¨ë“  ê³¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`,
        ...part2Result
      };
      
    } else {
      throw new Error(part2Result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
    }
    
  } catch (error) {
    console.error('ERROR in processCoupangFileImmediately:', error.toString());
    logUpdate('âŒ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨', { success: false, error: error.toString(), fileName });
    
    // ì„ì‹œ ì €ì¥ëœ ë‚ ì§œ ì •ë¦¬
    PropertiesService.getScriptProperties().deleteProperty('IMMEDIATE_TARGET_DATE');
    
    console.log('=== Function End: processCoupangFileImmediately FAILED ===');
    return {
      success: false,
      error: error.toString()
    };
  }
}

/**
 * í˜„ì¬ ì„¤ì •ëœ ì¦‰ì‹œ ì²˜ë¦¬ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (HTMLì—ì„œ ì‚¬ìš©)
 */
function getImmediateTargetDate() {
  const targetDate = PropertiesService.getScriptProperties().getProperty('IMMEDIATE_TARGET_DATE');
  return {
    targetDate: targetDate || null,
    dateString: targetDate ? `${targetDate.substring(0,2)}ì›” ${targetDate.substring(2,4)}ì¼` : 'ì˜¤ëŠ˜'
  };
}

/**
 * ì¿ íŒ¡ íŒŒì¼ ì—†ì´ Part 2 ì‹¤í–‰ (í’ˆëª©ë¶„ë¦¬, ì—‘ì…€ìƒì„±, ì´ë©”ì¼ì „ì†¡)
 */
function executePart2WithoutCoupang(targetDate) {
  console.log('=== Function Start: executePart2WithoutCoupang ===');
  console.log('Target Date:', targetDate);
  
  try {
    // ë‚ ì§œ ì²˜ë¦¬
    const dateString = targetDate ? convertToFullDate(targetDate) : getTodayDate();
    
    // 1. í’ˆëª©ë³„ ë¶„ë¦¬
    logUpdate('ğŸ“¦ í’ˆëª©ë³„ ì‹œíŠ¸ ë¶„ë¦¬ ì‹œì‘ (ì¿ íŒ¡ ì—†ìŒ)', { success: true });
    const splitResult = ProductSpliter.splitByProduct();
    
    if (!splitResult.success) {
      throw new Error('í’ˆëª©ë³„ ë¶„ë¦¬ ì‹¤íŒ¨: ' + splitResult.error);
    }
    
    logUpdate('âœ… í’ˆëª©ë³„ ì‹œíŠ¸ ë¶„ë¦¬ ì™„ë£Œ', splitResult);
    
    // 2. ì—‘ì…€ íŒŒì¼ ìƒì„±
    logUpdate('ğŸ“Š ì—‘ì…€ íŒŒì¼ ìƒì„± ì‹œì‘', { success: true });
    const downloadResult = ProductDownloader.downloadProductSheets(targetDate);
    
    if (!downloadResult.success) {
      throw new Error('ì—‘ì…€ íŒŒì¼ ìƒì„± ì‹¤íŒ¨: ' + downloadResult.error);
    }
    
    logUpdate('âœ… ì—‘ì…€ íŒŒì¼ ìƒì„± ì™„ë£Œ', downloadResult);
    
    // 3. ì´ë©”ì¼ ì „ì†¡
    logUpdate('ğŸ“§ ì¶œê³  ì´ë©”ì¼ ì „ì†¡ ì‹œì‘', { success: true });
    const emailResult = sendEmailWithProductSheets(targetDate);
    
    if (!emailResult.success) {
      // ì´ë©”ì¼ ì‹¤íŒ¨ëŠ” ê²½ê³ ë§Œ
      logUpdate('âš ï¸ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨ (ìˆ˜ë™ ì „ì†¡ í•„ìš”)', emailResult);
    } else {
      logUpdate('âœ… ì¶œê³  ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ', emailResult);
    }
    
    console.log('=== Function End: executePart2WithoutCoupang SUCCESS ===');
    return {
      success: true,
      message: 'Part 2 ì™„ë£Œ (ì¿ íŒ¡ ì—†ì´)',
      splitResult,
      downloadResult,
      emailResult,
      dateString
    };
    
  } catch (error) {
    console.error('ERROR in executePart2WithoutCoupang:', error.toString());
    logUpdate('âŒ Part 2 ì‹¤í–‰ ì‹¤íŒ¨ (ì¿ íŒ¡ ì—†ìŒ)', { success: false, error: error.toString() });
    
    console.log('=== Function End: executePart2WithoutCoupang FAILED ===');
    return {
      success: false,
      error: error.toString()
    };
  }
}

/**
 * ì¿ íŒ¡ íŒŒì¼ ì—†ì´ Part 1ë§Œ ì™„ë£Œ ì²˜ë¦¬
 */
function completePart1Only() {
  console.log('=== Function Start: completePart1Only ===');
  
  try {
    // ì„ì‹œ ì €ì¥ëœ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
    const targetDate = PropertiesService.getScriptProperties().getProperty('IMMEDIATE_TARGET_DATE');
    const dateStr = targetDate ? `${targetDate.substring(0,2)}ì›” ${targetDate.substring(2,4)}ì¼` : 'ì˜¤ëŠ˜';
    
    logUpdate('âœ… Part 1ë§Œ ì™„ë£Œ - ì¿ íŒ¡ íŒŒì¼ ì—†ì´ ì¢…ë£Œ', {
      success: true,
      targetDate: dateStr,
      message: 'Part 1 ì™„ë£Œ, ì¿ íŒ¡ ì²˜ë¦¬ ê±´ë„ˆëœ€ (ì‚¬ìš©ì ì„ íƒ)',
      time: new Date().toLocaleString('ko-KR')
    });
    
    // ì„ì‹œ ì €ì¥ëœ ë‚ ì§œ ì •ë¦¬
    PropertiesService.getScriptProperties().deleteProperty('IMMEDIATE_TARGET_DATE');
    
    console.log('=== Function End: completePart1Only SUCCESS ===');
    return {
      success: true,
      message: `Part 1ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ (${dateStr})`
    };
    
  } catch (error) {
    console.error('ERROR in completePart1Only:', error.toString());
    console.log('=== Function End: completePart1Only FAILED ===');
    return {
      success: false,
      error: error.toString()
    };
  }
}