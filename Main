/**
 * ê³°íƒ• ì¶œê³  ìë™í™” ì‹œìŠ¤í…œ - ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬
 * Main.gs
 */

// ì „ì—­ ì„¤ì •
const CONFIG = {
  SOURCE_SPREADSHEET_ID: 'YOUR_SOURCE_SPREADSHEET_ID', // ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì†ŒìŠ¤ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID
  FOLDER_ID: 'YOUR_FOLDER_ID', // ì €ì¥í•  êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ID
  MANUAL_TEMPLATE_SHEET_NAME: 'ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥ ì–‘ì‹',
  SENDER_POSTAL_CODE: '7505',
  SENDER_ADDRESS: 'ì„œìš¸ ê°•ì„œêµ¬ ì˜¤ì •ë¡œ 602',
  COUPANG_FILE_ID: '' // íŠ¸ë¦¬ê±°ìš© ì¿ íŒ¡ íŒŒì¼ ID
};

/**
 * ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì‹œ ì„¤ì • ë¡œë“œ
 */
function initializeConfig() {
  const settings = getSettings();
  CONFIG.SOURCE_SPREADSHEET_ID = settings.sourceSpreadsheetId;
  CONFIG.FOLDER_ID = settings.folderId;
  CONFIG.SENDER_POSTAL_CODE = settings.senderPostal;
  CONFIG.SENDER_ADDRESS = settings.senderAddress;
}

/**
 * ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„±
 */
function createEmailSettingsSheet() {
  console.log('=== Function Start: createEmailSettingsSheet ===');
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = 'ì´ë©”ì¼_ì„¤ì •';
    
    // ê¸°ì¡´ ì‹œíŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
    let emailSettingsSheet = spreadsheet.getSheetByName(sheetName);
    
    if (emailSettingsSheet) {
      const ui = SpreadsheetApp.getUi();
      const response = ui.alert(
        'âš ï¸ ì‹œíŠ¸ ì´ë¯¸ ì¡´ì¬',
        `'${sheetName}' ì‹œíŠ¸ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.\n\nê¸°ì¡´ ì‹œíŠ¸ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?`,
        ui.ButtonSet.YES_NO
      );
      
      if (response === ui.Button.YES) {
        spreadsheet.deleteSheet(emailSettingsSheet);
        console.log('ê¸°ì¡´ ì´ë©”ì¼_ì„¤ì • ì‹œíŠ¸ ì‚­ì œ');
      } else {
        console.log('ì‹œíŠ¸ ìƒì„± ì·¨ì†Œ');
        return { success: false, error: 'ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.' };
      }
    }
    
    // ìƒˆ ì‹œíŠ¸ ìƒì„±
    emailSettingsSheet = spreadsheet.insertSheet(sheetName);
    console.log('ìƒˆ ì´ë©”ì¼_ì„¤ì • ì‹œíŠ¸ ìƒì„±');
    
    // í—¤ë” ì„¤ì •
    const headers = ['ìš°ì„ ìˆœìœ„', 'ì „ì†¡ì—¬ë¶€', 'ì´ë¦„', 'ì´ë©”ì¼', 'ë©”ëª¨'];
    emailSettingsSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // í—¤ë” ìŠ¤íƒ€ì¼ë§
    const headerRange = emailSettingsSheet.getRange(1, 1, 1, headers.length);
    headerRange.setBackground('#4285f4');
    headerRange.setFontColor('white');
    headerRange.setFontWeight('bold');
    headerRange.setHorizontalAlignment('center');
    
    // ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€
    const sampleData = [
      [1, 'TRUE', 'ê¹€ì˜ì¤€', 'example1@company.com', 'ë‹´ë‹¹ì'],
      [2, 'FALSE', 'í™ê¸¸ë™', 'example2@company.com', 'ë°±ì—… ë‹´ë‹¹ì'],
      [3, 'TRUE', 'ì´ìˆœì‹ ', 'example3@company.com', 'ê´€ë¦¬ì']
    ];
    
    emailSettingsSheet.getRange(2, 1, sampleData.length, headers.length).setValues(sampleData);
    
    // ì—´ ë„ˆë¹„ ì¡°ì •
    emailSettingsSheet.setColumnWidth(1, 80);  // ìš°ì„ ìˆœìœ„
    emailSettingsSheet.setColumnWidth(2, 80);  // ì „ì†¡ì—¬ë¶€
    emailSettingsSheet.setColumnWidth(3, 100); // ì´ë¦„
    emailSettingsSheet.setColumnWidth(4, 200); // ì´ë©”ì¼
    emailSettingsSheet.setColumnWidth(5, 150); // ë©”ëª¨
    
    // ìš°ì„ ìˆœìœ„ ì—´ì— ìˆ«ì ê²€ì¦ ì¶”ê°€
    const priorityRange = emailSettingsSheet.getRange(2, 1, 1000, 1); // A2:A1001
    const priorityValidation = SpreadsheetApp.newDataValidation()
      .requireNumberGreaterThan(0)
      .setAllowInvalid(false)
      .build();
    priorityRange.setDataValidation(priorityValidation);
    
    // ì „ì†¡ì—¬ë¶€ ì—´ì— ë°ì´í„° ê²€ì¦ ì¶”ê°€ (TRUE/FALSE ë“œë¡­ë‹¤ìš´)
    const validationRange = emailSettingsSheet.getRange(2, 2, 1000, 1); // B2:B1001
    const validation = SpreadsheetApp.newDataValidation()
      .requireValueInList(['TRUE', 'FALSE'])
      .setAllowInvalid(false)
      .build();
    validationRange.setDataValidation(validation);
    
    // í…Œë‘ë¦¬ ì¶”ê°€
    const dataRange = emailSettingsSheet.getRange(1, 1, sampleData.length + 1, headers.length);
    dataRange.setBorder(true, true, true, true, true, true);
    
    // ì‹œíŠ¸ í™œì„±í™”
    emailSettingsSheet.activate();
    
    // ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      'âœ… ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„± ì™„ë£Œ',
      `'${sheetName}' ì‹œíŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
      'â€¢ ìš°ì„ ìˆœìœ„: ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ë†’ì€ ìš°ì„ ìˆœìœ„ì…ë‹ˆë‹¤\n' +
      'â€¢ ì „ì†¡ì—¬ë¶€: TRUEë¡œ ì„¤ì •ëœ ì‚¬ìš©ìë§Œ ì´ë©”ì¼ì„ ë°›ìŠµë‹ˆë‹¤\n' +
      'â€¢ ìƒ˜í”Œ ë°ì´í„°ëŠ” ì‹¤ì œ ë°ì´í„°ë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”',
      ui.ButtonSet.OK
    );
    
    console.log('=== Function End: createEmailSettingsSheet SUCCESS ===');
    return { success: true, message: 'ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.' };
    
  } catch (error) {
    console.error('ERROR in createEmailSettingsSheet:', error.toString());
    console.log('=== Function End: createEmailSettingsSheet FAILED ===');
    
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      'âŒ ì‹œíŠ¸ ìƒì„± ì‹¤íŒ¨',
      `ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:\n\n${error.toString()}`,
      ui.ButtonSet.OK
    );
    
    return { success: false, error: error.toString() };
  }
}

/**
 * ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ ë•Œ ë©”ë‰´ ìƒì„±
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ğŸ“¦ ê³°íƒ• ì¶œê³  ìë™í™”')
    .addItem('ğŸ”„ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ìë£Œ ì—…ë°ì´íŠ¸', 'updateCybersky')
    .addItem('ğŸ“§ ì˜¤ëŠ˜ EDI ì—…ë°ì´íŠ¸', 'updateTodayEDI')
    .addItem('âš¡ ì‹¸ì´ë²„ìŠ¤ì¹´ì´, EDI ë™ì‹œ ì—…ë°ì´íŠ¸', 'updateBoth')
    .addSeparator()
    .addItem('âš™ï¸ ë°ì´í„° ì²˜ë¦¬ ì‹¤í–‰', 'runDataProcessor')
    .addItem('ğŸ§® ê²€ì‚° ì‹¤í–‰', 'runVerification')
    .addItem('ğŸ“Š í’ˆëª©ë³„ ì‹œíŠ¸ ë¶„ë¦¬', 'splitByProduct')
    .addSeparator()
    .addItem('ğŸ›ï¸ ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë” ì—´ê¸°', 'openCoupangUploader')
    .addItem('ğŸ“¥ í’ˆëª©ë³„ ë‹¤ìš´ë¡œë” ì—´ê¸°', 'openProductDownloader')
    .addItem('ğŸ“¤ ë¡œì»¬ ì—‘ì…€ ì—…ë¡œë” ì—´ê¸°', 'openLocalExcelUploader')
    .addItem('ğŸ“§ ì´ë©”ì¼ ì „ì†¡ê¸° ì—´ê¸°', 'openEmailSender')
    .addItem('ğŸ“ ë“œë¼ì´ë¸Œë¡œ ì´ˆê¸° ì„¤ì •', 'openGooglePicker')
    .addSeparator()
    .addItem('ğŸš€ í†µí•© ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ (ì¶”ì²œ)', 'executeSeamlessWorkflow')
    .addSeparator()
    .addItem('ğŸ›ï¸ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì¦‰ì‹œ ì‹¤í–‰', 'executeImmediateFullPipeline')
    .addItem('ğŸ›ï¸ íŠ¸ë¦¬ê±°ìš© ì¿ íŒ¡ ì—…ë¡œë”', 'openTriggerCoupangUploader')
    .addSeparator()
    .addItem('âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •', 'openSettings')
    .addItem('ğŸ“§ ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„±', 'createEmailSettingsSheet')
    .addSeparator()
    .addItem('ğŸ§ª í…ŒìŠ¤íŠ¸ - ìµœê·¼ EDI ê°€ì ¸ì˜¤ê¸°', 'testGetRecentEDI')
    .addItem('ğŸ§ª í…ŒìŠ¤íŠ¸ - ìë™ ì—…ë°ì´íŠ¸ ì‹¤í–‰', 'testDailyUpdate')
    .addItem('âš¡ í…ŒìŠ¤íŠ¸ - ì¦‰ì‹œ ì‹¤í–‰ (ì‹œê°„ë¬´ê´€)', 'immediateTest')
    .addItem('ğŸ“… í…ŒìŠ¤íŠ¸ - ë‚ ì§œ ì§€ì • (ê³¼ê±°ë°ì´í„°)', 'testWithDate')
    .addItem('ğŸš€ í…ŒìŠ¤íŠ¸ - ìë™ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸', 'testTriggerAutomation')
    .addItem('ğŸ§ª í…ŒìŠ¤íŠ¸ - í…œí”Œë¦¿ ì‹œíŠ¸ ì´ˆê¸°í™”', 'clearTemplates')
    .addSeparator()
    .addItem('ğŸ—‘ï¸ ì¼ì¼ ì‹œíŠ¸ ì •ë¦¬', 'cleanupDailySheets')
    .addItem('ğŸ“… ë‚ ì§œë³„ ì‹œíŠ¸ ì •ë¦¬', 'cleanupDateSheets')
    .addToUi();
}

/**
 * ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ìë£Œ ì—…ë°ì´íŠ¸
 */
function updateCybersky() {
  // ì„¤ì • ì´ˆê¸°í™”
  initializeConfig();
  
  const ui = SpreadsheetApp.getUi();
  
  // ë‚ ì§œ ì„ íƒ ì˜µì…˜
  const response = ui.alert(
    'ğŸ“… ë‚ ì§œ ì„ íƒ',
    'ì˜¤ëŠ˜ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
    'ì˜ˆ: ì˜¤ëŠ˜ ë‚ ì§œ (ìë™)\n' +
    'ì•„ë‹ˆì˜¤: ë‚ ì§œ ì§ì ‘ ì§€ì •',
    ui.ButtonSet.YES_NO_CANCEL
  );
  
  if (response === ui.Button.CANCEL) {
    return;
  }
  
  let targetDate = null;
  if (response === ui.Button.NO) {
    // ë‚ ì§œ ì§ì ‘ ì…ë ¥
    const dateResponse = ui.prompt(
      'ë‚ ì§œ ì…ë ¥',
      'MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 0807, 0808)',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (dateResponse.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    targetDate = dateResponse.getResponseText().trim();
    if (!/^\d{4}$/.test(targetDate)) {
      ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  }
  
  try {
    const result = targetDate 
      ? CyberskyData.updateCyberskyDataForDate(targetDate)
      : CyberskyData.updateCyberskyData();
      
    if (result.success) {
      ui.alert('âœ… ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ìë£Œ ì—…ë°ì´íŠ¸ ì™„ë£Œ!\n' + 
               (targetDate ? `ë‚ ì§œ: ${targetDate}` : 'ë‚ ì§œ: ì˜¤ëŠ˜'));
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    ui.alert('âŒ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ì˜¤ëŠ˜ EDI ì—…ë°ì´íŠ¸
 */
function updateTodayEDI() {
  // ì„¤ì • ì´ˆê¸°í™”
  initializeConfig();
  
  const ui = SpreadsheetApp.getUi();
  
  // ë‚ ì§œ ì„ íƒ ì˜µì…˜
  const response = ui.alert(
    'ğŸ“… ë‚ ì§œ ì„ íƒ',
    'ì˜¤ëŠ˜ ë‚ ì§œì˜ EDIë¥¼ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
    'ì˜ˆ: ì˜¤ëŠ˜ ë‚ ì§œ (ìë™)\n' +
    'ì•„ë‹ˆì˜¤: ë‚ ì§œ ì§ì ‘ ì§€ì •',
    ui.ButtonSet.YES_NO_CANCEL
  );
  
  if (response === ui.Button.CANCEL) {
    return;
  }
  
  let targetDate = null;
  if (response === ui.Button.NO) {
    // ë‚ ì§œ ì§ì ‘ ì…ë ¥
    const dateResponse = ui.prompt(
      'ë‚ ì§œ ì…ë ¥',
      'MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 0728, 0807)',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (dateResponse.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    targetDate = dateResponse.getResponseText().trim();
    if (!/^\d{4}$/.test(targetDate)) {
      ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  }
  
  try {
    const result = targetDate 
      ? EDIData.getEDIFromEmail(targetDate)
      : EDIData.updateEDIData();
      
    if (result.success) {
      ui.alert('âœ… EDI ì—…ë°ì´íŠ¸ ì™„ë£Œ!\n' + 
               (targetDate ? `ë‚ ì§œ: ${targetDate}` : 'ë‚ ì§œ: ì˜¤ëŠ˜'));
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    ui.alert('âŒ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ì‹¸ì´ë²„ìŠ¤ì¹´ì´ì™€ EDI ë™ì‹œ ì—…ë°ì´íŠ¸
 */
function updateBoth() {
  // ì„¤ì • ì´ˆê¸°í™”
  initializeConfig();
  
  const ui = SpreadsheetApp.getUi();
  
  // ë‚ ì§œ ì„ íƒ ì˜µì…˜
  const response = ui.alert(
    'ğŸ“… ë‚ ì§œ ì„ íƒ',
    'ì˜¤ëŠ˜ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
    'ì˜ˆ: ì˜¤ëŠ˜ ë‚ ì§œ (ìë™)\n' +
    'ì•„ë‹ˆì˜¤: ë‚ ì§œ ì§ì ‘ ì§€ì •',
    ui.ButtonSet.YES_NO_CANCEL
  );
  
  if (response === ui.Button.CANCEL) {
    return;
  }
  
  let targetDate = null;
  if (response === ui.Button.NO) {
    // ë‚ ì§œ ì§ì ‘ ì…ë ¥
    const dateResponse = ui.prompt(
      'ë‚ ì§œ ì…ë ¥',
      'MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 0807, 0808)\n' +
      'ì‹¸ì´ë²„ìŠ¤ì¹´ì´ì™€ EDI ëª¨ë‘ í•´ë‹¹ ë‚ ì§œ ë°ì´í„°ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (dateResponse.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    targetDate = dateResponse.getResponseText().trim();
    if (!/^\d{4}$/.test(targetDate)) {
      ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  }
  
  try {
    const cyberskyResult = targetDate
      ? CyberskyData.updateCyberskyDataForDate(targetDate)
      : CyberskyData.updateCyberskyData();
      
    const ediResult = targetDate
      ? EDIData.getEDIFromEmail(targetDate)
      : EDIData.updateEDIData();
    
    if (cyberskyResult.success && ediResult.success) {
      // ë°ì´í„° ì²˜ë¦¬ ì‹¤í–‰
      const processResult = DataProcessor.processData();
      if (processResult.success) {
        ui.alert('âœ… ëª¨ë“  ë°ì´í„° ì—…ë°ì´íŠ¸ ë° ì²˜ë¦¬ ì™„ë£Œ!\n' +
                 (targetDate ? `ë‚ ì§œ: ${targetDate}` : 'ë‚ ì§œ: ì˜¤ëŠ˜'));
      } else {
        throw new Error('ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨: ' + processResult.error);
      }
    } else {
      let errors = [];
      if (!cyberskyResult.success) errors.push('ì‹¸ì´ë²„ìŠ¤ì¹´ì´: ' + cyberskyResult.error);
      if (!ediResult.success) errors.push('EDI: ' + ediResult.error);
      throw new Error(errors.join('\n'));
    }
  } catch (error) {
    ui.alert('âŒ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ê²€ì‚° ì‹¤í–‰
 */
function runVerification() {
  // ì„¤ì • ì´ˆê¸°í™”
  initializeConfig();
  
  try {
    const result = Verification.runVerification();
    const ui = SpreadsheetApp.getUi();
    
    if (result.success) {
      ui.alert('âœ… ê²€ì‚° ì™„ë£Œ!\n\n' + result.message);
    } else {
      ui.alert('âš ï¸ ê²€ì‚° ì‹¤íŒ¨!\n\n' + result.message);
    }
  } catch (error) {
    SpreadsheetApp.getUi().alert('âŒ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * í’ˆëª©ë³„ ì‹œíŠ¸ ë¶„ë¦¬
 */
function splitByProduct() {
  // ì„¤ì • ì´ˆê¸°í™”
  initializeConfig();
  
  const ui = SpreadsheetApp.getUi();
  
  // ë‚ ì§œ ì„ íƒ ì˜µì…˜
  const response = ui.alert(
    'ğŸ“… ë‚ ì§œ ì„ íƒ',
    'ì–´ë–¤ ë‚ ì§œì˜ ë°ì´í„°ë¡œ í’ˆëª©ë³„ ì‹œíŠ¸ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
    'ì˜ˆ: ìë™ ì¶”ì¶œ (ê¸°ì¡´ ì‹œíŠ¸ì—ì„œ ë‚ ì§œ ì°¾ê¸°)\n' +
    'ì•„ë‹ˆì˜¤: ë‚ ì§œ ì§ì ‘ ì§€ì •',
    ui.ButtonSet.YES_NO_CANCEL
  );
  
  if (response === ui.Button.CANCEL) {
    return;
  }
  
  let targetDate = null;
  if (response === ui.Button.NO) {
    // ë‚ ì§œ ì§ì ‘ ì…ë ¥
    const dateResponse = ui.prompt(
      'ë‚ ì§œ ì…ë ¥',
      'MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 0807, 0811)',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (dateResponse.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    targetDate = dateResponse.getResponseText().trim();
    if (!/^\d{4}$/.test(targetDate)) {
      ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  }
  
  try {
    const result = ProductSpliter.splitByProduct(targetDate);
    if (result.success) {
      ui.alert('âœ… í’ˆëª©ë³„ ì‹œíŠ¸ ë¶„ë¦¬ ì™„ë£Œ!\nìƒì„±ëœ ì‹œíŠ¸: ' + result.sheets.join(', '));
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    ui.alert('âŒ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ë°ì´í„° ì²˜ë¦¬ ì‹¤í–‰
 */
function runDataProcessor() {
  // ì„¤ì • ì´ˆê¸°í™”
  initializeConfig();
  
  try {
    const result = DataProcessor.processData();
    if (result.success) {
      SpreadsheetApp.getUi().alert('âœ… ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ!\nì²˜ë¦¬ëœ í–‰: ' + result.processedRows);
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    SpreadsheetApp.getUi().alert('âŒ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë” ì—´ê¸°
 */
function openCoupangUploader() {
  const html = HtmlService.createHtmlOutputFromFile('CoupangUploader')
    .setWidth(600)
    .setHeight(400)
    .setTitle('ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë”');
  SpreadsheetApp.getUi().showModalDialog(html, 'ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë”');
}

/**
 * ë¡œì»¬ ì—‘ì…€ ì—…ë¡œë” ì—´ê¸°
 */
function openLocalExcelUploader() {
  const html = HtmlService.createHtmlOutputFromFile('ExcelUploaderDialog')
    .setWidth(950)
    .setHeight(700)
    .setTitle('ë¡œì»¬ ì—‘ì…€ ì—…ë¡œë”');
  SpreadsheetApp.getUi().showModalDialog(html, 'ë¡œì»¬ ì—‘ì…€ ì—…ë¡œë”');
}

/**
 * í’ˆëª©ë³„ ë‹¤ìš´ë¡œë” ì—´ê¸°
 */
function openProductDownloader() {
  const html = HtmlService.createHtmlOutputFromFile('ProductDownloaderDialog')
    .setWidth(850)
    .setHeight(650)
    .setTitle('í’ˆëª©ë³„ ë‹¤ìš´ë¡œë”');
  SpreadsheetApp.getUi().showModalDialog(html, 'í’ˆëª©ë³„ ë‹¤ìš´ë¡œë”');
}

/**
 * ì´ë©”ì¼ ì „ì†¡ê¸° ì—´ê¸°
 */
function openEmailSender() {
  const html = HtmlService.createHtmlOutputFromFile('EmailSenderDialog')
    .setWidth(750)
    .setHeight(700)
    .setTitle('ì´ë©”ì¼ ì „ì†¡ê¸°');
  SpreadsheetApp.getUi().showModalDialog(html, 'ì´ë©”ì¼ ì „ì†¡ê¸°');
}

/**
 * ë“œë¼ì´ë¸Œ íƒìƒ‰ê¸° ì—´ê¸°
 */
function openDriveExplorer() {
  DriveExplorer.openExplorer();
}

/**
 * ì„¤ì • ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°
 */
function openSettings() {
  const html = HtmlService.createHtmlOutputFromFile('Settings')
    .setWidth(500)
    .setHeight(400)
    .setTitle('ì„¤ì •');
  SpreadsheetApp.getUi().showModalDialog(html, 'ê³°íƒ• ì¶œê³  ìë™í™” ì„¤ì •');
}

/**
 * Part 1 ì‹¤í–‰ (ê²€ì‚°ê¹Œì§€ - ë‚ ì§œ ì„ íƒ ê°€ëŠ¥)
 */
function executePart1Pipeline() {
  try {
    const ui = SpreadsheetApp.getUi();
    
    // ë‚ ì§œ ì„ íƒ ì˜µì…˜
    const dateResponse = ui.alert(
      'ğŸ“… Part 1 ì‹¤í–‰ - ë‚ ì§œ ì„ íƒ',
      'ì–´ë–¤ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
      'ì˜ˆ: ì˜¤ëŠ˜ ë‚ ì§œ (ìë™)\n' +
      'ì•„ë‹ˆì˜¤: ë‚ ì§œ ì§ì ‘ ì§€ì •',
      ui.ButtonSet.YES_NO_CANCEL
    );
    
    if (dateResponse === ui.Button.CANCEL) {
      return;
    }
    
    let targetDate = null;
    if (dateResponse === ui.Button.NO) {
      // ë‚ ì§œ ì§ì ‘ ì…ë ¥
      const inputResponse = ui.prompt(
        'ë‚ ì§œ ì…ë ¥',
        'MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 0807, 0810)\n\nPart 1: ì‹¸ì´ë²„ìŠ¤ì¹´ì´ â†’ EDI â†’ ê²€ì‚°',
        ui.ButtonSet.OK_CANCEL
      );
      
      if (inputResponse.getSelectedButton() !== ui.Button.OK) {
        return;
      }
      
      targetDate = inputResponse.getResponseText().trim();
      if (!/^\d{4}$/.test(targetDate)) {
        ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
    }
    
    // ì‹¤í–‰ í™•ì¸
    const confirmResponse = ui.alert(
      'ğŸ”„ Part 1 ì‹¤í–‰',
      `Part 1 íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
      `ë‚ ì§œ: ${targetDate || 'ì˜¤ëŠ˜'}\n\n` +
      'ì‹¤í–‰ ê³¼ì •:\n' +
      'â€¢ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ìˆ˜ì§‘\n' +
      'â€¢ EDI ë°ì´í„° ì²˜ë¦¬\n' +
      'â€¢ ë°ì´í„° ê°€ê³µ ë° ê²€ì‚°\n' +
      'â€¢ ì¿ íŒ¡ ì—…ë¡œë“œ ì•ˆë‚´ ì´ë©”ì¼',
      ui.ButtonSet.YES_NO
    );
    
    if (confirmResponse === ui.Button.YES) {
      ui.alert(`ğŸ”„ Part 1 íŒŒì´í”„ë¼ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤.\në‚ ì§œ: ${targetDate || 'ì˜¤ëŠ˜'}\n\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ì§„í–‰ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.`);
      
      // ë‚ ì§œ ì§€ì • Part 1 ì‹¤í–‰
      if (targetDate) {
        semiAutomationPipelineWithDate(targetDate);
      } else {
        semiAutomationPipeline();
      }
    }
    
  } catch (error) {
    console.error('Part 1 ì‹¤í–‰ ì˜¤ë¥˜:', error);
    SpreadsheetApp.getUi().alert('âŒ Part 1 ì‹¤í–‰ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ - TestFunctions.gsë¡œ ìœ„ì„
 */
function testCyberskyByDate() {
  TestFunctions.testCyberskyByDate();
}

function testEDIByDate() {
  TestFunctions.testEDIByDate();
}

function testFullProcessByDate() {
  TestFunctions.testFullProcessByDate();
}

function testGetRecentEDI() {
  TestFunctions.testGetRecentEDI();
}

function testDailyUpdate() {
  // Triggers.gsì˜ í•¨ìˆ˜ í˜¸ì¶œ
  dailyUpdate();
  SpreadsheetApp.getUi().alert('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì™„ë£Œ!\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
}

function cleanTestSheets() {
  TestFunctions.cleanTestSheets();
}


/**
 * í…œí”Œë¦¿ ì‹œíŠ¸ ì´ˆê¸°í™”
 */
function clearTemplates() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'âš ï¸ í…œí”Œë¦¿ ì´ˆê¸°í™”',
    'ìƒ˜í”Œë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ì‹œíŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìƒ˜í”Œ ì‹œíŠ¸, ì„¤ëª…ì„œ ë“±ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)',
    ui.ButtonSet.YES_NO
  );
  
  if (response === ui.Button.YES) {
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const sheets = spreadsheet.getSheets();
      let deletedCount = 0;
      
      for (const sheet of sheets) {
        const name = sheet.getName();
        if (name.startsWith('ìƒ˜í”Œ') || name.includes('ì„¤ëª…') || name.includes('í…œí”Œë¦¿')) {
          spreadsheet.deleteSheet(sheet);
          deletedCount++;
        }
      }
      
      ui.alert(`âœ… ${deletedCount}ê°œì˜ í…œí”Œë¦¿ ì‹œíŠ¸ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
      ui.alert('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.toString());
    }
  }
}

/**
 * ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYYMMDD í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
 */
function getTodayDate() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  return year + month + day;
}

/**
 * ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYMM í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
 */
function getTodayShortDate() {
  const today = new Date();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  return month + day;
}

/**
 * MMDDë¥¼ YYYYMMDDë¡œ ë³€í™˜
 */
function convertToFullDate(shortDate) {
  if (shortDate.length === 8) {
    return shortDate; // ì´ë¯¸ YYYYMMDD í˜•ì‹
  }
  
  const year = new Date().getFullYear();
  return year + shortDate;
}

/**
 * ì„¤ì • ì €ì¥
 */
function saveSettings(settings) {
  try {
    const scriptProperties = PropertiesService.getScriptProperties();
    scriptProperties.setProperty('SOURCE_SPREADSHEET_ID', settings.sourceSpreadsheetId);
    scriptProperties.setProperty('FOLDER_ID', settings.folderId);
    scriptProperties.setProperty('SENDER_POSTAL_CODE', settings.senderPostal);
    scriptProperties.setProperty('SENDER_ADDRESS', settings.senderAddress);
    
    // ì´ë©”ì¼ ë°œì‹ ì ì •ë³´ ì„¤ì •
    scriptProperties.setProperty('EMAIL_SENDER_NAME', settings.emailSenderName || '');
    scriptProperties.setProperty('EMAIL_SENDER_TITLE', settings.emailSenderTitle || '');
    scriptProperties.setProperty('EMAIL_SENDER_SIGNATURE', settings.emailSenderSignature || '');
    
    // CONFIG ê°ì²´ ì—…ë°ì´íŠ¸
    CONFIG.SOURCE_SPREADSHEET_ID = settings.sourceSpreadsheetId;
    CONFIG.FOLDER_ID = settings.folderId;
    CONFIG.SENDER_POSTAL_CODE = settings.senderPostal;
    CONFIG.SENDER_ADDRESS = settings.senderAddress;
    CONFIG.EMAIL_SENDER_NAME = settings.emailSenderName || '';
    CONFIG.EMAIL_SENDER_TITLE = settings.emailSenderTitle || '';
    CONFIG.EMAIL_SENDER_SIGNATURE = settings.emailSenderSignature || '';
    
    return { success: true };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

/**
 * íŠ¸ë¦¬ê±°ìš© ì¿ íŒ¡ íŒŒì¼ ì—…ë¡œë“œ (ë‹¨ìˆœ ì—…ë¡œë“œë§Œ, ë°ì´í„° ì²˜ë¦¬ ì—†ìŒ)
 */
function uploadCoupangFileForTrigger(fileData, fileName) {
  console.log('=== Function Start: uploadCoupangFileForTrigger ===');
  console.log('Parameters:', { fileName });
  
  try {
    // Base64 ë””ì½”ë”©
    const blob = Utilities.newBlob(Utilities.base64Decode(fileData), 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', fileName);
    
    // ë‚´ ë“œë¼ì´ë¸Œì— íŒŒì¼ ì €ì¥ (ë‹¨ìˆœ ì €ì¥ë§Œ)
    const file = DriveApp.createFile(blob);
    console.log('File uploaded successfully with ID:', file.getId());
    
    console.log('=== Function End: uploadCoupangFileForTrigger SUCCESS ===');
    return { success: true, fileId: file.getId() };
    
  } catch (error) {
    console.error('ERROR in uploadCoupangFileForTrigger:', error.toString());
    console.log('=== Function End: uploadCoupangFileForTrigger FAILED ===');
    return { success: false, error: error.toString() };
  }
}

/**
 * íŠ¸ë¦¬ê±°ìš© ì¿ íŒ¡ ì—…ë¡œë” ì—´ê¸°
 */
function openTriggerCoupangUploader() {
  const html = HtmlService.createHtmlOutputFromFile('TriggerCoupangUploader')
    .setWidth(600)
    .setHeight(700)
    .setTitle('íŠ¸ë¦¬ê±°ìš© ì¿ íŒ¡ íŒŒì¼ ì—…ë¡œë”');
  SpreadsheetApp.getUi().showModalDialog(html, 'â° íŠ¸ë¦¬ê±°ìš© ì¿ íŒ¡ íŒŒì¼ ì—…ë¡œë”');
}

/**
 * ì˜¤ëŠ˜ ìë™ íŠ¸ë¦¬ê±° ìƒì„± (ì—…ë¡œë“œëœ íŒŒì¼ ì‚¬ìš©)
 */
function createTodayAutoTrigger(coupangFileId, coupangFileName, hour, minute) {
  console.log('=== Function Start: createTodayAutoTrigger ===');
  console.log('Parameters:', { coupangFileId, coupangFileName, hour, minute });
  
  try {
    // ì¿ íŒ¡ íŒŒì¼ IDë¥¼ ì„¤ì •ì— ì €ì¥
    const scriptProperties = PropertiesService.getScriptProperties();
    scriptProperties.setProperty('COUPANG_FILE_ID', coupangFileId);
    
    // CONFIG ì—…ë°ì´íŠ¸
    CONFIG.COUPANG_FILE_ID = coupangFileId;
    
    console.log('ì¿ íŒ¡ íŒŒì¼ ID ì„¤ì • ì™„ë£Œ:', coupangFileId);
    
    // ê¸°ì¡´ íŠ¸ë¦¬ê±° ì •ë¦¬
    const existingTriggers = ScriptApp.getProjectTriggers();
    for (const trigger of existingTriggers) {
      if (trigger.getHandlerFunction() === 'executeTriggerCoupangAutomation' || 
          trigger.getHandlerFunction() === 'retryTriggerAutomation') {
        ScriptApp.deleteTrigger(trigger);
        console.log('ê¸°ì¡´ íŠ¸ë¦¬ê±° ì‚­ì œ:', trigger.getHandlerFunction());
      }
    }
    
    // ìƒˆ íŠ¸ë¦¬ê±° ìƒì„±
    const today = new Date();
    const triggerTime = new Date();
    triggerTime.setHours(hour, minute, 0, 0);
    
    // ì˜¤ëŠ˜ ì‹œê°„ì´ ì´ë¯¸ ì§€ë‚¬ìœ¼ë©´ ë‚´ì¼ë¡œ ì„¤ì •
    if (triggerTime <= today) {
      triggerTime.setDate(triggerTime.getDate() + 1);
    }
    
    const newTrigger = ScriptApp.newTrigger('executeTriggerCoupangAutomation')
      .timeBased()
      .at(triggerTime)
      .create();
    
    console.log('ìƒˆ íŠ¸ë¦¬ê±° ìƒì„± ì™„ë£Œ:', {
      time: triggerTime,
      triggerId: newTrigger.getUniqueId()
    });
    
    console.log('=== Function End: createTodayAutoTrigger SUCCESS ===');
    return { 
      success: true, 
      message: `âœ… ìë™ íŠ¸ë¦¬ê±° ì„¤ì • ì™„ë£Œ!\n\níŒŒì¼: ${coupangFileName}\nì‹¤í–‰ ì‹œê°„: ${hour}:${minute.toString().padStart(2, '0')}\n\nğŸ“Œ ì„¤ì •ëœ ì‹œê°„ì— ìë™ìœ¼ë¡œ ì „ì²´ íŒŒì´í”„ë¼ì¸ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.\nâš ï¸ ì‹¤íŒ¨ì‹œ 30ë¶„ë§ˆë‹¤ 3íšŒê¹Œì§€ ìë™ ì¬ì‹œë„í•©ë‹ˆë‹¤.\nâœ… ì„±ê³µì‹œ íŠ¸ë¦¬ê±°ì™€ íŒŒì¼ì´ ìë™ìœ¼ë¡œ ì •ë¦¬ë©ë‹ˆë‹¤.`,
      triggerId: newTrigger.getUniqueId(),
      scheduledTime: triggerTime.toLocaleString('ko-KR')
    };
    
  } catch (error) {
    console.error('ERROR in createTodayAutoTrigger:', error.toString());
    console.log('=== Function End: createTodayAutoTrigger FAILED ===');
    return { success: false, error: error.toString() };
  }
}

/**
 * ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
 */
function getSettings() {
  const scriptProperties = PropertiesService.getScriptProperties();
  return {
    sourceSpreadsheetId: scriptProperties.getProperty('SOURCE_SPREADSHEET_ID') || CONFIG.SOURCE_SPREADSHEET_ID,
    folderId: scriptProperties.getProperty('FOLDER_ID') || CONFIG.FOLDER_ID,
    senderPostal: scriptProperties.getProperty('SENDER_POSTAL_CODE') || CONFIG.SENDER_POSTAL_CODE,
    senderAddress: scriptProperties.getProperty('SENDER_ADDRESS') || CONFIG.SENDER_ADDRESS,
    emailSenderName: scriptProperties.getProperty('EMAIL_SENDER_NAME') || '',
    emailSenderTitle: scriptProperties.getProperty('EMAIL_SENDER_TITLE') || '',
    emailSenderSignature: scriptProperties.getProperty('EMAIL_SENDER_SIGNATURE') || ''
  };
}

/**
 * ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì‹œ ì„¤ì • ë¡œë“œ
 */
function initializeConfig() {
  const settings = getSettings();
  CONFIG.SOURCE_SPREADSHEET_ID = settings.sourceSpreadsheetId;
  CONFIG.FOLDER_ID = settings.folderId;
  CONFIG.SENDER_POSTAL_CODE = settings.senderPostal;
  CONFIG.SENDER_ADDRESS = settings.senderAddress;
}

/**
 * ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„±
 */
function createEmailSettingsSheet() {
  console.log('=== Function Start: createEmailSettingsSheet ===');
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = 'ì´ë©”ì¼_ì„¤ì •';
    
    // ê¸°ì¡´ ì‹œíŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
    let emailSettingsSheet = spreadsheet.getSheetByName(sheetName);
    
    if (emailSettingsSheet) {
      const ui = SpreadsheetApp.getUi();
      const response = ui.alert(
        'âš ï¸ ì‹œíŠ¸ ì´ë¯¸ ì¡´ì¬',
        `'${sheetName}' ì‹œíŠ¸ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.\n\nê¸°ì¡´ ì‹œíŠ¸ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?`,
        ui.ButtonSet.YES_NO
      );
      
      if (response === ui.Button.YES) {
        spreadsheet.deleteSheet(emailSettingsSheet);
        console.log('ê¸°ì¡´ ì´ë©”ì¼_ì„¤ì • ì‹œíŠ¸ ì‚­ì œ');
      } else {
        console.log('ì‹œíŠ¸ ìƒì„± ì·¨ì†Œ');
        return { success: false, error: 'ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.' };
      }
    }
    
    // ìƒˆ ì‹œíŠ¸ ìƒì„±
    emailSettingsSheet = spreadsheet.insertSheet(sheetName);
    console.log('ìƒˆ ì´ë©”ì¼_ì„¤ì • ì‹œíŠ¸ ìƒì„±');
    
    // í—¤ë” ì„¤ì •
    const headers = ['ìš°ì„ ìˆœìœ„', 'ì „ì†¡ì—¬ë¶€', 'ì´ë¦„', 'ì´ë©”ì¼', 'ë©”ëª¨'];
    emailSettingsSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // í—¤ë” ìŠ¤íƒ€ì¼ë§
    const headerRange = emailSettingsSheet.getRange(1, 1, 1, headers.length);
    headerRange.setBackground('#4285f4');
    headerRange.setFontColor('white');
    headerRange.setFontWeight('bold');
    headerRange.setHorizontalAlignment('center');
    
    // ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€
    const sampleData = [
      [1, 'TRUE', 'ê¹€ì˜ì¤€', 'example1@company.com', 'ë‹´ë‹¹ì'],
      [2, 'FALSE', 'í™ê¸¸ë™', 'example2@company.com', 'ë°±ì—… ë‹´ë‹¹ì'],
      [3, 'TRUE', 'ì´ìˆœì‹ ', 'example3@company.com', 'ê´€ë¦¬ì']
    ];
    
    emailSettingsSheet.getRange(2, 1, sampleData.length, headers.length).setValues(sampleData);
    
    // ì—´ ë„ˆë¹„ ì¡°ì •
    emailSettingsSheet.setColumnWidth(1, 80);  // ìš°ì„ ìˆœìœ„
    emailSettingsSheet.setColumnWidth(2, 80);  // ì „ì†¡ì—¬ë¶€
    emailSettingsSheet.setColumnWidth(3, 100); // ì´ë¦„
    emailSettingsSheet.setColumnWidth(4, 200); // ì´ë©”ì¼
    emailSettingsSheet.setColumnWidth(5, 150); // ë©”ëª¨
    
    // ìš°ì„ ìˆœìœ„ ì—´ì— ìˆ«ì ê²€ì¦ ì¶”ê°€
    const priorityRange = emailSettingsSheet.getRange(2, 1, 1000, 1); // A2:A1001
    const priorityValidation = SpreadsheetApp.newDataValidation()
      .requireNumberGreaterThan(0)
      .setAllowInvalid(false)
      .build();
    priorityRange.setDataValidation(priorityValidation);
    
    // ì „ì†¡ì—¬ë¶€ ì—´ì— ë°ì´í„° ê²€ì¦ ì¶”ê°€ (TRUE/FALSE ë“œë¡­ë‹¤ìš´)
    const validationRange = emailSettingsSheet.getRange(2, 2, 1000, 1); // B2:B1001
    const validation = SpreadsheetApp.newDataValidation()
      .requireValueInList(['TRUE', 'FALSE'])
      .setAllowInvalid(false)
      .build();
    validationRange.setDataValidation(validation);
    
    // í…Œë‘ë¦¬ ì¶”ê°€
    const dataRange = emailSettingsSheet.getRange(1, 1, sampleData.length + 1, headers.length);
    dataRange.setBorder(true, true, true, true, true, true);
    
    // ì‹œíŠ¸ í™œì„±í™”
    emailSettingsSheet.activate();
    
    // ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      'âœ… ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„± ì™„ë£Œ',
      `'${sheetName}' ì‹œíŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
      'â€¢ ìš°ì„ ìˆœìœ„: ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ë†’ì€ ìš°ì„ ìˆœìœ„ì…ë‹ˆë‹¤\n' +
      'â€¢ ì „ì†¡ì—¬ë¶€: TRUEë¡œ ì„¤ì •ëœ ì‚¬ìš©ìë§Œ ì´ë©”ì¼ì„ ë°›ìŠµë‹ˆë‹¤\n' +
      'â€¢ ìƒ˜í”Œ ë°ì´í„°ëŠ” ì‹¤ì œ ë°ì´í„°ë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”',
      ui.ButtonSet.OK
    );
    
    console.log('=== Function End: createEmailSettingsSheet SUCCESS ===');
    return { success: true, message: 'ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.' };
    
  } catch (error) {
    console.error('ERROR in createEmailSettingsSheet:', error.toString());
    console.log('=== Function End: createEmailSettingsSheet FAILED ===');
    
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      'âŒ ì‹œíŠ¸ ìƒì„± ì‹¤íŒ¨',
      `ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:\n\n${error.toString()}`,
      ui.ButtonSet.OK
    );
    
    return { success: false, error: error.toString() };
  }
}


/**
 * ìë™ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (ë‚ ì§œ ì§€ì • ê°€ëŠ¥)
 */
function testTriggerAutomation() {
  console.log('=== Function Start: testTriggerAutomation ===');
  
  try {
    const ui = SpreadsheetApp.getUi();
    
    // ë‚ ì§œ ì…ë ¥ ë°›ê¸°
    const dateResponse = ui.prompt(
      'ğŸ§ª ìë™ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸',
      'í…ŒìŠ¤íŠ¸í•  ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš” (MMDD í˜•ì‹)\n\nì˜ˆ: 0812, 1225\n\në¹ˆ ê°’ì´ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (dateResponse.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    let targetDate = dateResponse.getResponseText().trim();
    
    // ë‚ ì§œ ê²€ì¦
    if (targetDate && !/^\d{4}$/.test(targetDate)) {
      ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 0812)');
      return;
    }
    
    // ë¹ˆ ê°’ì´ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©
    if (!targetDate) {
      const today = new Date();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      targetDate = month + day;
    }
    
    // ì‹¤í–‰ í™•ì¸
    const confirmResponse = ui.alert(
      'ğŸš€ ìë™ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸ ì‹¤í–‰',
      `ìë™ íŠ¸ë¦¬ê±° ì‹œìŠ¤í…œì„ í…ŒìŠ¤íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
      `í…ŒìŠ¤íŠ¸ ë‚ ì§œ: ${targetDate}\n\n` +
      'âš ï¸ ì£¼ì˜: ì‹¤ì œ íŠ¸ë¦¬ê±° ìë™í™” í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.\n' +
      '(Coupang íŒŒì¼ì´ ì—†ìœ¼ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)',
      ui.ButtonSet.YES_NO
    );
    
    if (confirmResponse !== ui.Button.YES) {
      return;
    }
    
    ui.alert(`ğŸ§ª ìë™ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\në‚ ì§œ: ${targetDate}\n\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ì§„í–‰ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.`);
    
    // ì„¤ì • ì´ˆê¸°í™”
    initializeConfig();
    
    // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì„ì‹œ Coupang íŒŒì¼ ID ì„¤ì • (ì‹¤ì œ íŒŒì¼ì´ ìˆë‹¤ë©´)
    const coupangFileId = PropertiesService.getScriptProperties().getProperty('COUPANG_FILE_ID');
    
    if (!coupangFileId) {
      ui.alert(
        'âš ï¸ Coupang íŒŒì¼ì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ',
        'PropertiesServiceì— COUPANG_FILE_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n' +
        'íŠ¸ë¦¬ê±°ìš© Coupang ì—…ë¡œë”ë¡œ íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ê±°ë‚˜,\n' +
        'Part1 íŒŒì´í”„ë¼ì¸ë§Œ í…ŒìŠ¤íŠ¸ë©ë‹ˆë‹¤.',
        ui.ButtonSet.OK
      );
    }
    
    logUpdate('ğŸ§ª ìë™ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸ ì‹œì‘', { 
      success: true, 
      targetDate,
      coupangFileId: coupangFileId || 'N/A',
      time: new Date().toLocaleString('ko-KR') 
    });
    
    // executeTriggerCoupangAutomation í•¨ìˆ˜ í˜¸ì¶œ (TriggerManagement.gs)
    const result = executeTriggerCoupangAutomation();
    
    if (result.success) {
      logUpdate('ğŸ‰ ìë™ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸ ì„±ê³µ\!', result);
      ui.alert(
        'âœ… ìë™ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸ ì™„ë£Œ',
        `í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ìƒì„¸ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.`
      );
    } else {
      logUpdate('âŒ ìë™ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', result);
      ui.alert(
        'âŒ ìë™ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨',
        `í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${result.error}\n\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ìƒì„¸ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.`
      );
    }
    
    console.log('=== Function End: testTriggerAutomation SUCCESS ===');
    
  } catch (error) {
    console.error('ERROR in testTriggerAutomation:', error.toString());
    logUpdate('âŒ ìë™ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', { success: false, error: error.toString() });
    
    const ui = SpreadsheetApp.getUi();
    ui.alert('âŒ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + error.toString());
    
    console.log('=== Function End: testTriggerAutomation FAILED ===');
  }
}
