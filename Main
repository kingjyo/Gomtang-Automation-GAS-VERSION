/**
 * ê³°íƒ• ì¶œê³  ìë™í™” ì‹œìŠ¤í…œ - ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬
 * Main.gs
 */

// ì „ì—­ ì„¤ì •
const CONFIG = {
  SOURCE_SPREADSHEET_ID: 'YOUR_SOURCE_SPREADSHEET_ID', // ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ë°ì´í„° ì†ŒìŠ¤ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID
  FOLDER_ID: 'YOUR_FOLDER_ID', // ì €ì¥í•  êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ID
  MANUAL_TEMPLATE_SHEET_NAME: 'ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥ ì–‘ì‹',
  SENDER_POSTAL_CODE: '7505',
  SENDER_ADDRESS: 'ì„œìš¸ ê°•ì„œêµ¬ ì˜¤ì •ë¡œ 602'
};

/**
 * ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì‹œ ì„¤ì • ë¡œë“œ
 */
function initializeConfig() {
  const settings = getSettings();
  CONFIG.SOURCE_SPREADSHEET_ID = settings.sourceSpreadsheetId;
  CONFIG.FOLDER_ID = settings.folderId;
  CONFIG.SENDER_POSTAL_CODE = settings.senderPostal;
  CONFIG.SENDER_ADDRESS = settings.senderAddress;
}

/**
 * ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„±
 */
function createEmailSettingsSheet() {
  console.log('=== Function Start: createEmailSettingsSheet ===');
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = 'ì´ë©”ì¼_ì„¤ì •';
    
    // ê¸°ì¡´ ì‹œíŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
    let emailSettingsSheet = spreadsheet.getSheetByName(sheetName);
    
    if (emailSettingsSheet) {
      const ui = SpreadsheetApp.getUi();
      const response = ui.alert(
        'âš ï¸ ì‹œíŠ¸ ì´ë¯¸ ì¡´ì¬',
        `'${sheetName}' ì‹œíŠ¸ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.\n\nê¸°ì¡´ ì‹œíŠ¸ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?`,
        ui.ButtonSet.YES_NO
      );
      
      if (response === ui.Button.YES) {
        spreadsheet.deleteSheet(emailSettingsSheet);
        console.log('ê¸°ì¡´ ì´ë©”ì¼_ì„¤ì • ì‹œíŠ¸ ì‚­ì œ');
      } else {
        console.log('ì‹œíŠ¸ ìƒì„± ì·¨ì†Œ');
        return { success: false, error: 'ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.' };
      }
    }
    
    // ìƒˆ ì‹œíŠ¸ ìƒì„±
    emailSettingsSheet = spreadsheet.insertSheet(sheetName);
    console.log('ìƒˆ ì´ë©”ì¼_ì„¤ì • ì‹œíŠ¸ ìƒì„±');
    
    // í—¤ë” ì„¤ì •
    const headers = ['ìš°ì„ ìˆœìœ„', 'ì „ì†¡ì—¬ë¶€', 'ì´ë¦„', 'ì´ë©”ì¼', 'ë©”ëª¨'];
    emailSettingsSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // í—¤ë” ìŠ¤íƒ€ì¼ë§
    const headerRange = emailSettingsSheet.getRange(1, 1, 1, headers.length);
    headerRange.setBackground('#4285f4');
    headerRange.setFontColor('white');
    headerRange.setFontWeight('bold');
    headerRange.setHorizontalAlignment('center');
    
    // ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€
    const sampleData = [
      [1, 'TRUE', 'ê¹€ì˜ì¤€', 'example1@company.com', 'ë‹´ë‹¹ì'],
      [2, 'FALSE', 'í™ê¸¸ë™', 'example2@company.com', 'ë°±ì—… ë‹´ë‹¹ì'],
      [3, 'TRUE', 'ì´ìˆœì‹ ', 'example3@company.com', 'ê´€ë¦¬ì']
    ];
    
    emailSettingsSheet.getRange(2, 1, sampleData.length, headers.length).setValues(sampleData);
    
    // ì—´ ë„ˆë¹„ ì¡°ì •
    emailSettingsSheet.setColumnWidth(1, 80);  // ìš°ì„ ìˆœìœ„
    emailSettingsSheet.setColumnWidth(2, 80);  // ì „ì†¡ì—¬ë¶€
    emailSettingsSheet.setColumnWidth(3, 100); // ì´ë¦„
    emailSettingsSheet.setColumnWidth(4, 200); // ì´ë©”ì¼
    emailSettingsSheet.setColumnWidth(5, 150); // ë©”ëª¨
    
    // ìš°ì„ ìˆœìœ„ ì—´ì— ìˆ«ì ê²€ì¦ ì¶”ê°€
    const priorityRange = emailSettingsSheet.getRange(2, 1, 1000, 1); // A2:A1001
    const priorityValidation = SpreadsheetApp.newDataValidation()
      .requireNumberGreaterThan(0)
      .setAllowInvalid(false)
      .build();
    priorityRange.setDataValidation(priorityValidation);
    
    // ì „ì†¡ì—¬ë¶€ ì—´ì— ë°ì´í„° ê²€ì¦ ì¶”ê°€ (TRUE/FALSE ë“œë¡­ë‹¤ìš´)
    const validationRange = emailSettingsSheet.getRange(2, 2, 1000, 1); // B2:B1001
    const validation = SpreadsheetApp.newDataValidation()
      .requireValueInList(['TRUE', 'FALSE'])
      .setAllowInvalid(false)
      .build();
    validationRange.setDataValidation(validation);
    
    // í…Œë‘ë¦¬ ì¶”ê°€
    const dataRange = emailSettingsSheet.getRange(1, 1, sampleData.length + 1, headers.length);
    dataRange.setBorder(true, true, true, true, true, true);
    
    // ì‹œíŠ¸ í™œì„±í™”
    emailSettingsSheet.activate();
    
    // ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      'âœ… ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„± ì™„ë£Œ',
      `'${sheetName}' ì‹œíŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
      'â€¢ ìš°ì„ ìˆœìœ„: ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ë†’ì€ ìš°ì„ ìˆœìœ„ì…ë‹ˆë‹¤\n' +
      'â€¢ ì „ì†¡ì—¬ë¶€: TRUEë¡œ ì„¤ì •ëœ ì‚¬ìš©ìë§Œ ì´ë©”ì¼ì„ ë°›ìŠµë‹ˆë‹¤\n' +
      'â€¢ ìƒ˜í”Œ ë°ì´í„°ëŠ” ì‹¤ì œ ë°ì´í„°ë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”',
      ui.ButtonSet.OK
    );
    
    console.log('=== Function End: createEmailSettingsSheet SUCCESS ===');
    return { success: true, message: 'ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.' };
    
  } catch (error) {
    console.error('ERROR in createEmailSettingsSheet:', error.toString());
    console.log('=== Function End: createEmailSettingsSheet FAILED ===');
    
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      'âŒ ì‹œíŠ¸ ìƒì„± ì‹¤íŒ¨',
      `ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:\n\n${error.toString()}`,
      ui.ButtonSet.OK
    );
    
    return { success: false, error: error.toString() };
  }
}

/**
 * ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ ë•Œ ë©”ë‰´ ìƒì„±
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ğŸ“¦ ê³°íƒ• ì¶œê³  ìë™í™”')
    .addItem('ğŸ”„ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ìë£Œ ì—…ë°ì´íŠ¸', 'updateCybersky')
    .addItem('ğŸ“§ ì˜¤ëŠ˜ EDI ì—…ë°ì´íŠ¸', 'updateTodayEDI')
    .addItem('âš¡ ì‹¸ì´ë²„ìŠ¤ì¹´ì´, EDI ë™ì‹œ ì—…ë°ì´íŠ¸', 'updateBoth')
    .addSeparator()
    .addItem('âš™ï¸ ë°ì´í„° ì²˜ë¦¬ ì‹¤í–‰', 'runDataProcessor')
    .addItem('ğŸ§® ê²€ì‚° ì‹¤í–‰', 'runVerification')
    .addItem('ğŸ“Š í’ˆëª©ë³„ ì‹œíŠ¸ ë¶„ë¦¬', 'splitByProduct')
    .addSeparator()
    .addItem('ğŸ›ï¸ ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë” ì—´ê¸°', 'openCoupangUploader')
    .addItem('ğŸ“¥ í’ˆëª©ë³„ ë‹¤ìš´ë¡œë” ì—´ê¸°', 'openProductDownloader')
    .addItem('ğŸ“¤ ë¡œì»¬ ì—‘ì…€ ì—…ë¡œë” ì—´ê¸°', 'openLocalExcelUploader')
    .addItem('ğŸ“§ ì´ë©”ì¼ ì „ì†¡ê¸° ì—´ê¸°', 'openEmailSender')
    .addItem('ğŸ“ ë“œë¼ì´ë¸Œë¡œ ì´ˆê¸° ì„¤ì •', 'openGooglePicker')
    .addSeparator()
    .addItem('â° ìë™ ì‹¤í–‰ ì„¤ì •', 'setupTriggers')
    .addItem('ğŸš€ ì™„ì „ ìë™í™” íŠ¸ë¦¬ê±° ì„¤ì •', 'setupCompleteAutomationTrigger')
    .addItem('â–¶ï¸ ì™„ì „ ìë™í™” ìˆ˜ë™ ì‹¤í–‰', 'manualCompleteAutomation')
    .addItem('ğŸ”§ ì„¤ì •', 'openSettings')
    .addItem('ğŸ“§ ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„±', 'createEmailSettingsSheet')
    .addSeparator()
    .addItem('ğŸ§ª í…ŒìŠ¤íŠ¸ - ìµœê·¼ EDI ê°€ì ¸ì˜¤ê¸°', 'testGetRecentEDI')
    .addItem('ğŸ§ª í…ŒìŠ¤íŠ¸ - ìë™ ì—…ë°ì´íŠ¸ ì‹¤í–‰', 'testDailyUpdate')
    .addItem('âš¡ í…ŒìŠ¤íŠ¸ - ì¦‰ì‹œ ì‹¤í–‰ (ì‹œê°„ë¬´ê´€)', 'immediateTest')
    .addItem('ğŸ“… í…ŒìŠ¤íŠ¸ - ë‚ ì§œ ì§€ì • (ê³¼ê±°ë°ì´í„°)', 'testWithDate')
    .addItem('ğŸ§ª í…ŒìŠ¤íŠ¸ - í…œí”Œë¦¿ ì‹œíŠ¸ ì´ˆê¸°í™”', 'clearTemplates')
    .addToUi();
}

/**
 * ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ìë£Œ ì—…ë°ì´íŠ¸
 */
function updateCybersky() {
  // ì„¤ì • ì´ˆê¸°í™”
  initializeConfig();
  
  const ui = SpreadsheetApp.getUi();
  
  // ë‚ ì§œ ì„ íƒ ì˜µì…˜
  const response = ui.alert(
    'ğŸ“… ë‚ ì§œ ì„ íƒ',
    'ì˜¤ëŠ˜ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
    'ì˜ˆ: ì˜¤ëŠ˜ ë‚ ì§œ (ìë™)\n' +
    'ì•„ë‹ˆì˜¤: ë‚ ì§œ ì§ì ‘ ì§€ì •',
    ui.ButtonSet.YES_NO_CANCEL
  );
  
  if (response === ui.Button.CANCEL) {
    return;
  }
  
  let targetDate = null;
  if (response === ui.Button.NO) {
    // ë‚ ì§œ ì§ì ‘ ì…ë ¥
    const dateResponse = ui.prompt(
      'ë‚ ì§œ ì…ë ¥',
      'MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 0807, 0808)',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (dateResponse.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    targetDate = dateResponse.getResponseText().trim();
    if (!/^\d{4}$/.test(targetDate)) {
      ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  }
  
  try {
    const result = targetDate 
      ? CyberskyData.updateCyberskyDataForDate(targetDate)
      : CyberskyData.updateCyberskyData();
      
    if (result.success) {
      ui.alert('âœ… ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ìë£Œ ì—…ë°ì´íŠ¸ ì™„ë£Œ!\n' + 
               (targetDate ? `ë‚ ì§œ: ${targetDate}` : 'ë‚ ì§œ: ì˜¤ëŠ˜'));
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    ui.alert('âŒ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ì˜¤ëŠ˜ EDI ì—…ë°ì´íŠ¸
 */
function updateTodayEDI() {
  // ì„¤ì • ì´ˆê¸°í™”
  initializeConfig();
  
  const ui = SpreadsheetApp.getUi();
  
  // ë‚ ì§œ ì„ íƒ ì˜µì…˜
  const response = ui.alert(
    'ğŸ“… ë‚ ì§œ ì„ íƒ',
    'ì˜¤ëŠ˜ ë‚ ì§œì˜ EDIë¥¼ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
    'ì˜ˆ: ì˜¤ëŠ˜ ë‚ ì§œ (ìë™)\n' +
    'ì•„ë‹ˆì˜¤: ë‚ ì§œ ì§ì ‘ ì§€ì •',
    ui.ButtonSet.YES_NO_CANCEL
  );
  
  if (response === ui.Button.CANCEL) {
    return;
  }
  
  let targetDate = null;
  if (response === ui.Button.NO) {
    // ë‚ ì§œ ì§ì ‘ ì…ë ¥
    const dateResponse = ui.prompt(
      'ë‚ ì§œ ì…ë ¥',
      'MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 0728, 0807)',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (dateResponse.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    targetDate = dateResponse.getResponseText().trim();
    if (!/^\d{4}$/.test(targetDate)) {
      ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  }
  
  try {
    const result = targetDate 
      ? EDIData.getEDIFromEmail(targetDate)
      : EDIData.updateEDIData();
      
    if (result.success) {
      ui.alert('âœ… EDI ì—…ë°ì´íŠ¸ ì™„ë£Œ!\n' + 
               (targetDate ? `ë‚ ì§œ: ${targetDate}` : 'ë‚ ì§œ: ì˜¤ëŠ˜'));
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    ui.alert('âŒ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ì‹¸ì´ë²„ìŠ¤ì¹´ì´ì™€ EDI ë™ì‹œ ì—…ë°ì´íŠ¸
 */
function updateBoth() {
  // ì„¤ì • ì´ˆê¸°í™”
  initializeConfig();
  
  const ui = SpreadsheetApp.getUi();
  
  // ë‚ ì§œ ì„ íƒ ì˜µì…˜
  const response = ui.alert(
    'ğŸ“… ë‚ ì§œ ì„ íƒ',
    'ì˜¤ëŠ˜ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
    'ì˜ˆ: ì˜¤ëŠ˜ ë‚ ì§œ (ìë™)\n' +
    'ì•„ë‹ˆì˜¤: ë‚ ì§œ ì§ì ‘ ì§€ì •',
    ui.ButtonSet.YES_NO_CANCEL
  );
  
  if (response === ui.Button.CANCEL) {
    return;
  }
  
  let targetDate = null;
  if (response === ui.Button.NO) {
    // ë‚ ì§œ ì§ì ‘ ì…ë ¥
    const dateResponse = ui.prompt(
      'ë‚ ì§œ ì…ë ¥',
      'MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 0807, 0808)\n' +
      'ì‹¸ì´ë²„ìŠ¤ì¹´ì´ì™€ EDI ëª¨ë‘ í•´ë‹¹ ë‚ ì§œ ë°ì´í„°ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (dateResponse.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    targetDate = dateResponse.getResponseText().trim();
    if (!/^\d{4}$/.test(targetDate)) {
      ui.alert('âŒ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. MMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  }
  
  try {
    const cyberskyResult = targetDate
      ? CyberskyData.updateCyberskyDataForDate(targetDate)
      : CyberskyData.updateCyberskyData();
      
    const ediResult = targetDate
      ? EDIData.getEDIFromEmail(targetDate)
      : EDIData.updateEDIData();
    
    if (cyberskyResult.success && ediResult.success) {
      // ë°ì´í„° ì²˜ë¦¬ ì‹¤í–‰
      const processResult = DataProcessor.processData();
      if (processResult.success) {
        ui.alert('âœ… ëª¨ë“  ë°ì´í„° ì—…ë°ì´íŠ¸ ë° ì²˜ë¦¬ ì™„ë£Œ!\n' +
                 (targetDate ? `ë‚ ì§œ: ${targetDate}` : 'ë‚ ì§œ: ì˜¤ëŠ˜'));
      } else {
        throw new Error('ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨: ' + processResult.error);
      }
    } else {
      let errors = [];
      if (!cyberskyResult.success) errors.push('ì‹¸ì´ë²„ìŠ¤ì¹´ì´: ' + cyberskyResult.error);
      if (!ediResult.success) errors.push('EDI: ' + ediResult.error);
      throw new Error(errors.join('\n'));
    }
  } catch (error) {
    ui.alert('âŒ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ê²€ì‚° ì‹¤í–‰
 */
function runVerification() {
  // ì„¤ì • ì´ˆê¸°í™”
  initializeConfig();
  
  try {
    const result = Verification.runVerification();
    const ui = SpreadsheetApp.getUi();
    
    if (result.success) {
      ui.alert('âœ… ê²€ì‚° ì™„ë£Œ!\n\n' + result.message);
    } else {
      ui.alert('âš ï¸ ê²€ì‚° ì‹¤íŒ¨!\n\n' + result.message);
    }
  } catch (error) {
    SpreadsheetApp.getUi().alert('âŒ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * í’ˆëª©ë³„ ì‹œíŠ¸ ë¶„ë¦¬
 */
function splitByProduct() {
  // ì„¤ì • ì´ˆê¸°í™”
  initializeConfig();
  
  try {
    const result = ProductSplitter.splitByProduct();
    if (result.success) {
      SpreadsheetApp.getUi().alert('âœ… í’ˆëª©ë³„ ì‹œíŠ¸ ë¶„ë¦¬ ì™„ë£Œ!\nìƒì„±ëœ ì‹œíŠ¸: ' + result.sheets.join(', '));
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    SpreadsheetApp.getUi().alert('âŒ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ë°ì´í„° ì²˜ë¦¬ ì‹¤í–‰
 */
function runDataProcessor() {
  // ì„¤ì • ì´ˆê¸°í™”
  initializeConfig();
  
  try {
    const result = DataProcessor.processData();
    if (result.success) {
      SpreadsheetApp.getUi().alert('âœ… ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ!\nì²˜ë¦¬ëœ í–‰: ' + result.processedRows);
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    SpreadsheetApp.getUi().alert('âŒ ì˜¤ë¥˜: ' + error.toString());
  }
}

/**
 * ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë” ì—´ê¸°
 */
function openCoupangUploader() {
  const html = HtmlService.createHtmlOutputFromFile('CoupangUploader')
    .setWidth(600)
    .setHeight(400)
    .setTitle('ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë”');
  SpreadsheetApp.getUi().showModalDialog(html, 'ì¿ íŒ¡ ë°ì´í„° ì—…ë¡œë”');
}

/**
 * ë¡œì»¬ ì—‘ì…€ ì—…ë¡œë” ì—´ê¸°
 */
function openLocalExcelUploader() {
  const html = HtmlService.createHtmlOutputFromFile('ExcelUploaderDialog')
    .setWidth(950)
    .setHeight(700)
    .setTitle('ë¡œì»¬ ì—‘ì…€ ì—…ë¡œë”');
  SpreadsheetApp.getUi().showModalDialog(html, 'ë¡œì»¬ ì—‘ì…€ ì—…ë¡œë”');
}

/**
 * í’ˆëª©ë³„ ë‹¤ìš´ë¡œë” ì—´ê¸°
 */
function openProductDownloader() {
  const html = HtmlService.createHtmlOutputFromFile('ProductDownloaderDialog')
    .setWidth(850)
    .setHeight(650)
    .setTitle('í’ˆëª©ë³„ ë‹¤ìš´ë¡œë”');
  SpreadsheetApp.getUi().showModalDialog(html, 'í’ˆëª©ë³„ ë‹¤ìš´ë¡œë”');
}

/**
 * ì´ë©”ì¼ ì „ì†¡ê¸° ì—´ê¸°
 */
function openEmailSender() {
  const html = HtmlService.createHtmlOutputFromFile('EmailSenderDialog')
    .setWidth(750)
    .setHeight(700)
    .setTitle('ì´ë©”ì¼ ì „ì†¡ê¸°');
  SpreadsheetApp.getUi().showModalDialog(html, 'ì´ë©”ì¼ ì „ì†¡ê¸°');
}

/**
 * ë“œë¼ì´ë¸Œ íƒìƒ‰ê¸° ì—´ê¸°
 */
function openDriveExplorer() {
  DriveExplorer.openExplorer();
}

/**
 * ì„¤ì • ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°
 */
function openSettings() {
  const html = HtmlService.createHtmlOutputFromFile('Settings')
    .setWidth(500)
    .setHeight(400)
    .setTitle('ì„¤ì •');
  SpreadsheetApp.getUi().showModalDialog(html, 'ê³°íƒ• ì¶œê³  ìë™í™” ì„¤ì •');
}

/**
 * í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ - TestFunctions.gsë¡œ ìœ„ì„
 */
function testCyberskyByDate() {
  TestFunctions.testCyberskyByDate();
}

function testEDIByDate() {
  TestFunctions.testEDIByDate();
}

function testFullProcessByDate() {
  TestFunctions.testFullProcessByDate();
}

function testGetRecentEDI() {
  TestFunctions.testGetRecentEDI();
}

function testDailyUpdate() {
  // Triggers.gsì˜ í•¨ìˆ˜ í˜¸ì¶œ
  dailyUpdate();
  SpreadsheetApp.getUi().alert('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì™„ë£Œ!\nì—…ë°ì´íŠ¸_ë¡œê·¸ ì‹œíŠ¸ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
}

function cleanTestSheets() {
  TestFunctions.cleanTestSheets();
}


/**
 * í…œí”Œë¦¿ ì‹œíŠ¸ ì´ˆê¸°í™”
 */
function clearTemplates() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'âš ï¸ í…œí”Œë¦¿ ì´ˆê¸°í™”',
    'ìƒ˜í”Œë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ì‹œíŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìƒ˜í”Œ ì‹œíŠ¸, ì„¤ëª…ì„œ ë“±ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)',
    ui.ButtonSet.YES_NO
  );
  
  if (response === ui.Button.YES) {
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const sheets = spreadsheet.getSheets();
      let deletedCount = 0;
      
      for (const sheet of sheets) {
        const name = sheet.getName();
        if (name.startsWith('ìƒ˜í”Œ') || name.includes('ì„¤ëª…') || name.includes('í…œí”Œë¦¿')) {
          spreadsheet.deleteSheet(sheet);
          deletedCount++;
        }
      }
      
      ui.alert(`âœ… ${deletedCount}ê°œì˜ í…œí”Œë¦¿ ì‹œíŠ¸ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
      ui.alert('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.toString());
    }
  }
}

/**
 * ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYYMMDD í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
 */
function getTodayDate() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  return year + month + day;
}

/**
 * ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYMM í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
 */
function getTodayShortDate() {
  const today = new Date();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  return month + day;
}

/**
 * MMDDë¥¼ YYYYMMDDë¡œ ë³€í™˜
 */
function convertToFullDate(shortDate) {
  if (shortDate.length === 8) {
    return shortDate; // ì´ë¯¸ YYYYMMDD í˜•ì‹
  }
  
  const year = new Date().getFullYear();
  return year + shortDate;
}

/**
 * ì„¤ì • ì €ì¥
 */
function saveSettings(settings) {
  try {
    const scriptProperties = PropertiesService.getScriptProperties();
    scriptProperties.setProperty('SOURCE_SPREADSHEET_ID', settings.sourceSpreadsheetId);
    scriptProperties.setProperty('FOLDER_ID', settings.folderId);
    scriptProperties.setProperty('SENDER_POSTAL_CODE', settings.senderPostal);
    scriptProperties.setProperty('SENDER_ADDRESS', settings.senderAddress);
    
    // CONFIG ê°ì²´ ì—…ë°ì´íŠ¸
    CONFIG.SOURCE_SPREADSHEET_ID = settings.sourceSpreadsheetId;
    CONFIG.FOLDER_ID = settings.folderId;
    CONFIG.SENDER_POSTAL_CODE = settings.senderPostal;
    CONFIG.SENDER_ADDRESS = settings.senderAddress;
    
    return { success: true };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

/**
 * ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
 */
function getSettings() {
  const scriptProperties = PropertiesService.getScriptProperties();
  return {
    sourceSpreadsheetId: scriptProperties.getProperty('SOURCE_SPREADSHEET_ID') || CONFIG.SOURCE_SPREADSHEET_ID,
    folderId: scriptProperties.getProperty('FOLDER_ID') || CONFIG.FOLDER_ID,
    senderPostal: scriptProperties.getProperty('SENDER_POSTAL_CODE') || CONFIG.SENDER_POSTAL_CODE,
    senderAddress: scriptProperties.getProperty('SENDER_ADDRESS') || CONFIG.SENDER_ADDRESS
  };
}

/**
 * ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì‹œ ì„¤ì • ë¡œë“œ
 */
function initializeConfig() {
  const settings = getSettings();
  CONFIG.SOURCE_SPREADSHEET_ID = settings.sourceSpreadsheetId;
  CONFIG.FOLDER_ID = settings.folderId;
  CONFIG.SENDER_POSTAL_CODE = settings.senderPostal;
  CONFIG.SENDER_ADDRESS = settings.senderAddress;
}

/**
 * ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„±
 */
function createEmailSettingsSheet() {
  console.log('=== Function Start: createEmailSettingsSheet ===');
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = 'ì´ë©”ì¼_ì„¤ì •';
    
    // ê¸°ì¡´ ì‹œíŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
    let emailSettingsSheet = spreadsheet.getSheetByName(sheetName);
    
    if (emailSettingsSheet) {
      const ui = SpreadsheetApp.getUi();
      const response = ui.alert(
        'âš ï¸ ì‹œíŠ¸ ì´ë¯¸ ì¡´ì¬',
        `'${sheetName}' ì‹œíŠ¸ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.\n\nê¸°ì¡´ ì‹œíŠ¸ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?`,
        ui.ButtonSet.YES_NO
      );
      
      if (response === ui.Button.YES) {
        spreadsheet.deleteSheet(emailSettingsSheet);
        console.log('ê¸°ì¡´ ì´ë©”ì¼_ì„¤ì • ì‹œíŠ¸ ì‚­ì œ');
      } else {
        console.log('ì‹œíŠ¸ ìƒì„± ì·¨ì†Œ');
        return { success: false, error: 'ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.' };
      }
    }
    
    // ìƒˆ ì‹œíŠ¸ ìƒì„±
    emailSettingsSheet = spreadsheet.insertSheet(sheetName);
    console.log('ìƒˆ ì´ë©”ì¼_ì„¤ì • ì‹œíŠ¸ ìƒì„±');
    
    // í—¤ë” ì„¤ì •
    const headers = ['ìš°ì„ ìˆœìœ„', 'ì „ì†¡ì—¬ë¶€', 'ì´ë¦„', 'ì´ë©”ì¼', 'ë©”ëª¨'];
    emailSettingsSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // í—¤ë” ìŠ¤íƒ€ì¼ë§
    const headerRange = emailSettingsSheet.getRange(1, 1, 1, headers.length);
    headerRange.setBackground('#4285f4');
    headerRange.setFontColor('white');
    headerRange.setFontWeight('bold');
    headerRange.setHorizontalAlignment('center');
    
    // ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€
    const sampleData = [
      [1, 'TRUE', 'ê¹€ì˜ì¤€', 'example1@company.com', 'ë‹´ë‹¹ì'],
      [2, 'FALSE', 'í™ê¸¸ë™', 'example2@company.com', 'ë°±ì—… ë‹´ë‹¹ì'],
      [3, 'TRUE', 'ì´ìˆœì‹ ', 'example3@company.com', 'ê´€ë¦¬ì']
    ];
    
    emailSettingsSheet.getRange(2, 1, sampleData.length, headers.length).setValues(sampleData);
    
    // ì—´ ë„ˆë¹„ ì¡°ì •
    emailSettingsSheet.setColumnWidth(1, 80);  // ìš°ì„ ìˆœìœ„
    emailSettingsSheet.setColumnWidth(2, 80);  // ì „ì†¡ì—¬ë¶€
    emailSettingsSheet.setColumnWidth(3, 100); // ì´ë¦„
    emailSettingsSheet.setColumnWidth(4, 200); // ì´ë©”ì¼
    emailSettingsSheet.setColumnWidth(5, 150); // ë©”ëª¨
    
    // ìš°ì„ ìˆœìœ„ ì—´ì— ìˆ«ì ê²€ì¦ ì¶”ê°€
    const priorityRange = emailSettingsSheet.getRange(2, 1, 1000, 1); // A2:A1001
    const priorityValidation = SpreadsheetApp.newDataValidation()
      .requireNumberGreaterThan(0)
      .setAllowInvalid(false)
      .build();
    priorityRange.setDataValidation(priorityValidation);
    
    // ì „ì†¡ì—¬ë¶€ ì—´ì— ë°ì´í„° ê²€ì¦ ì¶”ê°€ (TRUE/FALSE ë“œë¡­ë‹¤ìš´)
    const validationRange = emailSettingsSheet.getRange(2, 2, 1000, 1); // B2:B1001
    const validation = SpreadsheetApp.newDataValidation()
      .requireValueInList(['TRUE', 'FALSE'])
      .setAllowInvalid(false)
      .build();
    validationRange.setDataValidation(validation);
    
    // í…Œë‘ë¦¬ ì¶”ê°€
    const dataRange = emailSettingsSheet.getRange(1, 1, sampleData.length + 1, headers.length);
    dataRange.setBorder(true, true, true, true, true, true);
    
    // ì‹œíŠ¸ í™œì„±í™”
    emailSettingsSheet.activate();
    
    // ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      'âœ… ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„± ì™„ë£Œ',
      `'${sheetName}' ì‹œíŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
      'â€¢ ìš°ì„ ìˆœìœ„: ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ë†’ì€ ìš°ì„ ìˆœìœ„ì…ë‹ˆë‹¤\n' +
      'â€¢ ì „ì†¡ì—¬ë¶€: TRUEë¡œ ì„¤ì •ëœ ì‚¬ìš©ìë§Œ ì´ë©”ì¼ì„ ë°›ìŠµë‹ˆë‹¤\n' +
      'â€¢ ìƒ˜í”Œ ë°ì´í„°ëŠ” ì‹¤ì œ ë°ì´í„°ë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”',
      ui.ButtonSet.OK
    );
    
    console.log('=== Function End: createEmailSettingsSheet SUCCESS ===');
    return { success: true, message: 'ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.' };
    
  } catch (error) {
    console.error('ERROR in createEmailSettingsSheet:', error.toString());
    console.log('=== Function End: createEmailSettingsSheet FAILED ===');
    
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      'âŒ ì‹œíŠ¸ ìƒì„± ì‹¤íŒ¨',
      `ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:\n\n${error.toString()}`,
      ui.ButtonSet.OK
    );
    
    return { success: false, error: error.toString() };
  }
}
