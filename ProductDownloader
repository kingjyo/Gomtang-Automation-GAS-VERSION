/**
 * í’ˆëª©ë³„ ì‹œíŠ¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬ê¸°
 * ProductDownloader.gs
 */

const ProductDownloader = {
  /**
   * ì‚¬ìš© ê°€ëŠ¥í•œ ì œí’ˆ ëª©ë¡
   */
  PRODUCTS: [
    'ì‚¬ê³¨ê³ ê¸°ê³°íƒ•',
    'ì‚¬ê³¨ê³°íƒ•', 
    'ìœ¡í¬'
  ],

  /**
   * í’ˆëª©ë³„ ì‹œíŠ¸ë“¤ì„ í•˜ë‚˜ì˜ ì—‘ì…€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
   */
  downloadProductSheets: function(targetDate) {
    console.log('=== í’ˆëª©ë³„ ì‹œíŠ¸ ë‹¤ìš´ë¡œë“œ ì‹œì‘ ===');
    console.log('Target date:', targetDate);
    
    try {
      // ì„¤ì • ì´ˆê¸°í™”
      initializeConfig();
      
      // ë‚ ì§œ ì²˜ë¦¬
      let dateString;
      if (targetDate) {
        if (targetDate.length === 4) {
          // MMDD í˜•ì‹ì„ YYYYMMDDë¡œ ë³€í™˜
          const currentYear = new Date().getFullYear();
          const month = targetDate.substring(0, 2);
          const day = targetDate.substring(2, 4);
          dateString = currentYear + month + day;
        } else {
          // YYYYMMDD í˜•ì‹
          dateString = targetDate.replace(/\//g, '').replace(/-/g, '');
        }
      } else {
        dateString = getTodayDate();
      }
      
      console.log('Using date string:', dateString);
      
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const availableSheets = [];
      const foundSheets = [];
      
      // ê° ì œí’ˆë³„ë¡œ ì‹œíŠ¸ í™•ì¸
      for (const product of this.PRODUCTS) {
        const sheetName = `${dateString}_${product}`;
        console.log(`Looking for sheet: ${sheetName}`);
        
        const sheet = spreadsheet.getSheetByName(sheetName);
        if (sheet) {
          console.log(`Found sheet: ${sheetName}`);
          availableSheets.push(sheetName);
          foundSheets.push({
            originalSheet: sheet,
            productName: product,
            sheetName: sheetName
          });
        } else {
          console.log(`Sheet not found: ${sheetName}`);
        }
      }
      
      if (foundSheets.length === 0) {
        return {
          success: false,
          error: `${dateString} ë‚ ì§œì˜ í’ˆëª©ë³„ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në‹¤ìŒ í˜•ì‹ì˜ ì‹œíŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤:\n- ${dateString}_ì‚¬ê³¨ê³ ê¸°ê³°íƒ•\n- ${dateString}_ì‚¬ê³¨ê³°íƒ•\n- ${dateString}_ìœ¡í¬`
        };
      }
      
      // í•˜ë‚˜ì˜ ì—‘ì…€ íŒŒì¼ì— ëª¨ë“  ì‹œíŠ¸ í¬í•¨
      const downloadInfo = this.createCombinedExcelFile(foundSheets, dateString);
      
      console.log('=== í’ˆëª©ë³„ ì‹œíŠ¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ===');
      return {
        success: true,
        message: `${foundSheets.length}ê°œ í’ˆëª©ì´ í¬í•¨ëœ ì—‘ì…€ íŒŒì¼ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.`,
        availableSheets: availableSheets,
        downloadInfo: downloadInfo,
        dateString: dateString
      };
      
    } catch (error) {
      console.error('í’ˆëª©ë³„ ì‹œíŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error.toString()
      };
    }
  },

  /**
   * ì—¬ëŸ¬ ì‹œíŠ¸ë¥¼ í•˜ë‚˜ì˜ ì—‘ì…€ íŒŒì¼ë¡œ í†µí•©
   */
  createCombinedExcelFile: function(foundSheets, dateString) {
    console.log(`=== Creating combined Excel file for ${foundSheets.length} sheets ===`);
    
    try {
      // ìƒˆë¡œìš´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±
      const tempSpreadsheet = SpreadsheetApp.create(`temp_í’ˆëª©ë³„_${dateString}`);
      console.log(`Created temp spreadsheet: temp_í’ˆëª©ë³„_${dateString}`);
      
      // ê¸°ë³¸ ì‹œíŠ¸ ì‚­ì œ (ë‚˜ì¤‘ì— ìƒˆë¡œìš´ ì‹œíŠ¸ë“¤ë¡œ ëŒ€ì²´)
      const defaultSheet = tempSpreadsheet.getActiveSheet();
      
      // ê° ì œí’ˆë³„ ì‹œíŠ¸ ì¶”ê°€
      for (const sheetInfo of foundSheets) {
        console.log(`Adding sheet for: ${sheetInfo.productName}`);
        
        // ìƒˆ ì‹œíŠ¸ ìƒì„± (ì œí’ˆëª…ë§Œ, YYYYMMDD_ ì ‘ë‘ì‚¬ ì—†ì´)
        const newSheet = tempSpreadsheet.insertSheet(sheetInfo.productName);
        
        // ì›ë³¸ ì‹œíŠ¸ì˜ ëª¨ë“  ë°ì´í„° ë³µì‚¬
        const sourceData = sheetInfo.originalSheet.getDataRange().getValues();
        console.log(`Copying ${sourceData.length} rows for ${sheetInfo.productName}`);
        
        if (sourceData.length > 0) {
          newSheet.getRange(1, 1, sourceData.length, sourceData[0].length).setValues(sourceData);
          
          // ì„œì‹ë„ ë³µì‚¬
          this.copySheetFormatting(sheetInfo.originalSheet, newSheet);
        }
      }
      
      // ê¸°ë³¸ ì‹œíŠ¸ ì‚­ì œ
      if (tempSpreadsheet.getSheets().length > foundSheets.length) {
        tempSpreadsheet.deleteSheet(defaultSheet);
      }
      
      // Drive APIë¥¼ ì‚¬ìš©í•´ ì—‘ì…€ë¡œ ë³€í™˜
      const tempFile = DriveApp.getFileById(tempSpreadsheet.getId());
      
      // ì—‘ì…€ íŒŒì¼ëª… - ê³µì‹ í˜•ì‹: "ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥ (MM.DD).xlsx"
      const month = dateString.substring(4, 6);
      const day = dateString.substring(6, 8);
      const excelFileName = `ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥ (${month}.${day}).xlsx`;
      
      // ì—‘ì…€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const excelBlob = this.convertToExcel(tempSpreadsheet.getId(), excelFileName);
      
      // ì„ì‹œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì‚­ì œ
      DriveApp.getFileById(tempSpreadsheet.getId()).setTrashed(true);
      console.log('Temp spreadsheet deleted');
      
      // ë“œë¼ì´ë¸Œì— ì—‘ì…€ íŒŒì¼ ì €ì¥
      const excelFile = DriveApp.createFile(excelBlob);
      excelFile.setName(excelFileName);
      
      // ë‚ ì§œ í´ë”ë¡œ ì´ë™
      this.moveToDateFolder(excelFile.getId(), dateString, excelFileName);
      
      // ì‹¤ì œ ë‹¤ìš´ë¡œë“œ URL ìƒì„± (export link ì‚¬ìš©)
      const downloadUrl = `https://drive.google.com/uc?export=download&id=${excelFile.getId()}`;
      
      console.log(`Combined Excel file created successfully: ${excelFileName}`);
      console.log(`Download URL: ${downloadUrl}`);
      
      return {
        fileName: excelFileName,
        fileId: excelFile.getId(),
        downloadUrl: downloadUrl,
        sheetsIncluded: foundSheets.map(s => s.productName)
      };
      
    } catch (error) {
      console.error(`Error creating combined Excel file:`, error);
      throw error;
    }
  },

  /**
   * ê°œë³„ ì‹œíŠ¸ì—ì„œ ì—‘ì…€ íŒŒì¼ ìƒì„± (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
   */
  createExcelFile: function(sheet, productName, dateString) {
    console.log(`=== Creating Excel file for: ${productName} ===`);
    
    try {
      // ìƒˆë¡œìš´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±
      const tempSpreadsheet = SpreadsheetApp.create(`temp_${productName}_${dateString}`);
      console.log(`Created temp spreadsheet: temp_${productName}_${dateString}`);
      
      // ê¸°ë³¸ ì‹œíŠ¸ ì´ë¦„ì„ ì œí’ˆëª…ìœ¼ë¡œ ë³€ê²½
      const tempSheet = tempSpreadsheet.getActiveSheet();
      tempSheet.setName(productName); // YYYYMMDD_ ì ‘ë‘ì‚¬ ì—†ì´ ì œí’ˆëª…ë§Œ
      console.log(`Renamed sheet to: ${productName}`);
      
      // ì›ë³¸ ì‹œíŠ¸ì˜ ëª¨ë“  ë°ì´í„° ë³µì‚¬
      const sourceData = sheet.getDataRange().getValues();
      console.log(`Source data rows: ${sourceData.length}`);
      
      if (sourceData.length > 0) {
        tempSheet.getRange(1, 1, sourceData.length, sourceData[0].length).setValues(sourceData);
        console.log('Data copied successfully');
        
        // ì›ë³¸ ì‹œíŠ¸ì˜ ì„œì‹ë„ ë³µì‚¬ (í—¤ë” ìŠ¤íƒ€ì¼ ë“±)
        this.copySheetFormatting(sheet, tempSheet);
      }
      
      // Drive APIë¥¼ ì‚¬ìš©í•´ ì—‘ì…€ë¡œ ë³€í™˜
      const tempFile = DriveApp.getFileById(tempSpreadsheet.getId());
      
      // ì—‘ì…€ íŒŒì¼ëª… (ë‚ ì§œ_ì œí’ˆëª….xlsx)
      const excelFileName = `${dateString}_${productName}.xlsx`;
      
      // ì—‘ì…€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const blob = tempFile.getBlob();
      const excelBlob = this.convertToExcel(blob, excelFileName);
      
      // ì„ì‹œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì‚­ì œ
      DriveApp.getFileById(tempSpreadsheet.getId()).setTrashed(true);
      console.log('Temp spreadsheet deleted');
      
      // ë“œë¼ì´ë¸Œì— ì—‘ì…€ íŒŒì¼ ì €ì¥
      const excelFile = DriveApp.createFile(excelBlob);
      
      // ë‚ ì§œ í´ë”ë¡œ ì´ë™
      this.moveToDateFolder(excelFile.getId(), dateString, excelFileName);
      
      // ë‹¤ìš´ë¡œë“œ URL ìƒì„±
      const downloadUrl = `https://drive.google.com/file/d/${excelFile.getId()}/view`;
      
      console.log(`Excel file created successfully: ${excelFileName}`);
      console.log(`Download URL: ${downloadUrl}`);
      
      return downloadUrl;
      
    } catch (error) {
      console.error(`Error creating Excel file for ${productName}:`, error);
      throw error;
    }
  },

  /**
   * ì‹œíŠ¸ ì„œì‹ ë³µì‚¬
   */
  copySheetFormatting: function(sourceSheet, targetSheet) {
    try {
      const lastRow = sourceSheet.getLastRow();
      const lastCol = sourceSheet.getLastColumn();
      
      if (lastRow > 0 && lastCol > 0) {
        // í—¤ë” í–‰ (ì²« ë²ˆì§¸ í–‰) ì„œì‹ ë³µì‚¬
        if (lastRow >= 1) {
          const headerRange = sourceSheet.getRange(1, 1, 1, lastCol);
          const targetHeaderRange = targetSheet.getRange(1, 1, 1, lastCol);
          
          // ë°°ê²½ìƒ‰ ë³µì‚¬
          const backgrounds = headerRange.getBackgrounds();
          targetHeaderRange.setBackgrounds(backgrounds);
          
          // í°íŠ¸ ìŠ¤íƒ€ì¼ ë³µì‚¬
          const fontWeights = headerRange.getFontWeights();
          targetHeaderRange.setFontWeights(fontWeights);
          
          // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³µì‚¬
          const fontColors = headerRange.getFontColors();
          targetHeaderRange.setFontColors(fontColors);
          
          console.log('Header formatting copied');
        }
        
        // ì—´ ë„ˆë¹„ ë³µì‚¬
        for (let col = 1; col <= lastCol; col++) {
          const width = sourceSheet.getColumnWidth(col);
          targetSheet.setColumnWidth(col, width);
        }
        
        console.log('Column widths copied');
      }
    } catch (error) {
      console.log('Warning: Could not copy all formatting:', error.toString());
    }
  },

  /**
   * Google Sheetsë¥¼ Excel í˜•ì‹ìœ¼ë¡œ ë³€í™˜
   */
  convertToExcel: function(spreadsheetId, fileName) {
    try {
      console.log(`Converting spreadsheet ${spreadsheetId} to Excel...`);
      
      // Drive API v3ë¥¼ ì‚¬ìš©í•˜ì—¬ Excel í˜•ì‹ìœ¼ë¡œ export
      const exportUrl = `https://www.googleapis.com/drive/v3/files/${spreadsheetId}/export?mimeType=application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`;
      
      const response = UrlFetchApp.fetch(exportUrl, {
        headers: {
          'Authorization': `Bearer ${ScriptApp.getOAuthToken()}`
        }
      });
      
      if (response.getResponseCode() !== 200) {
        throw new Error(`Failed to export Excel: ${response.getResponseCode()}`);
      }
      
      console.log('Excel conversion successful');
      
      // Excel blob ë°˜í™˜
      return Utilities.newBlob(
        response.getContent(),
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        fileName
      );
      
    } catch (error) {
      console.error('Excel conversion failed:', error);
      throw error;
    }
  },

  /**
   * íŒŒì¼ì„ ë‚ ì§œ í´ë”ë¡œ ì´ë™
   */
  moveToDateFolder: function(fileId, dateString, fileName) {
    try {
      const file = DriveApp.getFileById(fileId);
      const parentFolderId = CONFIG.FOLDER_ID;
      
      if (!parentFolderId || parentFolderId === 'YOUR_FOLDER_ID') {
        console.log('í´ë” IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ë£¨íŠ¸ í´ë”ì— ì €ì¥ë©ë‹ˆë‹¤.');
        return;
      }
      
      const parentFolder = DriveApp.getFolderById(parentFolderId);
      
      // ë‚ ì§œ í´ë” ìƒì„± ë˜ëŠ” ê°€ì ¸ì˜¤ê¸°
      const folders = parentFolder.getFoldersByName(dateString);
      let dateFolder;
      
      if (folders.hasNext()) {
        dateFolder = folders.next();
      } else {
        dateFolder = parentFolder.createFolder(dateString);
      }
      
      // ë‹¤ìš´ë¡œë“œ í•˜ìœ„ í´ë” ìƒì„± ë˜ëŠ” ê°€ì ¸ì˜¤ê¸°
      const downloadFolders = dateFolder.getFoldersByName('ë‹¤ìš´ë¡œë“œ');
      let downloadFolder;
      
      if (downloadFolders.hasNext()) {
        downloadFolder = downloadFolders.next();
      } else {
        downloadFolder = dateFolder.createFolder('ë‹¤ìš´ë¡œë“œ');
      }
      
      // ê°™ì€ ì´ë¦„ì˜ ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´ ì‚­ì œ
      const existingFiles = downloadFolder.getFilesByName(fileName);
      while (existingFiles.hasNext()) {
        const existingFile = existingFiles.next();
        existingFile.setTrashed(true);
      }
      
      // íŒŒì¼ ì´ë™
      downloadFolder.addFile(file);
      
      // ì›ë˜ ìœ„ì¹˜ì—ì„œ ì œê±°
      const parents = file.getParents();
      while (parents.hasNext()) {
        const parent = parents.next();
        if (parent.getId() !== downloadFolder.getId()) {
          parent.removeFile(file);
        }
      }
      
      console.log(`íŒŒì¼ì´ ${dateString}/ë‹¤ìš´ë¡œë“œ í´ë”ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      
    } catch (error) {
      console.error('íŒŒì¼ ì´ë™ ì‹¤íŒ¨:', error);
    }
  },

  /**
   * ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ì´ˆê¸°í™”
   */
  initializeEmailSettings: function() {
    console.log('=== ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ì´ˆê¸°í™” ===');
    
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const settingsSheetName = 'ì´ë©”ì¼_ì„¤ì •';
      
      // ê¸°ì¡´ ì„¤ì • ì‹œíŠ¸ í™•ì¸
      let settingsSheet = spreadsheet.getSheetByName(settingsSheetName);
      
      if (!settingsSheet) {
        // ì„¤ì • ì‹œíŠ¸ ìƒì„±
        settingsSheet = spreadsheet.insertSheet(settingsSheetName);
        
        // í—¤ë” ì„¤ì •
        settingsSheet.getRange(1, 1, 1, 5).setValues([
          ['ìˆœì„œ', 'ì´ë¦„', 'ì´ë©”ì¼ ì£¼ì†Œ', 'ë¹„ê³ ', 'ì „ì†¡ì—¬ë¶€']
        ]);
        
        // ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€ (ì§ê¸‰ ìˆœì„œëŒ€ë¡œ)
        settingsSheet.getRange(2, 1, 3, 5).setValues([
          [1, 'ê¹€ì˜ì¤€', 'youngjun.kim@company.com', 'ë‹´ë‹¹ì (íŒ€ì¥)', true],
          [2, 'í™ê¸¸ë™', 'gildong.hong@partner.com', 'íŒŒíŠ¸ë„ˆ (ëŒ€ë¦¬)', true],
          [3, 'ì´ì² ìˆ˜', 'chulsoo.lee@client.com', 'ê³ ê° (ì‚¬ì›)', false]
        ]);
        
        // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš©
        const headerRange = settingsSheet.getRange(1, 1, 1, 5);
        headerRange.setBackground('#4285f4');
        headerRange.setFontColor('#ffffff');
        headerRange.setFontWeight('bold');
        
        // ì—´ ë„ˆë¹„ ì¡°ì •
        settingsSheet.setColumnWidth(1, 60);  // ìˆœì„œ
        settingsSheet.setColumnWidth(2, 120); // ì´ë¦„
        settingsSheet.setColumnWidth(3, 250); // ì´ë©”ì¼ ì£¼ì†Œ
        settingsSheet.setColumnWidth(4, 150); // ë¹„ê³ 
        settingsSheet.setColumnWidth(5, 80);  // ì „ì†¡ì—¬ë¶€
        
        // ì „ì†¡ì—¬ë¶€ ì»¬ëŸ¼ì„ ì²´í¬ë°•ìŠ¤ë¡œ ì„¤ì •
        const checkboxRange = settingsSheet.getRange(2, 5, 100, 1); // E2:E101 ë²”ìœ„
        checkboxRange.insertCheckboxes();
        
        console.log('ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
      
      return {
        success: true,
        message: 'ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.'
      };
      
    } catch (error) {
      console.error('ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: error.toString()
      };
    }
  },

  /**
   * ì´ë©”ì¼ ì£¼ì†Œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
   */
  getEmailRecipients: function() {
    console.log('=== ì´ë©”ì¼ ì£¼ì†Œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ===');
    
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const settingsSheet = spreadsheet.getSheetByName('ì´ë©”ì¼_ì„¤ì •');
      
      if (!settingsSheet) {
        // ì„¤ì • ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
        const initResult = this.initializeEmailSettings();
        if (!initResult.success) {
          return initResult;
        }
        return this.getEmailRecipients(); // ì¬ê·€ í˜¸ì¶œ
      }
      
      const data = settingsSheet.getDataRange().getValues();
      const recipients = [];
      
      // í—¤ë” í–‰ ì œì™¸í•˜ê³  ì²˜ë¦¬
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const order = parseInt(row[0] || 999); // Aì—´: ìš°ì„ ìˆœìœ„ (ê¸°ë³¸ê°’ 999)
        const sendEnabled = String(row[1] || '').toUpperCase() === 'TRUE'; // Bì—´: ì „ì†¡ì—¬ë¶€ (TRUE/FALSE)
        const name = String(row[2] || '').trim(); // Cì—´: ì´ë¦„
        const email = String(row[3] || '').trim(); // Dì—´: ì´ë©”ì¼ ì£¼ì†Œ
        const memo = String(row[4] || '').trim(); // Eì—´: ë©”ëª¨
        
        console.log(`Processing row ${i}: order=${order}, sendEnabled=${sendEnabled}, name="${name}", email="${email}"`);
        
        if (name && email && email.includes('@') && sendEnabled) {
          recipients.push({
            order: order,
            name: name,
            email: email,
            memo: memo,
            sendEnabled: sendEnabled
          });
        }
      }
      
      // ìˆœì„œëŒ€ë¡œ ì •ë ¬ (ì§ê¸‰ì´ ë†’ì€ ìˆœì„œëŒ€ë¡œ)
      recipients.sort((a, b) => a.order - b.order);
      
      console.log(`Found ${recipients.length} email recipients (sorted by order)`);
      console.log('Recipients order:', recipients.map(r => `${r.order}: ${r.name}`));
      
      return {
        success: true,
        recipients: recipients
      };
      
    } catch (error) {
      console.error('ì´ë©”ì¼ ì£¼ì†Œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: error.toString()
      };
    }
  },

  /**
   * ì´ë©”ì¼ë¡œ ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥ ì „ì†¡
   */
  sendShipmentEmail: function(targetDate, recipients, excelFileId, fileName) {
    console.log('=== ì´ë©”ì¼ ì „ì†¡ ì‹œì‘ ===');
    console.log('Parameters:', { targetDate, recipients, fileName });
    
    try {
      // ì„¤ì • ì´ˆê¸°í™”
      initializeConfig();
      
      // ë‚ ì§œ ì²˜ë¦¬
      let dateString;
      if (targetDate) {
        if (targetDate.length === 4) {
          // MMDD í˜•ì‹ì„ YYYYMMDDë¡œ ë³€í™˜
          const currentYear = new Date().getFullYear();
          const month = targetDate.substring(0, 2);
          const day = targetDate.substring(2, 4);
          dateString = currentYear + month + day;
        } else {
          // YYYYMMDD í˜•ì‹
          dateString = targetDate.replace(/\//g, '').replace(/-/g, '');
        }
      } else {
        dateString = getTodayDate();
      }
      
      // ì¶œê³  ìˆ˜ëŸ‰ ë°ì´í„° ìˆ˜ì§‘
      const shipmentData = this.collectShipmentData(dateString);
      if (!shipmentData.success) {
        return shipmentData;
      }
      
      // ì´ë©”ì¼ ë‚´ìš© ìƒì„±
      const emailContent = this.generateEmailContent(shipmentData.data, dateString);
      
      // ì²¨ë¶€íŒŒì¼ ì¤€ë¹„
      const attachment = DriveApp.getFileById(excelFileId);
      
      // ì´ë©”ì¼ ì „ì†¡
      const subject = `${dateString.substring(4,6)}.${dateString.substring(6,8)} ê°„í¸ì‹ ì¶œê³ ìš”ì²­`;
      
      GmailApp.sendEmail(
        recipients, // ë°›ëŠ” ì‚¬ëŒ (ì½¤ë§ˆë¡œ êµ¬ë¶„)
        subject,
        emailContent, // í…ìŠ¤íŠ¸ ë³¸ë¬¸
        {
          attachments: [attachment.getBlob()],
          name: 'í•œêµ­ê³µí•­ ê¹€ì˜ì¤€'
        }
      );
      
      console.log('=== ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ ===');
      return {
        success: true,
        message: `ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\në°›ëŠ” ì‚¬ëŒ: ${recipients}`,
        recipientCount: recipients.split(',').length,
        shipmentSummary: shipmentData.data
      };
      
    } catch (error) {
      console.error('ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: 'ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: ' + error.toString()
      };
    }
  },

  /**
   * ì¶œê³  ìˆ˜ëŸ‰ ë°ì´í„° ìˆ˜ì§‘ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´ + ì¿ íŒ¡)
   */
  collectShipmentData: function(dateString) {
    console.log(`=== ì¶œê³  ë°ì´í„° ìˆ˜ì§‘ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´ + ì¿ íŒ¡): ${dateString} ===`);
    
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const shipmentData = {
        'ì‚¬ê³¨ê³ ê¸°ê³°íƒ•5ê°œì…': { cybersky: 0, coupang: 0, total: 0 },
        'ì‚¬ê³¨ê³°íƒ•5ê°œì…': { cybersky: 0, coupang: 0, total: 0 },
        'ì‚¬ê³¨ê³°íƒ•20ê°œì…': { cybersky: 0, coupang: 0, total: 0 },
        'ì‚¬ê³¨ê³°íƒ•10ê°œì…': { cybersky: 0, coupang: 0, total: 0 },
        'ìœ¡í¬5ê°œì…': { cybersky: 0, coupang: 0, total: 0 }
      };
      
      // 1. ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì½ê¸°
      const cyberskySheetName = `${dateString}_ê°„í¸ì‹_ì‹¸ì´ë²„ìŠ¤ì¹´ì´`;
      const cyberskySheet = spreadsheet.getSheetByName(cyberskySheetName);
      
      console.log(`ğŸ” ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ ì°¾ê¸°: ${cyberskySheetName}`);
      
      if (cyberskySheet) {
        console.log(`âœ… ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ ë°œê²¬: ${cyberskySheet.getName()}`);
        this.processCyberskySheetForProductDownloader(cyberskySheet, shipmentData);
      } else {
        console.log(`âš ï¸ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ ì—†ìŒ: ${cyberskySheetName}`);
      }
      
      // 2. ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì—ì„œ ì¿ íŒ¡ ë°ì´í„° ì½ê¸°
      const verificationSheetName = `${dateString}_ê²€ì‚°ê²°ê³¼`;
      const verificationSheet = spreadsheet.getSheetByName(verificationSheetName);
      
      console.log(`ğŸ” ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì°¾ê¸°: ${verificationSheetName}`);
      
      if (verificationSheet) {
        console.log(`âœ… ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ë°œê²¬: ${verificationSheet.getName()}`);
        this.processCoupangDataForProductDownloader(verificationSheet, shipmentData);
      } else {
        console.log(`âš ï¸ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ ì—†ìŒ: ${verificationSheetName}`);
      }
      
      // ìµœì¢… ê²°ê³¼ ë¡œê¹…
      console.log('ğŸ“Š ìµœì¢… ì¶œê³  ë°ì´í„°:');
      let totalQuantity = 0;
      for (const [product, data] of Object.entries(shipmentData)) {
        if (data.total > 0) {
          console.log(`  ${product}: ì´ ${data.total}ê°œ (ì‹¸ì´ë²„ìŠ¤ì¹´ì´: ${data.cybersky}, ì¿ íŒ¡: ${data.coupang})`);
          totalQuantity += data.total;
        }
      }
      console.log(`âœ… ì´ ì¶œê³ ëŸ‰: ${totalQuantity}ê°œ`);
      
      return {
        success: true,
        data: shipmentData
      };
      
    } catch (error) {
      console.error('ì¶œê³  ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: error.toString()
      };
    }
  },

  /**
   * ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ ì²˜ë¦¬ (ProductDownloaderìš©)
   */
  processCyberskySheetForProductDownloader: function(cyberskySheet, shipmentData) {
    console.log('ğŸ“‹ ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì‹œíŠ¸ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘ (ProductDownloader)');
    
    const data = cyberskySheet.getDataRange().getValues();
    console.log(`  â””â”€ ì‹œíŠ¸ í¬ê¸°: ${data.length} í–‰ x ${data[0] ? data[0].length : 0} ì—´`);
    
    if (data.length <= 1) {
      console.log(`  â””â”€ âš ï¸ ë°ì´í„° ì—†ìŒ`);
      return;
    }
    
    // ê³ ì • ì—´ ì¸ë±ìŠ¤ ì‚¬ìš©
    const productColIndex = 15; // Pì—´: PROD_NAME (0-based index)
    const quantityColIndex = 19; // Tì—´: ORDERCNT (0-based index)
    
    const headers = data[0];
    console.log(`  â””â”€ ğŸ“ ê³ ì • ì—´ ì‚¬ìš© - Pì—´(${productColIndex}): ${headers[productColIndex]}, Tì—´(${quantityColIndex}): ${headers[quantityColIndex]}`);
    
    let processedRows = 0;
    
    // ë°ì´í„° í–‰ ì²˜ë¦¬
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const productName = String(row[productColIndex] || '');
      const quantity = parseInt(row[quantityColIndex] || 0);
      
      if (quantity > 0 && productName) {
        const normalizedProduct = this.normalizeProductNameForProductDownloader(productName);
        
        if (normalizedProduct && shipmentData[normalizedProduct]) {
          shipmentData[normalizedProduct].cybersky += quantity;
          shipmentData[normalizedProduct].total += quantity;
          processedRows++;
        }
      }
    }
    
    console.log(`âœ… ì‹¸ì´ë²„ìŠ¤ì¹´ì´ ì²˜ë¦¬ ì™„ë£Œ: ${processedRows}ê°œ í–‰ ì²˜ë¦¬`);
  },

  /**
   * ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì—ì„œ ì¿ íŒ¡ ë°ì´í„° ì²˜ë¦¬ (ProductDownloaderìš©)
   */
  processCoupangDataForProductDownloader: function(verificationSheet, shipmentData) {
    console.log('ğŸ“‹ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì—ì„œ ì¿ íŒ¡ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘ (ProductDownloader)');
    
    const data = verificationSheet.getDataRange().getValues();
    console.log(`  â””â”€ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ í¬ê¸°: ${data.length} í–‰ x ${data[0] ? data[0].length : 0} ì—´`);
    
    if (data.length <= 1) {
      console.log(`  â””â”€ âš ï¸ ê²€ì‚°ê²°ê³¼ ì‹œíŠ¸ì— ë°ì´í„° ì—†ìŒ`);
      return 0;
    }
    
    // Hì—´(7)ì— ì¿ íŒ¡ ìˆ˜ëŸ‰ì´ ìˆëŠ” í–‰ë“¤ì—ì„œ ì¿ íŒ¡ ë°ì´í„° ì½ê¸°
    let coupangCount = 0;
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const productName = String(row[1] || ''); // Bì—´: í’ˆëª©ëª…
      const coupangQuantity = parseInt(row[7] || 0); // Hì—´: ì¿ íŒ¡ ìˆ˜ëŸ‰
      
      if (coupangQuantity > 0 && productName) {
        console.log(`    ğŸ›’ ì¿ íŒ¡ ë°ì´í„° ë°œê²¬: "${productName}" / ì¿ íŒ¡ìˆ˜ëŸ‰=${coupangQuantity}`);
        
        const normalizedProduct = this.normalizeProductNameForProductDownloader(productName);
        
        if (normalizedProduct && shipmentData[normalizedProduct]) {
          shipmentData[normalizedProduct].coupang += coupangQuantity;
          shipmentData[normalizedProduct].total += coupangQuantity;
          coupangCount++;
          
          console.log(`    â• ì¿ íŒ¡ ì¶”ê°€: ${normalizedProduct} +${coupangQuantity} (ìƒˆ ì´ê³„: ${shipmentData[normalizedProduct].total})`);
        }
      }
    }
    
    console.log(`âœ… ì¿ íŒ¡ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${coupangCount}ê°œ í•­ëª© ì²˜ë¦¬`);
    return coupangCount;
  },

  /**
   * ì œí’ˆëª… ì •ê·œí™” (ProductDownloaderìš©)
   */
  normalizeProductNameForProductDownloader: function(productName) {
    if (productName.includes('ì‚¬ê³¨ê³ ê¸°ê³°íƒ•')) {
      return 'ì‚¬ê³¨ê³ ê¸°ê³°íƒ•5ê°œì…';
    }
    else if (productName.includes('ì‚¬ê³¨ê³°íƒ•') && (productName.includes('20íŒ©') || productName.includes('20ê°œì…'))) {
      return 'ì‚¬ê³¨ê³°íƒ•20ê°œì…';
    }
    else if (productName.includes('ì‚¬ê³¨ê³°íƒ•') && (productName.includes('10íŒ©') || productName.includes('10ê°œì…'))) {
      return 'ì‚¬ê³¨ê³°íƒ•10ê°œì…';
    }
    else if (productName.includes('ì‚¬ê³¨ê³°íƒ•') && !productName.includes('ì‚¬ê³¨ê³ ê¸°ê³°íƒ•') && 
            (productName.includes('5íŒ©') || productName.includes('5ê°œì…') || productName.includes('1ë°•ìŠ¤'))) {
      return 'ì‚¬ê³¨ê³°íƒ•5ê°œì…';
    }
    else if (productName.includes('ìœ¡í¬')) {
      return 'ìœ¡í¬5ê°œì…';
    }
    
    return null;
  },

  /**
   * ì´ë©”ì¼ ë‚´ìš© ìƒì„±
   */
  generateEmailContent: function(shipmentData, dateString) {
    console.log('=== ì´ë©”ì¼ ë‚´ìš© ìƒì„± ===');
    
    // ë‚ ì§œ í¬ë§·íŒ… (YY.MM)
    const year = dateString.substring(2, 4);
    const month = dateString.substring(4, 6);
    const day = dateString.substring(6, 8);
    
    // ì´ë©”ì¼ ë³¸ë¬¸ ì‹œì‘ (HTML ì—†ì´ ìˆœìˆ˜ í…ìŠ¤íŠ¸)
    let emailBody = `ì•ˆë…•í•˜ì„¸ìš” í•œêµ­ê³µí•­ ê¹€ì˜ì¤€ ì‚¬ì›ì…ë‹ˆë‹¤
ê¸ˆì¼ ê°„í¸ì‹ ì¶œê³ ìš”ì²­ ë“œë¦½ë‹ˆë‹¤

ê¸ˆì¼ ì¶œê³ ëª©ë¡

`;

    // ê° ì œí’ˆë³„ ì¶œê³ ëŸ‰ ì¶”ê°€ (ìˆ˜ëŸ‰ì´ 0ì¸ ê²ƒì€ ì œì™¸)
    const productLabels = {
      'ì‚¬ê³¨ê³ ê¸°ê³°íƒ•5ê°œì…': 'ì œë™ ì‚¬ê³¨ê³ ê¸°ê³°íƒ• 5ê°œì…',
      'ì‚¬ê³¨ê³°íƒ•5ê°œì…': 'ì œë™ ì‚¬ê³¨ê³°íƒ• 5ê°œì…',
      'ì‚¬ê³¨ê³°íƒ•20ê°œì…': 'ì œë™ ì‚¬ê³¨ê³°íƒ• 20ê°œì…',
      'ì‚¬ê³¨ê³°íƒ•10ê°œì…': 'ì œë™ ì‚¬ê³¨ê³°íƒ• 10ê°œì…',
      'ìœ¡í¬5ê°œì…': 'ì œë™í•œìš° ìœ¡í¬ 5ê°œì…'
    };

    for (const [product, data] of Object.entries(shipmentData)) {
      if (data.total > 0) {
        const label = productLabels[product] || product;
        emailBody += `${label} X ${data.total}ë°•ìŠ¤\n`;
      }
    }

    emailBody += `
ê°ì‚¬í•©ë‹ˆë‹¤

ê¹€ì˜ì¤€ ë“œë¦¼`;

    return emailBody;
  },

  /**
   * ì‚¬ìš© ê°€ëŠ¥í•œ í’ˆëª©ë³„ ì‹œíŠ¸ ëª©ë¡ ì¡°íšŒ
   */
  getAvailableProductSheets: function(targetDate) {
    console.log('=== ì‚¬ìš© ê°€ëŠ¥í•œ í’ˆëª©ë³„ ì‹œíŠ¸ ì¡°íšŒ ===');
    
    try {
      // ë‚ ì§œ ì²˜ë¦¬
      let dateString;
      if (targetDate) {
        if (targetDate.length === 4) {
          // MMDD í˜•ì‹ì„ YYYYMMDDë¡œ ë³€í™˜
          const currentYear = new Date().getFullYear();
          const month = targetDate.substring(0, 2);
          const day = targetDate.substring(2, 4);
          dateString = currentYear + month + day;
        } else {
          // YYYYMMDD í˜•ì‹
          dateString = targetDate.replace(/\//g, '').replace(/-/g, '');
        }
      } else {
        dateString = getTodayDate();
      }
      
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const availableSheets = [];
      
      // ê° ì œí’ˆë³„ë¡œ ì‹œíŠ¸ í™•ì¸
      for (const product of this.PRODUCTS) {
        const sheetName = `${dateString}_${product}`;
        const sheet = spreadsheet.getSheetByName(sheetName);
        
        if (sheet) {
          const lastRow = sheet.getLastRow();
          availableSheets.push({
            product: product,
            sheetName: sheetName,
            rowCount: lastRow,
            hasData: lastRow > 1 // í—¤ë” í–‰ ì œì™¸í•˜ê³  ë°ì´í„°ê°€ ìˆëŠ”ì§€
          });
        }
      }
      
      return {
        success: true,
        dateString: dateString,
        availableSheets: availableSheets,
        totalSheets: availableSheets.length
      };
      
    } catch (error) {
      console.error('ì‹œíŠ¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: error.toString()
      };
    }
  }
};

/**
 * HTMLì—ì„œ í˜¸ì¶œí•  ì „ì—­ í•¨ìˆ˜ë“¤
 */

// í’ˆëª©ë³„ ì‹œíŠ¸ ë‹¤ìš´ë¡œë“œ
function downloadProductSheets(targetDate) {
  console.log('=== Global Function Start: downloadProductSheets ===');
  console.log('Parameters:', { targetDate });
  
  try {
    const result = ProductDownloader.downloadProductSheets(targetDate);
    console.log('Download result:', result);
    console.log('=== Global Function End: downloadProductSheets SUCCESS ===');
    return result;
    
  } catch (error) {
    console.error('ERROR in global downloadProductSheets:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Global Function End: downloadProductSheets FAILED ===');
    return { success: false, error: error.toString() };
  }
}

// ì‚¬ìš© ê°€ëŠ¥í•œ í’ˆëª©ë³„ ì‹œíŠ¸ ì¡°íšŒ
function getAvailableProductSheets(targetDate) {
  console.log('=== Global Function Start: getAvailableProductSheets ===');
  console.log('Parameters:', { targetDate });
  
  try {
    const result = ProductDownloader.getAvailableProductSheets(targetDate);
    console.log('Available sheets result:', result);
    console.log('=== Global Function End: getAvailableProductSheets SUCCESS ===');
    return result;
    
  } catch (error) {
    console.error('ERROR in global getAvailableProductSheets:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Global Function End: getAvailableProductSheets FAILED ===');
    return { success: false, error: error.toString() };
  }
}

// íŒŒì¼ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±° (HtmlServiceì—ì„œ í˜¸ì¶œ)
function triggerDownload(fileId, fileName) {
  console.log('=== Global Function Start: triggerDownload ===');
  console.log('Parameters:', { fileId, fileName });
  
  try {
    // ë‹¤ìš´ë¡œë“œ URL ìƒì„±
    const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
    
    console.log('=== Global Function End: triggerDownload SUCCESS ===');
    return { 
      success: true, 
      downloadUrl: downloadUrl,
      fileName: fileName,
      message: 'ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.'
    };
    
  } catch (error) {
    console.error('ERROR in global triggerDownload:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Global Function End: triggerDownload FAILED ===');
    return { success: false, error: error.toString() };
  }
}

// ì´ë©”ì¼ ì„¤ì • ì‹œíŠ¸ ì´ˆê¸°í™”
function initializeEmailSettings() {
  console.log('=== Global Function Start: initializeEmailSettings ===');
  
  try {
    const result = ProductDownloader.initializeEmailSettings();
    console.log('Initialize email settings result:', result);
    console.log('=== Global Function End: initializeEmailSettings SUCCESS ===');
    return result;
    
  } catch (error) {
    console.error('ERROR in global initializeEmailSettings:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Global Function End: initializeEmailSettings FAILED ===');
    return { success: false, error: error.toString() };
  }
}

// ì´ë©”ì¼ ì£¼ì†Œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
function getEmailRecipients() {
  console.log('=== Global Function Start: getEmailRecipients ===');
  
  try {
    const result = ProductDownloader.getEmailRecipients();
    console.log('Get email recipients result:', result);
    console.log('=== Global Function End: getEmailRecipients SUCCESS ===');
    return result;
    
  } catch (error) {
    console.error('ERROR in global getEmailRecipients:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Global Function End: getEmailRecipients FAILED ===');
    return { success: false, error: error.toString() };
  }
}

/**
   * ìë™ ì´ë©”ì¼ ì „ì†¡ (íŠ¸ë¦¬ê±°ìš©) - í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„±í•˜ê³  ì´ë©”ì¼ë¡œ ì „ì†¡
   */
  sendEmailWithProductSheets: function(targetDate) {
    console.log('=== ìë™ ì´ë©”ì¼ ì „ì†¡ ì‹œì‘ ===');
    
    try {
      // ë‚ ì§œ ì²˜ë¦¬
      let dateString;
      if (targetDate) {
        if (targetDate.length === 4) {
          // MMDD í˜•ì‹ì„ YYYYMMDDë¡œ ë³€í™˜
          const currentYear = new Date().getFullYear();
          const month = targetDate.substring(0, 2);
          const day = targetDate.substring(2, 4);
          dateString = currentYear + month + day;
        } else {
          // YYYYMMDD í˜•ì‹
          dateString = targetDate.replace(/\//g, '').replace(/-/g, '');
        }
      } else {
        dateString = getTodayDate();
      }
      
      console.log('ìë™ ì´ë©”ì¼ ì „ì†¡ ë‚ ì§œ:', dateString);
      
      // 1. í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
      const downloadResult = this.downloadProductSheets(targetDate);
      
      if (!downloadResult.success) {
        return {
          success: false,
          error: 'í’ˆëª©ë³„ ì‹œíŠ¸ ìƒì„± ì‹¤íŒ¨: ' + downloadResult.error,
          step: 'downloadProductSheets'
        };
      }
      
      // 2. ì´ë©”ì¼ ìˆ˜ì‹ ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      const recipientsResult = this.getEmailRecipients();
      if (!recipientsResult.success) {
        return {
          success: false,
          error: 'ì´ë©”ì¼ ìˆ˜ì‹ ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + recipientsResult.error,
          step: 'getEmailRecipients'
        };
      }
      
      if (recipientsResult.recipients.length === 0) {
        return {
          success: false,
          error: 'ì „ì†¡ ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë©”ì¼_ì„¤ì • ì‹œíŠ¸ì—ì„œ ì „ì†¡ì—¬ë¶€ë¥¼ ì²´í¬í•´ì£¼ì„¸ìš”.',
          step: 'noRecipients'
        };
      }
      
      // 3. ì¶œê³  ë°ì´í„° ìˆ˜ì§‘
      const shipmentData = this.collectShipmentData(dateString);
      if (!shipmentData.success) {
        return {
          success: false,
          error: 'ì¶œê³  ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨: ' + shipmentData.error,
          step: 'collectShipmentData'
        };
      }
      
      // 4. ì´ë©”ì¼ ë‚´ìš© ìƒì„±
      const emailContent = this.generateEmailContent(shipmentData.data, dateString);
      
      // 5. ì²¨ë¶€ íŒŒì¼ ì¤€ë¹„ (ìƒì„±ëœ ì—‘ì…€ íŒŒì¼)
      const excelFileId = downloadResult.downloadInfo.fileId;
      const attachment = DriveApp.getFileById(excelFileId);
      
      // 6. ì´ë©”ì¼ ì „ì†¡
      const subject = `${dateString.substring(4,6)}.${dateString.substring(6,8)} ê°„í¸ì‹ ì¶œê³ ìš”ì²­ (ìë™ì „ì†¡)`;
      const recipients = recipientsResult.recipients.map(r => r.email).join(',');
      
      GmailApp.sendEmail(
        recipients,
        subject,
        emailContent,
        {
          attachments: [attachment],
          name: 'í•œêµ­ê³µí•­ ê¹€ì˜ì¤€ (ìë™ì‹œìŠ¤í…œ)'
        }
      );
      
      console.log('âœ… ìë™ ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ');
      
      return {
        success: true,
        message: `ìë™ ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ (${dateString})`,
        recipientCount: recipientsResult.recipients.length,
        recipients: recipientsResult.recipients,
        fileName: downloadResult.downloadInfo.fileName,
        fileId: excelFileId,
        shipmentSummary: shipmentData.data
      };
      
    } catch (error) {
      console.error('ìë™ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: error.toString(),
        step: 'emailSending'
      };
    }
  }
};

// ì´ë©”ì¼ ì „ì†¡ (HtmlServiceì—ì„œ í˜¸ì¶œ)
function sendShipmentEmail(targetDate, recipients, excelFileId, fileName) {
  console.log('=== Global Function Start: sendShipmentEmail ===');
  console.log('Parameters:', { targetDate, recipients, fileName });
  
  try {
    const result = ProductDownloader.sendShipmentEmail(targetDate, recipients, excelFileId, fileName);
    console.log('Email send result:', result);
    console.log('=== Global Function End: sendShipmentEmail SUCCESS ===');
    return result;
    
  } catch (error) {
    console.error('ERROR in global sendShipmentEmail:', error.toString());
    console.error('Error stack:', error.stack);
    console.log('=== Global Function End: sendShipmentEmail FAILED ===');
    return { success: false, error: error.toString() };
  }
}