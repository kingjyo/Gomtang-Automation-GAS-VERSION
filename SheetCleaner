/**
 * ì‹œíŠ¸ ì •ë¦¬ ê¸°ëŠ¥
 * SheetCleaner.gs
 */

const SheetCleaner = {
  /**
   * ë³´ì¡´í•  ì‹œíŠ¸ ëª©ë¡
   */
  PRESERVED_SHEETS: [
    'ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥ ì–‘ì‹',
    'ì´ë©”ì¼_ì„¤ì •',
    'ì´ë©”ì¼_ë¡œê·¸', 
    'ì—…ë°ì´íŠ¸_ë¡œê·¸'
  ],

  /**
   * ì¼ì¼ ì‘ì—… ì™„ë£Œ í›„ ì‹œíŠ¸ ì •ë¦¬
   */
  cleanupDailySheets: function() {
    console.log('=== ì¼ì¼ ì‹œíŠ¸ ì •ë¦¬ ì‹œì‘ ===');
    
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const allSheets = spreadsheet.getSheets();
      const sheetsToDelete = [];
      const preservedSheets = [];
      
      // ì‚­ì œí•  ì‹œíŠ¸ì™€ ë³´ì¡´í•  ì‹œíŠ¸ ë¶„ë¥˜
      for (const sheet of allSheets) {
        const sheetName = sheet.getName();
        
        if (this.shouldPreserveSheet(sheetName)) {
          preservedSheets.push(sheetName);
        } else {
          sheetsToDelete.push({
            sheet: sheet,
            name: sheetName
          });
        }
      }
      
      console.log('ë³´ì¡´í•  ì‹œíŠ¸:', preservedSheets);
      console.log('ì‚­ì œí•  ì‹œíŠ¸:', sheetsToDelete.map(s => s.name));
      
      // ì‹œíŠ¸ ì‚­ì œ ì‹¤í–‰
      let deletedCount = 0;
      const deletedSheets = [];
      
      for (const sheetInfo of sheetsToDelete) {
        try {
          spreadsheet.deleteSheet(sheetInfo.sheet);
          deletedSheets.push(sheetInfo.name);
          deletedCount++;
          console.log(`ì‚­ì œë¨: ${sheetInfo.name}`);
        } catch (deleteError) {
          console.error(`ì‹œíŠ¸ ì‚­ì œ ì‹¤íŒ¨ (${sheetInfo.name}):`, deleteError);
        }
      }
      
      console.log('=== ì¼ì¼ ì‹œíŠ¸ ì •ë¦¬ ì™„ë£Œ ===');
      
      return {
        success: true,
        message: `${deletedCount}ê°œ ì‹œíŠ¸ê°€ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        deletedCount: deletedCount,
        preservedCount: preservedSheets.length,
        deletedSheets: deletedSheets,
        preservedSheets: preservedSheets
      };
      
    } catch (error) {
      console.error('ì¼ì¼ ì‹œíŠ¸ ì •ë¦¬ ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: error.toString()
      };
    }
  },
  
  /**
   * ì‹œíŠ¸ë¥¼ ë³´ì¡´í• ì§€ ì—¬ë¶€ íŒë‹¨
   */
  shouldPreserveSheet: function(sheetName) {
    // ì •í™•í•œ ì´ë¦„ ë§¤ì¹˜
    if (this.PRESERVED_SHEETS.includes(sheetName)) {
      return true;
    }
    
    // TEST_ ì‹œíŠ¸ëŠ” ì‚­ì œ ëŒ€ìƒ
    if (sheetName.startsWith('TEST_')) {
      return false;
    }
    
    // ìƒ˜í”Œ/í…œí”Œë¦¿ ì‹œíŠ¸ëŠ” ì‚­ì œ ëŒ€ìƒ
    if (sheetName.includes('ìƒ˜í”Œ') || sheetName.includes('í…œí”Œë¦¿') || sheetName.includes('ì„¤ëª…')) {
      return false;
    }
    
    return false; // ê¸°ë³¸ì ìœ¼ë¡œ ì‚­ì œ
  },

  /**
   * ì‹œíŠ¸ ì •ë¦¬ ë¯¸ë¦¬ë³´ê¸° (ì‚­ì œí•˜ì§€ ì•Šê³  í™•ì¸ë§Œ)
   */
  previewCleanup: function() {
    console.log('=== ì‹œíŠ¸ ì •ë¦¬ ë¯¸ë¦¬ë³´ê¸° ===');
    
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const allSheets = spreadsheet.getSheets();
      const sheetsToDelete = [];
      const preservedSheets = [];
      
      for (const sheet of allSheets) {
        const sheetName = sheet.getName();
        
        if (this.shouldPreserveSheet(sheetName)) {
          preservedSheets.push(sheetName);
        } else {
          sheetsToDelete.push(sheetName);
        }
      }
      
      return {
        success: true,
        sheetsToDelete: sheetsToDelete,
        preservedSheets: preservedSheets,
        totalSheets: allSheets.length,
        deleteCount: sheetsToDelete.length,
        preserveCount: preservedSheets.length
      };
      
    } catch (error) {
      console.error('ì‹œíŠ¸ ì •ë¦¬ ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: error.toString()
      };
    }
  },

  /**
   * íŠ¹ì • ë‚ ì§œì˜ ì‹œíŠ¸ë“¤ë§Œ ì‚­ì œ
   */
  cleanupDateSheets: function(targetDate) {
    console.log(`=== ${targetDate} ë‚ ì§œ ì‹œíŠ¸ ì •ë¦¬ ì‹œì‘ ===`);
    
    try {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const allSheets = spreadsheet.getSheets();
      const sheetsToDelete = [];
      
      // ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
      let fullDate = targetDate;
      if (targetDate.length === 4) {
        // MMDD â†’ YYYYMMDD
        fullDate = new Date().getFullYear() + targetDate;
      }
      
      for (const sheet of allSheets) {
        const sheetName = sheet.getName();
        
        // í•´ë‹¹ ë‚ ì§œë¡œ ì‹œì‘í•˜ëŠ” ì‹œíŠ¸ë“¤ ì°¾ê¸°
        if (sheetName.startsWith(fullDate + '_') || sheetName.startsWith(fullDate + ' ')) {
          // ë³´ì¡´í•  ì‹œíŠ¸ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ ì‚­ì œ ëŒ€ìƒì— ì¶”ê°€
          if (!this.shouldPreserveSheet(sheetName)) {
            sheetsToDelete.push({
              sheet: sheet,
              name: sheetName
            });
          }
        }
      }
      
      // ì‹œíŠ¸ ì‚­ì œ ì‹¤í–‰
      let deletedCount = 0;
      const deletedSheets = [];
      
      for (const sheetInfo of sheetsToDelete) {
        try {
          spreadsheet.deleteSheet(sheetInfo.sheet);
          deletedSheets.push(sheetInfo.name);
          deletedCount++;
          console.log(`ì‚­ì œë¨: ${sheetInfo.name}`);
        } catch (deleteError) {
          console.error(`ì‹œíŠ¸ ì‚­ì œ ì‹¤íŒ¨ (${sheetInfo.name}):`, deleteError);
        }
      }
      
      console.log(`=== ${targetDate} ë‚ ì§œ ì‹œíŠ¸ ì •ë¦¬ ì™„ë£Œ ===`);
      
      return {
        success: true,
        message: `${targetDate} ë‚ ì§œì˜ ${deletedCount}ê°œ ì‹œíŠ¸ê°€ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        deletedCount: deletedCount,
        deletedSheets: deletedSheets,
        targetDate: targetDate
      };
      
    } catch (error) {
      console.error('ë‚ ì§œë³„ ì‹œíŠ¸ ì •ë¦¬ ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: error.toString()
      };
    }
  }
};

/**
 * ì¼ì¼ ì‹œíŠ¸ ì •ë¦¬ (ë©”ë‰´ì—ì„œ í˜¸ì¶œ)
 */
function cleanupDailySheets() {
  console.log('=== Global Function Start: cleanupDailySheets ===');
  
  try {
    const ui = SpreadsheetApp.getUi();
    
    // ë¯¸ë¦¬ë³´ê¸° ì‹¤í–‰
    const previewResult = SheetCleaner.previewCleanup();
    
    if (!previewResult.success) {
      ui.alert('âŒ ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨: ' + previewResult.error);
      return { success: false, error: previewResult.error };
    }
    
    // ì‚¬ìš©ì í™•ì¸
    const confirmMessage = `ğŸ—‘ï¸ ì‹œíŠ¸ ì •ë¦¬ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
      `ğŸ“Š ì´ ì‹œíŠ¸ ìˆ˜: ${previewResult.totalSheets}ê°œ\n` +
      `ğŸ—‘ï¸ ì‚­ì œí•  ì‹œíŠ¸: ${previewResult.deleteCount}ê°œ\n` +
      `ğŸ’¾ ë³´ì¡´í•  ì‹œíŠ¸: ${previewResult.preserveCount}ê°œ\n\n` +
      `ì‚­ì œ ì˜ˆì • ì‹œíŠ¸:\n${previewResult.sheetsToDelete.slice(0, 10).join('\n')}` +
      (previewResult.sheetsToDelete.length > 10 ? `\n... ì™¸ ${previewResult.sheetsToDelete.length - 10}ê°œ` : '') +
      `\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
    
    const response = ui.alert(
      'ì‹œíŠ¸ ì •ë¦¬ í™•ì¸',
      confirmMessage,
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) {
      return { success: false, message: 'ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.' };
    }
    
    // ì •ë¦¬ ì‹¤í–‰
    const result = SheetCleaner.cleanupDailySheets();
    
    if (result.success) {
      ui.alert(`âœ… ì‹œíŠ¸ ì •ë¦¬ ì™„ë£Œ!\n\n` +
              `ğŸ—‘ï¸ ì‚­ì œëœ ì‹œíŠ¸: ${result.deletedCount}ê°œ\n` +
              `ğŸ’¾ ë³´ì¡´ëœ ì‹œíŠ¸: ${result.preservedCount}ê°œ\n\n` +
              `ë‹¤ìŒ ì‹œíŠ¸ë“¤ì´ ë³´ì¡´ë˜ì—ˆìŠµë‹ˆë‹¤:\n${result.preservedSheets.join('\n')}`);
    } else {
      ui.alert('âŒ ì‹œíŠ¸ ì •ë¦¬ ì‹¤íŒ¨: ' + result.error);
    }
    
    console.log('=== Global Function End: cleanupDailySheets SUCCESS ===');
    return result;
    
  } catch (error) {
    console.error('ERROR in global cleanupDailySheets:', error);
    console.log('=== Global Function End: cleanupDailySheets FAILED ===');
    
    SpreadsheetApp.getUi().alert('âŒ ì‹œíŠ¸ ì •ë¦¬ ì˜¤ë¥˜: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * ë‚ ì§œë³„ ì‹œíŠ¸ ì •ë¦¬ (ë©”ë‰´ì—ì„œ í˜¸ì¶œ)
 */
function cleanupDateSheets() {
  console.log('=== Global Function Start: cleanupDateSheets ===');
  
  try {
    const ui = SpreadsheetApp.getUi();
    
    // ë‚ ì§œ ì…ë ¥
    const response = ui.prompt(
      'ğŸ“… ë‚ ì§œë³„ ì‹œíŠ¸ ì •ë¦¬',
      'ì‚­ì œí•  ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n\nMMDD í˜•ì‹ (ì˜ˆ: 0810, 0811)\në˜ëŠ” YYYYMMDD í˜•ì‹ (ì˜ˆ: 20240810)',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (response.getSelectedButton() !== ui.Button.OK) {
      return { success: false, message: 'ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.' };
    }
    
    const inputDate = response.getResponseText().trim();
    if (!inputDate) {
      ui.alert('âŒ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return { success: false, error: 'ë‚ ì§œê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' };
    }
    
    if (!/^\d{4}$/.test(inputDate) && !/^\d{8}$/.test(inputDate)) {
      ui.alert('âŒ ì˜¬ë°”ë¥¸ ë‚ ì§œ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\nMMDD (ì˜ˆ: 0810) ë˜ëŠ” YYYYMMDD (ì˜ˆ: 20240810)');
      return { success: false, error: 'ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤.' };
    }
    
    // í™•ì¸ ë©”ì‹œì§€
    const confirmResponse = ui.alert(
      'ë‚ ì§œë³„ ì‹œíŠ¸ ì •ë¦¬ í™•ì¸',
      `${inputDate} ë‚ ì§œì˜ ì‹œíŠ¸ë“¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
      ui.ButtonSet.YES_NO
    );
    
    if (confirmResponse !== ui.Button.YES) {
      return { success: false, message: 'ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.' };
    }
    
    // ì •ë¦¬ ì‹¤í–‰
    const result = SheetCleaner.cleanupDateSheets(inputDate);
    
    if (result.success) {
      ui.alert(`âœ… ${inputDate} ë‚ ì§œ ì‹œíŠ¸ ì •ë¦¬ ì™„ë£Œ!\n\n` +
              `ğŸ—‘ï¸ ì‚­ì œëœ ì‹œíŠ¸: ${result.deletedCount}ê°œ\n\n` +
              (result.deletedSheets.length > 0 ? 
                `ì‚­ì œëœ ì‹œíŠ¸:\n${result.deletedSheets.join('\n')}` : 
                'ì‚­ì œí•  ì‹œíŠ¸ê°€ ì—†ì—ˆìŠµë‹ˆë‹¤.'));
    } else {
      ui.alert('âŒ ë‚ ì§œë³„ ì‹œíŠ¸ ì •ë¦¬ ì‹¤íŒ¨: ' + result.error);
    }
    
    console.log('=== Global Function End: cleanupDateSheets SUCCESS ===');
    return result;
    
  } catch (error) {
    console.error('ERROR in global cleanupDateSheets:', error);
    console.log('=== Global Function End: cleanupDateSheets FAILED ===');
    
    SpreadsheetApp.getUi().alert('âŒ ë‚ ì§œë³„ ì‹œíŠ¸ ì •ë¦¬ ì˜¤ë¥˜: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}