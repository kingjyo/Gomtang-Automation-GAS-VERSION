<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    
    .content {
      padding: 30px;
    }
    
    /* ë‚ ì§œ ì„ íƒ ì„¹ì…˜ */
    .date-section {
      margin-bottom: 25px;
      padding: 20px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      background: #f8f9fa;
    }
    
    .date-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .date-input-group {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .date-input {
      padding: 10px 15px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 14px;
      width: 120px;
      text-align: center;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .date-input:focus {
      outline: none;
      border-color: #dc3545;
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
    }
    
    .date-input::placeholder {
      color: #999;
      font-weight: 400;
    }
    
    .date-today-btn {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: #dc3545;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .date-today-btn:hover {
      background: #c82333;
      transform: translateY(-1px);
    }
    
    .date-help {
      font-size: 12px;
      color: #666;
      margin-left: 10px;
      line-height: 1.4;
    }
    
    /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ */
    .upload-section {
      margin-bottom: 25px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .upload-area {
      border: 3px dashed #dee2e6;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      background: #fafbfc;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .upload-area:hover {
      border-color: #dc3545;
      background: #fff5f5;
      transform: translateY(-2px);
    }
    
    .upload-area.dragover {
      background: #fff5f5;
      border-color: #dc3545;
      border-style: solid;
      transform: scale(1.02);
      box-shadow: 0 10px 30px rgba(220, 53, 69, 0.2);
    }
    
    .upload-area.has-file {
      background: #d4edda;
      border-color: #28a745;
      border-style: solid;
    }
    
    .upload-icon {
      font-size: 64px;
      color: #dc3545;
      margin-bottom: 20px;
    }
    
    .upload-area.has-file .upload-icon {
      color: #28a745;
    }
    
    .upload-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
    }
    
    .upload-description {
      font-size: 16px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .upload-hint {
      font-size: 14px;
      color: #999;
    }
    
    .file-info {
      margin-top: 20px;
      padding: 20px;
      background: white;
      border-radius: 10px;
      text-align: left;
      display: none;
      border: 2px solid #28a745;
    }
    
    .file-info.show {
      display: block;
    }
    
    .file-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      word-break: break-all;
      font-size: 16px;
    }
    
    .file-size {
      font-size: 14px;
      color: #666;
    }
    
    .file-input {
      display: none;
    }
    
    .remove-file {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }
    
    .upload-area.has-file .remove-file {
      display: flex;
    }
    
    .remove-file:hover {
      background: #c82333;
      transform: scale(1.1);
    }
    
    /* ìˆ˜ì‹ ì ì •ë³´ ì„¹ì…˜ */
    .recipients-section {
      margin-bottom: 25px;
      padding: 20px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      background: #f8f9fa;
    }
    
    .recipients-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .recipients-display {
      display: none;
      margin-top: 15px;
    }
    
    .recipients-display.show {
      display: block;
    }
    
    .recipient-item {
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin-bottom: 8px;
      background: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .recipient-info {
      flex: 1;
    }
    
    .recipient-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
    }
    
    .recipient-email {
      font-size: 12px;
      color: #666;
      font-family: 'Courier New', monospace;
    }
    
    .recipient-order {
      background: #dc3545;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }
    
    /* ë²„íŠ¼ ê·¸ë£¹ */
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    
    .button {
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    
    .button.primary {
      background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
      color: white;
    }
    
    .button.primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(220, 53, 69, 0.4);
    }
    
    .button.secondary {
      background: #6c757d;
      color: white;
    }
    
    .button.secondary:hover:not(:disabled) {
      background: #5a6268;
    }
    
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ë¡œë”© ë° ë©”ì‹œì§€ */
    .loading {
      display: none;
      text-align: center;
      padding: 30px;
    }
    
    .loading.show {
      display: block;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #dc3545;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .message {
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      display: none;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    
    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 10px;
      }
      
      .content {
        padding: 20px;
      }
      
      .upload-area {
        padding: 30px 20px;
        min-height: 150px;
      }
      
      .upload-icon {
        font-size: 48px;
      }
      
      .upload-title {
        font-size: 20px;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“§ ì´ë©”ì¼ ì „ì†¡ê¸°</h1>
      <p>ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ìë™ìœ¼ë¡œ ì¶œê³ ìš”ì²­ ì´ë©”ì¼ ì „ì†¡</p>
    </div>
    
    <div class="content">
      <!-- ë‚ ì§œ ì„ íƒ ì„¹ì…˜ -->
      <div class="date-section">
        <div class="date-title">
          ğŸ“… ì¶œê³  ë‚ ì§œ ì§€ì •
        </div>
        <div class="date-input-group">
          <input type="text" id="dateInput" class="date-input" placeholder="0809" maxlength="4" pattern="[0-9]{4}">
          <button class="date-today-btn" onclick="setTodayDate()">ğŸ“… ì˜¤ëŠ˜</button>
          <div class="date-help">
            MMDD í˜•ì‹ (ì˜ˆ: 0809)<br>
            ì´ë©”ì¼ ì œëª©ì— í‘œì‹œë  ë‚ ì§œì…ë‹ˆë‹¤
          </div>
        </div>
      </div>
      
      <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ -->
      <div class="upload-section">
        <div class="section-title">
          ğŸ“Š ì—‘ì…€ íŒŒì¼ ì²¨ë¶€ (ì´ë©”ì¼ ì²¨ë¶€ìš©)
        </div>
        
        <div class="upload-area" id="uploadArea">
          <button class="remove-file" onclick="removeFile()" id="removeFileBtn">Ã—</button>
          <div class="upload-icon">ğŸ“</div>
          <div class="upload-title">ê°„í¸ì‹ ìˆ˜ê¸°ì†¡ì¥ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
          <div class="upload-description">ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
          <div class="upload-hint">ì´ë©”ì¼ì— ì²¨ë¶€í•  ì—‘ì…€ íŒŒì¼ì…ë‹ˆë‹¤<br>ì¶œê³ ëª©ë¡ ë‚´ìš©ì€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì‹œíŠ¸ì—ì„œ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤</div>
          
          <div class="file-info" id="fileInfo">
            <div class="file-name" id="fileName"></div>
            <div class="file-size" id="fileSize"></div>
          </div>
        </div>
        
        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
      </div>
      
      <!-- ìˆ˜ì‹ ì ì •ë³´ ì„¹ì…˜ -->
      <div class="recipients-section">
        <div class="recipients-title">
          ğŸ‘¥ ì´ë©”ì¼ ìˆ˜ì‹ ì (ì´ë©”ì¼_ì„¤ì • ì‹œíŠ¸ ê¸°ì¤€)
        </div>
        <button class="button secondary" onclick="loadRecipients()" id="loadRecipientsBtn">
          <span>ğŸ“‹</span> ìˆ˜ì‹ ì ëª©ë¡ í™•ì¸
        </button>
        
        <div class="recipients-display" id="recipientsDisplay">
          <!-- ìˆ˜ì‹ ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
      </div>
      
      <div class="button-group">
        <button class="button primary" onclick="sendEmail()" id="sendEmailBtn" disabled>
          <span>ğŸš€</span> ì¶œê³ ìš”ì²­ ì´ë©”ì¼ ì „ì†¡
        </button>
      </div>
      
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div id="loadingText">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
      </div>
      
      <div class="message" id="message"></div>
    </div>
  </div>
  
  <script>
    let selectedFile = null;
    let recipients = [];
    
    // ë‚ ì§œ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function setTodayDate() {
      const today = new Date();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const mmdd = month + day;
      
      document.getElementById('dateInput').value = mmdd;
    }
    
    function getSelectedDate() {
      const dateInput = document.getElementById('dateInput').value.trim();
      
      // ì…ë ¥ê°’ ê²€ì¦
      if (dateInput && dateInput.length === 4 && /^\d{4}$/.test(dateInput)) {
        return dateInput;
      } else if (dateInput && dateInput.length > 0) {
        showMessage('ë‚ ì§œëŠ” MMDD í˜•ì‹ 4ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 0809)', 'error');
        return null;
      }
      
      // ì…ë ¥ê°’ì´ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©
      const today = new Date();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      return month + day;
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
    window.onload = function() {
      setTodayDate();
      setupDragAndDrop();
    };
    
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
    function setupDragAndDrop() {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      
      // í´ë¦­ ì´ë²¤íŠ¸
      uploadArea.addEventListener('click', function(e) {
        if (e.target.className !== 'remove-file') {
          fileInput.click();
        }
      });
      
      // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
      fileInput.addEventListener('change', function(e) {
        handleFile(e.target.files[0]);
      });
      
      // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
      uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', function() {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });
    }
    
    // íŒŒì¼ ì²˜ë¦¬
    function handleFile(file) {
      if (!file) return;
      
      // íŒŒì¼ í™•ì¥ì í™•ì¸
      const validExtensions = ['.xlsx', '.xls'];
      const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
      
      if (!validExtensions.includes(fileExtension)) {
        showMessage('ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
        return;
      }
      
      selectedFile = file;
      
      // íŒŒì¼ ì •ë³´ í‘œì‹œ
      document.getElementById('fileName').textContent = 'ğŸ“„ ' + file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
      document.getElementById('fileInfo').classList.add('show');
      document.getElementById('uploadArea').classList.add('has-file');
      
      updateButtonStates();
      clearMessage();
    }
    
    // íŒŒì¼ ì œê±°
    function removeFile() {
      selectedFile = null;
      document.getElementById('fileInfo').classList.remove('show');
      document.getElementById('uploadArea').classList.remove('has-file');
      document.getElementById('fileInput').value = '';
      updateButtonStates();
    }
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateButtonStates() {
      const sendBtn = document.getElementById('sendEmailBtn');
      sendBtn.disabled = !selectedFile || recipients.length === 0;
    }
    
    // íŒŒì¼ í¬ê¸° í¬ë§·
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // ìˆ˜ì‹ ì ëª©ë¡ ë¡œë“œ
    function loadRecipients() {
      showMessage('ìˆ˜ì‹ ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            recipients = result.recipients;
            displayRecipients(result.recipients);
            showMessage(`ğŸ“§ ${result.recipients.length}ëª…ì˜ ìˆ˜ì‹ ìë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ì²´í¬ë°•ìŠ¤ ì„ íƒëœ ì‚¬ìš©ìë§Œ)`, 'success');
            updateButtonStates();
          } else {
            showMessage(`ìˆ˜ì‹ ì ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${result.error}`, 'error');
            recipients = [];
          }
        })
        .withFailureHandler(function(error) {
          showMessage(`ìˆ˜ì‹ ì ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error}`, 'error');
          recipients = [];
        })
        .getEmailRecipients();
    }
    
    // ìˆ˜ì‹ ì ëª©ë¡ í‘œì‹œ
    function displayRecipients(recipientsList) {
      const display = document.getElementById('recipientsDisplay');
      display.innerHTML = '';
      
      if (recipientsList.length === 0) {
        display.innerHTML = '<div style="text-align: center; color: #666; margin-top: 15px;">ì „ì†¡ ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì´ë©”ì¼_ì„¤ì • ì‹œíŠ¸ì—ì„œ ì „ì†¡ì—¬ë¶€ë¥¼ ì²´í¬í•´ì£¼ì„¸ìš”.</div>';
      } else {
        recipientsList.forEach(recipient => {
          const item = document.createElement('div');
          item.className = 'recipient-item';
          item.innerHTML = `
            <div class="recipient-info">
              <div class="recipient-name">${recipient.name}</div>
              <div class="recipient-email">${recipient.email}</div>
            </div>
            <div class="recipient-order">${recipient.order}ìˆœìœ„</div>
          `;
          display.appendChild(item);
        });
      }
      
      display.classList.add('show');
    }
    
    // ì´ë©”ì¼ ì „ì†¡
    function sendEmail() {
      if (!selectedFile) {
        showMessage('ì²¨ë¶€í•  ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      if (recipients.length === 0) {
        showMessage('ìˆ˜ì‹ ìê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìˆ˜ì‹ ì ëª©ë¡ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      const targetDate = getSelectedDate();
      if (targetDate === null) {
        return;
      }
      
      showLoading('ì—‘ì…€ íŒŒì¼ì„ ì²˜ë¦¬í•˜ê³  ì´ë©”ì¼ì„ ì „ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
      
      // íŒŒì¼ì„ Base64ë¡œ ì¸ì½”ë”©
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileData = e.target.result.split(',')[1]; // Base64 ë°ì´í„°ë§Œ ì¶”ì¶œ
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            
            if (result.success) {
              showMessage(`âœ… ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ!\n\në°›ëŠ” ì‚¬ëŒ: ${result.recipientCount}ëª…\níŒŒì¼ëª…: ${result.fileName}\n\nì¶œê³ ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } else {
              showMessage(`ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: ${result.error}`, 'error');
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showMessage(`ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: ${error}`, 'error');
          })
          .processExcelAndSendEmail(fileData, selectedFile.name, targetDate);
      };
      
      reader.readAsDataURL(selectedFile);
    }
    
    // UI í—¬í¼ í•¨ìˆ˜ë“¤
    function showLoading(text) {
      document.getElementById('loading').classList.add('show');
      document.getElementById('loadingText').textContent = text || 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...';
      document.querySelectorAll('.button').forEach(button => {
        button.disabled = true;
      });
    }
    
    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
      document.querySelectorAll('.button').forEach(button => {
        button.disabled = false;
      });
      updateButtonStates();
    }
    
    function showMessage(text, type) {
      const message = document.getElementById('message');
      message.textContent = text;
      message.className = 'message ' + type;
      
      if (type === 'success') {
        setTimeout(clearMessage, 7000);
      }
    }
    
    function clearMessage() {
      const message = document.getElementById('message');
      message.classList.remove('success', 'error', 'info');
    }
    
    // ë‚ ì§œ ì…ë ¥ í•„ë“œì—ì„œ ì—”í„°í‚¤ ì²˜ë¦¬
    document.getElementById('dateInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        if (selectedFile && recipients.length > 0) {
          sendEmail();
        }
      }
    });
  </script>
</body>
</html>